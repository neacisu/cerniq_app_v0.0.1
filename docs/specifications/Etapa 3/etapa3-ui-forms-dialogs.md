# Etapa 3 - UI Forms & Dialogs Documentation

## Formulare și Dialoguri pentru AI Sales Agent - Cerniq.app

**Versiune:** 1.0  
**Data:** Ianuarie 2026  
**Stack:** React 19.2.3 + React Hook Form + Zod + Shadcn/ui + Tailwind v4

---

## Cuprins

1. [Overview și Convenții](#1-overview-și-convenții)
2. [Form Validation Schemas (Zod)](#2-form-validation-schemas-zod)
3. [Negocieri Forms](#3-negocieri-forms)
4. [Produse Forms](#4-produse-forms)
5. [Prețuri & Discount Forms](#5-prețuri--discount-forms)
6. [Documente Forms](#6-documente-forms)
7. [AI Configuration Forms](#7-ai-configuration-forms)
8. [Guardrails Forms](#8-guardrails-forms)
9. [HITL Approval Dialogs](#9-hitl-approval-dialogs)
10. [Integration Forms](#10-integration-forms)
11. [Settings Forms](#11-settings-forms)
12. [Confirmation Dialogs](#12-confirmation-dialogs)
13. [Multi-Step Forms](#13-multi-step-forms)
14. [Form Testing](#14-form-testing)

---

## 1. Overview și Convenții

### 1.1 Technology Stack

```typescript
// Dependențe pentru forms
const formDependencies = {
  "react-hook-form": "^7.54.2",
  "@hookform/resolvers": "^3.9.1",
  "zod": "^3.24.1",
  "@radix-ui/react-dialog": "^1.1.4",
  "@radix-ui/react-alert-dialog": "^1.1.4",
  "date-fns": "^4.1.0",
  "sonner": "^1.7.3"  // Pentru toast notifications
};
```

### 1.2 Form Pattern Standard

```typescript
// Pattern standard pentru toate formularele
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';

// 1. Definire schema Zod
const formSchema = z.object({
  field: z.string().min(1, 'Câmp obligatoriu'),
});

type FormData = z.infer<typeof formSchema>;

// 2. Componentă form
function MyForm({ onSubmit, defaultValues }: FormProps) {
  const form = useForm<FormData>({
    resolver: zodResolver(formSchema),
    defaultValues,
  });

  const handleSubmit = form.handleSubmit(async (data) => {
    try {
      await onSubmit(data);
    } catch (error) {
      // Handle error
    }
  });

  return (
    <Form {...form}>
      <form onSubmit={handleSubmit}>
        {/* Form fields */}
      </form>
    </Form>
  );
}
```

### 1.3 Form Component Wrapper

```typescript
// components/forms/Form.tsx
'use client';

import * as React from 'react';
import {
  Controller,
  FormProvider,
  useFormContext,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from 'react-hook-form';
import { cn } from '@/lib/utils';
import { Label } from '@/components/ui/label';
import { AlertCircle, HelpCircle } from 'lucide-react';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';

const Form = FormProvider;

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
> = {
  name: TName;
};

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue
);

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  );
};

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext);
  const { getFieldState, formState } = useFormContext();
  const fieldState = getFieldState(fieldContext.name, formState);

  if (!fieldContext) {
    throw new Error('useFormField should be used within <FormField>');
  }

  return {
    name: fieldContext.name,
    ...fieldState,
  };
};

interface FormItemProps extends React.HTMLAttributes<HTMLDivElement> {
  horizontal?: boolean;
}

const FormItem = React.forwardRef<HTMLDivElement, FormItemProps>(
  ({ className, horizontal, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn(
          'space-y-2',
          horizontal && 'flex items-start gap-4 space-y-0',
          className
        )}
        {...props}
      />
    );
  }
);
FormItem.displayName = 'FormItem';

interface FormLabelProps extends React.ComponentPropsWithoutRef<typeof Label> {
  required?: boolean;
  tooltip?: string;
}

const FormLabel = React.forwardRef<
  React.ElementRef<typeof Label>,
  FormLabelProps
>(({ className, required, tooltip, children, ...props }, ref) => {
  const { error } = useFormField();

  return (
    <div className="flex items-center gap-1.5">
      <Label
        ref={ref}
        className={cn(error && 'text-destructive', className)}
        {...props}
      >
        {children}
        {required && <span className="text-destructive ml-0.5">*</span>}
      </Label>
      {tooltip && (
        <TooltipProvider>
          <Tooltip>
            <TooltipTrigger asChild>
              <HelpCircle className="h-3.5 w-3.5 text-muted-foreground cursor-help" />
            </TooltipTrigger>
            <TooltipContent>
              <p className="max-w-xs">{tooltip}</p>
            </TooltipContent>
          </Tooltip>
        </TooltipProvider>
      )}
    </div>
  );
});
FormLabel.displayName = 'FormLabel';

const FormControl = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ ...props }, ref) => {
  const { error } = useFormField();

  return (
    <div
      ref={ref}
      aria-invalid={!!error}
      {...props}
    />
  );
});
FormControl.displayName = 'FormControl';

const FormDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => {
  return (
    <p
      ref={ref}
      className={cn('text-sm text-muted-foreground', className)}
      {...props}
    />
  );
});
FormDescription.displayName = 'FormDescription';

const FormMessage = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, children, ...props }, ref) => {
  const { error } = useFormField();
  const body = error ? String(error?.message) : children;

  if (!body) {
    return null;
  }

  return (
    <p
      ref={ref}
      className={cn(
        'text-sm font-medium text-destructive flex items-center gap-1',
        className
      )}
      {...props}
    >
      <AlertCircle className="h-3.5 w-3.5" />
      {body}
    </p>
  );
});
FormMessage.displayName = 'FormMessage';

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
};
```

---

## 2. Form Validation Schemas (Zod)

### 2.1 Common Schemas

```typescript
// schemas/common.ts
import { z } from 'zod';

// Romanian CUI validation
export const cuiSchema = z
  .string()
  .transform(val => val.replace(/\s/g, '').toUpperCase())
  .refine(val => /^(RO)?[0-9]{2,10}$/.test(val), {
    message: 'CUI invalid. Format: RO12345678 sau 12345678',
  });

// Romanian phone validation
export const phoneSchema = z
  .string()
  .transform(val => val.replace(/[\s\-\.]/g, ''))
  .refine(val => /^(\+40|0040|0)?[0-9]{9}$/.test(val), {
    message: 'Număr de telefon invalid. Format: +40712345678',
  });

// Email validation
export const emailSchema = z
  .string()
  .min(1, 'Email obligatoriu')
  .email('Email invalid');

// Price validation (positive number)
export const priceSchema = z
  .number({ invalid_type_error: 'Preț invalid' })
  .positive('Prețul trebuie să fie pozitiv')
  .multipleOf(0.01, 'Maximum 2 zecimale');

// Percentage validation (0-100)
export const percentSchema = z
  .number({ invalid_type_error: 'Procentaj invalid' })
  .min(0, 'Minimum 0%')
  .max(100, 'Maximum 100%');

// Quantity validation (positive integer)
export const quantitySchema = z
  .number({ invalid_type_error: 'Cantitate invalidă' })
  .int('Cantitatea trebuie să fie număr întreg')
  .positive('Cantitatea trebuie să fie pozitivă');

// SKU validation
export const skuSchema = z
  .string()
  .min(3, 'SKU prea scurt')
  .max(50, 'SKU prea lung')
  .regex(/^[A-Z0-9\-_]+$/i, 'SKU poate conține doar litere, cifre, - și _');

// Date range validation
export const dateRangeSchema = z.object({
  from: z.date({ required_error: 'Data început obligatorie' }),
  to: z.date({ required_error: 'Data sfârșit obligatorie' }),
}).refine(data => data.from <= data.to, {
  message: 'Data început trebuie să fie înainte de data sfârșit',
  path: ['to'],
});

// Currency code
export const currencySchema = z.enum(['RON', 'EUR', 'USD'], {
  required_error: 'Monedă obligatorie',
});

// VAT rate
export const vatRateSchema = z.enum(['0', '5', '9', '19'], {
  required_error: 'Cotă TVA obligatorie',
});
```

### 2.2 Negotiation Schemas

```typescript
// schemas/negotiations.ts
import { z } from 'zod';
import { cuiSchema, emailSchema, phoneSchema, priceSchema, quantitySchema } from './common';

// Cart item schema
export const cartItemSchema = z.object({
  sku: z.string().min(1, 'SKU obligatoriu'),
  productId: z.string().uuid(),
  quantity: quantitySchema,
  unitPrice: priceSchema,
  discount: z.number().min(0).max(100).default(0),
  notes: z.string().max(500).optional(),
});

// Client data schema for negotiation
export const clientDataSchema = z.object({
  cui: cuiSchema,
  companyName: z.string().min(2, 'Nume companie obligatoriu'),
  email: emailSchema,
  phone: phoneSchema,
  contactPerson: z.string().min(2, 'Persoană contact obligatorie'),
  address: z.object({
    street: z.string().min(3, 'Strada obligatorie'),
    city: z.string().min(2, 'Oraș obligatoriu'),
    county: z.string().min(2, 'Județ obligatoriu'),
    postalCode: z.string().regex(/^[0-9]{6}$/, 'Cod poștal invalid (6 cifre)'),
    country: z.string().default('România'),
  }),
  vatPayer: z.boolean().default(false),
  splitVat: z.boolean().default(false),
});

// Negotiation create schema
export const negotiationCreateSchema = z.object({
  leadId: z.string().uuid('Lead ID invalid'),
  channel: z.enum(['whatsapp', 'email'], {
    required_error: 'Canal obligatoriu',
  }),
  initialMessage: z.string().min(10, 'Mesajul inițial trebuie să aibă minim 10 caractere').optional(),
  assignToHuman: z.boolean().default(false),
  tags: z.array(z.string()).default([]),
});

// Negotiation update schema
export const negotiationUpdateSchema = z.object({
  state: z.enum([
    'DISCOVERY', 'PROPOSAL', 'NEGOTIATION', 'CLOSING',
    'PROFORMA_SENT', 'PROFORMA_ACCEPTED', 'INVOICED',
    'EINVOICE_PENDING', 'EINVOICE_SENT', 'PAID', 'COMPLETED',
    'DEAD', 'ON_HOLD'
  ]).optional(),
  assignedToHuman: z.boolean().optional(),
  assignedUserId: z.string().uuid().optional(),
  notes: z.string().max(2000).optional(),
  nextFollowUp: z.date().optional(),
});

// State transition schema
export const stateTransitionSchema = z.object({
  negotiationId: z.string().uuid(),
  newState: z.string(),
  reason: z.string().min(5, 'Motivul tranziției obligatoriu').max(500),
  force: z.boolean().default(false),
});
```

### 2.3 Product Schemas

```typescript
// schemas/products.ts
import { z } from 'zod';
import { skuSchema, priceSchema, currencySchema, vatRateSchema, quantitySchema } from './common';

// Product create/edit schema
export const productSchema = z.object({
  sku: skuSchema,
  title: z.string().min(3, 'Titlu prea scurt').max(200, 'Titlu prea lung'),
  description: z.string().max(5000, 'Descriere prea lungă').optional(),
  shortDescription: z.string().max(500).optional(),
  
  // Pricing
  priceNet: priceSchema,
  currency: currencySchema,
  vatRate: vatRateSchema,
  
  // Stock
  inStock: z.boolean().default(true),
  stockQuantity: quantitySchema.optional(),
  stockUnit: z.string().default('buc'),
  minOrderQuantity: z.number().int().min(1).default(1),
  
  // Categories
  categoryId: z.string().uuid().optional(),
  tags: z.array(z.string()).default([]),
  
  // Attributes
  attributes: z.array(z.object({
    name: z.string().min(1),
    value: z.string().min(1),
    unit: z.string().optional(),
  })).default([]),
  
  // Media
  images: z.array(z.object({
    url: z.string().url(),
    alt: z.string().optional(),
    isPrimary: z.boolean().default(false),
  })).default([]),
  
  // Status
  active: z.boolean().default(true),
  publishedAt: z.date().optional(),
});

export type ProductFormData = z.infer<typeof productSchema>;

// Product import schema (CSV/Excel)
export const productImportSchema = z.object({
  file: z.instanceof(File).refine(
    file => ['text/csv', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'].includes(file.type),
    'Fișier invalid. Acceptăm doar CSV sau Excel.'
  ),
  updateExisting: z.boolean().default(true),
  createNew: z.boolean().default(true),
  skipErrors: z.boolean().default(false),
});

// Product search/filter schema
export const productFilterSchema = z.object({
  search: z.string().optional(),
  categoryId: z.string().uuid().optional(),
  inStock: z.boolean().optional(),
  priceMin: z.number().min(0).optional(),
  priceMax: z.number().min(0).optional(),
  tags: z.array(z.string()).optional(),
  active: z.boolean().optional(),
});
```

### 2.4 Pricing & Discount Schemas

```typescript
// schemas/pricing.ts
import { z } from 'zod';
import { percentSchema, priceSchema } from './common';

// Discount rule schema
export const discountRuleSchema = z.object({
  name: z.string().min(2, 'Nume obligatoriu').max(100),
  description: z.string().max(500).optional(),
  
  // Type
  type: z.enum(['percentage', 'fixed', 'tiered']),
  
  // Value
  value: z.number().min(0).when(
    (_, ctx) => ctx.parent?.type === 'percentage' ? percentSchema : priceSchema
  ),
  
  // Conditions
  conditions: z.array(z.object({
    field: z.enum(['quantity', 'total', 'category', 'sku', 'client_type']),
    operator: z.enum(['eq', 'neq', 'gt', 'gte', 'lt', 'lte', 'in', 'not_in']),
    value: z.union([z.string(), z.number(), z.array(z.string())]),
  })).default([]),
  
  // Tiered pricing (for tiered type)
  tiers: z.array(z.object({
    minQuantity: z.number().int().min(1),
    maxQuantity: z.number().int().nullable(),
    discount: percentSchema,
  })).optional(),
  
  // Validity
  validFrom: z.date().optional(),
  validTo: z.date().optional(),
  maxUses: z.number().int().min(1).optional(),
  
  // Approval
  requiresApproval: z.boolean().default(false),
  approvalThreshold: percentSchema.optional(),
  
  // Status
  active: z.boolean().default(true),
  priority: z.number().int().min(0).max(100).default(50),
});

export type DiscountRuleFormData = z.infer<typeof discountRuleSchema>;

// Manual discount request schema
export const manualDiscountSchema = z.object({
  negotiationId: z.string().uuid(),
  productSku: z.string().optional(),
  discountType: z.enum(['percentage', 'fixed']),
  discountValue: z.number().min(0),
  reason: z.string().min(10, 'Motivul discount-ului obligatoriu').max(500),
  validUntil: z.date().optional(),
});

// Price override schema
export const priceOverrideSchema = z.object({
  negotiationId: z.string().uuid(),
  productSku: z.string(),
  originalPrice: priceSchema,
  newPrice: priceSchema,
  reason: z.string().min(10).max(500),
}).refine(data => data.newPrice < data.originalPrice, {
  message: 'Prețul nou trebuie să fie mai mic decât cel original',
  path: ['newPrice'],
});
```

---

## 3. Negocieri Forms

### 3.1 NegotiationCreateDialog

Dialog pentru crearea unei noi negocieri.

```typescript
// components/negotiations/NegotiationCreateDialog.tsx
'use client';

import React, { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Switch } from '@/components/ui/switch';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Form,
  FormField,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
} from '@/components/ui/form';
import { negotiationCreateSchema } from '@/schemas/negotiations';
import { MessageCircle, Mail, Plus, Loader2 } from 'lucide-react';
import { toast } from 'sonner';
import { z } from 'zod';

type FormData = z.infer<typeof negotiationCreateSchema>;

interface NegotiationCreateDialogProps {
  leadId: string;
  leadName: string;
  trigger?: React.ReactNode;
  onSuccess?: (negotiationId: string) => void;
}

export function NegotiationCreateDialog({
  leadId,
  leadName,
  trigger,
  onSuccess,
}: NegotiationCreateDialogProps) {
  const [open, setOpen] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);

  const form = useForm<FormData>({
    resolver: zodResolver(negotiationCreateSchema),
    defaultValues: {
      leadId,
      channel: 'whatsapp',
      assignToHuman: false,
      tags: [],
    },
  });

  const handleSubmit = form.handleSubmit(async (data) => {
    setIsSubmitting(true);
    try {
      const response = await fetch('/api/v1/negotiations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Eroare la crearea negocierii');
      }

      const result = await response.json();
      
      toast.success('Negociere creată cu succes', {
        description: `ID: ${result.id}`,
      });
      
      setOpen(false);
      form.reset();
      onSuccess?.(result.id);
    } catch (error) {
      toast.error('Eroare', {
        description: error instanceof Error ? error.message : 'Eroare necunoscută',
      });
    } finally {
      setIsSubmitting(false);
    }
  });

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        {trigger || (
          <Button>
            <Plus className="h-4 w-4 mr-2" />
            Negociere Nouă
          </Button>
        )}
      </DialogTrigger>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle>Creează Negociere Nouă</DialogTitle>
          <DialogDescription>
            Inițiază o negociere cu {leadName}
          </DialogDescription>
        </DialogHeader>

        <Form {...form}>
          <form onSubmit={handleSubmit} className="space-y-4">
            <FormField
              control={form.control}
              name="channel"
              render={({ field }) => (
                <FormItem>
                  <FormLabel required>Canal de Comunicare</FormLabel>
                  <Select
                    onValueChange={field.onChange}
                    defaultValue={field.value}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Selectează canal" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="whatsapp">
                        <div className="flex items-center gap-2">
                          <MessageCircle className="h-4 w-4 text-green-600" />
                          WhatsApp
                        </div>
                      </SelectItem>
                      <SelectItem value="email">
                        <div className="flex items-center gap-2">
                          <Mail className="h-4 w-4 text-blue-600" />
                          Email
                        </div>
                      </SelectItem>
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="initialMessage"
              render={({ field }) => (
                <FormItem>
                  <FormLabel tooltip="Mesajul va fi trimis automat de AI dacă nu preluați manual">
                    Mesaj Inițial (opțional)
                  </FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="Lăsați gol pentru mesaj generat de AI..."
                      className="resize-none"
                      rows={4}
                      {...field}
                    />
                  </FormControl>
                  <FormDescription>
                    Dacă nu completați, AI va genera un mesaj personalizat.
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="assignToHuman"
              render={({ field }) => (
                <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                  <div className="space-y-0.5">
                    <FormLabel className="text-base">
                      Preluare Manuală
                    </FormLabel>
                    <FormDescription>
                      Dezactivează AI și gestionează negocierea manual
                    </FormDescription>
                  </div>
                  <FormControl>
                    <Switch
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                </FormItem>
              )}
            />

            <DialogFooter>
              <Button
                type="button"
                variant="outline"
                onClick={() => setOpen(false)}
                disabled={isSubmitting}
              >
                Anulează
              </Button>
              <Button type="submit" disabled={isSubmitting}>
                {isSubmitting ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Se creează...
                  </>
                ) : (
                  'Creează Negociere'
                )}
              </Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```

### 3.2 StateTransitionDialog

Dialog pentru tranziția de stare a negocierii.

```typescript
// components/negotiations/StateTransitionDialog.tsx
'use client';

import React, { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Checkbox } from '@/components/ui/checkbox';
import {
  Form,
  FormField,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
} from '@/components/ui/form';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { stateTransitionSchema } from '@/schemas/negotiations';
import { AlertTriangle, ArrowRight, Loader2 } from 'lucide-react';
import { toast } from 'sonner';
import { z } from 'zod';

type FormData = z.infer<typeof stateTransitionSchema>;

// State configurations
const stateConfig: Record<string, {
  label: string;
  color: string;
  allowedActions: string[];
}> = {
  DISCOVERY: { label: 'Descoperire', color: 'bg-blue-100', allowedActions: ['search_products'] },
  PROPOSAL: { label: 'Propunere', color: 'bg-indigo-100', allowedActions: ['search_products', 'check_stock'] },
  NEGOTIATION: { label: 'Negociere', color: 'bg-purple-100', allowedActions: ['calculate_discount', 'update_cart'] },
  CLOSING: { label: 'Închidere', color: 'bg-amber-100', allowedActions: ['create_proforma'] },
  PROFORMA_SENT: { label: 'Proforma Trimisă', color: 'bg-orange-100', allowedActions: [] },
  PROFORMA_ACCEPTED: { label: 'Proforma Acceptată', color: 'bg-green-100', allowedActions: ['convert_to_invoice'] },
  INVOICED: { label: 'Facturată', color: 'bg-emerald-100', allowedActions: ['send_einvoice'] },
  PAID: { label: 'Plătită', color: 'bg-teal-100', allowedActions: [] },
  COMPLETED: { label: 'Finalizată', color: 'bg-gray-100', allowedActions: [] },
  DEAD: { label: 'Pierdută', color: 'bg-red-100', allowedActions: [] },
  ON_HOLD: { label: 'În Așteptare', color: 'bg-yellow-100', allowedActions: [] },
};

// Valid transitions
const validTransitions: Record<string, string[]> = {
  DISCOVERY: ['PROPOSAL', 'DEAD', 'ON_HOLD'],
  PROPOSAL: ['NEGOTIATION', 'CLOSING', 'DISCOVERY', 'DEAD'],
  NEGOTIATION: ['CLOSING', 'PROPOSAL', 'DEAD', 'ON_HOLD'],
  CLOSING: ['PROFORMA_SENT', 'NEGOTIATION', 'DEAD'],
  PROFORMA_SENT: ['PROFORMA_ACCEPTED', 'NEGOTIATION', 'DEAD'],
  PROFORMA_ACCEPTED: ['INVOICED', 'DEAD'],
  INVOICED: ['EINVOICE_PENDING', 'EINVOICE_SENT'],
  EINVOICE_SENT: ['PAID', 'DEAD'],
  PAID: ['COMPLETED'],
  DEAD: ['DISCOVERY'],
  ON_HOLD: ['DISCOVERY', 'PROPOSAL', 'NEGOTIATION', 'DEAD'],
};

interface StateTransitionDialogProps {
  negotiationId: string;
  currentState: string;
  targetState: string;
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onSuccess?: () => void;
}

export function StateTransitionDialog({
  negotiationId,
  currentState,
  targetState,
  open,
  onOpenChange,
  onSuccess,
}: StateTransitionDialogProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  const isValidTransition = validTransitions[currentState]?.includes(targetState);
  const currentConfig = stateConfig[currentState];
  const targetConfig = stateConfig[targetState];

  const form = useForm<FormData>({
    resolver: zodResolver(stateTransitionSchema),
    defaultValues: {
      negotiationId,
      newState: targetState,
      reason: '',
      force: false,
    },
  });

  const handleSubmit = form.handleSubmit(async (data) => {
    setIsSubmitting(true);
    try {
      const response = await fetch(`/api/v1/negotiations/${negotiationId}/state`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Eroare la tranziția de stare');
      }

      toast.success('Stare actualizată', {
        description: `${currentConfig.label} → ${targetConfig.label}`,
      });

      onOpenChange(false);
      onSuccess?.();
    } catch (error) {
      toast.error('Eroare', {
        description: error instanceof Error ? error.message : 'Eroare necunoscută',
      });
    } finally {
      setIsSubmitting(false);
    }
  });

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[450px]">
        <DialogHeader>
          <DialogTitle>Schimbă Starea Negocierii</DialogTitle>
          <DialogDescription>
            Confirmă tranziția de stare pentru această negociere.
          </DialogDescription>
        </DialogHeader>

        {/* State Transition Visual */}
        <div className="flex items-center justify-center gap-4 py-4">
          <div className={`px-4 py-2 rounded-lg ${currentConfig.color}`}>
            <span className="font-medium">{currentConfig.label}</span>
          </div>
          <ArrowRight className="h-5 w-5 text-muted-foreground" />
          <div className={`px-4 py-2 rounded-lg ${targetConfig.color}`}>
            <span className="font-medium">{targetConfig.label}</span>
          </div>
        </div>

        {!isValidTransition && (
          <Alert variant="destructive">
            <AlertTriangle className="h-4 w-4" />
            <AlertDescription>
              Această tranziție nu este permisă normal. Folosiți opțiunea "Forțează" doar dacă este absolut necesar.
            </AlertDescription>
          </Alert>
        )}

        <Form {...form}>
          <form onSubmit={handleSubmit} className="space-y-4">
            <FormField
              control={form.control}
              name="reason"
              render={({ field }) => (
                <FormItem>
                  <FormLabel required>Motivul Tranziției</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="Explicați de ce se face această schimbare de stare..."
                      className="resize-none"
                      rows={3}
                      {...field}
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            {!isValidTransition && (
              <FormField
                control={form.control}
                name="force"
                render={({ field }) => (
                  <FormItem className="flex flex-row items-start space-x-3 space-y-0 rounded-md border border-destructive p-4">
                    <FormControl>
                      <Checkbox
                        checked={field.value}
                        onCheckedChange={field.onChange}
                      />
                    </FormControl>
                    <div className="space-y-1 leading-none">
                      <FormLabel className="text-destructive">
                        Forțează Tranziția
                      </FormLabel>
                      <FormDescription>
                        Confirm că înțeleg că aceasta este o tranziție nestandard.
                      </FormDescription>
                    </div>
                  </FormItem>
                )}
              />
            )}

            <DialogFooter>
              <Button
                type="button"
                variant="outline"
                onClick={() => onOpenChange(false)}
                disabled={isSubmitting}
              >
                Anulează
              </Button>
              <Button 
                type="submit" 
                disabled={isSubmitting || (!isValidTransition && !form.watch('force'))}
              >
                {isSubmitting ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Se procesează...
                  </>
                ) : (
                  'Confirmă Tranziția'
                )}
              </Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```

### 3.3 AssignNegotiationDialog

Dialog pentru asignarea unei negocieri către un agent uman sau AI.

```typescript
// components/negotiations/AssignNegotiationDialog.tsx
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Switch } from '@/components/ui/switch';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Badge } from '@/components/ui/badge';
import { Loader2, UserPlus, Bot, User } from 'lucide-react';
import { toast } from 'sonner';

// Schema
const assignNegotiationSchema = z.object({
  assigneeType: z.enum(['human', 'ai']),
  userId: z.string().optional(),
  reason: z.string().min(5, 'Motivul trebuie să aibă cel puțin 5 caractere').max(500),
  notifyAssignee: z.boolean().default(true),
  transferConversation: z.boolean().default(true),
});

type AssignNegotiationFormData = z.infer<typeof assignNegotiationSchema>;

interface User {
  id: string;
  name: string;
  email: string;
  avatar?: string;
  activeNegotiations: number;
  avgResponseTime: number; // minutes
  successRate: number; // percentage
}

interface AssignNegotiationDialogProps {
  negotiationId: string;
  negotiationTitle: string;
  currentAssignee?: {
    type: 'human' | 'ai';
    userId?: string;
    userName?: string;
  };
  availableUsers: User[];
  trigger?: React.ReactNode;
  onSuccess?: () => void;
}

export function AssignNegotiationDialog({
  negotiationId,
  negotiationTitle,
  currentAssignee,
  availableUsers,
  trigger,
  onSuccess,
}: AssignNegotiationDialogProps) {
  const [open, setOpen] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);

  const form = useForm<AssignNegotiationFormData>({
    resolver: zodResolver(assignNegotiationSchema),
    defaultValues: {
      assigneeType: currentAssignee?.type === 'human' ? 'ai' : 'human',
      userId: undefined,
      reason: '',
      notifyAssignee: true,
      transferConversation: true,
    },
  });

  const assigneeType = form.watch('assigneeType');

  async function handleSubmit(data: AssignNegotiationFormData) {
    setIsSubmitting(true);
    try {
      const response = await fetch(`/api/v1/negotiations/${negotiationId}/assign`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Failed to assign negotiation');
      }

      toast.success('Negocierea a fost asignată cu succes');
      setOpen(false);
      form.reset();
      onSuccess?.();
    } catch (error) {
      toast.error('Eroare la asignarea negocierii');
    } finally {
      setIsSubmitting(false);
    }
  }

  const selectedUser = availableUsers.find(u => u.id === form.watch('userId'));

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        {trigger || (
          <Button variant="outline" size="sm">
            <UserPlus className="h-4 w-4 mr-2" />
            Asignează
          </Button>
        )}
      </DialogTrigger>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle>Asignare Negociere</DialogTitle>
          <DialogDescription>
            Asignați negocierea "{negotiationTitle}" unui agent uman sau AI.
          </DialogDescription>
        </DialogHeader>

        {/* Current Assignment */}
        {currentAssignee && (
          <div className="flex items-center gap-3 p-3 bg-muted rounded-lg">
            <span className="text-sm text-muted-foreground">Asignat curent:</span>
            {currentAssignee.type === 'ai' ? (
              <Badge variant="secondary">
                <Bot className="h-3 w-3 mr-1" />
                Agent AI
              </Badge>
            ) : (
              <Badge variant="outline">
                <User className="h-3 w-3 mr-1" />
                {currentAssignee.userName}
              </Badge>
            )}
          </div>
        )}

        <Form {...form}>
          <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-4">
            {/* Assignee Type */}
            <FormField
              control={form.control}
              name="assigneeType"
              render={({ field }) => (
                <FormItem>
                  <FormLabel required>Tip Asignare</FormLabel>
                  <div className="grid grid-cols-2 gap-3">
                    <Button
                      type="button"
                      variant={field.value === 'human' ? 'default' : 'outline'}
                      className="h-20 flex flex-col gap-2"
                      onClick={() => field.onChange('human')}
                    >
                      <User className="h-6 w-6" />
                      <span>Agent Uman</span>
                    </Button>
                    <Button
                      type="button"
                      variant={field.value === 'ai' ? 'default' : 'outline'}
                      className="h-20 flex flex-col gap-2"
                      onClick={() => field.onChange('ai')}
                    >
                      <Bot className="h-6 w-6" />
                      <span>Agent AI</span>
                    </Button>
                  </div>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* User Selection (if human) */}
            {assigneeType === 'human' && (
              <FormField
                control={form.control}
                name="userId"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel required>Selectează Agent</FormLabel>
                    <Select onValueChange={field.onChange} value={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Alege un agent..." />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {availableUsers.map((user) => (
                          <SelectItem key={user.id} value={user.id}>
                            <div className="flex items-center gap-3">
                              <Avatar className="h-6 w-6">
                                <AvatarImage src={user.avatar} />
                                <AvatarFallback>
                                  {user.name.split(' ').map(n => n[0]).join('')}
                                </AvatarFallback>
                              </Avatar>
                              <div className="flex flex-col">
                                <span className="font-medium">{user.name}</span>
                                <span className="text-xs text-muted-foreground">
                                  {user.activeNegotiations} active • {user.successRate}% succes
                                </span>
                              </div>
                            </div>
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />
            )}

            {/* Selected User Stats */}
            {assigneeType === 'human' && selectedUser && (
              <div className="grid grid-cols-3 gap-2 p-3 bg-muted/50 rounded-lg text-sm">
                <div className="text-center">
                  <div className="font-semibold">{selectedUser.activeNegotiations}</div>
                  <div className="text-muted-foreground text-xs">Active</div>
                </div>
                <div className="text-center">
                  <div className="font-semibold">{selectedUser.avgResponseTime}m</div>
                  <div className="text-muted-foreground text-xs">Timp Răspuns</div>
                </div>
                <div className="text-center">
                  <div className="font-semibold">{selectedUser.successRate}%</div>
                  <div className="text-muted-foreground text-xs">Rată Succes</div>
                </div>
              </div>
            )}

            {/* Reason */}
            <FormField
              control={form.control}
              name="reason"
              render={({ field }) => (
                <FormItem>
                  <FormLabel required>Motivul Asignării</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="Explicați de ce se face această asignare..."
                      className="resize-none"
                      rows={2}
                      {...field}
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Options */}
            <div className="space-y-3">
              <FormField
                control={form.control}
                name="notifyAssignee"
                render={({ field }) => (
                  <FormItem className="flex items-center justify-between rounded-lg border p-3">
                    <div className="space-y-0.5">
                      <FormLabel>Notifică Asignat</FormLabel>
                      <FormDescription>
                        Trimite notificare despre noua asignare
                      </FormDescription>
                    </div>
                    <FormControl>
                      <Switch checked={field.value} onCheckedChange={field.onChange} />
                    </FormControl>
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="transferConversation"
                render={({ field }) => (
                  <FormItem className="flex items-center justify-between rounded-lg border p-3">
                    <div className="space-y-0.5">
                      <FormLabel>Transfer Conversație</FormLabel>
                      <FormDescription>
                        Include istoricul complet al conversației
                      </FormDescription>
                    </div>
                    <FormControl>
                      <Switch checked={field.value} onCheckedChange={field.onChange} />
                    </FormControl>
                  </FormItem>
                )}
              />
            </div>

            <DialogFooter>
              <Button
                type="button"
                variant="outline"
                onClick={() => setOpen(false)}
                disabled={isSubmitting}
              >
                Anulează
              </Button>
              <Button 
                type="submit" 
                disabled={isSubmitting || (assigneeType === 'human' && !form.watch('userId'))}
              >
                {isSubmitting ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Se procesează...
                  </>
                ) : (
                  'Asignează'
                )}
              </Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```

### 3.4 NegotiationNotesForm

Formular pentru adăugarea și editarea notelor interne ale unei negocieri.

```typescript
// components/negotiations/NegotiationNotesForm.tsx
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Badge } from '@/components/ui/badge';
import { Loader2, Send, Pin, Tag, X } from 'lucide-react';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';

// Schema
const noteSchema = z.object({
  content: z.string().min(3, 'Nota trebuie să aibă cel puțin 3 caractere').max(2000),
  isPinned: z.boolean().default(false),
  tags: z.array(z.string()).max(5, 'Maximum 5 tag-uri'),
});

type NoteFormData = z.infer<typeof noteSchema>;

const SUGGESTED_TAGS = [
  'urgent',
  'de verificat',
  'aprobat',
  'respins',
  'follow-up',
  'preț special',
  'client vechi',
  'referral',
  'escalat',
  'de discutat',
];

interface NegotiationNotesFormProps {
  negotiationId: string;
  onSuccess?: () => void;
  className?: string;
}

export function NegotiationNotesForm({
  negotiationId,
  onSuccess,
  className,
}: NegotiationNotesFormProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [tagInput, setTagInput] = useState('');

  const form = useForm<NoteFormData>({
    resolver: zodResolver(noteSchema),
    defaultValues: {
      content: '',
      isPinned: false,
      tags: [],
    },
  });

  const tags = form.watch('tags');

  const addTag = (tag: string) => {
    const normalized = tag.toLowerCase().trim();
    if (normalized && !tags.includes(normalized) && tags.length < 5) {
      form.setValue('tags', [...tags, normalized]);
      setTagInput('');
    }
  };

  const removeTag = (tagToRemove: string) => {
    form.setValue('tags', tags.filter(t => t !== tagToRemove));
  };

  async function handleSubmit(data: NoteFormData) {
    setIsSubmitting(true);
    try {
      const response = await fetch(`/api/v1/negotiations/${negotiationId}/notes`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Failed to add note');
      }

      toast.success('Nota a fost adăugată');
      form.reset();
      onSuccess?.();
    } catch (error) {
      toast.error('Eroare la adăugarea notei');
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <Form {...form}>
      <form 
        onSubmit={form.handleSubmit(handleSubmit)} 
        className={cn("space-y-3", className)}
      >
        {/* Content */}
        <FormField
          control={form.control}
          name="content"
          render={({ field }) => (
            <FormItem>
              <FormControl>
                <Textarea
                  placeholder="Adaugă o notă internă..."
                  className="resize-none min-h-[80px]"
                  {...field}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        {/* Tags */}
        <div className="space-y-2">
          {/* Current Tags */}
          {tags.length > 0 && (
            <div className="flex flex-wrap gap-1">
              {tags.map((tag) => (
                <Badge key={tag} variant="secondary" className="gap-1">
                  {tag}
                  <button
                    type="button"
                    onClick={() => removeTag(tag)}
                    className="hover:text-destructive"
                  >
                    <X className="h-3 w-3" />
                  </button>
                </Badge>
              ))}
            </div>
          )}

          {/* Tag Input */}
          <div className="flex gap-2">
            <input
              type="text"
              value={tagInput}
              onChange={(e) => setTagInput(e.target.value)}
              onKeyDown={(e) => {
                if (e.key === 'Enter') {
                  e.preventDefault();
                  addTag(tagInput);
                }
              }}
              placeholder="Adaugă tag..."
              className="flex-1 h-8 px-2 text-sm rounded-md border bg-background"
            />
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={() => addTag(tagInput)}
              disabled={!tagInput.trim() || tags.length >= 5}
            >
              <Tag className="h-3 w-3" />
            </Button>
          </div>

          {/* Suggested Tags */}
          <div className="flex flex-wrap gap-1">
            {SUGGESTED_TAGS.filter(t => !tags.includes(t)).slice(0, 6).map((tag) => (
              <button
                key={tag}
                type="button"
                onClick={() => addTag(tag)}
                className="text-xs px-2 py-0.5 rounded-full bg-muted hover:bg-muted/80 text-muted-foreground"
              >
                + {tag}
              </button>
            ))}
          </div>
        </div>

        {/* Actions */}
        <div className="flex items-center justify-between">
          <FormField
            control={form.control}
            name="isPinned"
            render={({ field }) => (
              <Button
                type="button"
                variant={field.value ? 'default' : 'ghost'}
                size="sm"
                onClick={() => field.onChange(!field.value)}
              >
                <Pin className={cn("h-4 w-4 mr-1", field.value && "fill-current")} />
                {field.value ? 'Fixată' : 'Fixează'}
              </Button>
            )}
          />

          <Button type="submit" size="sm" disabled={isSubmitting}>
            {isSubmitting ? (
              <Loader2 className="h-4 w-4 animate-spin" />
            ) : (
              <>
                <Send className="h-4 w-4 mr-1" />
                Adaugă
              </>
            )}
          </Button>
        </div>
      </form>
    </Form>
  );
}
```

### 3.5 FollowUpScheduleDialog

Dialog pentru programarea unui follow-up automat.

```typescript
// components/negotiations/FollowUpScheduleDialog.tsx
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { format, addDays, addHours, setHours, setMinutes } from 'date-fns';
import { ro } from 'date-fns/locale';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Calendar } from '@/components/ui/calendar';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { Loader2, CalendarIcon, Clock, Bell } from 'lucide-react';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';

// Schema
const followUpSchema = z.object({
  scheduledAt: z.date({
    required_error: 'Selectați data și ora',
  }).refine(
    (date) => date > new Date(),
    'Data trebuie să fie în viitor'
  ),
  type: z.enum(['email', 'whatsapp', 'phone_call', 'internal_reminder']),
  message: z.string().min(10, 'Mesajul trebuie să aibă cel puțin 10 caractere').max(1000),
  autoSend: z.boolean().default(false),
});

type FollowUpFormData = z.infer<typeof followUpSchema>;

const FOLLOW_UP_TYPES = [
  { value: 'email', label: 'Email', icon: '📧' },
  { value: 'whatsapp', label: 'WhatsApp', icon: '💬' },
  { value: 'phone_call', label: 'Apel Telefonic', icon: '📞' },
  { value: 'internal_reminder', label: 'Reminder Intern', icon: '🔔' },
];

const QUICK_DATES = [
  { label: 'Peste 1 oră', getValue: () => addHours(new Date(), 1) },
  { label: 'Mâine dimineață', getValue: () => setHours(setMinutes(addDays(new Date(), 1), 0), 9) },
  { label: 'Mâine după-amiază', getValue: () => setHours(setMinutes(addDays(new Date(), 1), 0), 14) },
  { label: 'Peste 3 zile', getValue: () => addDays(new Date(), 3) },
  { label: 'Săptămâna viitoare', getValue: () => addDays(new Date(), 7) },
];

interface FollowUpScheduleDialogProps {
  negotiationId: string;
  clientName: string;
  defaultChannel?: 'email' | 'whatsapp';
  trigger?: React.ReactNode;
  onSuccess?: () => void;
}

export function FollowUpScheduleDialog({
  negotiationId,
  clientName,
  defaultChannel = 'email',
  trigger,
  onSuccess,
}: FollowUpScheduleDialogProps) {
  const [open, setOpen] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);

  const form = useForm<FollowUpFormData>({
    resolver: zodResolver(followUpSchema),
    defaultValues: {
      scheduledAt: undefined,
      type: defaultChannel,
      message: '',
      autoSend: false,
    },
  });

  async function handleSubmit(data: FollowUpFormData) {
    setIsSubmitting(true);
    try {
      const response = await fetch(`/api/v1/negotiations/${negotiationId}/follow-ups`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...data,
          scheduledAt: data.scheduledAt.toISOString(),
        }),
      });

      if (!response.ok) {
        throw new Error('Failed to schedule follow-up');
      }

      toast.success('Follow-up programat cu succes');
      setOpen(false);
      form.reset();
      onSuccess?.();
    } catch (error) {
      toast.error('Eroare la programarea follow-up-ului');
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        {trigger || (
          <Button variant="outline" size="sm">
            <Bell className="h-4 w-4 mr-2" />
            Programează Follow-up
          </Button>
        )}
      </DialogTrigger>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle>Programează Follow-up</DialogTitle>
          <DialogDescription>
            Programați un follow-up automat pentru {clientName}.
          </DialogDescription>
        </DialogHeader>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-4">
            {/* Quick Date Selection */}
            <div className="space-y-2">
              <FormLabel>Selectare Rapidă</FormLabel>
              <div className="flex flex-wrap gap-2">
                {QUICK_DATES.map((option) => (
                  <Button
                    key={option.label}
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => form.setValue('scheduledAt', option.getValue())}
                  >
                    {option.label}
                  </Button>
                ))}
              </div>
            </div>

            {/* Date & Time Picker */}
            <FormField
              control={form.control}
              name="scheduledAt"
              render={({ field }) => (
                <FormItem className="flex flex-col">
                  <FormLabel required>Data și Ora</FormLabel>
                  <div className="flex gap-2">
                    <Popover>
                      <PopoverTrigger asChild>
                        <FormControl>
                          <Button
                            variant="outline"
                            className={cn(
                              "flex-1 pl-3 text-left font-normal",
                              !field.value && "text-muted-foreground"
                            )}
                          >
                            {field.value ? (
                              format(field.value, "PPP HH:mm", { locale: ro })
                            ) : (
                              <span>Selectează data</span>
                            )}
                            <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                          </Button>
                        </FormControl>
                      </PopoverTrigger>
                      <PopoverContent className="w-auto p-0" align="start">
                        <Calendar
                          mode="single"
                          selected={field.value}
                          onSelect={(date) => {
                            if (date) {
                              // Keep existing time or default to 9:00
                              const newDate = field.value 
                                ? setHours(setMinutes(date, field.value.getMinutes()), field.value.getHours())
                                : setHours(setMinutes(date, 0), 9);
                              field.onChange(newDate);
                            }
                          }}
                          disabled={(date) => date < new Date()}
                          initialFocus
                          locale={ro}
                        />
                      </PopoverContent>
                    </Popover>

                    {/* Time Selection */}
                    <Select
                      value={field.value ? format(field.value, 'HH:mm') : undefined}
                      onValueChange={(time) => {
                        const [hours, minutes] = time.split(':').map(Number);
                        const date = field.value || new Date();
                        field.onChange(setHours(setMinutes(date, minutes), hours));
                      }}
                    >
                      <SelectTrigger className="w-[120px]">
                        <Clock className="h-4 w-4 mr-2" />
                        <SelectValue placeholder="Ora" />
                      </SelectTrigger>
                      <SelectContent>
                        {Array.from({ length: 12 }, (_, i) => i + 8).map((hour) => (
                          <>
                            <SelectItem key={`${hour}:00`} value={`${hour.toString().padStart(2, '0')}:00`}>
                              {hour.toString().padStart(2, '0')}:00
                            </SelectItem>
                            <SelectItem key={`${hour}:30`} value={`${hour.toString().padStart(2, '0')}:30`}>
                              {hour.toString().padStart(2, '0')}:30
                            </SelectItem>
                          </>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Type */}
            <FormField
              control={form.control}
              name="type"
              render={({ field }) => (
                <FormItem>
                  <FormLabel required>Tip Follow-up</FormLabel>
                  <Select onValueChange={field.onChange} value={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {FOLLOW_UP_TYPES.map((type) => (
                        <SelectItem key={type.value} value={type.value}>
                          <span className="flex items-center gap-2">
                            <span>{type.icon}</span>
                            <span>{type.label}</span>
                          </span>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Message */}
            <FormField
              control={form.control}
              name="message"
              render={({ field }) => (
                <FormItem>
                  <FormLabel required>Mesaj</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="Scrieți mesajul pentru follow-up..."
                      className="resize-none"
                      rows={3}
                      {...field}
                    />
                  </FormControl>
                  <FormDescription>
                    Acest mesaj va fi trimis automat la data și ora selectată.
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Auto Send Option */}
            {form.watch('type') !== 'internal_reminder' && (
              <FormField
                control={form.control}
                name="autoSend"
                render={({ field }) => (
                  <FormItem className="flex items-center justify-between rounded-lg border p-3">
                    <div className="space-y-0.5">
                      <FormLabel>Trimitere Automată</FormLabel>
                      <FormDescription>
                        Trimite mesajul automat fără aprobare
                      </FormDescription>
                    </div>
                    <FormControl>
                      <input
                        type="checkbox"
                        checked={field.value}
                        onChange={field.onChange}
                        className="h-4 w-4"
                      />
                    </FormControl>
                  </FormItem>
                )}
              />
            )}

            <DialogFooter>
              <Button
                type="button"
                variant="outline"
                onClick={() => setOpen(false)}
                disabled={isSubmitting}
              >
                Anulează
              </Button>
              <Button type="submit" disabled={isSubmitting}>
                {isSubmitting ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Se programează...
                  </>
                ) : (
                  <>
                    <Bell className="h-4 w-4 mr-2" />
                    Programează
                  </>
                )}
              </Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```

---

## 4. Produse Forms

### 4.1 ProductForm

Formular complet pentru crearea și editarea produselor.

```typescript
// components/products/ProductForm.tsx
import { useState, useCallback } from 'react';
import { useForm, useFieldArray } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Tabs,
  TabsContent,
  TabsList,
  TabsTrigger,
} from '@/components/ui/tabs';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Switch } from '@/components/ui/switch';
import { Badge } from '@/components/ui/badge';
import { 
  Loader2, 
  Plus, 
  Trash2, 
  Upload, 
  Image as ImageIcon,
  GripVertical,
  X 
} from 'lucide-react';
import { toast } from 'sonner';
import { DndContext, closestCenter, DragEndEvent } from '@dnd-kit/core';
import { SortableContext, verticalListSortingStrategy, useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

// Schema
const productSchema = z.object({
  sku: z.string()
    .min(3, 'SKU trebuie să aibă cel puțin 3 caractere')
    .max(50)
    .regex(/^[A-Za-z0-9\-_]+$/, 'SKU poate conține doar litere, cifre, - și _'),
  title: z.string().min(5, 'Titlul trebuie să aibă cel puțin 5 caractere').max(200),
  description: z.string().max(5000).optional(),
  shortDescription: z.string().max(300).optional(),
  priceNet: z.number().positive('Prețul trebuie să fie pozitiv').multipleOf(0.01),
  currency: z.enum(['RON', 'EUR', 'USD']).default('RON'),
  vatRate: z.enum(['0', '5', '9', '19']).default('19'),
  inStock: z.boolean().default(true),
  stockQuantity: z.number().int().min(0).optional(),
  stockUnit: z.string().max(20).default('buc'),
  minOrderQuantity: z.number().int().min(1).default(1),
  categoryId: z.string().uuid().optional(),
  tags: z.array(z.string().max(50)).max(10),
  attributes: z.array(z.object({
    name: z.string().min(1).max(50),
    value: z.string().min(1).max(200),
    unit: z.string().max(20).optional(),
  })).max(30),
  images: z.array(z.object({
    url: z.string().url(),
    alt: z.string().max(200).optional(),
    isPrimary: z.boolean().default(false),
  })).max(10),
  active: z.boolean().default(true),
  publishedAt: z.date().optional(),
});

type ProductFormData = z.infer<typeof productSchema>;

interface Category {
  id: string;
  name: string;
  parentId?: string;
}

interface ProductFormProps {
  product?: Partial<ProductFormData> & { id?: string };
  categories: Category[];
  onSuccess?: () => void;
  onCancel?: () => void;
}

// Sortable Image Component
function SortableImage({ 
  id, 
  url, 
  alt, 
  isPrimary, 
  onRemove, 
  onSetPrimary,
  onUpdateAlt,
}: {
  id: string;
  url: string;
  alt?: string;
  isPrimary: boolean;
  onRemove: () => void;
  onSetPrimary: () => void;
  onUpdateAlt: (alt: string) => void;
}) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      className="relative group flex items-center gap-3 p-2 border rounded-lg bg-background"
    >
      <button
        type="button"
        className="cursor-grab touch-none"
        {...attributes}
        {...listeners}
      >
        <GripVertical className="h-4 w-4 text-muted-foreground" />
      </button>

      <img
        src={url}
        alt={alt || 'Product image'}
        className="w-16 h-16 object-cover rounded"
      />

      <div className="flex-1 space-y-1">
        <Input
          placeholder="Alt text..."
          value={alt || ''}
          onChange={(e) => onUpdateAlt(e.target.value)}
          className="h-8 text-sm"
        />
        {isPrimary && (
          <Badge variant="secondary" className="text-xs">Principală</Badge>
        )}
      </div>

      <div className="flex items-center gap-1">
        {!isPrimary && (
          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={onSetPrimary}
          >
            <ImageIcon className="h-4 w-4" />
          </Button>
        )}
        <Button
          type="button"
          variant="ghost"
          size="sm"
          onClick={onRemove}
          className="text-destructive hover:text-destructive"
        >
          <Trash2 className="h-4 w-4" />
        </Button>
      </div>
    </div>
  );
}

export function ProductForm({
  product,
  categories,
  onSuccess,
  onCancel,
}: ProductFormProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [tagInput, setTagInput] = useState('');
  const isEditing = !!product?.id;

  const form = useForm<ProductFormData>({
    resolver: zodResolver(productSchema),
    defaultValues: {
      sku: product?.sku || '',
      title: product?.title || '',
      description: product?.description || '',
      shortDescription: product?.shortDescription || '',
      priceNet: product?.priceNet || 0,
      currency: product?.currency || 'RON',
      vatRate: product?.vatRate || '19',
      inStock: product?.inStock ?? true,
      stockQuantity: product?.stockQuantity,
      stockUnit: product?.stockUnit || 'buc',
      minOrderQuantity: product?.minOrderQuantity || 1,
      categoryId: product?.categoryId,
      tags: product?.tags || [],
      attributes: product?.attributes || [],
      images: product?.images || [],
      active: product?.active ?? true,
      publishedAt: product?.publishedAt,
    },
  });

  const { fields: attributeFields, append: appendAttribute, remove: removeAttribute } = 
    useFieldArray({ control: form.control, name: 'attributes' });

  const { fields: imageFields, append: appendImage, remove: removeImage, move: moveImage, update: updateImage } = 
    useFieldArray({ control: form.control, name: 'images' });

  const tags = form.watch('tags');
  const images = form.watch('images');

  const addTag = useCallback((tag: string) => {
    const normalized = tag.toLowerCase().trim();
    if (normalized && !tags.includes(normalized) && tags.length < 10) {
      form.setValue('tags', [...tags, normalized]);
      setTagInput('');
    }
  }, [tags, form]);

  const removeTag = useCallback((tagToRemove: string) => {
    form.setValue('tags', tags.filter(t => t !== tagToRemove));
  }, [tags, form]);

  const handleImageUpload = useCallback(async (files: FileList) => {
    // In real implementation, upload to storage and get URLs
    for (const file of Array.from(files)) {
      if (imageFields.length >= 10) break;
      
      // Simulate upload
      const url = URL.createObjectURL(file);
      appendImage({
        url,
        alt: file.name.replace(/\.[^/.]+$/, ''),
        isPrimary: imageFields.length === 0,
      });
    }
  }, [imageFields.length, appendImage]);

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event;
    if (over && active.id !== over.id) {
      const oldIndex = imageFields.findIndex((img, i) => `image-${i}` === active.id);
      const newIndex = imageFields.findIndex((img, i) => `image-${i}` === over.id);
      moveImage(oldIndex, newIndex);
    }
  };

  const setImagePrimary = (index: number) => {
    images.forEach((img, i) => {
      updateImage(i, { ...img, isPrimary: i === index });
    });
  };

  async function handleSubmit(data: ProductFormData) {
    setIsSubmitting(true);
    try {
      const endpoint = isEditing 
        ? `/api/v1/products/${product.id}`
        : '/api/v1/products';
      
      const response = await fetch(endpoint, {
        method: isEditing ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Failed to save product');
      }

      toast.success(isEditing ? 'Produsul a fost actualizat' : 'Produsul a fost creat');
      onSuccess?.();
    } catch (error) {
      toast.error('Eroare la salvarea produsului');
    } finally {
      setIsSubmitting(false);
    }
  }

  // Calculate price with VAT
  const priceNet = form.watch('priceNet');
  const vatRate = form.watch('vatRate');
  const priceGross = priceNet * (1 + Number(vatRate) / 100);

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-6">
        <Tabs defaultValue="general" className="w-full">
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="general">General</TabsTrigger>
            <TabsTrigger value="pricing">Prețuri</TabsTrigger>
            <TabsTrigger value="attributes">Atribute</TabsTrigger>
            <TabsTrigger value="images">Imagini</TabsTrigger>
          </TabsList>

          {/* General Tab */}
          <TabsContent value="general" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Informații Generale</CardTitle>
                <CardDescription>
                  Detaliile de bază ale produsului
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  {/* SKU */}
                  <FormField
                    control={form.control}
                    name="sku"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel required>SKU</FormLabel>
                        <FormControl>
                          <Input placeholder="PRD-001" {...field} />
                        </FormControl>
                        <FormDescription>
                          Cod unic de identificare
                        </FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  {/* Category */}
                  <FormField
                    control={form.control}
                    name="categoryId"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Categorie</FormLabel>
                        <Select onValueChange={field.onChange} value={field.value}>
                          <FormControl>
                            <SelectTrigger>
                              <SelectValue placeholder="Selectează categoria" />
                            </SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            {categories.map((cat) => (
                              <SelectItem key={cat.id} value={cat.id}>
                                {cat.name}
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                {/* Title */}
                <FormField
                  control={form.control}
                  name="title"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel required>Titlu Produs</FormLabel>
                      <FormControl>
                        <Input placeholder="Denumirea completă a produsului" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                {/* Short Description */}
                <FormField
                  control={form.control}
                  name="shortDescription"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Descriere Scurtă</FormLabel>
                      <FormControl>
                        <Textarea
                          placeholder="Descriere scurtă pentru listări..."
                          className="resize-none"
                          rows={2}
                          {...field}
                        />
                      </FormControl>
                      <FormDescription>
                        Maximum 300 caractere
                      </FormDescription>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                {/* Full Description */}
                <FormField
                  control={form.control}
                  name="description"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Descriere Completă</FormLabel>
                      <FormControl>
                        <Textarea
                          placeholder="Descrierea detaliată a produsului..."
                          className="resize-none"
                          rows={5}
                          {...field}
                        />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                {/* Tags */}
                <FormItem>
                  <FormLabel>Tag-uri</FormLabel>
                  <div className="space-y-2">
                    {tags.length > 0 && (
                      <div className="flex flex-wrap gap-1">
                        {tags.map((tag) => (
                          <Badge key={tag} variant="secondary" className="gap-1">
                            {tag}
                            <button type="button" onClick={() => removeTag(tag)}>
                              <X className="h-3 w-3" />
                            </button>
                          </Badge>
                        ))}
                      </div>
                    )}
                    <div className="flex gap-2">
                      <Input
                        value={tagInput}
                        onChange={(e) => setTagInput(e.target.value)}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter') {
                            e.preventDefault();
                            addTag(tagInput);
                          }
                        }}
                        placeholder="Adaugă tag..."
                        className="flex-1"
                      />
                      <Button
                        type="button"
                        variant="outline"
                        onClick={() => addTag(tagInput)}
                        disabled={!tagInput.trim() || tags.length >= 10}
                      >
                        <Plus className="h-4 w-4" />
                      </Button>
                    </div>
                  </div>
                </FormItem>

                {/* Status */}
                <div className="flex items-center gap-6">
                  <FormField
                    control={form.control}
                    name="active"
                    render={({ field }) => (
                      <FormItem className="flex items-center gap-2">
                        <FormControl>
                          <Switch checked={field.value} onCheckedChange={field.onChange} />
                        </FormControl>
                        <FormLabel className="!mt-0">Activ</FormLabel>
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="inStock"
                    render={({ field }) => (
                      <FormItem className="flex items-center gap-2">
                        <FormControl>
                          <Switch checked={field.value} onCheckedChange={field.onChange} />
                        </FormControl>
                        <FormLabel className="!mt-0">În Stoc</FormLabel>
                      </FormItem>
                    )}
                  />
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Pricing Tab */}
          <TabsContent value="pricing" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Prețuri și Stoc</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid grid-cols-3 gap-4">
                  {/* Net Price */}
                  <FormField
                    control={form.control}
                    name="priceNet"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel required>Preț Net</FormLabel>
                        <FormControl>
                          <Input
                            type="number"
                            step="0.01"
                            min="0"
                            {...field}
                            onChange={(e) => field.onChange(parseFloat(e.target.value) || 0)}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  {/* Currency */}
                  <FormField
                    control={form.control}
                    name="currency"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Monedă</FormLabel>
                        <Select onValueChange={field.onChange} value={field.value}>
                          <FormControl>
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            <SelectItem value="RON">RON</SelectItem>
                            <SelectItem value="EUR">EUR</SelectItem>
                            <SelectItem value="USD">USD</SelectItem>
                          </SelectContent>
                        </Select>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  {/* VAT Rate */}
                  <FormField
                    control={form.control}
                    name="vatRate"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Cotă TVA</FormLabel>
                        <Select onValueChange={field.onChange} value={field.value}>
                          <FormControl>
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            <SelectItem value="19">19%</SelectItem>
                            <SelectItem value="9">9%</SelectItem>
                            <SelectItem value="5">5%</SelectItem>
                            <SelectItem value="0">0% (Scutit)</SelectItem>
                          </SelectContent>
                        </Select>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                {/* Calculated Gross Price */}
                <div className="p-4 bg-muted rounded-lg">
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-muted-foreground">Preț Brut (cu TVA)</span>
                    <span className="text-lg font-semibold">
                      {priceGross.toFixed(2)} {form.watch('currency')}
                    </span>
                  </div>
                </div>

                <div className="grid grid-cols-3 gap-4">
                  {/* Stock Quantity */}
                  <FormField
                    control={form.control}
                    name="stockQuantity"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Cantitate Stoc</FormLabel>
                        <FormControl>
                          <Input
                            type="number"
                            min="0"
                            {...field}
                            onChange={(e) => field.onChange(parseInt(e.target.value) || 0)}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  {/* Stock Unit */}
                  <FormField
                    control={form.control}
                    name="stockUnit"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Unitate</FormLabel>
                        <FormControl>
                          <Input placeholder="buc" {...field} />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  {/* Min Order Quantity */}
                  <FormField
                    control={form.control}
                    name="minOrderQuantity"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Cantitate Minimă</FormLabel>
                        <FormControl>
                          <Input
                            type="number"
                            min="1"
                            {...field}
                            onChange={(e) => field.onChange(parseInt(e.target.value) || 1)}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Attributes Tab */}
          <TabsContent value="attributes" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Atribute Produs</CardTitle>
                <CardDescription>
                  Specificații tehnice și caracteristici
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                {attributeFields.map((field, index) => (
                  <div key={field.id} className="flex items-end gap-2">
                    <FormField
                      control={form.control}
                      name={`attributes.${index}.name`}
                      render={({ field }) => (
                        <FormItem className="flex-1">
                          {index === 0 && <FormLabel>Nume</FormLabel>}
                          <FormControl>
                            <Input placeholder="ex: Greutate" {...field} />
                          </FormControl>
                        </FormItem>
                      )}
                    />
                    <FormField
                      control={form.control}
                      name={`attributes.${index}.value`}
                      render={({ field }) => (
                        <FormItem className="flex-1">
                          {index === 0 && <FormLabel>Valoare</FormLabel>}
                          <FormControl>
                            <Input placeholder="ex: 500" {...field} />
                          </FormControl>
                        </FormItem>
                      )}
                    />
                    <FormField
                      control={form.control}
                      name={`attributes.${index}.unit`}
                      render={({ field }) => (
                        <FormItem className="w-24">
                          {index === 0 && <FormLabel>Unitate</FormLabel>}
                          <FormControl>
                            <Input placeholder="kg" {...field} />
                          </FormControl>
                        </FormItem>
                      )}
                    />
                    <Button
                      type="button"
                      variant="ghost"
                      size="icon"
                      onClick={() => removeAttribute(index)}
                      className="text-destructive"
                    >
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  </div>
                ))}

                <Button
                  type="button"
                  variant="outline"
                  onClick={() => appendAttribute({ name: '', value: '', unit: '' })}
                  disabled={attributeFields.length >= 30}
                >
                  <Plus className="h-4 w-4 mr-2" />
                  Adaugă Atribut
                </Button>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Images Tab */}
          <TabsContent value="images" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Imagini Produs</CardTitle>
                <CardDescription>
                  Maximum 10 imagini. Prima imagine este cea principală.
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                {/* Upload Area */}
                <div
                  className="border-2 border-dashed rounded-lg p-8 text-center cursor-pointer hover:border-primary/50 transition-colors"
                  onClick={() => document.getElementById('image-upload')?.click()}
                  onDrop={(e) => {
                    e.preventDefault();
                    if (e.dataTransfer.files) {
                      handleImageUpload(e.dataTransfer.files);
                    }
                  }}
                  onDragOver={(e) => e.preventDefault()}
                >
                  <Upload className="h-8 w-8 mx-auto mb-2 text-muted-foreground" />
                  <p className="text-sm text-muted-foreground">
                    Trage imagini aici sau click pentru a încărca
                  </p>
                  <input
                    id="image-upload"
                    type="file"
                    accept="image/*"
                    multiple
                    className="hidden"
                    onChange={(e) => {
                      if (e.target.files) {
                        handleImageUpload(e.target.files);
                      }
                    }}
                  />
                </div>

                {/* Image List */}
                {imageFields.length > 0 && (
                  <DndContext
                    collisionDetection={closestCenter}
                    onDragEnd={handleDragEnd}
                  >
                    <SortableContext
                      items={imageFields.map((_, i) => `image-${i}`)}
                      strategy={verticalListSortingStrategy}
                    >
                      <div className="space-y-2">
                        {imageFields.map((field, index) => (
                          <SortableImage
                            key={field.id}
                            id={`image-${index}`}
                            url={field.url}
                            alt={field.alt}
                            isPrimary={field.isPrimary}
                            onRemove={() => removeImage(index)}
                            onSetPrimary={() => setImagePrimary(index)}
                            onUpdateAlt={(alt) => updateImage(index, { ...images[index], alt })}
                          />
                        ))}
                      </div>
                    </SortableContext>
                  </DndContext>
                )}
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>

        {/* Actions */}
        <div className="flex items-center justify-end gap-3">
          {onCancel && (
            <Button type="button" variant="outline" onClick={onCancel}>
              Anulează
            </Button>
          )}
          <Button type="submit" disabled={isSubmitting}>
            {isSubmitting ? (
              <>
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                Se salvează...
              </>
            ) : (
              isEditing ? 'Actualizează Produs' : 'Creează Produs'
            )}
          </Button>
        </div>
      </form>
    </Form>
  );
}
```

### 4.2 ProductImportDialog

Dialog pentru importul produselor din CSV/Excel.

```typescript
// components/products/ProductImportDialog.tsx
import { useState, useCallback } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { Switch } from '@/components/ui/switch';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Badge } from '@/components/ui/badge';
import { ScrollArea } from '@/components/ui/scroll-area';
import { 
  Loader2, 
  Upload, 
  FileSpreadsheet, 
  Check, 
  X, 
  AlertTriangle,
  Download 
} from 'lucide-react';
import { toast } from 'sonner';

// Schema
const importSchema = z.object({
  file: z.instanceof(File, { message: 'Selectați un fișier' })
    .refine((file) => {
      const ext = file.name.split('.').pop()?.toLowerCase();
      return ['csv', 'xlsx', 'xls'].includes(ext || '');
    }, 'Format invalid. Acceptăm CSV sau Excel'),
  updateExisting: z.boolean().default(true),
  createNew: z.boolean().default(true),
  skipErrors: z.boolean().default(false),
});

type ImportFormData = z.infer<typeof importSchema>;

interface ImportResult {
  status: 'success' | 'error' | 'partial';
  totalRows: number;
  created: number;
  updated: number;
  skipped: number;
  errors: Array<{
    row: number;
    field: string;
    message: string;
  }>;
}

interface ProductImportDialogProps {
  trigger?: React.ReactNode;
  onSuccess?: (result: ImportResult) => void;
}

export function ProductImportDialog({
  trigger,
  onSuccess,
}: ProductImportDialogProps) {
  const [open, setOpen] = useState(false);
  const [step, setStep] = useState<'upload' | 'preview' | 'importing' | 'result'>('upload');
  const [progress, setProgress] = useState(0);
  const [previewData, setPreviewData] = useState<any[]>([]);
  const [result, setResult] = useState<ImportResult | null>(null);

  const form = useForm<ImportFormData>({
    resolver: zodResolver(importSchema),
    defaultValues: {
      file: undefined,
      updateExisting: true,
      createNew: true,
      skipErrors: false,
    },
  });

  const selectedFile = form.watch('file');

  const handleFileSelect = useCallback(async (file: File) => {
    form.setValue('file', file);
    
    // Parse preview
    try {
      const formData = new FormData();
      formData.append('file', file);
      
      const response = await fetch('/api/v1/products/import/preview', {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) throw new Error('Failed to parse file');

      const data = await response.json();
      setPreviewData(data.rows.slice(0, 5)); // Show first 5 rows
      setStep('preview');
    } catch (error) {
      toast.error('Eroare la parsarea fișierului');
    }
  }, [form]);

  async function handleSubmit(data: ImportFormData) {
    setStep('importing');
    setProgress(0);

    try {
      const formData = new FormData();
      formData.append('file', data.file);
      formData.append('updateExisting', String(data.updateExisting));
      formData.append('createNew', String(data.createNew));
      formData.append('skipErrors', String(data.skipErrors));

      // Simulate progress (in real implementation, use SSE or WebSocket)
      const progressInterval = setInterval(() => {
        setProgress(p => Math.min(p + 10, 90));
      }, 500);

      const response = await fetch('/api/v1/products/import', {
        method: 'POST',
        body: formData,
      });

      clearInterval(progressInterval);
      setProgress(100);

      if (!response.ok) throw new Error('Import failed');

      const importResult: ImportResult = await response.json();
      setResult(importResult);
      setStep('result');
      
      if (importResult.status === 'success') {
        toast.success(`Import finalizat: ${importResult.created} create, ${importResult.updated} actualizate`);
      }

      onSuccess?.(importResult);
    } catch (error) {
      toast.error('Eroare la import');
      setStep('upload');
    }
  }

  const resetDialog = () => {
    setStep('upload');
    setProgress(0);
    setPreviewData([]);
    setResult(null);
    form.reset();
  };

  const handleOpenChange = (newOpen: boolean) => {
    if (!newOpen) {
      resetDialog();
    }
    setOpen(newOpen);
  };

  return (
    <Dialog open={open} onOpenChange={handleOpenChange}>
      <DialogTrigger asChild>
        {trigger || (
          <Button variant="outline">
            <Upload className="h-4 w-4 mr-2" />
            Import Produse
          </Button>
        )}
      </DialogTrigger>
      <DialogContent className="sm:max-w-[600px]">
        <DialogHeader>
          <DialogTitle>
            {step === 'upload' && 'Import Produse'}
            {step === 'preview' && 'Previzualizare Import'}
            {step === 'importing' && 'Se importă...'}
            {step === 'result' && 'Rezultat Import'}
          </DialogTitle>
          <DialogDescription>
            {step === 'upload' && 'Încărcați un fișier CSV sau Excel cu produse.'}
            {step === 'preview' && 'Verificați datele înainte de import.'}
            {step === 'importing' && 'Vă rugăm așteptați...'}
            {step === 'result' && 'Importul a fost finalizat.'}
          </DialogDescription>
        </DialogHeader>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(handleSubmit)}>
            {/* Upload Step */}
            {step === 'upload' && (
              <div className="space-y-4">
                {/* Drop Zone */}
                <div
                  className="border-2 border-dashed rounded-lg p-8 text-center cursor-pointer hover:border-primary/50 transition-colors"
                  onClick={() => document.getElementById('product-file')?.click()}
                  onDrop={(e) => {
                    e.preventDefault();
                    const file = e.dataTransfer.files?.[0];
                    if (file) handleFileSelect(file);
                  }}
                  onDragOver={(e) => e.preventDefault()}
                >
                  {selectedFile ? (
                    <div className="flex items-center justify-center gap-3">
                      <FileSpreadsheet className="h-8 w-8 text-primary" />
                      <div className="text-left">
                        <p className="font-medium">{selectedFile.name}</p>
                        <p className="text-sm text-muted-foreground">
                          {(selectedFile.size / 1024).toFixed(1)} KB
                        </p>
                      </div>
                    </div>
                  ) : (
                    <>
                      <Upload className="h-8 w-8 mx-auto mb-2 text-muted-foreground" />
                      <p className="text-sm text-muted-foreground">
                        Trageți fișierul aici sau click pentru a selecta
                      </p>
                      <p className="text-xs text-muted-foreground mt-1">
                        CSV, XLSX, XLS (max 10MB)
                      </p>
                    </>
                  )}
                  <input
                    id="product-file"
                    type="file"
                    accept=".csv,.xlsx,.xls"
                    className="hidden"
                    onChange={(e) => {
                      const file = e.target.files?.[0];
                      if (file) handleFileSelect(file);
                    }}
                  />
                </div>

                {/* Download Template */}
                <div className="flex items-center justify-center">
                  <Button
                    type="button"
                    variant="link"
                    onClick={() => {
                      window.open('/api/v1/products/import/template', '_blank');
                    }}
                  >
                    <Download className="h-4 w-4 mr-2" />
                    Descarcă șablon
                  </Button>
                </div>

                {/* Options */}
                <div className="space-y-3 pt-4 border-t">
                  <FormField
                    control={form.control}
                    name="updateExisting"
                    render={({ field }) => (
                      <FormItem className="flex items-center justify-between">
                        <div>
                          <FormLabel>Actualizează produse existente</FormLabel>
                          <FormDescription>
                            Produsele cu același SKU vor fi actualizate
                          </FormDescription>
                        </div>
                        <FormControl>
                          <Switch checked={field.value} onCheckedChange={field.onChange} />
                        </FormControl>
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="createNew"
                    render={({ field }) => (
                      <FormItem className="flex items-center justify-between">
                        <div>
                          <FormLabel>Creează produse noi</FormLabel>
                          <FormDescription>
                            Produsele cu SKU inexistent vor fi create
                          </FormDescription>
                        </div>
                        <FormControl>
                          <Switch checked={field.value} onCheckedChange={field.onChange} />
                        </FormControl>
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="skipErrors"
                    render={({ field }) => (
                      <FormItem className="flex items-center justify-between">
                        <div>
                          <FormLabel>Sări peste erori</FormLabel>
                          <FormDescription>
                            Continuă importul chiar dacă unele rânduri au erori
                          </FormDescription>
                        </div>
                        <FormControl>
                          <Switch checked={field.value} onCheckedChange={field.onChange} />
                        </FormControl>
                      </FormItem>
                    )}
                  />
                </div>
              </div>
            )}

            {/* Preview Step */}
            {step === 'preview' && (
              <div className="space-y-4">
                <Alert>
                  <FileSpreadsheet className="h-4 w-4" />
                  <AlertDescription>
                    Se vor procesa {previewData.length > 5 ? '5+' : previewData.length} produse. 
                    Verificați datele de mai jos.
                  </AlertDescription>
                </Alert>

                <ScrollArea className="h-[200px] border rounded-lg">
                  <table className="w-full text-sm">
                    <thead className="bg-muted sticky top-0">
                      <tr>
                        <th className="p-2 text-left">SKU</th>
                        <th className="p-2 text-left">Titlu</th>
                        <th className="p-2 text-right">Preț</th>
                        <th className="p-2 text-center">Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {previewData.map((row, i) => (
                        <tr key={i} className="border-t">
                          <td className="p-2">{row.sku}</td>
                          <td className="p-2 truncate max-w-[200px]">{row.title}</td>
                          <td className="p-2 text-right">{row.priceNet}</td>
                          <td className="p-2 text-center">
                            {row.isValid ? (
                              <Check className="h-4 w-4 text-green-500 mx-auto" />
                            ) : (
                              <X className="h-4 w-4 text-red-500 mx-auto" />
                            )}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </ScrollArea>
              </div>
            )}

            {/* Importing Step */}
            {step === 'importing' && (
              <div className="py-8 space-y-4">
                <Progress value={progress} className="h-2" />
                <p className="text-center text-sm text-muted-foreground">
                  Import în curs... {progress}%
                </p>
              </div>
            )}

            {/* Result Step */}
            {step === 'result' && result && (
              <div className="space-y-4">
                <div className="flex items-center justify-center gap-2 py-4">
                  {result.status === 'success' && (
                    <Badge variant="default" className="bg-green-500">
                      <Check className="h-3 w-3 mr-1" />
                      Import Reușit
                    </Badge>
                  )}
                  {result.status === 'partial' && (
                    <Badge variant="secondary" className="bg-amber-500">
                      <AlertTriangle className="h-3 w-3 mr-1" />
                      Import Parțial
                    </Badge>
                  )}
                  {result.status === 'error' && (
                    <Badge variant="destructive">
                      <X className="h-3 w-3 mr-1" />
                      Import Eșuat
                    </Badge>
                  )}
                </div>

                <div className="grid grid-cols-4 gap-4 text-center">
                  <div className="p-3 bg-muted rounded-lg">
                    <div className="text-2xl font-bold">{result.totalRows}</div>
                    <div className="text-xs text-muted-foreground">Total</div>
                  </div>
                  <div className="p-3 bg-green-50 rounded-lg">
                    <div className="text-2xl font-bold text-green-600">{result.created}</div>
                    <div className="text-xs text-green-600">Create</div>
                  </div>
                  <div className="p-3 bg-blue-50 rounded-lg">
                    <div className="text-2xl font-bold text-blue-600">{result.updated}</div>
                    <div className="text-xs text-blue-600">Actualizate</div>
                  </div>
                  <div className="p-3 bg-amber-50 rounded-lg">
                    <div className="text-2xl font-bold text-amber-600">{result.skipped}</div>
                    <div className="text-xs text-amber-600">Sărite</div>
                  </div>
                </div>

                {result.errors.length > 0 && (
                  <div className="space-y-2">
                    <h4 className="text-sm font-medium text-destructive">
                      Erori ({result.errors.length})
                    </h4>
                    <ScrollArea className="h-[100px] border border-destructive/20 rounded-lg p-2">
                      {result.errors.map((err, i) => (
                        <div key={i} className="text-sm py-1">
                          <span className="font-medium">Rândul {err.row}:</span>{' '}
                          {err.field} - {err.message}
                        </div>
                      ))}
                    </ScrollArea>
                  </div>
                )}
              </div>
            )}

            <DialogFooter className="mt-6">
              {step === 'upload' && (
                <Button type="button" variant="outline" onClick={() => setOpen(false)}>
                  Anulează
                </Button>
              )}
              {step === 'preview' && (
                <>
                  <Button type="button" variant="outline" onClick={() => setStep('upload')}>
                    Înapoi
                  </Button>
                  <Button type="submit">
                    Începe Importul
                  </Button>
                </>
              )}
              {step === 'result' && (
                <Button type="button" onClick={() => setOpen(false)}>
                  Închide
                </Button>
              )}
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```

### 4.3 ProductFilterForm

```typescript
// components/products/ProductFilterForm.tsx

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { useSearchParams } from 'react-router-dom';
import { useQuery } from '@tanstack/react-query';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import { Badge } from '@/components/ui/badge';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Slider } from '@/components/ui/slider';
import {
  Search,
  Filter,
  X,
  ChevronDown,
  RotateCcw,
} from 'lucide-react';

// Schema validare
const productFilterSchema = z.object({
  search: z.string().optional(),
  categoryId: z.string().optional(),
  inStock: z.boolean().optional(),
  priceMin: z.number().min(0).optional(),
  priceMax: z.number().min(0).optional(),
  vatRate: z.enum(['0', '5', '9', '19', 'all']).optional(),
  tags: z.array(z.string()).optional(),
  active: z.boolean().optional(),
  sortBy: z.enum(['title', 'price', 'stock', 'created', 'updated']).optional(),
  sortOrder: z.enum(['asc', 'desc']).optional(),
}).refine(data => {
  if (data.priceMin && data.priceMax) {
    return data.priceMin <= data.priceMax;
  }
  return true;
}, {
  message: 'Prețul minim nu poate fi mai mare decât prețul maxim',
  path: ['priceMax'],
});

type ProductFilterValues = z.infer<typeof productFilterSchema>;

interface ProductFilterFormProps {
  onFilter: (filters: ProductFilterValues) => void;
  defaultValues?: Partial<ProductFilterValues>;
  compact?: boolean;
}

// Custom hook pentru categorii
function useCategories() {
  return useQuery({
    queryKey: ['product-categories'],
    queryFn: async () => {
      const response = await fetch('/api/v1/products/categories');
      if (!response.ok) throw new Error('Failed to fetch categories');
      return response.json();
    },
  });
}

// Custom hook pentru tag-uri disponibile
function useTags() {
  return useQuery({
    queryKey: ['product-tags'],
    queryFn: async () => {
      const response = await fetch('/api/v1/products/tags');
      if (!response.ok) throw new Error('Failed to fetch tags');
      return response.json();
    },
  });
}

export function ProductFilterForm({
  onFilter,
  defaultValues,
  compact = false,
}: ProductFilterFormProps) {
  const [searchParams, setSearchParams] = useSearchParams();
  const [isExpanded, setIsExpanded] = useState(false);
  
  const { data: categories = [] } = useCategories();
  const { data: availableTags = [] } = useTags();
  
  // Initialize from URL params
  const initialValues: ProductFilterValues = {
    search: searchParams.get('search') || defaultValues?.search || '',
    categoryId: searchParams.get('category') || defaultValues?.categoryId || '',
    inStock: searchParams.get('inStock') === 'true' || defaultValues?.inStock,
    priceMin: searchParams.get('priceMin') 
      ? Number(searchParams.get('priceMin')) 
      : defaultValues?.priceMin,
    priceMax: searchParams.get('priceMax') 
      ? Number(searchParams.get('priceMax')) 
      : defaultValues?.priceMax,
    vatRate: (searchParams.get('vat') as any) || defaultValues?.vatRate || 'all',
    tags: searchParams.get('tags')?.split(',').filter(Boolean) || defaultValues?.tags || [],
    active: searchParams.get('active') !== 'false',
    sortBy: (searchParams.get('sortBy') as any) || defaultValues?.sortBy || 'title',
    sortOrder: (searchParams.get('sortOrder') as any) || defaultValues?.sortOrder || 'asc',
  };

  const form = useForm<ProductFilterValues>({
    resolver: zodResolver(productFilterSchema),
    defaultValues: initialValues,
  });

  const activeFiltersCount = useMemo(() => {
    const values = form.getValues();
    let count = 0;
    if (values.search) count++;
    if (values.categoryId) count++;
    if (values.inStock) count++;
    if (values.priceMin || values.priceMax) count++;
    if (values.vatRate && values.vatRate !== 'all') count++;
    if (values.tags && values.tags.length > 0) count++;
    if (values.active === false) count++;
    return count;
  }, [form.watch()]);

  function onSubmit(data: ProductFilterValues) {
    // Update URL params
    const params = new URLSearchParams();
    if (data.search) params.set('search', data.search);
    if (data.categoryId) params.set('category', data.categoryId);
    if (data.inStock) params.set('inStock', 'true');
    if (data.priceMin) params.set('priceMin', String(data.priceMin));
    if (data.priceMax) params.set('priceMax', String(data.priceMax));
    if (data.vatRate && data.vatRate !== 'all') params.set('vat', data.vatRate);
    if (data.tags && data.tags.length > 0) params.set('tags', data.tags.join(','));
    if (data.active === false) params.set('active', 'false');
    if (data.sortBy) params.set('sortBy', data.sortBy);
    if (data.sortOrder) params.set('sortOrder', data.sortOrder);
    
    setSearchParams(params);
    onFilter(data);
  }

  function resetFilters() {
    form.reset({
      search: '',
      categoryId: '',
      inStock: undefined,
      priceMin: undefined,
      priceMax: undefined,
      vatRate: 'all',
      tags: [],
      active: true,
      sortBy: 'title',
      sortOrder: 'asc',
    });
    setSearchParams(new URLSearchParams());
    onFilter({});
  }

  // Compact variant - doar search + filter popover
  if (compact) {
    return (
      <Form {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)} className="flex gap-2">
          <FormField
            control={form.control}
            name="search"
            render={({ field }) => (
              <FormItem className="flex-1">
                <FormControl>
                  <div className="relative">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                    <Input
                      placeholder="Caută produse..."
                      className="pl-9"
                      {...field}
                    />
                  </div>
                </FormControl>
              </FormItem>
            )}
          />

          <Popover>
            <PopoverTrigger asChild>
              <Button variant="outline" className="relative">
                <Filter className="h-4 w-4 mr-2" />
                Filtre
                {activeFiltersCount > 0 && (
                  <Badge 
                    variant="secondary" 
                    className="absolute -top-2 -right-2 h-5 w-5 p-0 flex items-center justify-center"
                  >
                    {activeFiltersCount}
                  </Badge>
                )}
              </Button>
            </PopoverTrigger>
            <PopoverContent className="w-80" align="end">
              <div className="space-y-4">
                <div className="flex items-center justify-between">
                  <h4 className="font-medium">Filtre</h4>
                  <Button
                    type="button"
                    variant="ghost"
                    size="sm"
                    onClick={resetFilters}
                  >
                    <RotateCcw className="h-3 w-3 mr-1" />
                    Resetează
                  </Button>
                </div>

                <FormField
                  control={form.control}
                  name="categoryId"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Categorie</FormLabel>
                      <Select
                        value={field.value}
                        onValueChange={field.onChange}
                      >
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Toate categoriile" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          <SelectItem value="">Toate categoriile</SelectItem>
                          {categories.map((cat: any) => (
                            <SelectItem key={cat.id} value={cat.id}>
                              {cat.name}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="inStock"
                  render={({ field }) => (
                    <FormItem className="flex items-center gap-2">
                      <FormControl>
                        <Checkbox
                          checked={field.value}
                          onCheckedChange={field.onChange}
                        />
                      </FormControl>
                      <FormLabel className="!mt-0">Doar în stoc</FormLabel>
                    </FormItem>
                  )}
                />

                <div className="space-y-2">
                  <FormLabel>Interval preț (RON)</FormLabel>
                  <div className="flex gap-2">
                    <FormField
                      control={form.control}
                      name="priceMin"
                      render={({ field }) => (
                        <FormItem className="flex-1">
                          <FormControl>
                            <Input
                              type="number"
                              placeholder="Min"
                              {...field}
                              onChange={(e) => field.onChange(
                                e.target.value ? Number(e.target.value) : undefined
                              )}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />
                    <span className="self-center">-</span>
                    <FormField
                      control={form.control}
                      name="priceMax"
                      render={({ field }) => (
                        <FormItem className="flex-1">
                          <FormControl>
                            <Input
                              type="number"
                              placeholder="Max"
                              {...field}
                              onChange={(e) => field.onChange(
                                e.target.value ? Number(e.target.value) : undefined
                              )}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />
                  </div>
                </div>

                <FormField
                  control={form.control}
                  name="vatRate"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Cotă TVA</FormLabel>
                      <Select
                        value={field.value}
                        onValueChange={field.onChange}
                      >
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Toate" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          <SelectItem value="all">Toate</SelectItem>
                          <SelectItem value="0">0%</SelectItem>
                          <SelectItem value="5">5%</SelectItem>
                          <SelectItem value="9">9%</SelectItem>
                          <SelectItem value="19">19%</SelectItem>
                        </SelectContent>
                      </Select>
                    </FormItem>
                  )}
                />

                <Button type="submit" className="w-full">
                  Aplică Filtre
                </Button>
              </div>
            </PopoverContent>
          </Popover>

          <Button type="submit">
            <Search className="h-4 w-4" />
          </Button>
        </form>
      </Form>
    );
  }

  // Full variant
  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
        {/* Search Bar */}
        <div className="flex gap-2">
          <FormField
            control={form.control}
            name="search"
            render={({ field }) => (
              <FormItem className="flex-1">
                <FormControl>
                  <div className="relative">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                    <Input
                      placeholder="Caută după nume, SKU sau descriere..."
                      className="pl-9"
                      {...field}
                    />
                  </div>
                </FormControl>
              </FormItem>
            )}
          />
          <Button type="submit">Caută</Button>
          <Button
            type="button"
            variant="outline"
            onClick={() => setIsExpanded(!isExpanded)}
          >
            <Filter className="h-4 w-4 mr-2" />
            {isExpanded ? 'Ascunde Filtre' : 'Mai Multe Filtre'}
            <ChevronDown className={cn(
              "h-4 w-4 ml-2 transition-transform",
              isExpanded && "rotate-180"
            )} />
          </Button>
        </div>

        {/* Quick Filters */}
        <div className="flex flex-wrap gap-2">
          <FormField
            control={form.control}
            name="categoryId"
            render={({ field }) => (
              <FormItem>
                <Select
                  value={field.value}
                  onValueChange={field.onChange}
                >
                  <FormControl>
                    <SelectTrigger className="w-[180px]">
                      <SelectValue placeholder="Categorie" />
                    </SelectTrigger>
                  </FormControl>
                  <SelectContent>
                    <SelectItem value="">Toate categoriile</SelectItem>
                    {categories.map((cat: any) => (
                      <SelectItem key={cat.id} value={cat.id}>
                        {cat.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="sortBy"
            render={({ field }) => (
              <FormItem>
                <Select
                  value={field.value}
                  onValueChange={field.onChange}
                >
                  <FormControl>
                    <SelectTrigger className="w-[150px]">
                      <SelectValue placeholder="Sortare" />
                    </SelectTrigger>
                  </FormControl>
                  <SelectContent>
                    <SelectItem value="title">Nume</SelectItem>
                    <SelectItem value="price">Preț</SelectItem>
                    <SelectItem value="stock">Stoc</SelectItem>
                    <SelectItem value="created">Data creării</SelectItem>
                    <SelectItem value="updated">Ultima actualizare</SelectItem>
                  </SelectContent>
                </Select>
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="sortOrder"
            render={({ field }) => (
              <FormItem>
                <Select
                  value={field.value}
                  onValueChange={field.onChange}
                >
                  <FormControl>
                    <SelectTrigger className="w-[120px]">
                      <SelectValue />
                    </SelectTrigger>
                  </FormControl>
                  <SelectContent>
                    <SelectItem value="asc">Crescător</SelectItem>
                    <SelectItem value="desc">Descrescător</SelectItem>
                  </SelectContent>
                </Select>
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="inStock"
            render={({ field }) => (
              <FormItem className="flex items-center gap-2 border rounded-md px-3 h-10">
                <FormControl>
                  <Checkbox
                    checked={field.value}
                    onCheckedChange={field.onChange}
                  />
                </FormControl>
                <FormLabel className="!mt-0 text-sm">În stoc</FormLabel>
              </FormItem>
            )}
          />

          {activeFiltersCount > 0 && (
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={resetFilters}
              className="h-10"
            >
              <X className="h-4 w-4 mr-1" />
              Resetează ({activeFiltersCount})
            </Button>
          )}
        </div>

        {/* Expanded Filters */}
        {isExpanded && (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border rounded-lg bg-muted/20">
            {/* Price Range */}
            <div className="space-y-2">
              <FormLabel>Interval Preț (RON)</FormLabel>
              <div className="flex gap-2 items-center">
                <FormField
                  control={form.control}
                  name="priceMin"
                  render={({ field }) => (
                    <FormItem className="flex-1">
                      <FormControl>
                        <Input
                          type="number"
                          placeholder="De la"
                          {...field}
                          onChange={(e) => field.onChange(
                            e.target.value ? Number(e.target.value) : undefined
                          )}
                        />
                      </FormControl>
                    </FormItem>
                  )}
                />
                <span className="text-muted-foreground">-</span>
                <FormField
                  control={form.control}
                  name="priceMax"
                  render={({ field }) => (
                    <FormItem className="flex-1">
                      <FormControl>
                        <Input
                          type="number"
                          placeholder="Până la"
                          {...field}
                          onChange={(e) => field.onChange(
                            e.target.value ? Number(e.target.value) : undefined
                          )}
                        />
                      </FormControl>
                    </FormItem>
                  )}
                />
              </div>
            </div>

            {/* VAT Rate */}
            <FormField
              control={form.control}
              name="vatRate"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Cotă TVA</FormLabel>
                  <Select
                    value={field.value}
                    onValueChange={field.onChange}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Toate cotele" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="all">Toate cotele</SelectItem>
                      <SelectItem value="0">0% (scutit)</SelectItem>
                      <SelectItem value="5">5% (redus)</SelectItem>
                      <SelectItem value="9">9% (redus)</SelectItem>
                      <SelectItem value="19">19% (standard)</SelectItem>
                    </SelectContent>
                  </Select>
                </FormItem>
              )}
            />

            {/* Active Status */}
            <FormField
              control={form.control}
              name="active"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Status</FormLabel>
                  <Select
                    value={field.value === undefined ? 'all' : field.value ? 'active' : 'inactive'}
                    onValueChange={(v) => field.onChange(
                      v === 'all' ? undefined : v === 'active'
                    )}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Toate" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="all">Toate</SelectItem>
                      <SelectItem value="active">Active</SelectItem>
                      <SelectItem value="inactive">Inactive</SelectItem>
                    </SelectContent>
                  </Select>
                </FormItem>
              )}
            />

            {/* Tags */}
            <div className="md:col-span-3">
              <FormField
                control={form.control}
                name="tags"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Tag-uri</FormLabel>
                    <div className="flex flex-wrap gap-2">
                      {availableTags.map((tag: string) => (
                        <Badge
                          key={tag}
                          variant={field.value?.includes(tag) ? 'default' : 'outline'}
                          className="cursor-pointer"
                          onClick={() => {
                            const current = field.value || [];
                            if (current.includes(tag)) {
                              field.onChange(current.filter(t => t !== tag));
                            } else {
                              field.onChange([...current, tag]);
                            }
                          }}
                        >
                          {tag}
                        </Badge>
                      ))}
                    </div>
                  </FormItem>
                )}
              />
            </div>
          </div>
        )}

        {/* Active Filters Display */}
        {activeFiltersCount > 0 && (
          <div className="flex flex-wrap gap-2 text-sm">
            <span className="text-muted-foreground">Filtre active:</span>
            {form.watch('search') && (
              <Badge variant="secondary" className="gap-1">
                Căutare: "{form.watch('search')}"
                <X
                  className="h-3 w-3 cursor-pointer"
                  onClick={() => form.setValue('search', '')}
                />
              </Badge>
            )}
            {form.watch('categoryId') && (
              <Badge variant="secondary" className="gap-1">
                Categorie: {categories.find((c: any) => c.id === form.watch('categoryId'))?.name}
                <X
                  className="h-3 w-3 cursor-pointer"
                  onClick={() => form.setValue('categoryId', '')}
                />
              </Badge>
            )}
            {form.watch('inStock') && (
              <Badge variant="secondary" className="gap-1">
                În stoc
                <X
                  className="h-3 w-3 cursor-pointer"
                  onClick={() => form.setValue('inStock', false)}
                />
              </Badge>
            )}
            {(form.watch('priceMin') || form.watch('priceMax')) && (
              <Badge variant="secondary" className="gap-1">
                Preț: {form.watch('priceMin') || 0} - {form.watch('priceMax') || '∞'} RON
                <X
                  className="h-3 w-3 cursor-pointer"
                  onClick={() => {
                    form.setValue('priceMin', undefined);
                    form.setValue('priceMax', undefined);
                  }}
                />
              </Badge>
            )}
            {form.watch('vatRate') && form.watch('vatRate') !== 'all' && (
              <Badge variant="secondary" className="gap-1">
                TVA: {form.watch('vatRate')}%
                <X
                  className="h-3 w-3 cursor-pointer"
                  onClick={() => form.setValue('vatRate', 'all')}
                />
              </Badge>
            )}
            {form.watch('tags')?.map(tag => (
              <Badge key={tag} variant="secondary" className="gap-1">
                {tag}
                <X
                  className="h-3 w-3 cursor-pointer"
                  onClick={() => {
                    const current = form.watch('tags') || [];
                    form.setValue('tags', current.filter(t => t !== tag));
                  }}
                />
              </Badge>
            ))}
          </div>
        )}
      </form>
    </Form>
  );
}
```

---

## 5. Prețuri & Discount Forms

### 5.1 DiscountRuleForm

```typescript
// components/pricing/DiscountRuleForm.tsx

import { useState } from 'react';
import { useForm, useFieldArray } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { format } from 'date-fns';
import { ro } from 'date-fns/locale';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Switch } from '@/components/ui/switch';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Calendar } from '@/components/ui/calendar';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import {
  CalendarIcon,
  Plus,
  Trash2,
  AlertTriangle,
  Percent,
  DollarSign,
  Layers,
  Info,
} from 'lucide-react';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';

// Condition types for discount rules
const conditionTypes = [
  { value: 'min_quantity', label: 'Cantitate minimă', icon: Layers },
  { value: 'min_value', label: 'Valoare minimă comandă', icon: DollarSign },
  { value: 'customer_type', label: 'Tip client', icon: Building2 },
  { value: 'product_category', label: 'Categorie produs', icon: Tag },
  { value: 'payment_method', label: 'Metodă plată', icon: CreditCard },
  { value: 'first_order', label: 'Prima comandă', icon: Star },
] as const;

// Schema pentru condiții
const conditionSchema = z.object({
  type: z.enum(['min_quantity', 'min_value', 'customer_type', 'product_category', 'payment_method', 'first_order']),
  operator: z.enum(['eq', 'neq', 'gt', 'gte', 'lt', 'lte', 'in', 'nin']),
  value: z.union([z.string(), z.number(), z.array(z.string())]),
});

// Schema pentru tier-uri (discount progresiv)
const tierSchema = z.object({
  minQuantity: z.number().min(1, 'Cantitatea minimă trebuie să fie cel puțin 1'),
  discountValue: z.number().min(0, 'Discount-ul nu poate fi negativ'),
});

// Schema principală
const discountRuleSchema = z.object({
  name: z.string()
    .min(3, 'Numele trebuie să aibă cel puțin 3 caractere')
    .max(100, 'Numele nu poate depăși 100 caractere'),
  description: z.string()
    .max(500, 'Descrierea nu poate depăși 500 caractere')
    .optional(),
  type: z.enum(['percentage', 'fixed', 'tiered']),
  value: z.number()
    .min(0, 'Valoarea nu poate fi negativă')
    .optional(),
  conditions: z.array(conditionSchema).optional(),
  tiers: z.array(tierSchema).optional(),
  validFrom: z.date().optional(),
  validTo: z.date().optional(),
  maxUses: z.number().int().min(0).optional(),
  maxUsesPerCustomer: z.number().int().min(0).optional(),
  requiresApproval: z.boolean().default(false),
  approvalThreshold: z.number().min(0).optional(),
  active: z.boolean().default(true),
  priority: z.number().int().min(1).max(100).default(50),
  stackable: z.boolean().default(false),
  excludeDiscounted: z.boolean().default(true),
  appliesTo: z.enum(['all', 'specific_products', 'specific_categories']).default('all'),
  productIds: z.array(z.string()).optional(),
  categoryIds: z.array(z.string()).optional(),
}).refine(data => {
  if (data.validFrom && data.validTo) {
    return data.validFrom < data.validTo;
  }
  return true;
}, {
  message: 'Data de început trebuie să fie înainte de data de sfârșit',
  path: ['validTo'],
}).refine(data => {
  if (data.type === 'percentage' && data.value !== undefined) {
    return data.value <= 100;
  }
  return true;
}, {
  message: 'Procentul nu poate depăși 100%',
  path: ['value'],
}).refine(data => {
  if (data.type === 'tiered' && (!data.tiers || data.tiers.length === 0)) {
    return false;
  }
  return true;
}, {
  message: 'Discount-ul progresiv necesită cel puțin un nivel',
  path: ['tiers'],
});

type DiscountRuleValues = z.infer<typeof discountRuleSchema>;

interface DiscountRuleFormProps {
  defaultValues?: Partial<DiscountRuleValues>;
  onSubmit: (data: DiscountRuleValues) => Promise<void>;
  onCancel?: () => void;
  mode?: 'create' | 'edit';
}

export function DiscountRuleForm({
  defaultValues,
  onSubmit,
  onCancel,
  mode = 'create',
}: DiscountRuleFormProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);

  const form = useForm<DiscountRuleValues>({
    resolver: zodResolver(discountRuleSchema),
    defaultValues: {
      name: '',
      description: '',
      type: 'percentage',
      value: 0,
      conditions: [],
      tiers: [],
      active: true,
      priority: 50,
      stackable: false,
      excludeDiscounted: true,
      appliesTo: 'all',
      requiresApproval: false,
      ...defaultValues,
    },
  });

  const { fields: conditionFields, append: appendCondition, remove: removeCondition } = 
    useFieldArray({
      control: form.control,
      name: 'conditions',
    });

  const { fields: tierFields, append: appendTier, remove: removeTier } = 
    useFieldArray({
      control: form.control,
      name: 'tiers',
    });

  const discountType = form.watch('type');
  const requiresApproval = form.watch('requiresApproval');
  const appliesTo = form.watch('appliesTo');

  async function handleSubmit(data: DiscountRuleValues) {
    setIsSubmitting(true);
    try {
      await onSubmit(data);
      toast.success(
        mode === 'create' 
          ? 'Regulă discount creată cu succes' 
          : 'Regulă discount actualizată'
      );
    } catch (error) {
      toast.error('Eroare la salvarea regulii de discount');
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-8">
        {/* Basic Information */}
        <Card>
          <CardHeader>
            <CardTitle>Informații de Bază</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="name"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Nume Regulă *</FormLabel>
                  <FormControl>
                    <Input placeholder="ex: Discount volum mare" {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="description"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Descriere</FormLabel>
                  <FormControl>
                    <Textarea 
                      placeholder="Descriere detaliată a regulii..."
                      className="resize-none"
                      rows={3}
                      {...field} 
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="grid grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="type"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Tip Discount *</FormLabel>
                    <Select
                      value={field.value}
                      onValueChange={field.onChange}
                    >
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        <SelectItem value="percentage">
                          <div className="flex items-center gap-2">
                            <Percent className="h-4 w-4" />
                            Procentual
                          </div>
                        </SelectItem>
                        <SelectItem value="fixed">
                          <div className="flex items-center gap-2">
                            <DollarSign className="h-4 w-4" />
                            Sumă fixă
                          </div>
                        </SelectItem>
                        <SelectItem value="tiered">
                          <div className="flex items-center gap-2">
                            <Layers className="h-4 w-4" />
                            Progresiv (tier-uri)
                          </div>
                        </SelectItem>
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />

              {discountType !== 'tiered' && (
                <FormField
                  control={form.control}
                  name="value"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>
                        Valoare Discount *
                        {discountType === 'percentage' ? ' (%)' : ' (RON)'}
                      </FormLabel>
                      <FormControl>
                        <div className="relative">
                          <Input
                            type="number"
                            step={discountType === 'percentage' ? '0.1' : '0.01'}
                            min="0"
                            max={discountType === 'percentage' ? '100' : undefined}
                            {...field}
                            onChange={(e) => field.onChange(parseFloat(e.target.value) || 0)}
                          />
                          <div className="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground">
                            {discountType === 'percentage' ? '%' : 'RON'}
                          </div>
                        </div>
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              )}
            </div>

            <FormField
              control={form.control}
              name="priority"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Prioritate (1-100)</FormLabel>
                  <FormControl>
                    <Input
                      type="number"
                      min="1"
                      max="100"
                      {...field}
                      onChange={(e) => field.onChange(parseInt(e.target.value) || 50)}
                    />
                  </FormControl>
                  <FormDescription>
                    Prioritate mai mare = se aplică prima (în cazul discount-urilor non-stackable)
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />
          </CardContent>
        </Card>

        {/* Tiered Discounts */}
        {discountType === 'tiered' && (
          <Card>
            <CardHeader className="flex flex-row items-center justify-between">
              <CardTitle>Nivele Discount Progresiv</CardTitle>
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={() => appendTier({ minQuantity: 1, discountValue: 0 })}
              >
                <Plus className="h-4 w-4 mr-1" />
                Adaugă Nivel
              </Button>
            </CardHeader>
            <CardContent>
              {tierFields.length === 0 ? (
                <div className="text-center py-8 text-muted-foreground">
                  <Layers className="h-12 w-12 mx-auto mb-2 opacity-50" />
                  <p>Nu există nivele definite</p>
                  <p className="text-sm">Adăugați cel puțin un nivel pentru discount progresiv</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {tierFields.map((field, index) => (
                    <div
                      key={field.id}
                      className="flex items-center gap-4 p-4 border rounded-lg"
                    >
                      <div className="flex-1 grid grid-cols-2 gap-4">
                        <FormField
                          control={form.control}
                          name={`tiers.${index}.minQuantity`}
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Cantitate minimă</FormLabel>
                              <FormControl>
                                <Input
                                  type="number"
                                  min="1"
                                  {...field}
                                  onChange={(e) => field.onChange(parseInt(e.target.value) || 1)}
                                />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={form.control}
                          name={`tiers.${index}.discountValue`}
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Discount (%)</FormLabel>
                              <FormControl>
                                <Input
                                  type="number"
                                  min="0"
                                  max="100"
                                  step="0.1"
                                  {...field}
                                  onChange={(e) => field.onChange(parseFloat(e.target.value) || 0)}
                                />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                      </div>
                      <Button
                        type="button"
                        variant="ghost"
                        size="icon"
                        onClick={() => removeTier(index)}
                      >
                        <Trash2 className="h-4 w-4 text-destructive" />
                      </Button>
                    </div>
                  ))}

                  {/* Preview */}
                  <div className="mt-4 p-4 bg-muted rounded-lg">
                    <h4 className="text-sm font-medium mb-2">Preview Discount</h4>
                    <div className="space-y-1 text-sm">
                      {tierFields
                        .sort((a, b) => (a.minQuantity || 0) - (b.minQuantity || 0))
                        .map((tier, i, arr) => {
                          const next = arr[i + 1];
                          const minQty = form.watch(`tiers.${tierFields.indexOf(tier)}.minQuantity`);
                          const discount = form.watch(`tiers.${tierFields.indexOf(tier)}.discountValue`);
                          const maxQty = next 
                            ? form.watch(`tiers.${tierFields.indexOf(next)}.minQuantity`) - 1
                            : '∞';
                          return (
                            <div key={tier.id} className="flex justify-between">
                              <span>{minQty} - {maxQty} bucăți</span>
                              <span className="font-medium">{discount}% discount</span>
                            </div>
                          );
                        })}
                    </div>
                  </div>
                </div>
              )}
            </CardContent>
          </Card>
        )}

        {/* Conditions */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between">
            <CardTitle>Condiții de Aplicare</CardTitle>
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={() => appendCondition({ 
                type: 'min_quantity', 
                operator: 'gte', 
                value: 0 
              })}
            >
              <Plus className="h-4 w-4 mr-1" />
              Adaugă Condiție
            </Button>
          </CardHeader>
          <CardContent>
            {conditionFields.length === 0 ? (
              <div className="text-center py-8 text-muted-foreground">
                <Info className="h-12 w-12 mx-auto mb-2 opacity-50" />
                <p>Fără condiții suplimentare</p>
                <p className="text-sm">Discount-ul se va aplica tuturor comenzilor eligibile</p>
              </div>
            ) : (
              <div className="space-y-4">
                {conditionFields.map((field, index) => (
                  <div
                    key={field.id}
                    className="flex items-center gap-4 p-4 border rounded-lg"
                  >
                    <div className="flex-1 grid grid-cols-3 gap-4">
                      <FormField
                        control={form.control}
                        name={`conditions.${index}.type`}
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Tip</FormLabel>
                            <Select
                              value={field.value}
                              onValueChange={field.onChange}
                            >
                              <FormControl>
                                <SelectTrigger>
                                  <SelectValue />
                                </SelectTrigger>
                              </FormControl>
                              <SelectContent>
                                {conditionTypes.map(type => (
                                  <SelectItem key={type.value} value={type.value}>
                                    {type.label}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                      <FormField
                        control={form.control}
                        name={`conditions.${index}.operator`}
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Operator</FormLabel>
                            <Select
                              value={field.value}
                              onValueChange={field.onChange}
                            >
                              <FormControl>
                                <SelectTrigger>
                                  <SelectValue />
                                </SelectTrigger>
                              </FormControl>
                              <SelectContent>
                                <SelectItem value="eq">=</SelectItem>
                                <SelectItem value="neq">≠</SelectItem>
                                <SelectItem value="gt">&gt;</SelectItem>
                                <SelectItem value="gte">≥</SelectItem>
                                <SelectItem value="lt">&lt;</SelectItem>
                                <SelectItem value="lte">≤</SelectItem>
                                <SelectItem value="in">în listă</SelectItem>
                                <SelectItem value="nin">nu în listă</SelectItem>
                              </SelectContent>
                            </Select>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                      <FormField
                        control={form.control}
                        name={`conditions.${index}.value`}
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Valoare</FormLabel>
                            <FormControl>
                              <Input
                                {...field}
                                onChange={(e) => {
                                  const val = e.target.value;
                                  field.onChange(
                                    !isNaN(Number(val)) ? Number(val) : val
                                  );
                                }}
                              />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    </div>
                    <Button
                      type="button"
                      variant="ghost"
                      size="icon"
                      onClick={() => removeCondition(index)}
                    >
                      <Trash2 className="h-4 w-4 text-destructive" />
                    </Button>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>

        {/* Validity Period */}
        <Card>
          <CardHeader>
            <CardTitle>Perioada de Valabilitate</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="validFrom"
                render={({ field }) => (
                  <FormItem className="flex flex-col">
                    <FormLabel>Valabil de la</FormLabel>
                    <Popover>
                      <PopoverTrigger asChild>
                        <FormControl>
                          <Button
                            variant="outline"
                            className={cn(
                              "pl-3 text-left font-normal",
                              !field.value && "text-muted-foreground"
                            )}
                          >
                            {field.value ? (
                              format(field.value, 'PPP', { locale: ro })
                            ) : (
                              <span>Imediat</span>
                            )}
                            <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                          </Button>
                        </FormControl>
                      </PopoverTrigger>
                      <PopoverContent className="w-auto p-0" align="start">
                        <Calendar
                          mode="single"
                          selected={field.value}
                          onSelect={field.onChange}
                          locale={ro}
                        />
                      </PopoverContent>
                    </Popover>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="validTo"
                render={({ field }) => (
                  <FormItem className="flex flex-col">
                    <FormLabel>Valabil până la</FormLabel>
                    <Popover>
                      <PopoverTrigger asChild>
                        <FormControl>
                          <Button
                            variant="outline"
                            className={cn(
                              "pl-3 text-left font-normal",
                              !field.value && "text-muted-foreground"
                            )}
                          >
                            {field.value ? (
                              format(field.value, 'PPP', { locale: ro })
                            ) : (
                              <span>Fără limită</span>
                            )}
                            <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                          </Button>
                        </FormControl>
                      </PopoverTrigger>
                      <PopoverContent className="w-auto p-0" align="start">
                        <Calendar
                          mode="single"
                          selected={field.value}
                          onSelect={field.onChange}
                          disabled={(date) => 
                            form.watch('validFrom') 
                              ? date < form.watch('validFrom') 
                              : false
                          }
                          locale={ro}
                        />
                      </PopoverContent>
                    </Popover>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="maxUses"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Utilizări maxime totale</FormLabel>
                    <FormControl>
                      <Input
                        type="number"
                        min="0"
                        placeholder="Nelimitat"
                        {...field}
                        onChange={(e) => field.onChange(
                          e.target.value ? parseInt(e.target.value) : undefined
                        )}
                      />
                    </FormControl>
                    <FormDescription>0 sau gol = nelimitat</FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="maxUsesPerCustomer"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Utilizări maxime per client</FormLabel>
                    <FormControl>
                      <Input
                        type="number"
                        min="0"
                        placeholder="Nelimitat"
                        {...field}
                        onChange={(e) => field.onChange(
                          e.target.value ? parseInt(e.target.value) : undefined
                        )}
                      />
                    </FormControl>
                    <FormDescription>0 sau gol = nelimitat</FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
          </CardContent>
        </Card>

        {/* Approval Settings */}
        <Card>
          <CardHeader>
            <CardTitle>Setări Aprobare HITL</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="requiresApproval"
              render={({ field }) => (
                <FormItem className="flex items-center justify-between rounded-lg border p-4">
                  <div className="space-y-0.5">
                    <FormLabel className="text-base">Necesită aprobare manuală</FormLabel>
                    <FormDescription>
                      Discount-ul necesită aprobare umană înainte de aplicare
                    </FormDescription>
                  </div>
                  <FormControl>
                    <Switch
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                </FormItem>
              )}
            />

            {requiresApproval && (
              <FormField
                control={form.control}
                name="approvalThreshold"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Prag de aprobare (RON)</FormLabel>
                    <FormControl>
                      <Input
                        type="number"
                        min="0"
                        step="0.01"
                        placeholder="Orice valoare necesită aprobare"
                        {...field}
                        onChange={(e) => field.onChange(
                          e.target.value ? parseFloat(e.target.value) : undefined
                        )}
                      />
                    </FormControl>
                    <FormDescription>
                      Discount-urile sub acest prag nu necesită aprobare
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />
            )}
          </CardContent>
        </Card>

        {/* Additional Settings */}
        <Card>
          <CardHeader>
            <CardTitle>Setări Avansate</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="active"
                render={({ field }) => (
                  <FormItem className="flex items-center justify-between rounded-lg border p-4">
                    <div className="space-y-0.5">
                      <FormLabel>Activ</FormLabel>
                      <FormDescription>
                        Regula poate fi aplicată
                      </FormDescription>
                    </div>
                    <FormControl>
                      <Switch
                        checked={field.value}
                        onCheckedChange={field.onChange}
                      />
                    </FormControl>
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="stackable"
                render={({ field }) => (
                  <FormItem className="flex items-center justify-between rounded-lg border p-4">
                    <div className="space-y-0.5">
                      <FormLabel>Cumulabil</FormLabel>
                      <FormDescription>
                        Se poate combina cu alte discount-uri
                      </FormDescription>
                    </div>
                    <FormControl>
                      <Switch
                        checked={field.value}
                        onCheckedChange={field.onChange}
                      />
                    </FormControl>
                  </FormItem>
                )}
              />
            </div>

            <FormField
              control={form.control}
              name="excludeDiscounted"
              render={({ field }) => (
                <FormItem className="flex items-center justify-between rounded-lg border p-4">
                  <div className="space-y-0.5">
                    <FormLabel>Exclude produsele deja reduse</FormLabel>
                    <FormDescription>
                      Nu se aplică pe produse care au deja un discount
                    </FormDescription>
                  </div>
                  <FormControl>
                    <Switch
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="appliesTo"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Se aplică la</FormLabel>
                  <Select
                    value={field.value}
                    onValueChange={field.onChange}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="all">Toate produsele</SelectItem>
                      <SelectItem value="specific_products">Produse specifice</SelectItem>
                      <SelectItem value="specific_categories">Categorii specifice</SelectItem>
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            {appliesTo === 'specific_products' && (
              <FormField
                control={form.control}
                name="productIds"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Produse</FormLabel>
                    <FormControl>
                      {/* ProductMultiSelect component */}
                      <div className="border rounded-md p-4 min-h-[100px]">
                        <p className="text-sm text-muted-foreground">
                          Selector produse - {(field.value || []).length} selectate
                        </p>
                      </div>
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            )}

            {appliesTo === 'specific_categories' && (
              <FormField
                control={form.control}
                name="categoryIds"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Categorii</FormLabel>
                    <FormControl>
                      {/* CategoryMultiSelect component */}
                      <div className="border rounded-md p-4 min-h-[100px]">
                        <p className="text-sm text-muted-foreground">
                          Selector categorii - {(field.value || []).length} selectate
                        </p>
                      </div>
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            )}
          </CardContent>
        </Card>

        {/* Actions */}
        <div className="flex justify-end gap-4">
          {onCancel && (
            <Button type="button" variant="outline" onClick={onCancel}>
              Anulează
            </Button>
          )}
          <Button type="submit" disabled={isSubmitting}>
            {isSubmitting && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            {mode === 'create' ? 'Creează Regulă' : 'Salvează Modificările'}
          </Button>
        </div>
      </form>
    </Form>
  );
}
```

### 5.2 ManualDiscountDialog

```typescript
// components/pricing/ManualDiscountDialog.tsx

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { format, addDays } from 'date-fns';
import { ro } from 'date-fns/locale';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Calendar } from '@/components/ui/calendar';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription } from '@/components/ui/alert';
import {
  CalendarIcon,
  Percent,
  DollarSign,
  AlertTriangle,
  Loader2,
  Tag,
} from 'lucide-react';
import { toast } from 'sonner';
import { cn, formatCurrency } from '@/lib/utils';

// Schema
const manualDiscountSchema = z.object({
  negotiationId: z.string().uuid(),
  productSku: z.string().min(1, 'Selectați un produs'),
  discountType: z.enum(['percentage', 'fixed']),
  discountValue: z.number()
    .positive('Valoarea trebuie să fie pozitivă'),
  reason: z.string()
    .min(10, 'Motivul trebuie să aibă cel puțin 10 caractere')
    .max(500, 'Motivul nu poate depăși 500 caractere'),
  validUntil: z.date().optional(),
}).refine(data => {
  if (data.discountType === 'percentage' && data.discountValue > 100) {
    return false;
  }
  return true;
}, {
  message: 'Procentul nu poate depăși 100%',
  path: ['discountValue'],
});

type ManualDiscountValues = z.infer<typeof manualDiscountSchema>;

interface CartItem {
  sku: string;
  productId: string;
  title: string;
  quantity: number;
  unitPrice: number;
  currentDiscount?: number;
}

interface ManualDiscountDialogProps {
  negotiationId: string;
  cartItems: CartItem[];
  trigger?: React.ReactNode;
  onSuccess?: () => void;
}

export function ManualDiscountDialog({
  negotiationId,
  cartItems,
  trigger,
  onSuccess,
}: ManualDiscountDialogProps) {
  const [open, setOpen] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [previewDiscount, setPreviewDiscount] = useState<{
    originalPrice: number;
    discountAmount: number;
    finalPrice: number;
  } | null>(null);

  const form = useForm<ManualDiscountValues>({
    resolver: zodResolver(manualDiscountSchema),
    defaultValues: {
      negotiationId,
      productSku: '',
      discountType: 'percentage',
      discountValue: 0,
      reason: '',
      validUntil: addDays(new Date(), 7),
    },
  });

  const selectedSku = form.watch('productSku');
  const discountType = form.watch('discountType');
  const discountValue = form.watch('discountValue');

  // Calculate preview when values change
  useEffect(() => {
    if (selectedSku && discountValue > 0) {
      const item = cartItems.find(i => i.sku === selectedSku);
      if (item) {
        const lineTotal = item.unitPrice * item.quantity;
        const discountAmount = discountType === 'percentage'
          ? lineTotal * (discountValue / 100)
          : discountValue * item.quantity;
        setPreviewDiscount({
          originalPrice: lineTotal,
          discountAmount: Math.min(discountAmount, lineTotal),
          finalPrice: Math.max(0, lineTotal - discountAmount),
        });
      }
    } else {
      setPreviewDiscount(null);
    }
  }, [selectedSku, discountType, discountValue, cartItems]);

  async function onSubmit(data: ManualDiscountValues) {
    setIsSubmitting(true);
    try {
      const response = await fetch('/api/v1/pricing/manual-discount', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to apply discount');
      }

      const result = await response.json();
      
      toast.success('Discount aplicat cu succes', {
        description: result.requiresApproval 
          ? 'Discount-ul necesită aprobare și a fost trimis pentru verificare'
          : 'Discount-ul a fost aplicat imediat',
      });

      setOpen(false);
      form.reset();
      onSuccess?.();
    } catch (error) {
      toast.error('Eroare la aplicarea discount-ului', {
        description: error instanceof Error ? error.message : 'Eroare necunoscută',
      });
    } finally {
      setIsSubmitting(false);
    }
  }

  const selectedItem = cartItems.find(i => i.sku === selectedSku);
  const hasExistingDiscount = selectedItem?.currentDiscount && selectedItem.currentDiscount > 0;

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        {trigger || (
          <Button variant="outline" size="sm">
            <Tag className="h-4 w-4 mr-2" />
            Discount Manual
          </Button>
        )}
      </DialogTrigger>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle>Aplică Discount Manual</DialogTitle>
          <DialogDescription>
            Adaugă un discount manual pentru un produs din această negociere.
            Discount-urile mari pot necesita aprobare.
          </DialogDescription>
        </DialogHeader>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            {/* Product Selection */}
            <FormField
              control={form.control}
              name="productSku"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Produs *</FormLabel>
                  <Select
                    value={field.value}
                    onValueChange={field.onChange}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Selectează produsul" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {cartItems.map((item) => (
                        <SelectItem key={item.sku} value={item.sku}>
                          <div className="flex items-center gap-2">
                            <span>{item.title}</span>
                            <Badge variant="outline" className="text-xs">
                              {item.quantity} x {formatCurrency(item.unitPrice)}
                            </Badge>
                            {item.currentDiscount && item.currentDiscount > 0 && (
                              <Badge variant="secondary" className="text-xs">
                                -{item.currentDiscount}%
                              </Badge>
                            )}
                          </div>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            {hasExistingDiscount && (
              <Alert variant="warning">
                <AlertTriangle className="h-4 w-4" />
                <AlertDescription>
                  Acest produs are deja un discount de {selectedItem?.currentDiscount}%.
                  Discount-ul nou îl va înlocui pe cel existent.
                </AlertDescription>
              </Alert>
            )}

            {/* Discount Type & Value */}
            <div className="grid grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="discountType"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Tip Discount *</FormLabel>
                    <Select
                      value={field.value}
                      onValueChange={field.onChange}
                    >
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        <SelectItem value="percentage">
                          <div className="flex items-center gap-2">
                            <Percent className="h-4 w-4" />
                            Procentual
                          </div>
                        </SelectItem>
                        <SelectItem value="fixed">
                          <div className="flex items-center gap-2">
                            <DollarSign className="h-4 w-4" />
                            Sumă fixă / buc
                          </div>
                        </SelectItem>
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="discountValue"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>
                      Valoare {discountType === 'percentage' ? '(%)' : '(RON/buc)'} *
                    </FormLabel>
                    <FormControl>
                      <div className="relative">
                        <Input
                          type="number"
                          step={discountType === 'percentage' ? '0.1' : '0.01'}
                          min="0"
                          max={discountType === 'percentage' ? '100' : undefined}
                          {...field}
                          onChange={(e) => field.onChange(parseFloat(e.target.value) || 0)}
                        />
                        <div className="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground">
                          {discountType === 'percentage' ? '%' : 'RON'}
                        </div>
                      </div>
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            {/* Preview */}
            {previewDiscount && (
              <div className="p-4 bg-muted rounded-lg space-y-2">
                <h4 className="text-sm font-medium">Preview Discount</h4>
                <div className="grid grid-cols-3 gap-4 text-sm">
                  <div>
                    <div className="text-muted-foreground">Preț original</div>
                    <div className="font-medium">
                      {formatCurrency(previewDiscount.originalPrice)}
                    </div>
                  </div>
                  <div>
                    <div className="text-muted-foreground">Discount</div>
                    <div className="font-medium text-red-600">
                      -{formatCurrency(previewDiscount.discountAmount)}
                    </div>
                  </div>
                  <div>
                    <div className="text-muted-foreground">Preț final</div>
                    <div className="font-medium text-green-600">
                      {formatCurrency(previewDiscount.finalPrice)}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Reason */}
            <FormField
              control={form.control}
              name="reason"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Motiv *</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="Explicați motivul acordării acestui discount..."
                      className="resize-none"
                      rows={3}
                      {...field}
                    />
                  </FormControl>
                  <FormDescription>
                    Motivul va fi înregistrat în istoric și poate fi necesar pentru aprobare
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Valid Until */}
            <FormField
              control={form.control}
              name="validUntil"
              render={({ field }) => (
                <FormItem className="flex flex-col">
                  <FormLabel>Valabil până la</FormLabel>
                  <Popover>
                    <PopoverTrigger asChild>
                      <FormControl>
                        <Button
                          variant="outline"
                          className={cn(
                            "pl-3 text-left font-normal",
                            !field.value && "text-muted-foreground"
                          )}
                        >
                          {field.value ? (
                            format(field.value, 'PPP', { locale: ro })
                          ) : (
                            <span>Fără limită</span>
                          )}
                          <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                        </Button>
                      </FormControl>
                    </PopoverTrigger>
                    <PopoverContent className="w-auto p-0" align="start">
                      <Calendar
                        mode="single"
                        selected={field.value}
                        onSelect={field.onChange}
                        disabled={(date) => date < new Date()}
                        locale={ro}
                      />
                    </PopoverContent>
                  </Popover>
                  <FormDescription>
                    Discount-ul expiră la această dată dacă negocierea nu este încheiată
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            <DialogFooter>
              <Button
                type="button"
                variant="outline"
                onClick={() => setOpen(false)}
              >
                Anulează
              </Button>
              <Button type="submit" disabled={isSubmitting}>
                {isSubmitting && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                Aplică Discount
              </Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```

### 5.3 PriceOverrideDialog

```typescript
// components/pricing/PriceOverrideDialog.tsx

import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import {
  Edit3,
  AlertTriangle,
  ArrowRight,
  Loader2,
  ShieldAlert,
  TrendingDown,
  Info,
} from 'lucide-react';
import { toast } from 'sonner';
import { cn, formatCurrency } from '@/lib/utils';

// Schema
const priceOverrideSchema = z.object({
  negotiationId: z.string().uuid(),
  productSku: z.string().min(1, 'Selectați un produs'),
  originalPrice: z.number().positive(),
  newPrice: z.number().positive('Prețul nou trebuie să fie pozitiv'),
  reason: z.string()
    .min(20, 'Motivul trebuie să aibă cel puțin 20 caractere')
    .max(1000, 'Motivul nu poate depăși 1000 caractere'),
  approvalLevel: z.enum(['auto', 'manager', 'director', 'ceo']).optional(),
}).refine(data => data.newPrice < data.originalPrice, {
  message: 'Prețul nou trebuie să fie mai mic decât cel original',
  path: ['newPrice'],
}).refine(data => data.newPrice >= data.originalPrice * 0.5, {
  message: 'Nu se poate reduce prețul cu mai mult de 50%',
  path: ['newPrice'],
});

type PriceOverrideValues = z.infer<typeof priceOverrideSchema>;

interface Product {
  sku: string;
  title: string;
  currentPrice: number;
  minPrice: number;
  costPrice: number;
  quantity: number;
}

interface ApprovalThreshold {
  maxDiscountPercent: number;
  level: 'auto' | 'manager' | 'director' | 'ceo';
  label: string;
}

const approvalThresholds: ApprovalThreshold[] = [
  { maxDiscountPercent: 10, level: 'auto', label: 'Aprobare automată' },
  { maxDiscountPercent: 20, level: 'manager', label: 'Necesită aprobare Manager' },
  { maxDiscountPercent: 35, level: 'director', label: 'Necesită aprobare Director' },
  { maxDiscountPercent: 50, level: 'ceo', label: 'Necesită aprobare CEO' },
];

interface PriceOverrideDialogProps {
  negotiationId: string;
  products: Product[];
  trigger?: React.ReactNode;
  onSuccess?: () => void;
}

export function PriceOverrideDialog({
  negotiationId,
  products,
  trigger,
  onSuccess,
}: PriceOverrideDialogProps) {
  const [open, setOpen] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [analysis, setAnalysis] = useState<{
    discountPercent: number;
    marginPercent: number;
    requiredApproval: ApprovalThreshold;
    profitLoss: number;
    belowMinPrice: boolean;
    belowCost: boolean;
  } | null>(null);

  const form = useForm<PriceOverrideValues>({
    resolver: zodResolver(priceOverrideSchema),
    defaultValues: {
      negotiationId,
      productSku: '',
      originalPrice: 0,
      newPrice: 0,
      reason: '',
    },
  });

  const selectedSku = form.watch('productSku');
  const newPrice = form.watch('newPrice');
  const originalPrice = form.watch('originalPrice');

  // Update original price when product changes
  useEffect(() => {
    if (selectedSku) {
      const product = products.find(p => p.sku === selectedSku);
      if (product) {
        form.setValue('originalPrice', product.currentPrice);
        form.setValue('newPrice', product.currentPrice);
      }
    }
  }, [selectedSku, products, form]);

  // Calculate analysis when prices change
  useEffect(() => {
    if (selectedSku && newPrice > 0 && originalPrice > 0) {
      const product = products.find(p => p.sku === selectedSku);
      if (product) {
        const discountPercent = ((originalPrice - newPrice) / originalPrice) * 100;
        const marginPercent = ((newPrice - product.costPrice) / newPrice) * 100;
        const profitLoss = (originalPrice - newPrice) * product.quantity;
        
        const requiredApproval = approvalThresholds.find(
          t => discountPercent <= t.maxDiscountPercent
        ) || approvalThresholds[approvalThresholds.length - 1];

        setAnalysis({
          discountPercent,
          marginPercent,
          requiredApproval,
          profitLoss,
          belowMinPrice: newPrice < product.minPrice,
          belowCost: newPrice < product.costPrice,
        });
      }
    } else {
      setAnalysis(null);
    }
  }, [selectedSku, newPrice, originalPrice, products]);

  async function onSubmit(data: PriceOverrideValues) {
    setIsSubmitting(true);
    try {
      const response = await fetch('/api/v1/pricing/override', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...data,
          approvalLevel: analysis?.requiredApproval.level,
        }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to override price');
      }

      const result = await response.json();
      
      if (result.requiresApproval) {
        toast.success('Cerere de modificare preț trimisă', {
          description: `Necesită aprobare ${analysis?.requiredApproval.label}`,
        });
      } else {
        toast.success('Preț modificat cu succes');
      }

      setOpen(false);
      form.reset();
      onSuccess?.();
    } catch (error) {
      toast.error('Eroare la modificarea prețului', {
        description: error instanceof Error ? error.message : 'Eroare necunoscută',
      });
    } finally {
      setIsSubmitting(false);
    }
  }

  const selectedProduct = products.find(p => p.sku === selectedSku);

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        {trigger || (
          <Button variant="outline" size="sm">
            <Edit3 className="h-4 w-4 mr-2" />
            Modifică Preț
          </Button>
        )}
      </DialogTrigger>
      <DialogContent className="sm:max-w-[600px]">
        <DialogHeader>
          <DialogTitle>Modificare Preț (Override)</DialogTitle>
          <DialogDescription>
            Setează un preț personalizat pentru un produs în această negociere.
            Modificările semnificative necesită aprobare.
          </DialogDescription>
        </DialogHeader>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            {/* Product Selection */}
            <FormField
              control={form.control}
              name="productSku"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Produs *</FormLabel>
                  <Select
                    value={field.value}
                    onValueChange={field.onChange}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Selectează produsul" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {products.map((product) => (
                        <SelectItem key={product.sku} value={product.sku}>
                          <div className="flex flex-col">
                            <span>{product.title}</span>
                            <span className="text-xs text-muted-foreground">
                              SKU: {product.sku} | Preț: {formatCurrency(product.currentPrice)} | 
                              Qty: {product.quantity}
                            </span>
                          </div>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            {selectedProduct && (
              <>
                {/* Product Info */}
                <div className="p-4 bg-muted rounded-lg grid grid-cols-3 gap-4 text-sm">
                  <div>
                    <div className="text-muted-foreground">Preț curent</div>
                    <div className="font-medium">{formatCurrency(selectedProduct.currentPrice)}</div>
                  </div>
                  <div>
                    <div className="text-muted-foreground">Preț minim</div>
                    <div className="font-medium">{formatCurrency(selectedProduct.minPrice)}</div>
                  </div>
                  <div>
                    <div className="text-muted-foreground">Cost</div>
                    <div className="font-medium">{formatCurrency(selectedProduct.costPrice)}</div>
                  </div>
                </div>

                {/* New Price */}
                <FormField
                  control={form.control}
                  name="newPrice"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Preț Nou *</FormLabel>
                      <FormControl>
                        <div className="flex items-center gap-4">
                          <span className="text-muted-foreground line-through">
                            {formatCurrency(originalPrice)}
                          </span>
                          <ArrowRight className="h-4 w-4 text-muted-foreground" />
                          <div className="relative flex-1">
                            <Input
                              type="number"
                              step="0.01"
                              min={selectedProduct.costPrice * 0.5}
                              max={originalPrice - 0.01}
                              {...field}
                              onChange={(e) => field.onChange(parseFloat(e.target.value) || 0)}
                            />
                            <div className="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground">
                              RON
                            </div>
                          </div>
                        </div>
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                {/* Analysis */}
                {analysis && (
                  <div className="space-y-4">
                    {/* Discount Progress */}
                    <div className="p-4 border rounded-lg space-y-3">
                      <div className="flex items-center justify-between">
                        <span className="text-sm font-medium">Reducere</span>
                        <Badge 
                          variant={analysis.discountPercent > 35 ? 'destructive' : 'secondary'}
                        >
                          -{analysis.discountPercent.toFixed(1)}%
                        </Badge>
                      </div>
                      <Progress 
                        value={Math.min(analysis.discountPercent, 50) * 2} 
                        className={cn(
                          analysis.discountPercent > 35 && "bg-red-100 [&>div]:bg-red-500",
                          analysis.discountPercent > 20 && analysis.discountPercent <= 35 && 
                            "bg-amber-100 [&>div]:bg-amber-500"
                        )}
                      />
                      <div className="flex justify-between text-xs text-muted-foreground">
                        <span>0%</span>
                        <span>10% (auto)</span>
                        <span>20% (mgr)</span>
                        <span>35% (dir)</span>
                        <span>50% (max)</span>
                      </div>
                    </div>

                    {/* Impact Analysis */}
                    <div className="grid grid-cols-2 gap-4">
                      <div className="p-3 border rounded-lg">
                        <div className="text-sm text-muted-foreground">Marjă nouă</div>
                        <div className={cn(
                          "text-lg font-bold",
                          analysis.marginPercent < 10 && "text-red-600",
                          analysis.marginPercent >= 10 && analysis.marginPercent < 20 && "text-amber-600",
                          analysis.marginPercent >= 20 && "text-green-600"
                        )}>
                          {analysis.marginPercent.toFixed(1)}%
                        </div>
                      </div>
                      <div className="p-3 border rounded-lg">
                        <div className="text-sm text-muted-foreground">Impact profit</div>
                        <div className="text-lg font-bold text-red-600">
                          -{formatCurrency(analysis.profitLoss)}
                        </div>
                      </div>
                    </div>

                    {/* Approval Level */}
                    <Alert variant={
                      analysis.requiredApproval.level === 'auto' ? 'default' :
                      analysis.requiredApproval.level === 'ceo' ? 'destructive' : 'warning'
                    }>
                      <ShieldAlert className="h-4 w-4" />
                      <AlertTitle>Nivel Aprobare</AlertTitle>
                      <AlertDescription>
                        {analysis.requiredApproval.label}
                      </AlertDescription>
                    </Alert>

                    {/* Warnings */}
                    {analysis.belowMinPrice && (
                      <Alert variant="warning">
                        <AlertTriangle className="h-4 w-4" />
                        <AlertTitle>Sub prețul minim</AlertTitle>
                        <AlertDescription>
                          Prețul nou este sub prețul minim permis ({formatCurrency(selectedProduct.minPrice)}).
                          Acest lucru necesită justificare suplimentară.
                        </AlertDescription>
                      </Alert>
                    )}

                    {analysis.belowCost && (
                      <Alert variant="destructive">
                        <TrendingDown className="h-4 w-4" />
                        <AlertTitle>Sub preț de cost!</AlertTitle>
                        <AlertDescription>
                          Prețul nou este sub costul produsului ({formatCurrency(selectedProduct.costPrice)}).
                          Această vânzare va genera pierdere directă.
                        </AlertDescription>
                      </Alert>
                    )}
                  </div>
                )}

                {/* Reason */}
                <FormField
                  control={form.control}
                  name="reason"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Justificare *</FormLabel>
                      <FormControl>
                        <Textarea
                          placeholder="Explicați în detaliu motivul acestei modificări de preț. 
Include contextul negocierii, potențialul clientului și beneficiile strategice..."
                          className="resize-none"
                          rows={4}
                          {...field}
                        />
                      </FormControl>
                      <FormDescription>
                        Minimum 20 caractere. O justificare detaliată accelerează procesul de aprobare.
                      </FormDescription>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </>
            )}

            <DialogFooter>
              <Button
                type="button"
                variant="outline"
                onClick={() => setOpen(false)}
              >
                Anulează
              </Button>
              <Button 
                type="submit" 
                disabled={isSubmitting || !analysis}
                variant={analysis?.belowCost ? 'destructive' : 'default'}
              >
                {isSubmitting && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                {analysis?.requiredApproval.level === 'auto' 
                  ? 'Aplică Modificarea' 
                  : 'Trimite pentru Aprobare'
                }
              </Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```

---

## 6. Documente Forms

### 6.1 ProformaCreateForm

```typescript
// components/documents/ProformaCreateForm.tsx

import { useState, useEffect } from 'react';
import { useForm, useFieldArray } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { format, addDays } from 'date-fns';
import { ro } from 'date-fns/locale';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Calendar } from '@/components/ui/calendar';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  Table,
  TableBody,
  TableCell,
  TableFooter,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import {
  CalendarIcon,
  Plus,
  Trash2,
  FileText,
  Building2,
  Calculator,
  Loader2,
  Download,
  Send,
} from 'lucide-react';
import { toast } from 'sonner';
import { cn, formatCurrency, formatCUI } from '@/lib/utils';

// Line item schema
const lineItemSchema = z.object({
  productId: z.string().uuid().optional(),
  sku: z.string().min(1),
  description: z.string().min(1, 'Descrierea este obligatorie'),
  quantity: z.number().int().positive('Cantitatea trebuie să fie pozitivă'),
  unit: z.string().default('buc'),
  unitPriceNet: z.number().positive('Prețul trebuie să fie pozitiv'),
  vatRate: z.number().min(0).max(100),
  discount: z.number().min(0).max(100).default(0),
});

// Main schema
const proformaCreateSchema = z.object({
  negotiationId: z.string().uuid(),
  // Client details
  clientCui: z.string().min(1, 'CUI-ul este obligatoriu'),
  clientName: z.string().min(1, 'Numele companiei este obligatoriu'),
  clientAddress: z.string().min(1, 'Adresa este obligatorie'),
  clientEmail: z.string().email('Email invalid').optional(),
  clientPhone: z.string().optional(),
  clientRegCom: z.string().optional(),
  clientBank: z.string().optional(),
  clientIban: z.string().optional(),
  // Document details
  series: z.string().default('PF'),
  issueDate: z.date(),
  dueDate: z.date(),
  validUntil: z.date(),
  currency: z.enum(['RON', 'EUR', 'USD']).default('RON'),
  exchangeRate: z.number().positive().optional(),
  // Payment
  paymentTerms: z.enum(['advance', 'on_delivery', 'net_15', 'net_30', 'net_45', 'net_60']),
  paymentMethod: z.enum(['transfer', 'cash', 'card']).default('transfer'),
  // Lines
  items: z.array(lineItemSchema).min(1, 'Adăugați cel puțin un produs'),
  // Notes
  notes: z.string().max(2000).optional(),
  internalNotes: z.string().max(1000).optional(),
}).refine(data => data.dueDate >= data.issueDate, {
  message: 'Data scadenței nu poate fi înainte de data emiterii',
  path: ['dueDate'],
}).refine(data => data.validUntil >= data.issueDate, {
  message: 'Data valabilității nu poate fi înainte de data emiterii',
  path: ['validUntil'],
});

type ProformaCreateValues = z.infer<typeof proformaCreateSchema>;

interface NegotiationData {
  id: string;
  client: {
    cui: string;
    name: string;
    email?: string;
    phone?: string;
    address?: {
      street: string;
      city: string;
      county: string;
      postalCode?: string;
    };
    regCom?: string;
    bank?: string;
    iban?: string;
  };
  cart: Array<{
    productId: string;
    sku: string;
    title: string;
    quantity: number;
    unitPrice: number;
    discount: number;
    vatRate: number;
  }>;
}

interface ProformaCreateFormProps {
  negotiation: NegotiationData;
  onSuccess?: (proformaId: string) => void;
  onCancel?: () => void;
}

const paymentTermsLabels: Record<string, string> = {
  advance: 'Plată în avans',
  on_delivery: 'La livrare',
  net_15: '15 zile',
  net_30: '30 zile',
  net_45: '45 zile',
  net_60: '60 zile',
};

const unitOptions = ['buc', 'kg', 'l', 't', 'm', 'mp', 'mc', 'set', 'palet'];

export function ProformaCreateForm({
  negotiation,
  onSuccess,
  onCancel,
}: ProformaCreateFormProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [action, setAction] = useState<'save' | 'download' | 'send'>('save');

  // Format address
  const formatAddress = (addr?: typeof negotiation.client.address) => {
    if (!addr) return '';
    return [addr.street, addr.city, addr.county, addr.postalCode]
      .filter(Boolean)
      .join(', ');
  };

  const form = useForm<ProformaCreateValues>({
    resolver: zodResolver(proformaCreateSchema),
    defaultValues: {
      negotiationId: negotiation.id,
      clientCui: negotiation.client.cui,
      clientName: negotiation.client.name,
      clientAddress: formatAddress(negotiation.client.address),
      clientEmail: negotiation.client.email || '',
      clientPhone: negotiation.client.phone || '',
      clientRegCom: negotiation.client.regCom || '',
      clientBank: negotiation.client.bank || '',
      clientIban: negotiation.client.iban || '',
      series: 'PF',
      issueDate: new Date(),
      dueDate: addDays(new Date(), 30),
      validUntil: addDays(new Date(), 14),
      currency: 'RON',
      paymentTerms: 'net_30',
      paymentMethod: 'transfer',
      items: negotiation.cart.map(item => ({
        productId: item.productId,
        sku: item.sku,
        description: item.title,
        quantity: item.quantity,
        unit: 'buc',
        unitPriceNet: item.unitPrice,
        vatRate: item.vatRate,
        discount: item.discount,
      })),
      notes: '',
      internalNotes: '',
    },
  });

  const { fields: itemFields, append: appendItem, remove: removeItem } = 
    useFieldArray({
      control: form.control,
      name: 'items',
    });

  // Watch items for totals calculation
  const items = form.watch('items');
  const currency = form.watch('currency');

  // Calculate totals
  const totals = useMemo(() => {
    let subtotalNet = 0;
    let totalDiscount = 0;
    let totalVat = 0;

    items.forEach(item => {
      const lineNet = item.unitPriceNet * item.quantity;
      const lineDiscount = lineNet * (item.discount / 100);
      const lineNetAfterDiscount = lineNet - lineDiscount;
      const lineVat = lineNetAfterDiscount * (item.vatRate / 100);

      subtotalNet += lineNet;
      totalDiscount += lineDiscount;
      totalVat += lineVat;
    });

    return {
      subtotalNet,
      totalDiscount,
      netAfterDiscount: subtotalNet - totalDiscount,
      totalVat,
      grandTotal: subtotalNet - totalDiscount + totalVat,
    };
  }, [items]);

  async function onSubmit(data: ProformaCreateValues) {
    setIsSubmitting(true);
    try {
      const response = await fetch('/api/v1/documents/proforma', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...data,
          action,
        }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to create proforma');
      }

      const result = await response.json();

      if (action === 'download') {
        // Trigger download
        window.open(result.downloadUrl, '_blank');
        toast.success('Proformă generată și descărcată');
      } else if (action === 'send') {
        toast.success('Proformă trimisă clientului', {
          description: `Email trimis la ${data.clientEmail}`,
        });
      } else {
        toast.success('Proformă salvată cu succes');
      }

      onSuccess?.(result.id);
    } catch (error) {
      toast.error('Eroare la crearea proformei', {
        description: error instanceof Error ? error.message : 'Eroare necunoscută',
      });
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
        {/* Client Information */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Building2 className="h-5 w-5" />
              Date Client
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="clientCui"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>CUI *</FormLabel>
                    <FormControl>
                      <Input {...field} disabled />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="clientName"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Denumire *</FormLabel>
                    <FormControl>
                      <Input {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <FormField
              control={form.control}
              name="clientAddress"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Adresă *</FormLabel>
                  <FormControl>
                    <Textarea rows={2} {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="grid grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="clientEmail"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Email</FormLabel>
                    <FormControl>
                      <Input type="email" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="clientPhone"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Telefon</FormLabel>
                    <FormControl>
                      <Input {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <div className="grid grid-cols-3 gap-4">
              <FormField
                control={form.control}
                name="clientRegCom"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Nr. Reg. Com.</FormLabel>
                    <FormControl>
                      <Input placeholder="J40/123/2020" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="clientBank"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Bancă</FormLabel>
                    <FormControl>
                      <Input placeholder="Banca Transilvania" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="clientIban"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>IBAN</FormLabel>
                    <FormControl>
                      <Input placeholder="RO49AAAA1B31007593840000" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
          </CardContent>
        </Card>

        {/* Document Details */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <FileText className="h-5 w-5" />
              Detalii Document
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-4 gap-4">
              <FormField
                control={form.control}
                name="series"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Serie</FormLabel>
                    <FormControl>
                      <Input {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="issueDate"
                render={({ field }) => (
                  <FormItem className="flex flex-col">
                    <FormLabel>Data Emiterii *</FormLabel>
                    <Popover>
                      <PopoverTrigger asChild>
                        <FormControl>
                          <Button variant="outline" className="pl-3 text-left font-normal">
                            {format(field.value, 'dd.MM.yyyy', { locale: ro })}
                            <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                          </Button>
                        </FormControl>
                      </PopoverTrigger>
                      <PopoverContent className="w-auto p-0" align="start">
                        <Calendar
                          mode="single"
                          selected={field.value}
                          onSelect={field.onChange}
                          locale={ro}
                        />
                      </PopoverContent>
                    </Popover>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="dueDate"
                render={({ field }) => (
                  <FormItem className="flex flex-col">
                    <FormLabel>Scadență *</FormLabel>
                    <Popover>
                      <PopoverTrigger asChild>
                        <FormControl>
                          <Button variant="outline" className="pl-3 text-left font-normal">
                            {format(field.value, 'dd.MM.yyyy', { locale: ro })}
                            <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                          </Button>
                        </FormControl>
                      </PopoverTrigger>
                      <PopoverContent className="w-auto p-0" align="start">
                        <Calendar
                          mode="single"
                          selected={field.value}
                          onSelect={field.onChange}
                          disabled={(date) => date < form.watch('issueDate')}
                          locale={ro}
                        />
                      </PopoverContent>
                    </Popover>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="validUntil"
                render={({ field }) => (
                  <FormItem className="flex flex-col">
                    <FormLabel>Valabil până la *</FormLabel>
                    <Popover>
                      <PopoverTrigger asChild>
                        <FormControl>
                          <Button variant="outline" className="pl-3 text-left font-normal">
                            {format(field.value, 'dd.MM.yyyy', { locale: ro })}
                            <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                          </Button>
                        </FormControl>
                      </PopoverTrigger>
                      <PopoverContent className="w-auto p-0" align="start">
                        <Calendar
                          mode="single"
                          selected={field.value}
                          onSelect={field.onChange}
                          disabled={(date) => date < form.watch('issueDate')}
                          locale={ro}
                        />
                      </PopoverContent>
                    </Popover>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <div className="grid grid-cols-3 gap-4">
              <FormField
                control={form.control}
                name="currency"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Monedă</FormLabel>
                    <Select
                      value={field.value}
                      onValueChange={field.onChange}
                    >
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        <SelectItem value="RON">RON</SelectItem>
                        <SelectItem value="EUR">EUR</SelectItem>
                        <SelectItem value="USD">USD</SelectItem>
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="paymentTerms"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Termen Plată</FormLabel>
                    <Select
                      value={field.value}
                      onValueChange={field.onChange}
                    >
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {Object.entries(paymentTermsLabels).map(([value, label]) => (
                          <SelectItem key={value} value={value}>
                            {label}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="paymentMethod"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Metodă Plată</FormLabel>
                    <Select
                      value={field.value}
                      onValueChange={field.onChange}
                    >
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        <SelectItem value="transfer">Transfer bancar</SelectItem>
                        <SelectItem value="cash">Numerar</SelectItem>
                        <SelectItem value="card">Card</SelectItem>
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
          </CardContent>
        </Card>

        {/* Line Items */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between">
            <CardTitle className="flex items-center gap-2">
              <Calculator className="h-5 w-5" />
              Produse / Servicii
            </CardTitle>
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={() => appendItem({
                productId: undefined,
                sku: '',
                description: '',
                quantity: 1,
                unit: 'buc',
                unitPriceNet: 0,
                vatRate: 19,
                discount: 0,
              })}
            >
              <Plus className="h-4 w-4 mr-1" />
              Adaugă Linie
            </Button>
          </CardHeader>
          <CardContent>
            <ScrollArea className="w-full">
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead className="w-[80px]">SKU</TableHead>
                    <TableHead className="min-w-[200px]">Descriere</TableHead>
                    <TableHead className="w-[80px]">Cant.</TableHead>
                    <TableHead className="w-[80px]">UM</TableHead>
                    <TableHead className="w-[100px]">Preț Net</TableHead>
                    <TableHead className="w-[80px]">TVA %</TableHead>
                    <TableHead className="w-[80px]">Disc %</TableHead>
                    <TableHead className="w-[100px] text-right">Total</TableHead>
                    <TableHead className="w-[50px]"></TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {itemFields.map((field, index) => {
                    const item = items[index];
                    const lineNet = (item?.unitPriceNet || 0) * (item?.quantity || 0);
                    const lineDiscount = lineNet * ((item?.discount || 0) / 100);
                    const lineNetAfterDiscount = lineNet - lineDiscount;
                    const lineVat = lineNetAfterDiscount * ((item?.vatRate || 0) / 100);
                    const lineTotal = lineNetAfterDiscount + lineVat;

                    return (
                      <TableRow key={field.id}>
                        <TableCell>
                          <FormField
                            control={form.control}
                            name={`items.${index}.sku`}
                            render={({ field }) => (
                              <FormItem>
                                <FormControl>
                                  <Input className="h-8 text-xs" {...field} />
                                </FormControl>
                              </FormItem>
                            )}
                          />
                        </TableCell>
                        <TableCell>
                          <FormField
                            control={form.control}
                            name={`items.${index}.description`}
                            render={({ field }) => (
                              <FormItem>
                                <FormControl>
                                  <Input className="h-8" {...field} />
                                </FormControl>
                              </FormItem>
                            )}
                          />
                        </TableCell>
                        <TableCell>
                          <FormField
                            control={form.control}
                            name={`items.${index}.quantity`}
                            render={({ field }) => (
                              <FormItem>
                                <FormControl>
                                  <Input 
                                    type="number" 
                                    min="1" 
                                    className="h-8 w-16" 
                                    {...field}
                                    onChange={(e) => field.onChange(parseInt(e.target.value) || 1)}
                                  />
                                </FormControl>
                              </FormItem>
                            )}
                          />
                        </TableCell>
                        <TableCell>
                          <FormField
                            control={form.control}
                            name={`items.${index}.unit`}
                            render={({ field }) => (
                              <FormItem>
                                <Select
                                  value={field.value}
                                  onValueChange={field.onChange}
                                >
                                  <FormControl>
                                    <SelectTrigger className="h-8 w-20">
                                      <SelectValue />
                                    </SelectTrigger>
                                  </FormControl>
                                  <SelectContent>
                                    {unitOptions.map(unit => (
                                      <SelectItem key={unit} value={unit}>
                                        {unit}
                                      </SelectItem>
                                    ))}
                                  </SelectContent>
                                </Select>
                              </FormItem>
                            )}
                          />
                        </TableCell>
                        <TableCell>
                          <FormField
                            control={form.control}
                            name={`items.${index}.unitPriceNet`}
                            render={({ field }) => (
                              <FormItem>
                                <FormControl>
                                  <Input 
                                    type="number" 
                                    step="0.01" 
                                    min="0" 
                                    className="h-8 w-24" 
                                    {...field}
                                    onChange={(e) => field.onChange(parseFloat(e.target.value) || 0)}
                                  />
                                </FormControl>
                              </FormItem>
                            )}
                          />
                        </TableCell>
                        <TableCell>
                          <FormField
                            control={form.control}
                            name={`items.${index}.vatRate`}
                            render={({ field }) => (
                              <FormItem>
                                <Select
                                  value={String(field.value)}
                                  onValueChange={(v) => field.onChange(parseFloat(v))}
                                >
                                  <FormControl>
                                    <SelectTrigger className="h-8 w-16">
                                      <SelectValue />
                                    </SelectTrigger>
                                  </FormControl>
                                  <SelectContent>
                                    <SelectItem value="0">0%</SelectItem>
                                    <SelectItem value="5">5%</SelectItem>
                                    <SelectItem value="9">9%</SelectItem>
                                    <SelectItem value="19">19%</SelectItem>
                                  </SelectContent>
                                </Select>
                              </FormItem>
                            )}
                          />
                        </TableCell>
                        <TableCell>
                          <FormField
                            control={form.control}
                            name={`items.${index}.discount`}
                            render={({ field }) => (
                              <FormItem>
                                <FormControl>
                                  <Input 
                                    type="number" 
                                    step="0.1" 
                                    min="0" 
                                    max="100"
                                    className="h-8 w-16" 
                                    {...field}
                                    onChange={(e) => field.onChange(parseFloat(e.target.value) || 0)}
                                  />
                                </FormControl>
                              </FormItem>
                            )}
                          />
                        </TableCell>
                        <TableCell className="text-right font-medium">
                          {formatCurrency(lineTotal, currency)}
                        </TableCell>
                        <TableCell>
                          <Button
                            type="button"
                            variant="ghost"
                            size="icon"
                            className="h-8 w-8"
                            onClick={() => removeItem(index)}
                            disabled={itemFields.length === 1}
                          >
                            <Trash2 className="h-4 w-4 text-destructive" />
                          </Button>
                        </TableCell>
                      </TableRow>
                    );
                  })}
                </TableBody>
                <TableFooter>
                  <TableRow>
                    <TableCell colSpan={7} className="text-right font-medium">
                      Subtotal (fără TVA):
                    </TableCell>
                    <TableCell className="text-right font-medium">
                      {formatCurrency(totals.subtotalNet, currency)}
                    </TableCell>
                    <TableCell />
                  </TableRow>
                  {totals.totalDiscount > 0 && (
                    <TableRow>
                      <TableCell colSpan={7} className="text-right font-medium text-red-600">
                        Discount total:
                      </TableCell>
                      <TableCell className="text-right font-medium text-red-600">
                        -{formatCurrency(totals.totalDiscount, currency)}
                      </TableCell>
                      <TableCell />
                    </TableRow>
                  )}
                  <TableRow>
                    <TableCell colSpan={7} className="text-right font-medium">
                      TVA total:
                    </TableCell>
                    <TableCell className="text-right font-medium">
                      {formatCurrency(totals.totalVat, currency)}
                    </TableCell>
                    <TableCell />
                  </TableRow>
                  <TableRow className="bg-muted">
                    <TableCell colSpan={7} className="text-right font-bold text-lg">
                      TOTAL:
                    </TableCell>
                    <TableCell className="text-right font-bold text-lg">
                      {formatCurrency(totals.grandTotal, currency)}
                    </TableCell>
                    <TableCell />
                  </TableRow>
                </TableFooter>
              </Table>
            </ScrollArea>
          </CardContent>
        </Card>

        {/* Notes */}
        <Card>
          <CardHeader>
            <CardTitle>Note</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="notes"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Note pentru client</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="Observații, condiții de livrare, garanții..."
                      rows={3}
                      {...field}
                    />
                  </FormControl>
                  <FormDescription>
                    Vor apărea pe document
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="internalNotes"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Note interne</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="Note vizibile doar intern..."
                      rows={2}
                      {...field}
                    />
                  </FormControl>
                  <FormDescription>
                    Nu vor apărea pe document
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />
          </CardContent>
        </Card>

        {/* Actions */}
        <div className="flex justify-between">
          {onCancel && (
            <Button type="button" variant="outline" onClick={onCancel}>
              Anulează
            </Button>
          )}
          
          <div className="flex gap-2 ml-auto">
            <Button
              type="submit"
              variant="outline"
              disabled={isSubmitting}
              onClick={() => setAction('save')}
            >
              {isSubmitting && action === 'save' && (
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
              )}
              Salvează Draft
            </Button>
            <Button
              type="submit"
              variant="outline"
              disabled={isSubmitting}
              onClick={() => setAction('download')}
            >
              {isSubmitting && action === 'download' && (
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
              )}
              <Download className="h-4 w-4 mr-2" />
              Descarcă PDF
            </Button>
            <Button
              type="submit"
              disabled={isSubmitting || !form.watch('clientEmail')}
              onClick={() => setAction('send')}
            >
              {isSubmitting && action === 'send' && (
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
              )}
              <Send className="h-4 w-4 mr-2" />
              Trimite Clientului
            </Button>
          </div>
        </div>
      </form>
    </Form>
  );
}
```

### 6.2 InvoiceConvertDialog

```typescript
// components/documents/InvoiceConvertDialog.tsx

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { format, addDays } from 'date-fns';
import { ro } from 'date-fns/locale';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Calendar } from '@/components/ui/calendar';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Separator } from '@/components/ui/separator';
import {
  CalendarIcon,
  FileText,
  ArrowRight,
  AlertTriangle,
  Loader2,
  Receipt,
  Info,
} from 'lucide-react';
import { toast } from 'sonner';
import { cn, formatCurrency } from '@/lib/utils';

// Schema
const invoiceConvertSchema = z.object({
  proformaId: z.string().uuid(),
  invoiceSeries: z.string().min(1, 'Seria este obligatorie'),
  invoiceNumber: z.string().optional(), // Auto-generated if empty
  issueDate: z.date(),
  dueDate: z.date(),
  deliveryDate: z.date().optional(),
  sendToEFactura: z.boolean().default(true),
  sendToClient: z.boolean().default(true),
  createOblioEntry: z.boolean().default(true),
  adjustPrices: z.boolean().default(false),
  partialInvoice: z.boolean().default(false),
  invoicePercent: z.number().min(1).max(100).default(100),
}).refine(data => data.dueDate >= data.issueDate, {
  message: 'Data scadenței nu poate fi înainte de data emiterii',
  path: ['dueDate'],
});

type InvoiceConvertValues = z.infer<typeof invoiceConvertSchema>;

interface ProformaData {
  id: string;
  series: string;
  number: string;
  issueDate: Date;
  clientName: string;
  clientCui: string;
  clientEmail?: string;
  clientIsVatPayer: boolean;
  totalNet: number;
  totalVat: number;
  grandTotal: number;
  currency: string;
  items: Array<{
    description: string;
    quantity: number;
    unitPrice: number;
    total: number;
  }>;
  eFacturaRequired: boolean;
}

interface InvoiceConvertDialogProps {
  proforma: ProformaData;
  defaultSeries?: string;
  trigger?: React.ReactNode;
  onSuccess?: (invoiceId: string) => void;
}

export function InvoiceConvertDialog({
  proforma,
  defaultSeries = 'FC',
  trigger,
  onSuccess,
}: InvoiceConvertDialogProps) {
  const [open, setOpen] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [warnings, setWarnings] = useState<string[]>([]);

  const form = useForm<InvoiceConvertValues>({
    resolver: zodResolver(invoiceConvertSchema),
    defaultValues: {
      proformaId: proforma.id,
      invoiceSeries: defaultSeries,
      invoiceNumber: '',
      issueDate: new Date(),
      dueDate: addDays(new Date(), 30),
      deliveryDate: new Date(),
      sendToEFactura: proforma.eFacturaRequired,
      sendToClient: !!proforma.clientEmail,
      createOblioEntry: true,
      adjustPrices: false,
      partialInvoice: false,
      invoicePercent: 100,
    },
  });

  const partialInvoice = form.watch('partialInvoice');
  const invoicePercent = form.watch('invoicePercent');
  const sendToEFactura = form.watch('sendToEFactura');

  // Calculate partial amounts
  const partialAmount = partialInvoice 
    ? {
        net: proforma.totalNet * (invoicePercent / 100),
        vat: proforma.totalVat * (invoicePercent / 100),
        total: proforma.grandTotal * (invoicePercent / 100),
      }
    : {
        net: proforma.totalNet,
        vat: proforma.totalVat,
        total: proforma.grandTotal,
      };

  // Validate and show warnings
  useEffect(() => {
    const newWarnings: string[] = [];

    if (proforma.eFacturaRequired && !sendToEFactura) {
      newWarnings.push('Clientul este plătitor de TVA, e-Factura este obligatorie.');
    }

    if (partialInvoice && invoicePercent < 100) {
      newWarnings.push(`Se va factura doar ${invoicePercent}% din proformă.`);
    }

    setWarnings(newWarnings);
  }, [proforma, sendToEFactura, partialInvoice, invoicePercent]);

  async function onSubmit(data: InvoiceConvertValues) {
    setIsSubmitting(true);
    try {
      const response = await fetch('/api/v1/documents/invoice/from-proforma', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to create invoice');
      }

      const result = await response.json();

      toast.success('Factură creată cu succes', {
        description: `Factură ${result.series}${result.number}`,
      });

      if (result.eFacturaStatus) {
        if (result.eFacturaStatus === 'uploaded') {
          toast.info('e-Factura trimisă la ANAF');
        } else if (result.eFacturaStatus === 'error') {
          toast.error('Eroare la trimiterea e-Factura', {
            description: result.eFacturaError,
          });
        }
      }

      setOpen(false);
      form.reset();
      onSuccess?.(result.id);
    } catch (error) {
      toast.error('Eroare la crearea facturii', {
        description: error instanceof Error ? error.message : 'Eroare necunoscută',
      });
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        {trigger || (
          <Button>
            <Receipt className="h-4 w-4 mr-2" />
            Convertește în Factură
          </Button>
        )}
      </DialogTrigger>
      <DialogContent className="sm:max-w-[550px]">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <FileText className="h-5 w-5" />
            <ArrowRight className="h-4 w-4" />
            <Receipt className="h-5 w-5" />
            Convertește Proformă în Factură
          </DialogTitle>
          <DialogDescription>
            Creează o factură fiscală din proforma {proforma.series}{proforma.number}
          </DialogDescription>
        </DialogHeader>

        {/* Proforma Summary */}
        <div className="p-4 bg-muted rounded-lg space-y-2">
          <div className="flex justify-between items-center">
            <span className="text-sm text-muted-foreground">Proformă</span>
            <Badge variant="outline">{proforma.series}{proforma.number}</Badge>
          </div>
          <div className="flex justify-between items-center">
            <span className="text-sm text-muted-foreground">Client</span>
            <span className="text-sm font-medium">{proforma.clientName}</span>
          </div>
          <div className="flex justify-between items-center">
            <span className="text-sm text-muted-foreground">CUI</span>
            <span className="text-sm">{proforma.clientCui}</span>
          </div>
          <Separator className="my-2" />
          <div className="flex justify-between items-center">
            <span className="text-sm text-muted-foreground">Total Net</span>
            <span className="text-sm">{formatCurrency(partialAmount.net, proforma.currency)}</span>
          </div>
          <div className="flex justify-between items-center">
            <span className="text-sm text-muted-foreground">TVA</span>
            <span className="text-sm">{formatCurrency(partialAmount.vat, proforma.currency)}</span>
          </div>
          <div className="flex justify-between items-center font-bold">
            <span>Total</span>
            <span>{formatCurrency(partialAmount.total, proforma.currency)}</span>
          </div>
        </div>

        {/* Warnings */}
        {warnings.length > 0 && (
          <Alert variant="warning">
            <AlertTriangle className="h-4 w-4" />
            <AlertTitle>Atenție</AlertTitle>
            <AlertDescription>
              <ul className="list-disc list-inside">
                {warnings.map((warning, i) => (
                  <li key={i}>{warning}</li>
                ))}
              </ul>
            </AlertDescription>
          </Alert>
        )}

        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            {/* Invoice Series & Number */}
            <div className="grid grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="invoiceSeries"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Serie Factură *</FormLabel>
                    <FormControl>
                      <Input {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="invoiceNumber"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Număr</FormLabel>
                    <FormControl>
                      <Input placeholder="Auto-generat" {...field} />
                    </FormControl>
                    <FormDescription>
                      Lăsați gol pentru auto-generare
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            {/* Dates */}
            <div className="grid grid-cols-3 gap-4">
              <FormField
                control={form.control}
                name="issueDate"
                render={({ field }) => (
                  <FormItem className="flex flex-col">
                    <FormLabel>Data Emiterii *</FormLabel>
                    <Popover>
                      <PopoverTrigger asChild>
                        <FormControl>
                          <Button variant="outline" className="pl-3 text-left font-normal">
                            {format(field.value, 'dd.MM.yy', { locale: ro })}
                            <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                          </Button>
                        </FormControl>
                      </PopoverTrigger>
                      <PopoverContent className="w-auto p-0" align="start">
                        <Calendar
                          mode="single"
                          selected={field.value}
                          onSelect={field.onChange}
                          locale={ro}
                        />
                      </PopoverContent>
                    </Popover>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="dueDate"
                render={({ field }) => (
                  <FormItem className="flex flex-col">
                    <FormLabel>Scadență *</FormLabel>
                    <Popover>
                      <PopoverTrigger asChild>
                        <FormControl>
                          <Button variant="outline" className="pl-3 text-left font-normal">
                            {format(field.value, 'dd.MM.yy', { locale: ro })}
                            <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                          </Button>
                        </FormControl>
                      </PopoverTrigger>
                      <PopoverContent className="w-auto p-0" align="start">
                        <Calendar
                          mode="single"
                          selected={field.value}
                          onSelect={field.onChange}
                          disabled={(date) => date < form.watch('issueDate')}
                          locale={ro}
                        />
                      </PopoverContent>
                    </Popover>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="deliveryDate"
                render={({ field }) => (
                  <FormItem className="flex flex-col">
                    <FormLabel>Data Livrării</FormLabel>
                    <Popover>
                      <PopoverTrigger asChild>
                        <FormControl>
                          <Button variant="outline" className="pl-3 text-left font-normal">
                            {field.value 
                              ? format(field.value, 'dd.MM.yy', { locale: ro })
                              : <span className="text-muted-foreground">Opțional</span>
                            }
                            <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                          </Button>
                        </FormControl>
                      </PopoverTrigger>
                      <PopoverContent className="w-auto p-0" align="start">
                        <Calendar
                          mode="single"
                          selected={field.value}
                          onSelect={field.onChange}
                          locale={ro}
                        />
                      </PopoverContent>
                    </Popover>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            {/* Partial Invoice */}
            <div className="space-y-4 p-4 border rounded-lg">
              <FormField
                control={form.control}
                name="partialInvoice"
                render={({ field }) => (
                  <FormItem className="flex items-center gap-2">
                    <FormControl>
                      <Checkbox
                        checked={field.value}
                        onCheckedChange={field.onChange}
                      />
                    </FormControl>
                    <FormLabel className="!mt-0">Facturare parțială</FormLabel>
                  </FormItem>
                )}
              />

              {partialInvoice && (
                <FormField
                  control={form.control}
                  name="invoicePercent"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Procent de facturat</FormLabel>
                      <FormControl>
                        <div className="flex items-center gap-2">
                          <Input
                            type="number"
                            min="1"
                            max="100"
                            className="w-24"
                            {...field}
                            onChange={(e) => field.onChange(parseInt(e.target.value) || 100)}
                          />
                          <span>%</span>
                          <span className="text-sm text-muted-foreground">
                            = {formatCurrency(proforma.grandTotal * (field.value / 100), proforma.currency)}
                          </span>
                        </div>
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              )}
            </div>

            {/* Options */}
            <div className="space-y-4">
              <FormField
                control={form.control}
                name="sendToEFactura"
                render={({ field }) => (
                  <FormItem className="flex items-center justify-between rounded-lg border p-4">
                    <div className="space-y-0.5">
                      <FormLabel>Trimite la e-Factura</FormLabel>
                      <FormDescription>
                        {proforma.eFacturaRequired 
                          ? 'Obligatoriu pentru plătitori de TVA'
                          : 'Opțional pentru non-plătitori de TVA'
                        }
                      </FormDescription>
                    </div>
                    <FormControl>
                      <Checkbox
                        checked={field.value}
                        onCheckedChange={field.onChange}
                        disabled={proforma.eFacturaRequired}
                      />
                    </FormControl>
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="sendToClient"
                render={({ field }) => (
                  <FormItem className="flex items-center justify-between rounded-lg border p-4">
                    <div className="space-y-0.5">
                      <FormLabel>Trimite clientului</FormLabel>
                      <FormDescription>
                        {proforma.clientEmail 
                          ? `Se va trimite la ${proforma.clientEmail}`
                          : 'Email client nedisponibil'
                        }
                      </FormDescription>
                    </div>
                    <FormControl>
                      <Checkbox
                        checked={field.value}
                        onCheckedChange={field.onChange}
                        disabled={!proforma.clientEmail}
                      />
                    </FormControl>
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="createOblioEntry"
                render={({ field }) => (
                  <FormItem className="flex items-center justify-between rounded-lg border p-4">
                    <div className="space-y-0.5">
                      <FormLabel>Creează în Oblio</FormLabel>
                      <FormDescription>
                        Sincronizează automat cu sistemul de contabilitate
                      </FormDescription>
                    </div>
                    <FormControl>
                      <Checkbox
                        checked={field.value}
                        onCheckedChange={field.onChange}
                      />
                    </FormControl>
                  </FormItem>
                )}
              />
            </div>

            <DialogFooter>
              <Button
                type="button"
                variant="outline"
                onClick={() => setOpen(false)}
              >
                Anulează
              </Button>
              <Button type="submit" disabled={isSubmitting}>
                {isSubmitting && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                Creează Factură
              </Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```

### 6.3 EFacturaSendDialog

```typescript
// components/documents/EFacturaSendDialog.tsx

import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { format, differenceInHours } from 'date-fns';
import { ro } from 'date-fns/locale';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Progress } from '@/components/ui/progress';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from '@/components/ui/accordion';
import {
  Send,
  CheckCircle,
  XCircle,
  AlertTriangle,
  Clock,
  Loader2,
  FileCode,
  RefreshCw,
  Info,
  Shield,
} from 'lucide-react';
import { toast } from 'sonner';
import { cn, formatCurrency } from '@/lib/utils';

// Schema
const eFacturaSendSchema = z.object({
  invoiceId: z.string().uuid(),
  validateBeforeSend: z.boolean().default(true),
  skipWarnings: z.boolean().default(false),
  retryOnError: z.boolean().default(true),
});

type EFacturaSendValues = z.infer<typeof eFacturaSendSchema>;

interface ValidationResult {
  valid: boolean;
  errors: Array<{
    code: string;
    message: string;
    field?: string;
    severity: 'error' | 'warning';
  }>;
  xmlPreview?: string;
}

interface InvoiceData {
  id: string;
  series: string;
  number: string;
  issueDate: Date;
  clientName: string;
  clientCui: string;
  grandTotal: number;
  currency: string;
  eFacturaStatus: 'not_submitted' | 'pending' | 'uploaded' | 'processing' | 'accepted' | 'rejected' | 'error';
  eFacturaDeadline?: Date;
  lastError?: string;
}

interface EFacturaSendDialogProps {
  invoice: InvoiceData;
  trigger?: React.ReactNode;
  onSuccess?: (result: { indexUpload: string }) => void;
}

export function EFacturaSendDialog({
  invoice,
  trigger,
  onSuccess,
}: EFacturaSendDialogProps) {
  const [open, setOpen] = useState(false);
  const [step, setStep] = useState<'validate' | 'confirm' | 'sending' | 'result'>('validate');
  const [validation, setValidation] = useState<ValidationResult | null>(null);
  const [isValidating, setIsValidating] = useState(false);
  const [isSending, setIsSending] = useState(false);
  const [sendResult, setSendResult] = useState<{
    success: boolean;
    indexUpload?: string;
    error?: string;
  } | null>(null);

  const form = useForm<EFacturaSendValues>({
    resolver: zodResolver(eFacturaSendSchema),
    defaultValues: {
      invoiceId: invoice.id,
      validateBeforeSend: true,
      skipWarnings: false,
      retryOnError: true,
    },
  });

  // Calculate deadline urgency
  const deadlineInfo = useMemo(() => {
    if (!invoice.eFacturaDeadline) return null;
    const hoursRemaining = differenceInHours(invoice.eFacturaDeadline, new Date());
    return {
      hours: hoursRemaining,
      status: hoursRemaining < 0 ? 'overdue' : hoursRemaining < 24 ? 'critical' : hoursRemaining < 48 ? 'warning' : 'ok',
    };
  }, [invoice.eFacturaDeadline]);

  // Reset on open
  useEffect(() => {
    if (open) {
      setStep('validate');
      setValidation(null);
      setSendResult(null);
    }
  }, [open]);

  async function validateInvoice() {
    setIsValidating(true);
    try {
      const response = await fetch(`/api/v1/efactura/validate/${invoice.id}`, {
        method: 'POST',
      });

      if (!response.ok) {
        throw new Error('Validation failed');
      }

      const result: ValidationResult = await response.json();
      setValidation(result);

      if (result.valid) {
        setStep('confirm');
      }
    } catch (error) {
      toast.error('Eroare la validare');
    } finally {
      setIsValidating(false);
    }
  }

  async function sendToEFactura() {
    setIsSending(true);
    setStep('sending');

    try {
      const data = form.getValues();
      
      const response = await fetch('/api/v1/efactura/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to send');
      }

      const result = await response.json();
      setSendResult({
        success: true,
        indexUpload: result.indexUpload,
      });
      setStep('result');
      onSuccess?.(result);
    } catch (error) {
      setSendResult({
        success: false,
        error: error instanceof Error ? error.message : 'Eroare necunoscută',
      });
      setStep('result');
    } finally {
      setIsSending(false);
    }
  }

  const hasErrors = validation?.errors.some(e => e.severity === 'error');
  const hasWarnings = validation?.errors.some(e => e.severity === 'warning');
  const skipWarnings = form.watch('skipWarnings');

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        {trigger || (
          <Button variant="outline">
            <Send className="h-4 w-4 mr-2" />
            Trimite e-Factura
          </Button>
        )}
      </DialogTrigger>
      <DialogContent className="sm:max-w-[600px]">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <FileCode className="h-5 w-5" />
            Trimite la e-Factura SPV
          </DialogTitle>
          <DialogDescription>
            Factură {invoice.series}{invoice.number} pentru {invoice.clientName}
          </DialogDescription>
        </DialogHeader>

        {/* Invoice Summary */}
        <div className="p-4 bg-muted rounded-lg">
          <div className="flex justify-between items-start">
            <div>
              <div className="font-medium">{invoice.series}{invoice.number}</div>
              <div className="text-sm text-muted-foreground">
                {format(invoice.issueDate, 'dd.MM.yyyy', { locale: ro })}
              </div>
            </div>
            <div className="text-right">
              <div className="font-bold">{formatCurrency(invoice.grandTotal, invoice.currency)}</div>
              <div className="text-sm text-muted-foreground">{invoice.clientCui}</div>
            </div>
          </div>

          {deadlineInfo && (
            <div className={cn(
              "mt-3 pt-3 border-t flex items-center gap-2",
              deadlineInfo.status === 'overdue' && "text-red-600",
              deadlineInfo.status === 'critical' && "text-red-600",
              deadlineInfo.status === 'warning' && "text-amber-600",
            )}>
              <Clock className="h-4 w-4" />
              <span className="text-sm">
                {deadlineInfo.status === 'overdue' 
                  ? 'Termen depășit!'
                  : `Termen: ${deadlineInfo.hours}h rămase`
                }
              </span>
              {deadlineInfo.status !== 'ok' && (
                <Badge variant={deadlineInfo.status === 'overdue' ? 'destructive' : 'secondary'}>
                  {deadlineInfo.status === 'overdue' ? 'URGENT' : 'Atenție'}
                </Badge>
              )}
            </div>
          )}
        </div>

        {/* Step: Validate */}
        {step === 'validate' && (
          <div className="space-y-4">
            <Alert>
              <Info className="h-4 w-4" />
              <AlertTitle>Validare obligatorie</AlertTitle>
              <AlertDescription>
                Factura va fi validată conform specificațiilor ANAF înainte de trimitere.
              </AlertDescription>
            </Alert>

            {validation && (
              <div className="space-y-4">
                {hasErrors && (
                  <Alert variant="destructive">
                    <XCircle className="h-4 w-4" />
                    <AlertTitle>Erori de validare</AlertTitle>
                    <AlertDescription>
                      {validation.errors.filter(e => e.severity === 'error').length} erori găsite. 
                      Corectați erorile înainte de a trimite.
                    </AlertDescription>
                  </Alert>
                )}

                {!hasErrors && hasWarnings && (
                  <Alert variant="warning">
                    <AlertTriangle className="h-4 w-4" />
                    <AlertTitle>Avertismente</AlertTitle>
                    <AlertDescription>
                      {validation.errors.filter(e => e.severity === 'warning').length} avertismente găsite.
                      Puteți continua, dar verificați datele.
                    </AlertDescription>
                  </Alert>
                )}

                {validation.valid && !hasWarnings && (
                  <Alert className="border-green-500 bg-green-50">
                    <CheckCircle className="h-4 w-4 text-green-500" />
                    <AlertTitle>Validare reușită</AlertTitle>
                    <AlertDescription>
                      Factura este conformă cu specificațiile e-Factura.
                    </AlertDescription>
                  </Alert>
                )}

                {validation.errors.length > 0 && (
                  <ScrollArea className="h-[200px] border rounded-lg p-4">
                    <div className="space-y-2">
                      {validation.errors.map((error, i) => (
                        <div 
                          key={i}
                          className={cn(
                            "p-3 rounded-lg",
                            error.severity === 'error' ? "bg-red-50" : "bg-amber-50"
                          )}
                        >
                          <div className="flex items-center gap-2">
                            {error.severity === 'error' 
                              ? <XCircle className="h-4 w-4 text-red-500" />
                              : <AlertTriangle className="h-4 w-4 text-amber-500" />
                            }
                            <span className="font-medium text-sm">{error.code}</span>
                          </div>
                          <p className="text-sm mt-1">{error.message}</p>
                          {error.field && (
                            <p className="text-xs text-muted-foreground mt-1">
                              Câmp: {error.field}
                            </p>
                          )}
                        </div>
                      ))}
                    </div>
                  </ScrollArea>
                )}

                {validation.xmlPreview && (
                  <Accordion type="single" collapsible>
                    <AccordionItem value="xml">
                      <AccordionTrigger className="text-sm">
                        <FileCode className="h-4 w-4 mr-2" />
                        Previzualizare XML
                      </AccordionTrigger>
                      <AccordionContent>
                        <ScrollArea className="h-[200px] border rounded p-2">
                          <pre className="text-xs font-mono">
                            {validation.xmlPreview}
                          </pre>
                        </ScrollArea>
                      </AccordionContent>
                    </AccordionItem>
                  </Accordion>
                )}

                {hasWarnings && !hasErrors && (
                  <FormField
                    control={form.control}
                    name="skipWarnings"
                    render={({ field }) => (
                      <FormItem className="flex items-center gap-2">
                        <FormControl>
                          <Checkbox
                            checked={field.value}
                            onCheckedChange={field.onChange}
                          />
                        </FormControl>
                        <FormLabel className="!mt-0">
                          Am verificat avertismentele și doresc să continui
                        </FormLabel>
                      </FormItem>
                    )}
                  />
                )}
              </div>
            )}

            <DialogFooter>
              <Button
                type="button"
                variant="outline"
                onClick={() => setOpen(false)}
              >
                Anulează
              </Button>
              {!validation ? (
                <Button onClick={validateInvoice} disabled={isValidating}>
                  {isValidating && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                  Validează
                </Button>
              ) : hasErrors ? (
                <Button onClick={validateInvoice} disabled={isValidating}>
                  {isValidating && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                  <RefreshCw className="h-4 w-4 mr-2" />
                  Revalidează
                </Button>
              ) : (
                <Button 
                  onClick={() => setStep('confirm')} 
                  disabled={hasWarnings && !skipWarnings}
                >
                  Continuă
                </Button>
              )}
            </DialogFooter>
          </div>
        )}

        {/* Step: Confirm */}
        {step === 'confirm' && (
          <div className="space-y-4">
            <Alert className="border-blue-500 bg-blue-50">
              <Shield className="h-4 w-4 text-blue-500" />
              <AlertTitle>Confirmare trimitere</AlertTitle>
              <AlertDescription>
                Factura va fi trimisă la ANAF prin sistemul e-Factura SPV.
                Această acțiune nu poate fi anulată.
              </AlertDescription>
            </Alert>

            <div className="p-4 border rounded-lg space-y-3">
              <h4 className="font-medium">Rezumat</h4>
              <div className="grid grid-cols-2 gap-2 text-sm">
                <span className="text-muted-foreground">Factură:</span>
                <span>{invoice.series}{invoice.number}</span>
                <span className="text-muted-foreground">Client:</span>
                <span>{invoice.clientName}</span>
                <span className="text-muted-foreground">CUI:</span>
                <span>{invoice.clientCui}</span>
                <span className="text-muted-foreground">Total:</span>
                <span className="font-medium">{formatCurrency(invoice.grandTotal, invoice.currency)}</span>
              </div>
            </div>

            <FormField
              control={form.control}
              name="retryOnError"
              render={({ field }) => (
                <FormItem className="flex items-center gap-2">
                  <FormControl>
                    <Checkbox
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                  <FormLabel className="!mt-0">
                    Reîncearcă automat în caz de eroare de rețea
                  </FormLabel>
                </FormItem>
              )}
            />

            <DialogFooter>
              <Button
                type="button"
                variant="outline"
                onClick={() => setStep('validate')}
              >
                Înapoi
              </Button>
              <Button onClick={sendToEFactura}>
                <Send className="h-4 w-4 mr-2" />
                Trimite la ANAF
              </Button>
            </DialogFooter>
          </div>
        )}

        {/* Step: Sending */}
        {step === 'sending' && (
          <div className="py-8 space-y-4">
            <div className="flex flex-col items-center gap-4">
              <Loader2 className="h-12 w-12 animate-spin text-primary" />
              <div className="text-center">
                <h4 className="font-medium">Se trimite la ANAF...</h4>
                <p className="text-sm text-muted-foreground">
                  Vă rugăm să așteptați
                </p>
              </div>
            </div>
            <Progress value={66} className="w-full" />
          </div>
        )}

        {/* Step: Result */}
        {step === 'result' && sendResult && (
          <div className="space-y-4">
            {sendResult.success ? (
              <>
                <Alert className="border-green-500 bg-green-50">
                  <CheckCircle className="h-4 w-4 text-green-500" />
                  <AlertTitle>Succes!</AlertTitle>
                  <AlertDescription>
                    Factura a fost trimisă cu succes la ANAF.
                  </AlertDescription>
                </Alert>

                <div className="p-4 border rounded-lg space-y-2">
                  <div className="flex justify-between">
                    <span className="text-sm text-muted-foreground">Index Upload:</span>
                    <Badge variant="outline" className="font-mono">
                      {sendResult.indexUpload}
                    </Badge>
                  </div>
                  <p className="text-sm text-muted-foreground">
                    Verificați statusul în câteva minute pentru a confirma acceptarea de către ANAF.
                  </p>
                </div>
              </>
            ) : (
              <>
                <Alert variant="destructive">
                  <XCircle className="h-4 w-4" />
                  <AlertTitle>Eroare la trimitere</AlertTitle>
                  <AlertDescription>
                    {sendResult.error}
                  </AlertDescription>
                </Alert>

                <Button 
                  variant="outline" 
                  className="w-full"
                  onClick={() => {
                    setStep('confirm');
                    setSendResult(null);
                  }}
                >
                  <RefreshCw className="h-4 w-4 mr-2" />
                  Încearcă din nou
                </Button>
              </>
            )}

            <DialogFooter>
              <Button onClick={() => setOpen(false)}>
                Închide
              </Button>
            </DialogFooter>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}
```

---

## 7. AI Configuration Forms

Formulare pentru configurarea sistemelor AI, modelelor și template-urilor de prompt.

### 7.1 AISettingsForm

Formular principal pentru configurarea setărilor AI la nivel de tenant.

```typescript
// src/components/forms/ai/AISettingsForm.tsx
import { useForm, useFieldArray } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Switch } from '@/components/ui/switch';
import { Slider } from '@/components/ui/slider';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Separator } from '@/components/ui/separator';
import { 
  Brain, 
  Shield, 
  Zap, 
  DollarSign, 
  Settings, 
  AlertTriangle,
  Save,
  RefreshCw,
  Info,
  Lock
} from 'lucide-react';
import { toast } from 'sonner';
import { useState } from 'react';

// Schema validare setări AI
const aiSettingsSchema = z.object({
  // General Settings
  aiEnabled: z.boolean(),
  autoRespond: z.boolean(),
  maxAutoResponsesPerDay: z.number().min(1).max(1000),
  workingHoursOnly: z.boolean(),
  workingHoursStart: z.string().regex(/^\d{2}:\d{2}$/),
  workingHoursEnd: z.string().regex(/^\d{2}:\d{2}$/),
  
  // Model Configuration
  defaultModel: z.enum(['claude-3-opus', 'claude-3-sonnet', 'claude-3-haiku', 'gpt-4o', 'gpt-4o-mini']),
  fallbackModel: z.enum(['claude-3-sonnet', 'claude-3-haiku', 'gpt-4o-mini']),
  temperature: z.number().min(0).max(1),
  maxTokens: z.number().min(100).max(8000),
  
  // Cost Controls
  dailyCostLimit: z.number().min(0).max(1000),
  monthlyCostLimit: z.number().min(0).max(10000),
  alertThreshold: z.number().min(0).max(100),
  pauseOnLimitReached: z.boolean(),
  
  // Safety & Guardrails
  enableGuardrails: z.boolean(),
  confidenceThreshold: z.number().min(0).max(1),
  escalateOnLowConfidence: z.boolean(),
  maxRetriesBeforeEscalation: z.number().min(1).max(5),
  humanApprovalRequired: z.enum(['never', 'high_value', 'always']),
  highValueThreshold: z.number().min(0),
  
  // Response Settings
  responseLanguage: z.enum(['ro', 'en', 'auto']),
  formalityLevel: z.enum(['formal', 'neutral', 'informal']),
  includeProductRecommendations: z.boolean(),
  maxRecommendations: z.number().min(1).max(10),
  includeAlternatives: z.boolean(),
  
  // Integration Settings
  syncWithCRM: z.boolean(),
  logAllInteractions: z.boolean(),
  retentionDays: z.number().min(30).max(365),
  anonymizeAfterDays: z.number().min(90).max(365),
});

type AISettingsFormData = z.infer<typeof aiSettingsSchema>;

interface AISettingsFormProps {
  initialData: AISettingsFormData;
  onSave: (data: AISettingsFormData) => Promise<void>;
  isAdmin: boolean;
}

export function AISettingsForm({ initialData, onSave, isAdmin }: AISettingsFormProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [currentCosts, setCurrentCosts] = useState({ daily: 12.50, monthly: 245.80 });

  const form = useForm<AISettingsFormData>({
    resolver: zodResolver(aiSettingsSchema),
    defaultValues: initialData,
  });

  const aiEnabled = form.watch('aiEnabled');
  const enableGuardrails = form.watch('enableGuardrails');
  const dailyCostLimit = form.watch('dailyCostLimit');
  const monthlyCostLimit = form.watch('monthlyCostLimit');

  const handleSubmit = async (data: AISettingsFormData) => {
    setIsSubmitting(true);
    try {
      await onSave(data);
      toast.success('Setările AI au fost salvate');
    } catch (error) {
      toast.error('Eroare la salvarea setărilor');
    } finally {
      setIsSubmitting(false);
    }
  };

  const dailyCostPercent = (currentCosts.daily / dailyCostLimit) * 100;
  const monthlyCostPercent = (currentCosts.monthly / monthlyCostLimit) * 100;

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-6">
        <Tabs defaultValue="general" className="w-full">
          <TabsList className="grid w-full grid-cols-5">
            <TabsTrigger value="general">
              <Settings className="h-4 w-4 mr-2" />
              General
            </TabsTrigger>
            <TabsTrigger value="models">
              <Brain className="h-4 w-4 mr-2" />
              Modele
            </TabsTrigger>
            <TabsTrigger value="costs">
              <DollarSign className="h-4 w-4 mr-2" />
              Costuri
            </TabsTrigger>
            <TabsTrigger value="safety">
              <Shield className="h-4 w-4 mr-2" />
              Siguranță
            </TabsTrigger>
            <TabsTrigger value="responses">
              <Zap className="h-4 w-4 mr-2" />
              Răspunsuri
            </TabsTrigger>
          </TabsList>

          {/* Tab: General Settings */}
          <TabsContent value="general" className="space-y-4 mt-4">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Settings className="h-5 w-5" />
                  Setări Generale AI
                </CardTitle>
                <CardDescription>
                  Configurează comportamentul general al sistemului AI
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                <FormField
                  control={form.control}
                  name="aiEnabled"
                  render={({ field }) => (
                    <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                      <div className="space-y-0.5">
                        <FormLabel className="text-base">
                          Activare AI
                        </FormLabel>
                        <FormDescription>
                          Activează sau dezactivează complet sistemul AI pentru negocieri
                        </FormDescription>
                      </div>
                      <FormControl>
                        <Switch
                          checked={field.value}
                          onCheckedChange={field.onChange}
                        />
                      </FormControl>
                    </FormItem>
                  )}
                />

                {aiEnabled && (
                  <>
                    <FormField
                      control={form.control}
                      name="autoRespond"
                      render={({ field }) => (
                        <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                          <div className="space-y-0.5">
                            <FormLabel className="text-base">
                              Răspuns Automat
                            </FormLabel>
                            <FormDescription>
                              AI-ul poate trimite răspunsuri automat fără aprobare umană
                            </FormDescription>
                          </div>
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="maxAutoResponsesPerDay"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Limită Răspunsuri Auto/Zi</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                          <FormDescription>
                            Numărul maxim de răspunsuri automate pe zi
                          </FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <Separator />

                    <div className="space-y-4">
                      <FormField
                        control={form.control}
                        name="workingHoursOnly"
                        render={({ field }) => (
                          <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                            <div className="space-y-0.5">
                              <FormLabel className="text-base">
                                Doar în Program
                              </FormLabel>
                              <FormDescription>
                                AI-ul răspunde doar în orele de lucru configurate
                              </FormDescription>
                            </div>
                            <FormControl>
                              <Switch
                                checked={field.value}
                                onCheckedChange={field.onChange}
                              />
                            </FormControl>
                          </FormItem>
                        )}
                      />

                      {form.watch('workingHoursOnly') && (
                        <div className="grid grid-cols-2 gap-4 pl-4">
                          <FormField
                            control={form.control}
                            name="workingHoursStart"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Ora Start</FormLabel>
                                <FormControl>
                                  <Input type="time" {...field} />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />

                          <FormField
                            control={form.control}
                            name="workingHoursEnd"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Ora Sfârșit</FormLabel>
                                <FormControl>
                                  <Input type="time" {...field} />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                        </div>
                      )}
                    </div>
                  </>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          {/* Tab: Model Configuration */}
          <TabsContent value="models" className="space-y-4 mt-4">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Brain className="h-5 w-5" />
                  Configurare Modele AI
                </CardTitle>
                <CardDescription>
                  Selectează și configurează modelele AI utilizate
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="grid grid-cols-2 gap-4">
                  <FormField
                    control={form.control}
                    name="defaultModel"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Model Principal</FormLabel>
                        <Select onValueChange={field.onChange} defaultValue={field.value}>
                          <FormControl>
                            <SelectTrigger>
                              <SelectValue placeholder="Selectează model" />
                            </SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            <SelectItem value="claude-3-opus">
                              <div className="flex items-center gap-2">
                                <Badge variant="default">Premium</Badge>
                                Claude 3 Opus
                              </div>
                            </SelectItem>
                            <SelectItem value="claude-3-sonnet">
                              <div className="flex items-center gap-2">
                                <Badge variant="secondary">Recomandat</Badge>
                                Claude 3 Sonnet
                              </div>
                            </SelectItem>
                            <SelectItem value="claude-3-haiku">
                              Claude 3 Haiku
                            </SelectItem>
                            <SelectItem value="gpt-4o">
                              <div className="flex items-center gap-2">
                                <Badge variant="default">Premium</Badge>
                                GPT-4o
                              </div>
                            </SelectItem>
                            <SelectItem value="gpt-4o-mini">
                              GPT-4o Mini
                            </SelectItem>
                          </SelectContent>
                        </Select>
                        <FormDescription>
                          Modelul utilizat pentru majoritatea interacțiunilor
                        </FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="fallbackModel"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Model Fallback</FormLabel>
                        <Select onValueChange={field.onChange} defaultValue={field.value}>
                          <FormControl>
                            <SelectTrigger>
                              <SelectValue placeholder="Selectează model" />
                            </SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            <SelectItem value="claude-3-sonnet">Claude 3 Sonnet</SelectItem>
                            <SelectItem value="claude-3-haiku">Claude 3 Haiku</SelectItem>
                            <SelectItem value="gpt-4o-mini">GPT-4o Mini</SelectItem>
                          </SelectContent>
                        </Select>
                        <FormDescription>
                          Utilizat când modelul principal nu este disponibil
                        </FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                <Separator />

                <FormField
                  control={form.control}
                  name="temperature"
                  render={({ field }) => (
                    <FormItem>
                      <div className="flex justify-between">
                        <FormLabel>Temperatură: {field.value.toFixed(2)}</FormLabel>
                        <span className="text-sm text-muted-foreground">
                          {field.value < 0.3 ? 'Precis' : field.value < 0.7 ? 'Balansat' : 'Creativ'}
                        </span>
                      </div>
                      <FormControl>
                        <Slider
                          value={[field.value]}
                          onValueChange={([value]) => field.onChange(value)}
                          min={0}
                          max={1}
                          step={0.05}
                          className="py-4"
                        />
                      </FormControl>
                      <FormDescription>
                        Valori mici = răspunsuri mai precise și consistente. 
                        Valori mari = răspunsuri mai creative și variate.
                      </FormDescription>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="maxTokens"
                  render={({ field }) => (
                    <FormItem>
                      <div className="flex justify-between">
                        <FormLabel>Tokeni Maximi: {field.value.toLocaleString()}</FormLabel>
                        <span className="text-sm text-muted-foreground">
                          ~{Math.round(field.value * 0.75)} cuvinte
                        </span>
                      </div>
                      <FormControl>
                        <Slider
                          value={[field.value]}
                          onValueChange={([value]) => field.onChange(value)}
                          min={100}
                          max={8000}
                          step={100}
                          className="py-4"
                        />
                      </FormControl>
                      <FormDescription>
                        Limita maximă de tokeni pentru fiecare răspuns generat
                      </FormDescription>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <Alert>
                  <Info className="h-4 w-4" />
                  <AlertDescription>
                    Modelele premium (Opus, GPT-4o) oferă răspunsuri mai nuanțate dar costă mai mult.
                    Recomandăm Sonnet pentru majoritatea cazurilor de utilizare.
                  </AlertDescription>
                </Alert>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Tab: Cost Controls */}
          <TabsContent value="costs" className="space-y-4 mt-4">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <DollarSign className="h-5 w-5" />
                  Control Costuri
                </CardTitle>
                <CardDescription>
                  Setează limite de cost și monitorizează cheltuielile AI
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                {/* Current Usage Display */}
                <div className="grid grid-cols-2 gap-4">
                  <div className="p-4 border rounded-lg">
                    <div className="flex justify-between items-center mb-2">
                      <span className="text-sm font-medium">Cost Azi</span>
                      <Badge variant={dailyCostPercent > 80 ? 'destructive' : 'secondary'}>
                        {dailyCostPercent.toFixed(0)}%
                      </Badge>
                    </div>
                    <div className="text-2xl font-bold">
                      ${currentCosts.daily.toFixed(2)}
                    </div>
                    <div className="text-sm text-muted-foreground">
                      din ${dailyCostLimit} limită
                    </div>
                    <div className="mt-2 h-2 bg-muted rounded-full overflow-hidden">
                      <div
                        className={`h-full transition-all ${
                          dailyCostPercent > 80 ? 'bg-destructive' : 
                          dailyCostPercent > 60 ? 'bg-yellow-500' : 'bg-primary'
                        }`}
                        style={{ width: `${Math.min(dailyCostPercent, 100)}%` }}
                      />
                    </div>
                  </div>

                  <div className="p-4 border rounded-lg">
                    <div className="flex justify-between items-center mb-2">
                      <span className="text-sm font-medium">Cost Luna</span>
                      <Badge variant={monthlyCostPercent > 80 ? 'destructive' : 'secondary'}>
                        {monthlyCostPercent.toFixed(0)}%
                      </Badge>
                    </div>
                    <div className="text-2xl font-bold">
                      ${currentCosts.monthly.toFixed(2)}
                    </div>
                    <div className="text-sm text-muted-foreground">
                      din ${monthlyCostLimit} limită
                    </div>
                    <div className="mt-2 h-2 bg-muted rounded-full overflow-hidden">
                      <div
                        className={`h-full transition-all ${
                          monthlyCostPercent > 80 ? 'bg-destructive' : 
                          monthlyCostPercent > 60 ? 'bg-yellow-500' : 'bg-primary'
                        }`}
                        style={{ width: `${Math.min(monthlyCostPercent, 100)}%` }}
                      />
                    </div>
                  </div>
                </div>

                <Separator />

                <div className="grid grid-cols-2 gap-4">
                  <FormField
                    control={form.control}
                    name="dailyCostLimit"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Limită Zilnică ($)</FormLabel>
                        <FormControl>
                          <Input
                            type="number"
                            step="0.01"
                            {...field}
                            onChange={(e) => field.onChange(Number(e.target.value))}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="monthlyCostLimit"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Limită Lunară ($)</FormLabel>
                        <FormControl>
                          <Input
                            type="number"
                            step="0.01"
                            {...field}
                            onChange={(e) => field.onChange(Number(e.target.value))}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                <FormField
                  control={form.control}
                  name="alertThreshold"
                  render={({ field }) => (
                    <FormItem>
                      <div className="flex justify-between">
                        <FormLabel>Prag Alertă: {field.value}%</FormLabel>
                      </div>
                      <FormControl>
                        <Slider
                          value={[field.value]}
                          onValueChange={([value]) => field.onChange(value)}
                          min={50}
                          max={95}
                          step={5}
                          className="py-4"
                        />
                      </FormControl>
                      <FormDescription>
                        Primești alertă când se atinge acest procent din limită
                      </FormDescription>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="pauseOnLimitReached"
                  render={({ field }) => (
                    <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                      <div className="space-y-0.5">
                        <FormLabel className="text-base">
                          Pauză la Atingerea Limitei
                        </FormLabel>
                        <FormDescription>
                          Oprește automat AI-ul când se atinge limita de cost
                        </FormDescription>
                      </div>
                      <FormControl>
                        <Switch
                          checked={field.value}
                          onCheckedChange={field.onChange}
                        />
                      </FormControl>
                    </FormItem>
                  )}
                />

                {!form.watch('pauseOnLimitReached') && (
                  <Alert variant="destructive">
                    <AlertTriangle className="h-4 w-4" />
                    <AlertDescription>
                      Atenție: AI-ul va continua să funcționeze chiar și după atingerea limitei de cost!
                    </AlertDescription>
                  </Alert>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          {/* Tab: Safety & Guardrails */}
          <TabsContent value="safety" className="space-y-4 mt-4">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Shield className="h-5 w-5" />
                  Siguranță & Guardrails
                </CardTitle>
                <CardDescription>
                  Configurează mecanismele de siguranță și control calitate
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                <FormField
                  control={form.control}
                  name="enableGuardrails"
                  render={({ field }) => (
                    <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                      <div className="space-y-0.5">
                        <FormLabel className="text-base flex items-center gap-2">
                          <Lock className="h-4 w-4" />
                          Activare Guardrails
                        </FormLabel>
                        <FormDescription>
                          Verifică și validează toate răspunsurile AI înainte de trimitere
                        </FormDescription>
                      </div>
                      <FormControl>
                        <Switch
                          checked={field.value}
                          onCheckedChange={field.onChange}
                        />
                      </FormControl>
                    </FormItem>
                  )}
                />

                {enableGuardrails && (
                  <>
                    <FormField
                      control={form.control}
                      name="confidenceThreshold"
                      render={({ field }) => (
                        <FormItem>
                          <div className="flex justify-between">
                            <FormLabel>Prag Încredere: {(field.value * 100).toFixed(0)}%</FormLabel>
                            <span className="text-sm text-muted-foreground">
                              {field.value < 0.7 ? 'Relaxat' : field.value < 0.85 ? 'Moderat' : 'Strict'}
                            </span>
                          </div>
                          <FormControl>
                            <Slider
                              value={[field.value]}
                              onValueChange={([value]) => field.onChange(value)}
                              min={0.5}
                              max={0.95}
                              step={0.05}
                              className="py-4"
                            />
                          </FormControl>
                          <FormDescription>
                            Răspunsurile sub acest prag de încredere sunt escalate pentru verificare
                          </FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="escalateOnLowConfidence"
                      render={({ field }) => (
                        <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                          <div className="space-y-0.5">
                            <FormLabel className="text-base">
                              Escalare Automată
                            </FormLabel>
                            <FormDescription>
                              Escalează automat către operator uman când încrederea este scăzută
                            </FormDescription>
                          </div>
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="maxRetriesBeforeEscalation"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Reîncercări Maxime</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min={1}
                              max={5}
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                          <FormDescription>
                            Numărul de încercări înainte de escalare (1-5)
                          </FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </>
                )}

                <Separator />

                <FormField
                  control={form.control}
                  name="humanApprovalRequired"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Aprobare Umană Necesară</FormLabel>
                      <Select onValueChange={field.onChange} defaultValue={field.value}>
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          <SelectItem value="never">
                            <div className="flex items-center gap-2">
                              <Badge variant="outline" className="text-green-600">Auto</Badge>
                              Niciodată - AI complet autonom
                            </div>
                          </SelectItem>
                          <SelectItem value="high_value">
                            <div className="flex items-center gap-2">
                              <Badge variant="secondary">Recomandat</Badge>
                              Doar tranzacții de valoare mare
                            </div>
                          </SelectItem>
                          <SelectItem value="always">
                            <div className="flex items-center gap-2">
                              <Badge variant="destructive">Strict</Badge>
                              Întotdeauna - fiecare răspuns
                            </div>
                          </SelectItem>
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                {form.watch('humanApprovalRequired') === 'high_value' && (
                  <FormField
                    control={form.control}
                    name="highValueThreshold"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Prag Valoare Mare (RON)</FormLabel>
                        <FormControl>
                          <Input
                            type="number"
                            {...field}
                            onChange={(e) => field.onChange(Number(e.target.value))}
                          />
                        </FormControl>
                        <FormDescription>
                          Tranzacțiile peste această sumă necesită aprobare umană
                        </FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                )}
              </CardContent>
            </Card>
          </TabsContent>

          {/* Tab: Response Settings */}
          <TabsContent value="responses" className="space-y-4 mt-4">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Zap className="h-5 w-5" />
                  Setări Răspunsuri
                </CardTitle>
                <CardDescription>
                  Personalizează stilul și conținutul răspunsurilor AI
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="grid grid-cols-2 gap-4">
                  <FormField
                    control={form.control}
                    name="responseLanguage"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Limbă Răspuns</FormLabel>
                        <Select onValueChange={field.onChange} defaultValue={field.value}>
                          <FormControl>
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            <SelectItem value="ro">🇷🇴 Română</SelectItem>
                            <SelectItem value="en">🇬🇧 Engleză</SelectItem>
                            <SelectItem value="auto">🌐 Auto-detectare</SelectItem>
                          </SelectContent>
                        </Select>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="formalityLevel"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Nivel Formalitate</FormLabel>
                        <Select onValueChange={field.onChange} defaultValue={field.value}>
                          <FormControl>
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            <SelectItem value="formal">Formal - Dvs.</SelectItem>
                            <SelectItem value="neutral">Neutru - Mixt</SelectItem>
                            <SelectItem value="informal">Informal - Tu</SelectItem>
                          </SelectContent>
                        </Select>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                <Separator />

                <FormField
                  control={form.control}
                  name="includeProductRecommendations"
                  render={({ field }) => (
                    <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                      <div className="space-y-0.5">
                        <FormLabel className="text-base">
                          Recomandări Produse
                        </FormLabel>
                        <FormDescription>
                          AI-ul poate sugera produse relevante în conversație
                        </FormDescription>
                      </div>
                      <FormControl>
                        <Switch
                          checked={field.value}
                          onCheckedChange={field.onChange}
                        />
                      </FormControl>
                    </FormItem>
                  )}
                />

                {form.watch('includeProductRecommendations') && (
                  <FormField
                    control={form.control}
                    name="maxRecommendations"
                    render={({ field }) => (
                      <FormItem className="pl-4">
                        <FormLabel>Număr Maxim Recomandări: {field.value}</FormLabel>
                        <FormControl>
                          <Slider
                            value={[field.value]}
                            onValueChange={([value]) => field.onChange(value)}
                            min={1}
                            max={10}
                            step={1}
                            className="py-4"
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                )}

                <FormField
                  control={form.control}
                  name="includeAlternatives"
                  render={({ field }) => (
                    <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                      <div className="space-y-0.5">
                        <FormLabel className="text-base">
                          Oferte Alternative
                        </FormLabel>
                        <FormDescription>
                          Sugerează alternative când produsul solicitat nu e disponibil
                        </FormDescription>
                      </div>
                      <FormControl>
                        <Switch
                          checked={field.value}
                          onCheckedChange={field.onChange}
                        />
                      </FormControl>
                    </FormItem>
                  )}
                />

                <Separator />

                <div className="space-y-4">
                  <h4 className="font-medium">Integrare & Logging</h4>

                  <FormField
                    control={form.control}
                    name="syncWithCRM"
                    render={({ field }) => (
                      <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                        <div className="space-y-0.5">
                          <FormLabel className="text-base">
                            Sincronizare CRM
                          </FormLabel>
                          <FormDescription>
                            Sincronizează conversațiile și rezultatele cu CRM-ul
                          </FormDescription>
                        </div>
                        <FormControl>
                          <Switch
                            checked={field.value}
                            onCheckedChange={field.onChange}
                          />
                        </FormControl>
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="logAllInteractions"
                    render={({ field }) => (
                      <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                        <div className="space-y-0.5">
                          <FormLabel className="text-base">
                            Logging Complet
                          </FormLabel>
                          <FormDescription>
                            Salvează toate interacțiunile pentru audit și analiză
                          </FormDescription>
                        </div>
                        <FormControl>
                          <Switch
                            checked={field.value}
                            onCheckedChange={field.onChange}
                          />
                        </FormControl>
                      </FormItem>
                    )}
                  />

                  <div className="grid grid-cols-2 gap-4 pl-4">
                    <FormField
                      control={form.control}
                      name="retentionDays"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Retenție Date (zile)</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                          <FormDescription>
                            30-365 zile
                          </FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="anonymizeAfterDays"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Anonimizare După (zile)</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                          <FormDescription>
                            Minim 90 zile
                          </FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>

        {/* Form Actions */}
        <div className="flex justify-between items-center pt-4 border-t">
          <Button
            type="button"
            variant="outline"
            onClick={() => form.reset(initialData)}
          >
            <RefreshCw className="h-4 w-4 mr-2" />
            Resetare
          </Button>

          <div className="flex gap-2">
            {!isAdmin && (
              <Badge variant="outline" className="text-yellow-600">
                <Lock className="h-3 w-3 mr-1" />
                Unele setări necesită rol admin
              </Badge>
            )}
            <Button type="submit" disabled={isSubmitting}>
              {isSubmitting ? (
                <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
              ) : (
                <Save className="h-4 w-4 mr-2" />
              )}
              Salvează Setările
            </Button>
          </div>
        </div>
      </form>
    </Form>
  );
}
```

### 7.2 ModelConfigForm

Formular pentru configurarea detaliată a unui model AI specific.

```typescript
// src/components/forms/ai/ModelConfigForm.tsx
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Switch } from '@/components/ui/switch';
import { Slider } from '@/components/ui/slider';
import { Textarea } from '@/components/ui/textarea';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '@/components/ui/accordion';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { 
  Brain, 
  Zap, 
  DollarSign, 
  Clock, 
  AlertTriangle,
  Save,
  TestTube,
  RefreshCw,
  Code,
  Info
} from 'lucide-react';
import { toast } from 'sonner';
import { useState } from 'react';

// Schema configurare model
const modelConfigSchema = z.object({
  modelId: z.string().min(1, 'ID model obligatoriu'),
  displayName: z.string().min(1, 'Nume afișare obligatoriu'),
  provider: z.enum(['anthropic', 'openai', 'local']),
  modelName: z.string().min(1, 'Nume model obligatoriu'),
  apiEndpoint: z.string().url().optional().or(z.literal('')),
  
  // Parameters
  temperature: z.number().min(0).max(2),
  topP: z.number().min(0).max(1),
  topK: z.number().min(1).max(100).optional(),
  frequencyPenalty: z.number().min(-2).max(2),
  presencePenalty: z.number().min(-2).max(2),
  maxTokens: z.number().min(100).max(128000),
  
  // Rate Limiting
  requestsPerMinute: z.number().min(1).max(1000),
  tokensPerMinute: z.number().min(1000).max(1000000),
  
  // Cost
  inputCostPer1k: z.number().min(0),
  outputCostPer1k: z.number().min(0),
  
  // Capabilities
  supportsVision: z.boolean(),
  supportsFunctions: z.boolean(),
  supportsStreaming: z.boolean(),
  contextWindow: z.number().min(1000),
  
  // Usage
  isEnabled: z.boolean(),
  useCases: z.array(z.enum([
    'chat', 
    'negotiation', 
    'analysis', 
    'summarization', 
    'translation',
    'code_generation'
  ])),
  
  // System Prompt Override
  systemPromptOverride: z.string().optional(),
  stopSequences: z.array(z.string()).optional(),
});

type ModelConfigFormData = z.infer<typeof modelConfigSchema>;

interface ModelConfigFormProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  model?: ModelConfigFormData;
  onSave: (data: ModelConfigFormData) => Promise<void>;
}

// Model presets
const MODEL_PRESETS: Record<string, Partial<ModelConfigFormData>> = {
  'claude-3-opus': {
    provider: 'anthropic',
    modelName: 'claude-3-opus-20240229',
    temperature: 0.7,
    topP: 0.9,
    maxTokens: 4096,
    contextWindow: 200000,
    inputCostPer1k: 0.015,
    outputCostPer1k: 0.075,
    supportsVision: true,
    supportsFunctions: true,
    supportsStreaming: true,
    requestsPerMinute: 50,
    tokensPerMinute: 100000,
  },
  'claude-3-sonnet': {
    provider: 'anthropic',
    modelName: 'claude-3-sonnet-20240229',
    temperature: 0.7,
    topP: 0.9,
    maxTokens: 4096,
    contextWindow: 200000,
    inputCostPer1k: 0.003,
    outputCostPer1k: 0.015,
    supportsVision: true,
    supportsFunctions: true,
    supportsStreaming: true,
    requestsPerMinute: 100,
    tokensPerMinute: 200000,
  },
  'claude-3-haiku': {
    provider: 'anthropic',
    modelName: 'claude-3-haiku-20240307',
    temperature: 0.7,
    topP: 0.9,
    maxTokens: 4096,
    contextWindow: 200000,
    inputCostPer1k: 0.00025,
    outputCostPer1k: 0.00125,
    supportsVision: true,
    supportsFunctions: true,
    supportsStreaming: true,
    requestsPerMinute: 200,
    tokensPerMinute: 400000,
  },
  'gpt-4o': {
    provider: 'openai',
    modelName: 'gpt-4o',
    temperature: 0.7,
    topP: 1,
    maxTokens: 4096,
    contextWindow: 128000,
    inputCostPer1k: 0.005,
    outputCostPer1k: 0.015,
    supportsVision: true,
    supportsFunctions: true,
    supportsStreaming: true,
    requestsPerMinute: 100,
    tokensPerMinute: 150000,
  },
};

const USE_CASE_LABELS: Record<string, string> = {
  chat: 'Chat General',
  negotiation: 'Negociere',
  analysis: 'Analiză',
  summarization: 'Sumarizare',
  translation: 'Traducere',
  code_generation: 'Generare Cod',
};

export function ModelConfigForm({ open, onOpenChange, model, onSave }: ModelConfigFormProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isTesting, setIsTesting] = useState(false);
  const [testResult, setTestResult] = useState<{ success: boolean; message: string } | null>(null);

  const defaultValues: ModelConfigFormData = model || {
    modelId: '',
    displayName: '',
    provider: 'anthropic',
    modelName: '',
    apiEndpoint: '',
    temperature: 0.7,
    topP: 0.9,
    topK: undefined,
    frequencyPenalty: 0,
    presencePenalty: 0,
    maxTokens: 4096,
    requestsPerMinute: 100,
    tokensPerMinute: 200000,
    inputCostPer1k: 0,
    outputCostPer1k: 0,
    supportsVision: false,
    supportsFunctions: false,
    supportsStreaming: true,
    contextWindow: 128000,
    isEnabled: true,
    useCases: ['chat', 'negotiation'],
    systemPromptOverride: '',
    stopSequences: [],
  };

  const form = useForm<ModelConfigFormData>({
    resolver: zodResolver(modelConfigSchema),
    defaultValues,
  });

  const provider = form.watch('provider');

  const applyPreset = (presetKey: string) => {
    const preset = MODEL_PRESETS[presetKey];
    if (preset) {
      Object.entries(preset).forEach(([key, value]) => {
        form.setValue(key as keyof ModelConfigFormData, value as any);
      });
      form.setValue('modelId', presetKey);
      form.setValue('displayName', presetKey.split('-').map(s => 
        s.charAt(0).toUpperCase() + s.slice(1)
      ).join(' '));
      toast.success(`Preset ${presetKey} aplicat`);
    }
  };

  const testConnection = async () => {
    setIsTesting(true);
    setTestResult(null);
    try {
      const values = form.getValues();
      const response = await fetch('/api/v1/ai/models/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(values),
      });
      const data = await response.json();
      setTestResult({
        success: data.success,
        message: data.success ? 'Conexiune reușită!' : data.error,
      });
    } catch (error) {
      setTestResult({
        success: false,
        message: 'Eroare la testarea conexiunii',
      });
    } finally {
      setIsTesting(false);
    }
  };

  const handleSubmit = async (data: ModelConfigFormData) => {
    setIsSubmitting(true);
    try {
      await onSave(data);
      toast.success('Configurația modelului a fost salvată');
      onOpenChange(false);
    } catch (error) {
      toast.error('Eroare la salvarea configurației');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Brain className="h-5 w-5" />
            {model ? 'Editare Model AI' : 'Adăugare Model AI'}
          </DialogTitle>
          <DialogDescription>
            Configurează parametrii și comportamentul modelului AI
          </DialogDescription>
        </DialogHeader>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-6">
            {/* Presets */}
            {!model && (
              <div className="space-y-2">
                <label className="text-sm font-medium">Încarcă Preset</label>
                <div className="flex flex-wrap gap-2">
                  {Object.keys(MODEL_PRESETS).map((preset) => (
                    <Button
                      key={preset}
                      type="button"
                      variant="outline"
                      size="sm"
                      onClick={() => applyPreset(preset)}
                    >
                      {preset}
                    </Button>
                  ))}
                </div>
              </div>
            )}

            {/* Basic Info */}
            <div className="grid grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="modelId"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>ID Model *</FormLabel>
                    <FormControl>
                      <Input placeholder="claude-3-sonnet" {...field} />
                    </FormControl>
                    <FormDescription>
                      Identificator unic pentru model
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="displayName"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Nume Afișare *</FormLabel>
                    <FormControl>
                      <Input placeholder="Claude 3 Sonnet" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="provider"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Provider *</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        <SelectItem value="anthropic">
                          <span className="flex items-center gap-2">
                            <span className="text-orange-600">●</span>
                            Anthropic
                          </span>
                        </SelectItem>
                        <SelectItem value="openai">
                          <span className="flex items-center gap-2">
                            <span className="text-green-600">●</span>
                            OpenAI
                          </span>
                        </SelectItem>
                        <SelectItem value="local">
                          <span className="flex items-center gap-2">
                            <span className="text-blue-600">●</span>
                            Local / Self-hosted
                          </span>
                        </SelectItem>
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="modelName"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Nume Model API *</FormLabel>
                    <FormControl>
                      <Input 
                        placeholder={
                          provider === 'anthropic' ? 'claude-3-sonnet-20240229' :
                          provider === 'openai' ? 'gpt-4o' : 'custom-model'
                        }
                        {...field} 
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            {provider === 'local' && (
              <FormField
                control={form.control}
                name="apiEndpoint"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>API Endpoint</FormLabel>
                    <FormControl>
                      <Input placeholder="http://localhost:11434/v1" {...field} />
                    </FormControl>
                    <FormDescription>
                      URL-ul endpoint-ului API pentru modelul local
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />
            )}

            <Accordion type="multiple" defaultValue={['parameters', 'capabilities']} className="w-full">
              {/* Parameters */}
              <AccordionItem value="parameters">
                <AccordionTrigger>
                  <span className="flex items-center gap-2">
                    <Zap className="h-4 w-4" />
                    Parametri Generare
                  </span>
                </AccordionTrigger>
                <AccordionContent className="space-y-4 pt-4">
                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="temperature"
                      render={({ field }) => (
                        <FormItem>
                          <div className="flex justify-between">
                            <FormLabel>Temperatură: {field.value.toFixed(2)}</FormLabel>
                          </div>
                          <FormControl>
                            <Slider
                              value={[field.value]}
                              onValueChange={([value]) => field.onChange(value)}
                              min={0}
                              max={2}
                              step={0.05}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="topP"
                      render={({ field }) => (
                        <FormItem>
                          <div className="flex justify-between">
                            <FormLabel>Top P: {field.value.toFixed(2)}</FormLabel>
                          </div>
                          <FormControl>
                            <Slider
                              value={[field.value]}
                              onValueChange={([value]) => field.onChange(value)}
                              min={0}
                              max={1}
                              step={0.05}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="frequencyPenalty"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Frequency Penalty: {field.value.toFixed(1)}</FormLabel>
                          <FormControl>
                            <Slider
                              value={[field.value]}
                              onValueChange={([value]) => field.onChange(value)}
                              min={-2}
                              max={2}
                              step={0.1}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="presencePenalty"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Presence Penalty: {field.value.toFixed(1)}</FormLabel>
                          <FormControl>
                            <Slider
                              value={[field.value]}
                              onValueChange={([value]) => field.onChange(value)}
                              min={-2}
                              max={2}
                              step={0.1}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <FormField
                    control={form.control}
                    name="maxTokens"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Max Tokens: {field.value.toLocaleString()}</FormLabel>
                        <FormControl>
                          <Slider
                            value={[field.value]}
                            onValueChange={([value]) => field.onChange(value)}
                            min={100}
                            max={128000}
                            step={100}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </AccordionContent>
              </AccordionItem>

              {/* Rate Limits & Cost */}
              <AccordionItem value="limits">
                <AccordionTrigger>
                  <span className="flex items-center gap-2">
                    <Clock className="h-4 w-4" />
                    Rate Limits & Costuri
                  </span>
                </AccordionTrigger>
                <AccordionContent className="space-y-4 pt-4">
                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="requestsPerMinute"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Requests/Minut</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="tokensPerMinute"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Tokens/Minut</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="inputCostPer1k"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Cost Input ($/1K tokens)</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              step="0.0001"
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="outputCostPer1k"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Cost Output ($/1K tokens)</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              step="0.0001"
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <Alert>
                    <DollarSign className="h-4 w-4" />
                    <AlertDescription>
                      Cost estimat per răspuns tipic (~500 tokens in, ~1000 tokens out): 
                      <strong className="ml-1">
                        ${((form.watch('inputCostPer1k') * 0.5) + (form.watch('outputCostPer1k') * 1)).toFixed(4)}
                      </strong>
                    </AlertDescription>
                  </Alert>
                </AccordionContent>
              </AccordionItem>

              {/* Capabilities */}
              <AccordionItem value="capabilities">
                <AccordionTrigger>
                  <span className="flex items-center gap-2">
                    <Code className="h-4 w-4" />
                    Capabilități
                  </span>
                </AccordionTrigger>
                <AccordionContent className="space-y-4 pt-4">
                  <FormField
                    control={form.control}
                    name="contextWindow"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Context Window: {field.value.toLocaleString()} tokens</FormLabel>
                        <FormControl>
                          <Slider
                            value={[field.value]}
                            onValueChange={([value]) => field.onChange(value)}
                            min={1000}
                            max={200000}
                            step={1000}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <div className="grid grid-cols-3 gap-4">
                    <FormField
                      control={form.control}
                      name="supportsVision"
                      render={({ field }) => (
                        <FormItem className="flex flex-row items-center justify-between rounded-lg border p-3">
                          <FormLabel className="text-sm">Vision</FormLabel>
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="supportsFunctions"
                      render={({ field }) => (
                        <FormItem className="flex flex-row items-center justify-between rounded-lg border p-3">
                          <FormLabel className="text-sm">Functions</FormLabel>
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="supportsStreaming"
                      render={({ field }) => (
                        <FormItem className="flex flex-row items-center justify-between rounded-lg border p-3">
                          <FormLabel className="text-sm">Streaming</FormLabel>
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />
                  </div>

                  <FormField
                    control={form.control}
                    name="useCases"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Cazuri de Utilizare</FormLabel>
                        <div className="flex flex-wrap gap-2">
                          {Object.entries(USE_CASE_LABELS).map(([key, label]) => (
                            <Badge
                              key={key}
                              variant={field.value.includes(key as any) ? 'default' : 'outline'}
                              className="cursor-pointer"
                              onClick={() => {
                                const newValue = field.value.includes(key as any)
                                  ? field.value.filter(v => v !== key)
                                  : [...field.value, key as any];
                                field.onChange(newValue);
                              }}
                            >
                              {label}
                            </Badge>
                          ))}
                        </div>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </AccordionContent>
              </AccordionItem>

              {/* Advanced */}
              <AccordionItem value="advanced">
                <AccordionTrigger>
                  <span className="flex items-center gap-2">
                    <AlertTriangle className="h-4 w-4" />
                    Avansat
                  </span>
                </AccordionTrigger>
                <AccordionContent className="space-y-4 pt-4">
                  <FormField
                    control={form.control}
                    name="systemPromptOverride"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>System Prompt Override</FormLabel>
                        <FormControl>
                          <Textarea
                            placeholder="Lasă gol pentru a folosi system prompt-ul default..."
                            className="min-h-[100px] font-mono text-sm"
                            {...field}
                          />
                        </FormControl>
                        <FormDescription>
                          Suprascrie system prompt-ul pentru acest model specific
                        </FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="isEnabled"
                    render={({ field }) => (
                      <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                        <div className="space-y-0.5">
                          <FormLabel className="text-base">Model Activ</FormLabel>
                          <FormDescription>
                            Modelul poate fi utilizat în sistem
                          </FormDescription>
                        </div>
                        <FormControl>
                          <Switch
                            checked={field.value}
                            onCheckedChange={field.onChange}
                          />
                        </FormControl>
                      </FormItem>
                    )}
                  />
                </AccordionContent>
              </AccordionItem>
            </Accordion>

            {/* Test Result */}
            {testResult && (
              <Alert variant={testResult.success ? 'default' : 'destructive'}>
                {testResult.success ? (
                  <Info className="h-4 w-4" />
                ) : (
                  <AlertTriangle className="h-4 w-4" />
                )}
                <AlertDescription>{testResult.message}</AlertDescription>
              </Alert>
            )}

            <DialogFooter className="gap-2">
              <Button
                type="button"
                variant="outline"
                onClick={testConnection}
                disabled={isTesting}
              >
                {isTesting ? (
                  <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                ) : (
                  <TestTube className="h-4 w-4 mr-2" />
                )}
                Testează Conexiunea
              </Button>

              <Button type="submit" disabled={isSubmitting}>
                {isSubmitting ? (
                  <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                ) : (
                  <Save className="h-4 w-4 mr-2" />
                )}
                Salvează
              </Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```

### 7.3 PromptTemplateForm

Formular pentru crearea și editarea template-urilor de prompt.

```typescript
// src/components/forms/ai/PromptTemplateForm.tsx
import { useForm, useFieldArray } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetFooter,
  SheetHeader,
  SheetTitle,
} from '@/components/ui/sheet';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Switch } from '@/components/ui/switch';
import { Textarea } from '@/components/ui/textarea';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Separator } from '@/components/ui/separator';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { 
  FileText, 
  Code, 
  Variable, 
  Play, 
  Save, 
  Copy, 
  Plus, 
  Trash2, 
  RefreshCw,
  AlertTriangle,
  CheckCircle,
  Wand2
} from 'lucide-react';
import { toast } from 'sonner';
import { useState, useEffect, useMemo } from 'react';

// Schema variabilă template
const templateVariableSchema = z.object({
  name: z.string().min(1, 'Nume variabilă obligatoriu').regex(/^[a-zA-Z_][a-zA-Z0-9_]*$/, 'Format invalid'),
  type: z.enum(['string', 'number', 'boolean', 'array', 'object']),
  description: z.string().optional(),
  required: z.boolean(),
  defaultValue: z.string().optional(),
  example: z.string().optional(),
});

// Schema template prompt
const promptTemplateSchema = z.object({
  id: z.string().optional(),
  name: z.string().min(1, 'Nume template obligatoriu').max(100),
  slug: z.string().min(1, 'Slug obligatoriu').regex(/^[a-z0-9-]+$/, 'Format: litere mici, cifre, cratime'),
  category: z.enum([
    'negotiation',
    'product_recommendation',
    'objection_handling',
    'closing',
    'follow_up',
    'analysis',
    'system',
    'custom'
  ]),
  description: z.string().max(500).optional(),
  
  // Template content
  systemPrompt: z.string().min(10, 'System prompt minim 10 caractere'),
  userPromptTemplate: z.string().min(10, 'User prompt template minim 10 caractere'),
  
  // Variables
  variables: z.array(templateVariableSchema),
  
  // Settings
  defaultModel: z.string().optional(),
  temperature: z.number().min(0).max(2).optional(),
  maxTokens: z.number().min(100).max(8000).optional(),
  
  // Metadata
  isActive: z.boolean(),
  version: z.number().min(1),
  tags: z.array(z.string()),
});

type PromptTemplateFormData = z.infer<typeof promptTemplateSchema>;
type TemplateVariable = z.infer<typeof templateVariableSchema>;

interface PromptTemplateFormProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  template?: PromptTemplateFormData;
  onSave: (data: PromptTemplateFormData) => Promise<void>;
}

const CATEGORY_LABELS: Record<string, string> = {
  negotiation: 'Negociere',
  product_recommendation: 'Recomandare Produse',
  objection_handling: 'Gestionare Obiecții',
  closing: 'Închidere Vânzare',
  follow_up: 'Follow-up',
  analysis: 'Analiză',
  system: 'Sistem',
  custom: 'Personalizat',
};

const VARIABLE_TYPE_LABELS: Record<string, string> = {
  string: 'Text',
  number: 'Număr',
  boolean: 'Da/Nu',
  array: 'Listă',
  object: 'Obiect',
};

// Template-uri predefinite
const TEMPLATE_PRESETS: Record<string, Partial<PromptTemplateFormData>> = {
  negotiation_opening: {
    name: 'Deschidere Negociere',
    slug: 'negotiation-opening',
    category: 'negotiation',
    description: 'Template pentru inițierea unei negocieri cu un prospect',
    systemPrompt: `Ești un agent de vânzări expert pentru produse agricole în România.
Comunică în limba română, într-un ton profesionist dar prietenos.
Scopul tău este să înțelegi nevoile clientului și să propui soluții potrivite.

Reguli:
- Folosește forma de politețe "dumneavoastră"
- Nu promite reduceri fără aprobare
- Menționează întotdeauna disponibilitatea în stoc
- Fii specific cu prețurile și condițiile`,
    userPromptTemplate: `Clientul {{customer_name}} de la {{company_name}} (CUI: {{cui}}) te-a contactat.

Informații despre client:
- Tip fermă: {{farm_type}}
- Suprafață: {{farm_size}} hectare
- Istoric achiziții: {{purchase_history}}

Produse de interes:
{{#each products}}
- {{name}}: {{quantity}} {{unit}} (preț curent: {{price}} RON)
{{/each}}

Întrebarea clientului:
"{{customer_message}}"

Formulează un răspuns care să:
1. Salute clientul pe nume
2. Răspundă la întrebarea specifică
3. Ofere informații relevante despre produsele menționate
4. Sugereze următorii pași`,
    variables: [
      { name: 'customer_name', type: 'string', description: 'Nume client', required: true, example: 'Ion Popescu' },
      { name: 'company_name', type: 'string', description: 'Nume firmă', required: true, example: 'AgroFerm SRL' },
      { name: 'cui', type: 'string', description: 'Cod Unic de Identificare', required: true, example: 'RO12345678' },
      { name: 'farm_type', type: 'string', description: 'Tipul fermei', required: false, example: 'cereale', defaultValue: 'nespecificat' },
      { name: 'farm_size', type: 'number', description: 'Suprafață în hectare', required: false, example: '150' },
      { name: 'purchase_history', type: 'string', description: 'Istoric achiziții', required: false, defaultValue: 'fără istoric' },
      { name: 'products', type: 'array', description: 'Lista produse', required: true },
      { name: 'customer_message', type: 'string', description: 'Mesajul clientului', required: true },
    ],
    tags: ['negociere', 'deschidere', 'agricol'],
    temperature: 0.7,
    maxTokens: 1000,
  },
  objection_price: {
    name: 'Răspuns Obiecție Preț',
    slug: 'objection-price',
    category: 'objection_handling',
    description: 'Template pentru gestionarea obiecțiilor legate de preț',
    systemPrompt: `Ești un agent de vânzări expert în gestionarea obiecțiilor de preț.
Scopul tău este să demonstrezi valoarea produsului și să găsești soluții.

Strategii de utilizat:
- Evidențiază calitatea și durabilitatea
- Compară cost per utilizare vs concurență
- Oferă alternative sau pachete
- Menționează garanții și suport
- Nu reduce prețul fără a primi ceva în schimb`,
    userPromptTemplate: `Clientul {{customer_name}} a ridicat o obiecție de preț pentru {{product_name}}.

Detalii produs:
- Preț curent: {{current_price}} RON
- Preț minim posibil: {{min_price}} RON (cu aprobare)
- Preț concurență: {{competitor_price}} RON

Obiecția clientului:
"{{objection_text}}"

Contextul negocierii:
{{negotiation_context}}

Formulează un răspuns care să:
1. Empatizeze cu preocuparea clientului
2. Evidențieze valoarea produsului
3. Ofere o soluție sau alternativă
4. Păstreze relația pozitivă`,
    variables: [
      { name: 'customer_name', type: 'string', required: true },
      { name: 'product_name', type: 'string', required: true },
      { name: 'current_price', type: 'number', required: true },
      { name: 'min_price', type: 'number', required: false },
      { name: 'competitor_price', type: 'number', required: false },
      { name: 'objection_text', type: 'string', required: true },
      { name: 'negotiation_context', type: 'string', required: false, defaultValue: 'Fără context adițional' },
    ],
    tags: ['obiecții', 'preț', 'negociere'],
    temperature: 0.6,
    maxTokens: 800,
  },
};

export function PromptTemplateForm({ open, onOpenChange, template, onSave }: PromptTemplateFormProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isTesting, setIsTesting] = useState(false);
  const [testOutput, setTestOutput] = useState<string | null>(null);
  const [testVariables, setTestVariables] = useState<Record<string, string>>({});

  const defaultValues: PromptTemplateFormData = template || {
    name: '',
    slug: '',
    category: 'custom',
    description: '',
    systemPrompt: '',
    userPromptTemplate: '',
    variables: [],
    isActive: true,
    version: 1,
    tags: [],
  };

  const form = useForm<PromptTemplateFormData>({
    resolver: zodResolver(promptTemplateSchema),
    defaultValues,
  });

  const { fields: variableFields, append: appendVariable, remove: removeVariable } = useFieldArray({
    control: form.control,
    name: 'variables',
  });

  const userPromptTemplate = form.watch('userPromptTemplate');

  // Extract variables from template
  const extractedVariables = useMemo(() => {
    const regex = /\{\{([^}]+)\}\}/g;
    const matches = userPromptTemplate.match(regex) || [];
    return [...new Set(matches.map(m => m.replace(/\{\{|\}\}/g, '').replace(/^#each\s+/, '')))];
  }, [userPromptTemplate]);

  // Auto-generate slug from name
  useEffect(() => {
    const name = form.watch('name');
    if (name && !template) {
      const slug = name
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');
      form.setValue('slug', slug);
    }
  }, [form.watch('name')]);

  const applyPreset = (presetKey: string) => {
    const preset = TEMPLATE_PRESETS[presetKey];
    if (preset) {
      Object.entries(preset).forEach(([key, value]) => {
        form.setValue(key as keyof PromptTemplateFormData, value as any);
      });
      toast.success(`Preset "${preset.name}" aplicat`);
    }
  };

  const addMissingVariables = () => {
    const currentVars = form.getValues('variables').map(v => v.name);
    const missing = extractedVariables.filter(v => !currentVars.includes(v));
    
    missing.forEach(name => {
      appendVariable({
        name,
        type: 'string',
        required: true,
        description: '',
        defaultValue: '',
        example: '',
      });
    });

    if (missing.length > 0) {
      toast.success(`${missing.length} variabile adăugate`);
    }
  };

  const testTemplate = async () => {
    setIsTesting(true);
    setTestOutput(null);
    try {
      const values = form.getValues();
      const response = await fetch('/api/v1/ai/templates/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...values,
          testVariables,
        }),
      });
      const data = await response.json();
      setTestOutput(data.output);
    } catch (error) {
      toast.error('Eroare la testarea template-ului');
    } finally {
      setIsTesting(false);
    }
  };

  const handleSubmit = async (data: PromptTemplateFormData) => {
    setIsSubmitting(true);
    try {
      await onSave(data);
      toast.success('Template salvat cu succes');
      onOpenChange(false);
    } catch (error) {
      toast.error('Eroare la salvarea template-ului');
    } finally {
      setIsSubmitting(false);
    }
  };

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
    toast.success('Copiat în clipboard');
  };

  return (
    <Sheet open={open} onOpenChange={onOpenChange}>
      <SheetContent className="w-[800px] sm:max-w-[800px]">
        <SheetHeader>
          <SheetTitle className="flex items-center gap-2">
            <FileText className="h-5 w-5" />
            {template ? 'Editare Template' : 'Template Nou'}
          </SheetTitle>
          <SheetDescription>
            Creează sau editează un template de prompt pentru AI
          </SheetDescription>
        </SheetHeader>

        <ScrollArea className="h-[calc(100vh-200px)] pr-4">
          <Form {...form}>
            <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-6 py-4">
              {/* Presets */}
              {!template && (
                <div className="space-y-2">
                  <label className="text-sm font-medium">Template-uri Predefinite</label>
                  <div className="flex flex-wrap gap-2">
                    {Object.entries(TEMPLATE_PRESETS).map(([key, preset]) => (
                      <Button
                        key={key}
                        type="button"
                        variant="outline"
                        size="sm"
                        onClick={() => applyPreset(key)}
                      >
                        <Wand2 className="h-3 w-3 mr-1" />
                        {preset.name}
                      </Button>
                    ))}
                  </div>
                </div>
              )}

              <Tabs defaultValue="basic" className="w-full">
                <TabsList className="grid w-full grid-cols-3">
                  <TabsTrigger value="basic">Informații</TabsTrigger>
                  <TabsTrigger value="content">Conținut</TabsTrigger>
                  <TabsTrigger value="variables">Variabile</TabsTrigger>
                </TabsList>

                {/* Tab: Basic Info */}
                <TabsContent value="basic" className="space-y-4 mt-4">
                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="name"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Nume Template *</FormLabel>
                          <FormControl>
                            <Input placeholder="Răspuns Obiecție Preț" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="slug"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Slug *</FormLabel>
                          <FormControl>
                            <Input placeholder="raspuns-obiectie-pret" {...field} />
                          </FormControl>
                          <FormDescription>
                            Identificator unic (auto-generat)
                          </FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <FormField
                    control={form.control}
                    name="category"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Categorie *</FormLabel>
                        <Select onValueChange={field.onChange} defaultValue={field.value}>
                          <FormControl>
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            {Object.entries(CATEGORY_LABELS).map(([key, label]) => (
                              <SelectItem key={key} value={key}>
                                {label}
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="description"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Descriere</FormLabel>
                        <FormControl>
                          <Textarea
                            placeholder="Descrie scopul și utilizarea template-ului..."
                            className="min-h-[80px]"
                            {...field}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="tags"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Tag-uri</FormLabel>
                        <FormControl>
                          <Input
                            placeholder="Separă tag-urile cu virgulă"
                            value={field.value.join(', ')}
                            onChange={(e) => {
                              const tags = e.target.value.split(',').map(t => t.trim()).filter(Boolean);
                              field.onChange(tags);
                            }}
                          />
                        </FormControl>
                        <div className="flex flex-wrap gap-1 mt-2">
                          {field.value.map((tag, idx) => (
                            <Badge key={idx} variant="secondary">
                              {tag}
                            </Badge>
                          ))}
                        </div>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <Separator />

                  <div className="grid grid-cols-3 gap-4">
                    <FormField
                      control={form.control}
                      name="defaultModel"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Model Default</FormLabel>
                          <Select onValueChange={field.onChange} defaultValue={field.value}>
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue placeholder="Orice model" />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="">Orice model</SelectItem>
                              <SelectItem value="claude-3-sonnet">Claude 3 Sonnet</SelectItem>
                              <SelectItem value="claude-3-haiku">Claude 3 Haiku</SelectItem>
                              <SelectItem value="gpt-4o-mini">GPT-4o Mini</SelectItem>
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="temperature"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Temperatură</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              step="0.1"
                              min="0"
                              max="2"
                              placeholder="0.7"
                              {...field}
                              value={field.value ?? ''}
                              onChange={(e) => field.onChange(e.target.value ? Number(e.target.value) : undefined)}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="maxTokens"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Max Tokens</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              placeholder="1000"
                              {...field}
                              value={field.value ?? ''}
                              onChange={(e) => field.onChange(e.target.value ? Number(e.target.value) : undefined)}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <FormField
                    control={form.control}
                    name="isActive"
                    render={({ field }) => (
                      <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                        <div className="space-y-0.5">
                          <FormLabel className="text-base">Template Activ</FormLabel>
                          <FormDescription>
                            Poate fi utilizat în sistem
                          </FormDescription>
                        </div>
                        <FormControl>
                          <Switch
                            checked={field.value}
                            onCheckedChange={field.onChange}
                          />
                        </FormControl>
                      </FormItem>
                    )}
                  />
                </TabsContent>

                {/* Tab: Content */}
                <TabsContent value="content" className="space-y-4 mt-4">
                  <FormField
                    control={form.control}
                    name="systemPrompt"
                    render={({ field }) => (
                      <FormItem>
                        <div className="flex justify-between items-center">
                          <FormLabel>System Prompt *</FormLabel>
                          <Button
                            type="button"
                            variant="ghost"
                            size="sm"
                            onClick={() => copyToClipboard(field.value)}
                          >
                            <Copy className="h-3 w-3 mr-1" />
                            Copiază
                          </Button>
                        </div>
                        <FormControl>
                          <Textarea
                            placeholder="Instrucțiuni de sistem pentru AI..."
                            className="min-h-[150px] font-mono text-sm"
                            {...field}
                          />
                        </FormControl>
                        <FormDescription>
                          Definește comportamentul și regulile generale pentru AI
                        </FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="userPromptTemplate"
                    render={({ field }) => (
                      <FormItem>
                        <div className="flex justify-between items-center">
                          <FormLabel>User Prompt Template *</FormLabel>
                          <Button
                            type="button"
                            variant="ghost"
                            size="sm"
                            onClick={() => copyToClipboard(field.value)}
                          >
                            <Copy className="h-3 w-3 mr-1" />
                            Copiază
                          </Button>
                        </div>
                        <FormControl>
                          <Textarea
                            placeholder="Template cu variabile {{variabila}}..."
                            className="min-h-[200px] font-mono text-sm"
                            {...field}
                          />
                        </FormControl>
                        <FormDescription>
                          Folosește <code>{'{{variabila}}'}</code> pentru variabile și{' '}
                          <code>{'{{#each lista}}...{{/each}}'}</code> pentru iterații
                        </FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  {/* Extracted Variables Preview */}
                  {extractedVariables.length > 0 && (
                    <Card>
                      <CardHeader className="py-3">
                        <CardTitle className="text-sm flex items-center justify-between">
                          <span className="flex items-center gap-2">
                            <Variable className="h-4 w-4" />
                            Variabile Detectate ({extractedVariables.length})
                          </span>
                          <Button
                            type="button"
                            variant="outline"
                            size="sm"
                            onClick={addMissingVariables}
                          >
                            <Plus className="h-3 w-3 mr-1" />
                            Adaugă Lipsă
                          </Button>
                        </CardTitle>
                      </CardHeader>
                      <CardContent className="py-2">
                        <div className="flex flex-wrap gap-1">
                          {extractedVariables.map((v) => {
                            const isDefined = variableFields.some(f => f.name === v);
                            return (
                              <Badge
                                key={v}
                                variant={isDefined ? 'default' : 'destructive'}
                              >
                                {isDefined ? (
                                  <CheckCircle className="h-3 w-3 mr-1" />
                                ) : (
                                  <AlertTriangle className="h-3 w-3 mr-1" />
                                )}
                                {v}
                              </Badge>
                            );
                          })}
                        </div>
                      </CardContent>
                    </Card>
                  )}
                </TabsContent>

                {/* Tab: Variables */}
                <TabsContent value="variables" className="space-y-4 mt-4">
                  <div className="flex justify-between items-center">
                    <h4 className="font-medium">Variabile ({variableFields.length})</h4>
                    <Button
                      type="button"
                      variant="outline"
                      size="sm"
                      onClick={() => appendVariable({
                        name: '',
                        type: 'string',
                        required: true,
                        description: '',
                        defaultValue: '',
                        example: '',
                      })}
                    >
                      <Plus className="h-4 w-4 mr-1" />
                      Adaugă Variabilă
                    </Button>
                  </div>

                  {variableFields.length === 0 ? (
                    <Alert>
                      <AlertTriangle className="h-4 w-4" />
                      <AlertDescription>
                        Nu sunt definite variabile. Adaugă variabile sau extrage-le automat din template.
                      </AlertDescription>
                    </Alert>
                  ) : (
                    <div className="space-y-3">
                      {variableFields.map((field, index) => (
                        <Card key={field.id}>
                          <CardContent className="pt-4">
                            <div className="grid grid-cols-6 gap-3">
                              <FormField
                                control={form.control}
                                name={`variables.${index}.name`}
                                render={({ field }) => (
                                  <FormItem className="col-span-2">
                                    <FormLabel className="text-xs">Nume *</FormLabel>
                                    <FormControl>
                                      <Input placeholder="variabila_name" {...field} className="h-8 text-sm" />
                                    </FormControl>
                                    <FormMessage />
                                  </FormItem>
                                )}
                              />

                              <FormField
                                control={form.control}
                                name={`variables.${index}.type`}
                                render={({ field }) => (
                                  <FormItem>
                                    <FormLabel className="text-xs">Tip</FormLabel>
                                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                                      <FormControl>
                                        <SelectTrigger className="h-8 text-sm">
                                          <SelectValue />
                                        </SelectTrigger>
                                      </FormControl>
                                      <SelectContent>
                                        {Object.entries(VARIABLE_TYPE_LABELS).map(([k, v]) => (
                                          <SelectItem key={k} value={k}>{v}</SelectItem>
                                        ))}
                                      </SelectContent>
                                    </Select>
                                    <FormMessage />
                                  </FormItem>
                                )}
                              />

                              <FormField
                                control={form.control}
                                name={`variables.${index}.example`}
                                render={({ field }) => (
                                  <FormItem className="col-span-2">
                                    <FormLabel className="text-xs">Exemplu</FormLabel>
                                    <FormControl>
                                      <Input placeholder="Valoare exemplu" {...field} className="h-8 text-sm" />
                                    </FormControl>
                                    <FormMessage />
                                  </FormItem>
                                )}
                              />

                              <div className="flex items-end gap-2">
                                <FormField
                                  control={form.control}
                                  name={`variables.${index}.required`}
                                  render={({ field }) => (
                                    <FormItem className="flex items-center gap-1">
                                      <FormControl>
                                        <Switch
                                          checked={field.value}
                                          onCheckedChange={field.onChange}
                                        />
                                      </FormControl>
                                      <FormLabel className="text-xs">Obl.</FormLabel>
                                    </FormItem>
                                  )}
                                />
                                <Button
                                  type="button"
                                  variant="ghost"
                                  size="icon"
                                  className="h-8 w-8"
                                  onClick={() => removeVariable(index)}
                                >
                                  <Trash2 className="h-4 w-4 text-destructive" />
                                </Button>
                              </div>
                            </div>

                            <div className="grid grid-cols-2 gap-3 mt-2">
                              <FormField
                                control={form.control}
                                name={`variables.${index}.description`}
                                render={({ field }) => (
                                  <FormItem>
                                    <FormLabel className="text-xs">Descriere</FormLabel>
                                    <FormControl>
                                      <Input placeholder="Descriere variabilă" {...field} className="h-8 text-sm" />
                                    </FormControl>
                                    <FormMessage />
                                  </FormItem>
                                )}
                              />

                              <FormField
                                control={form.control}
                                name={`variables.${index}.defaultValue`}
                                render={({ field }) => (
                                  <FormItem>
                                    <FormLabel className="text-xs">Valoare Default</FormLabel>
                                    <FormControl>
                                      <Input placeholder="Valoare default" {...field} className="h-8 text-sm" />
                                    </FormControl>
                                    <FormMessage />
                                  </FormItem>
                                )}
                              />
                            </div>
                          </CardContent>
                        </Card>
                      ))}
                    </div>
                  )}
                </TabsContent>
              </Tabs>

              {/* Test Section */}
              <Card>
                <CardHeader className="py-3">
                  <CardTitle className="text-sm flex items-center gap-2">
                    <Play className="h-4 w-4" />
                    Testare Template
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="grid grid-cols-2 gap-2">
                    {variableFields.filter(v => v.required).slice(0, 4).map((variable) => (
                      <div key={variable.id}>
                        <label className="text-xs font-medium">{variable.name}</label>
                        <Input
                          className="h-8 text-sm"
                          placeholder={variable.example || `Valoare ${variable.name}`}
                          value={testVariables[variable.name] || ''}
                          onChange={(e) => setTestVariables(prev => ({
                            ...prev,
                            [variable.name]: e.target.value,
                          }))}
                        />
                      </div>
                    ))}
                  </div>

                  <Button
                    type="button"
                    variant="secondary"
                    size="sm"
                    onClick={testTemplate}
                    disabled={isTesting}
                    className="w-full"
                  >
                    {isTesting ? (
                      <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                    ) : (
                      <Play className="h-4 w-4 mr-2" />
                    )}
                    Testează
                  </Button>

                  {testOutput && (
                    <div className="p-3 bg-muted rounded-lg">
                      <div className="flex justify-between items-center mb-2">
                        <span className="text-xs font-medium">Output</span>
                        <Button
                          type="button"
                          variant="ghost"
                          size="sm"
                          onClick={() => copyToClipboard(testOutput)}
                        >
                          <Copy className="h-3 w-3" />
                        </Button>
                      </div>
                      <pre className="text-xs whitespace-pre-wrap max-h-[150px] overflow-auto">
                        {testOutput}
                      </pre>
                    </div>
                  )}
                </CardContent>
              </Card>
            </form>
          </Form>
        </ScrollArea>

        <SheetFooter className="pt-4 border-t">
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Anulează
          </Button>
          <Button onClick={form.handleSubmit(handleSubmit)} disabled={isSubmitting}>
            {isSubmitting ? (
              <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
            ) : (
              <Save className="h-4 w-4 mr-2" />
            )}
            Salvează Template
          </Button>
        </SheetFooter>
      </SheetContent>
    </Sheet>
  );
}
```

## 8. Guardrails Forms

### 8.1 GuardrailRuleForm

Form pentru crearea și editarea regulilor de guardrail pentru protecția AI-ului.

```typescript
// components/forms/guardrails/guardrail-rule-form.tsx
import { useForm, useFieldArray } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { useState, useEffect } from 'react';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Switch } from '@/components/ui/switch';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from '@/components/ui/collapsible';
import { Slider } from '@/components/ui/slider';
import {
  Shield,
  AlertTriangle,
  Plus,
  Trash2,
  Save,
  ChevronDown,
  ChevronUp,
  Code,
  FileText,
  Zap,
  Settings,
  TestTube,
  Eye,
} from 'lucide-react';
import { toast } from 'sonner';

// Tipuri de guardrail disponibile
const guardrailTypes = [
  { value: 'content_filter', label: 'Filtru Conținut', description: 'Blochează conținut nepotrivit' },
  { value: 'hallucination_check', label: 'Anti-Halucinare', description: 'Verifică acuratețea faptelor' },
  { value: 'price_validator', label: 'Validator Preț', description: 'Validează limite de preț' },
  { value: 'pii_detector', label: 'Detector PII', description: 'Detectează date personale' },
  { value: 'sentiment_check', label: 'Verificare Sentiment', description: 'Analizează tonul mesajelor' },
  { value: 'compliance_check', label: 'Conformitate', description: 'Verifică regulamente (GDPR, etc.)' },
  { value: 'rate_limiter', label: 'Rate Limiter', description: 'Limitează frecvența acțiunilor' },
  { value: 'output_validator', label: 'Validator Output', description: 'Validează structura răspunsurilor' },
  { value: 'custom', label: 'Personalizat', description: 'Regulă customizată' },
] as const;

// Acțiuni disponibile când o regulă se declanșează
const triggerActions = [
  { value: 'block', label: 'Blochează', severity: 'critical' },
  { value: 'warn', label: 'Avertizează', severity: 'warning' },
  { value: 'modify', label: 'Modifică', severity: 'info' },
  { value: 'log', label: 'Doar Log', severity: 'low' },
  { value: 'escalate', label: 'Escaladează HITL', severity: 'high' },
  { value: 'retry', label: 'Reîncearcă', severity: 'info' },
] as const;

// Schema pentru condiție
const conditionSchema = z.object({
  field: z.string().min(1, 'Câmpul este obligatoriu'),
  operator: z.enum(['equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'regex', 'in', 'not_in']),
  value: z.string().min(1, 'Valoarea este obligatorie'),
  caseSensitive: z.boolean().default(false),
});

// Schema pentru acțiune
const actionConfigSchema = z.object({
  type: z.enum(['block', 'warn', 'modify', 'log', 'escalate', 'retry']),
  message: z.string().optional(),
  replacement: z.string().optional(),
  escalationLevel: z.enum(['L1', 'L2', 'L3']).optional(),
  retryCount: z.number().min(1).max(5).optional(),
  notifyChannels: z.array(z.string()).optional(),
});

// Schema principală pentru guardrail rule
const guardrailRuleSchema = z.object({
  name: z.string()
    .min(3, 'Numele trebuie să aibă minim 3 caractere')
    .max(100, 'Numele poate avea maxim 100 caractere'),
  description: z.string()
    .min(10, 'Descrierea trebuie să aibă minim 10 caractere')
    .max(500, 'Descrierea poate avea maxim 500 caractere'),
  type: z.enum(['content_filter', 'hallucination_check', 'price_validator', 'pii_detector', 'sentiment_check', 'compliance_check', 'rate_limiter', 'output_validator', 'custom']),
  
  // Configurare activare
  enabled: z.boolean().default(true),
  priority: z.number().min(1).max(100).default(50),
  
  // Scop aplicare
  scope: z.object({
    applyTo: z.enum(['all', 'input', 'output', 'both']).default('both'),
    stages: z.array(z.enum(['negotiation', 'pricing', 'document', 'communication'])).min(1),
    models: z.array(z.string()).optional(),
  }),
  
  // Condiții declanșare
  conditions: z.array(conditionSchema).min(1, 'Minim o condiție este necesară'),
  conditionLogic: z.enum(['AND', 'OR']).default('AND'),
  
  // Acțiuni la declanșare
  actions: z.array(actionConfigSchema).min(1, 'Minim o acțiune este necesară'),
  
  // Threshold și sensibilitate
  threshold: z.number().min(0).max(1).default(0.8),
  sensitivity: z.enum(['low', 'medium', 'high']).default('medium'),
  
  // Rate limiting specific
  rateLimit: z.object({
    maxRequests: z.number().min(1).max(10000).optional(),
    windowSeconds: z.number().min(1).max(86400).optional(),
    perUser: z.boolean().default(true),
  }).optional(),
  
  // Configurare custom pentru tipuri specifice
  customConfig: z.record(z.any()).optional(),
  
  // Metadata
  tags: z.array(z.string()).optional(),
  notes: z.string().optional(),
});

type GuardrailRuleFormData = z.infer<typeof guardrailRuleSchema>;

interface GuardrailRuleFormProps {
  rule?: Partial<GuardrailRuleFormData> & { id?: string };
  onSuccess?: (rule: GuardrailRuleFormData) => void;
  onCancel?: () => void;
}

export function GuardrailRuleForm({ rule, onSuccess, onCancel }: GuardrailRuleFormProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [activeTab, setActiveTab] = useState('basic');
  const [showAdvanced, setShowAdvanced] = useState(false);
  const [testMode, setTestMode] = useState(false);
  const [testInput, setTestInput] = useState('');
  const [testResult, setTestResult] = useState<{
    triggered: boolean;
    matches: string[];
    score: number;
    action: string;
  } | null>(null);

  const isEdit = !!rule?.id;

  const form = useForm<GuardrailRuleFormData>({
    resolver: zodResolver(guardrailRuleSchema),
    defaultValues: {
      name: rule?.name || '',
      description: rule?.description || '',
      type: rule?.type || 'content_filter',
      enabled: rule?.enabled ?? true,
      priority: rule?.priority || 50,
      scope: rule?.scope || {
        applyTo: 'both',
        stages: ['negotiation'],
        models: [],
      },
      conditions: rule?.conditions || [
        { field: '', operator: 'contains', value: '', caseSensitive: false }
      ],
      conditionLogic: rule?.conditionLogic || 'AND',
      actions: rule?.actions || [
        { type: 'warn', message: '' }
      ],
      threshold: rule?.threshold || 0.8,
      sensitivity: rule?.sensitivity || 'medium',
      rateLimit: rule?.rateLimit,
      customConfig: rule?.customConfig || {},
      tags: rule?.tags || [],
      notes: rule?.notes || '',
    },
  });

  const selectedType = form.watch('type');
  const threshold = form.watch('threshold');
  const sensitivity = form.watch('sensitivity');

  // Field arrays pentru condiții și acțiuni
  const {
    fields: conditionFields,
    append: appendCondition,
    remove: removeCondition,
  } = useFieldArray({
    control: form.control,
    name: 'conditions',
  });

  const {
    fields: actionFields,
    append: appendAction,
    remove: removeAction,
  } = useFieldArray({
    control: form.control,
    name: 'actions',
  });

  // Funcție pentru a testa regula
  const handleTestRule = async () => {
    if (!testInput.trim()) {
      toast.error('Introduceți text pentru testare');
      return;
    }

    setTestResult(null);
    
    // Simulare test - în producție ar fi API call
    await new Promise(resolve => setTimeout(resolve, 500));
    
    const conditions = form.getValues('conditions');
    const matches: string[] = [];
    let triggered = false;
    
    conditions.forEach(cond => {
      if (cond.value && testInput.toLowerCase().includes(cond.value.toLowerCase())) {
        matches.push(cond.value);
        triggered = true;
      }
    });

    setTestResult({
      triggered,
      matches,
      score: triggered ? 0.95 : 0.1,
      action: triggered ? form.getValues('actions')[0]?.type || 'warn' : 'none',
    });
  };

  const handleSubmit = async (data: GuardrailRuleFormData) => {
    setIsSubmitting(true);

    try {
      const endpoint = isEdit 
        ? `/api/v1/guardrails/rules/${rule.id}`
        : '/api/v1/guardrails/rules';
      
      const response = await fetch(endpoint, {
        method: isEdit ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Eroare la salvarea regulii');
      }

      toast.success(isEdit ? 'Regulă actualizată' : 'Regulă creată cu succes');
      onSuccess?.(data);
    } catch (error) {
      toast.error('Eroare la salvarea regulii');
      console.error(error);
    } finally {
      setIsSubmitting(false);
    }
  };

  // Funcție helper pentru label operator
  const getOperatorLabel = (op: string) => {
    const labels: Record<string, string> = {
      equals: 'Este egal cu',
      not_equals: 'Nu este egal cu',
      contains: 'Conține',
      not_contains: 'Nu conține',
      greater_than: 'Mai mare decât',
      less_than: 'Mai mic decât',
      regex: 'Regex',
      in: 'În lista',
      not_in: 'Nu în lista',
    };
    return labels[op] || op;
  };

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-6">
        <Tabs value={activeTab} onValueChange={setActiveTab}>
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="basic">
              <Settings className="h-4 w-4 mr-2" />
              Bază
            </TabsTrigger>
            <TabsTrigger value="conditions">
              <Code className="h-4 w-4 mr-2" />
              Condiții
            </TabsTrigger>
            <TabsTrigger value="actions">
              <Zap className="h-4 w-4 mr-2" />
              Acțiuni
            </TabsTrigger>
            <TabsTrigger value="test">
              <TestTube className="h-4 w-4 mr-2" />
              Test
            </TabsTrigger>
          </TabsList>

          {/* Tab: Configurare Bază */}
          <TabsContent value="basic" className="space-y-4 mt-4">
            <div className="grid grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="name"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Nume Regulă *</FormLabel>
                    <FormControl>
                      <Input placeholder="ex: Filtru cuvinte interzise" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="type"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Tip Guardrail *</FormLabel>
                    <Select onValueChange={field.onChange} value={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selectează tipul" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {guardrailTypes.map((type) => (
                          <SelectItem key={type.value} value={type.value}>
                            <div className="flex flex-col">
                              <span>{type.label}</span>
                              <span className="text-xs text-muted-foreground">
                                {type.description}
                              </span>
                            </div>
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <FormField
              control={form.control}
              name="description"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Descriere *</FormLabel>
                  <FormControl>
                    <Textarea 
                      placeholder="Descrieți scopul și funcționarea acestei reguli..."
                      rows={3}
                      {...field}
                    />
                  </FormControl>
                  <FormDescription>
                    {field.value?.length || 0}/500 caractere
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            <Separator />

            <div className="grid grid-cols-3 gap-4">
              <FormField
                control={form.control}
                name="enabled"
                render={({ field }) => (
                  <FormItem className="flex items-center justify-between rounded-lg border p-3">
                    <div>
                      <FormLabel>Activă</FormLabel>
                      <FormDescription className="text-xs">
                        Regula este activă
                      </FormDescription>
                    </div>
                    <FormControl>
                      <Switch
                        checked={field.value}
                        onCheckedChange={field.onChange}
                      />
                    </FormControl>
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="priority"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Prioritate (1-100)</FormLabel>
                    <FormControl>
                      <Input
                        type="number"
                        min={1}
                        max={100}
                        {...field}
                        onChange={(e) => field.onChange(parseInt(e.target.value))}
                      />
                    </FormControl>
                    <FormDescription className="text-xs">
                      Regulile cu prioritate mai mare se execută primele
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="sensitivity"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Sensibilitate</FormLabel>
                    <Select onValueChange={field.onChange} value={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        <SelectItem value="low">Scăzută</SelectItem>
                        <SelectItem value="medium">Medie</SelectItem>
                        <SelectItem value="high">Ridicată</SelectItem>
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            {/* Scop aplicare */}
            <Card>
              <CardHeader className="pb-3">
                <CardTitle className="text-sm">Scop Aplicare</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <FormField
                    control={form.control}
                    name="scope.applyTo"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Aplică la</FormLabel>
                        <Select onValueChange={field.onChange} value={field.value}>
                          <FormControl>
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            <SelectItem value="all">Tot</SelectItem>
                            <SelectItem value="input">Doar Input</SelectItem>
                            <SelectItem value="output">Doar Output</SelectItem>
                            <SelectItem value="both">Input & Output</SelectItem>
                          </SelectContent>
                        </Select>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="scope.stages"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Etape</FormLabel>
                        <div className="flex flex-wrap gap-2 mt-2">
                          {['negotiation', 'pricing', 'document', 'communication'].map((stage) => (
                            <Badge
                              key={stage}
                              variant={field.value?.includes(stage as any) ? 'default' : 'outline'}
                              className="cursor-pointer"
                              onClick={() => {
                                const current = field.value || [];
                                if (current.includes(stage as any)) {
                                  field.onChange(current.filter((s: string) => s !== stage));
                                } else {
                                  field.onChange([...current, stage]);
                                }
                              }}
                            >
                              {stage === 'negotiation' && 'Negociere'}
                              {stage === 'pricing' && 'Prețuri'}
                              {stage === 'document' && 'Documente'}
                              {stage === 'communication' && 'Comunicare'}
                            </Badge>
                          ))}
                        </div>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>
              </CardContent>
            </Card>

            {/* Threshold */}
            <FormField
              control={form.control}
              name="threshold"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Threshold Declanșare: {(threshold * 100).toFixed(0)}%</FormLabel>
                  <FormControl>
                    <Slider
                      value={[field.value]}
                      onValueChange={([val]) => field.onChange(val)}
                      min={0}
                      max={1}
                      step={0.05}
                      className="mt-2"
                    />
                  </FormControl>
                  <FormDescription>
                    Scor minim pentru declanșarea regulii (0% = mereu, 100% = niciodată)
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />
          </TabsContent>

          {/* Tab: Condiții */}
          <TabsContent value="conditions" className="space-y-4 mt-4">
            <div className="flex items-center justify-between">
              <div>
                <h3 className="text-sm font-medium">Condiții de Declanșare</h3>
                <p className="text-xs text-muted-foreground">
                  Definește când această regulă se declanșează
                </p>
              </div>
              <FormField
                control={form.control}
                name="conditionLogic"
                render={({ field }) => (
                  <div className="flex items-center gap-2">
                    <span className="text-sm">Logic:</span>
                    <Select onValueChange={field.onChange} value={field.value}>
                      <SelectTrigger className="w-[100px]">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="AND">AND (Toate)</SelectItem>
                        <SelectItem value="OR">OR (Oricare)</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                )}
              />
            </div>

            <ScrollArea className="h-[350px] pr-4">
              <div className="space-y-3">
                {conditionFields.map((field, index) => (
                  <Card key={field.id} className="p-4">
                    <div className="flex items-start gap-3">
                      <div className="flex-1 grid grid-cols-4 gap-3">
                        <FormField
                          control={form.control}
                          name={`conditions.${index}.field`}
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel className="text-xs">Câmp</FormLabel>
                              <FormControl>
                                <Input placeholder="ex: message.content" {...field} />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        <FormField
                          control={form.control}
                          name={`conditions.${index}.operator`}
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel className="text-xs">Operator</FormLabel>
                              <Select onValueChange={field.onChange} value={field.value}>
                                <FormControl>
                                  <SelectTrigger>
                                    <SelectValue />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  <SelectItem value="equals">Este egal cu</SelectItem>
                                  <SelectItem value="not_equals">Nu este egal cu</SelectItem>
                                  <SelectItem value="contains">Conține</SelectItem>
                                  <SelectItem value="not_contains">Nu conține</SelectItem>
                                  <SelectItem value="greater_than">Mai mare decât</SelectItem>
                                  <SelectItem value="less_than">Mai mic decât</SelectItem>
                                  <SelectItem value="regex">Regex</SelectItem>
                                  <SelectItem value="in">În lista</SelectItem>
                                  <SelectItem value="not_in">Nu în lista</SelectItem>
                                </SelectContent>
                              </Select>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        <FormField
                          control={form.control}
                          name={`conditions.${index}.value`}
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel className="text-xs">Valoare</FormLabel>
                              <FormControl>
                                <Input placeholder="ex: spam, ofertă" {...field} />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        <FormField
                          control={form.control}
                          name={`conditions.${index}.caseSensitive`}
                          render={({ field }) => (
                            <FormItem className="flex items-center gap-2 pt-6">
                              <FormControl>
                                <Switch
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <FormLabel className="text-xs">Case Sensitive</FormLabel>
                            </FormItem>
                          )}
                        />
                      </div>

                      <Button
                        type="button"
                        variant="ghost"
                        size="icon"
                        onClick={() => removeCondition(index)}
                        disabled={conditionFields.length === 1}
                        className="mt-6"
                      >
                        <Trash2 className="h-4 w-4 text-destructive" />
                      </Button>
                    </div>
                  </Card>
                ))}
              </div>
            </ScrollArea>

            <Button
              type="button"
              variant="outline"
              onClick={() => appendCondition({
                field: '',
                operator: 'contains',
                value: '',
                caseSensitive: false,
              })}
              className="w-full"
            >
              <Plus className="h-4 w-4 mr-2" />
              Adaugă Condiție
            </Button>

            {/* Preset-uri pentru tipuri specifice */}
            {selectedType === 'pii_detector' && (
              <Card className="bg-muted/50">
                <CardHeader className="pb-2">
                  <CardTitle className="text-sm">Preset-uri PII</CardTitle>
                </CardHeader>
                <CardContent className="flex flex-wrap gap-2">
                  {['CNP', 'Email', 'Telefon', 'IBAN', 'Adresă'].map((preset) => (
                    <Button
                      key={preset}
                      type="button"
                      variant="outline"
                      size="sm"
                      onClick={() => {
                        const patterns: Record<string, string> = {
                          CNP: '^[1-9]\\d{12}$',
                          Email: '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}',
                          Telefon: '(\\+40|0)[0-9]{9}',
                          IBAN: 'RO\\d{2}[A-Z]{4}[0-9A-Z]{16}',
                          Adresă: '(str\\.|strada|bd\\.|bulevardul)',
                        };
                        appendCondition({
                          field: 'content',
                          operator: 'regex',
                          value: patterns[preset],
                          caseSensitive: false,
                        });
                      }}
                    >
                      + {preset}
                    </Button>
                  ))}
                </CardContent>
              </Card>
            )}

            {selectedType === 'content_filter' && (
              <Card className="bg-muted/50">
                <CardHeader className="pb-2">
                  <CardTitle className="text-sm">Liste Predefinite</CardTitle>
                </CardHeader>
                <CardContent className="flex flex-wrap gap-2">
                  {['Profanități', 'Spam', 'Competitori', 'Prețuri Concurență'].map((preset) => (
                    <Button
                      key={preset}
                      type="button"
                      variant="outline"
                      size="sm"
                      onClick={() => {
                        toast.info(`Lista "${preset}" încărcată`);
                      }}
                    >
                      Încarcă {preset}
                    </Button>
                  ))}
                </CardContent>
              </Card>
            )}
          </TabsContent>

          {/* Tab: Acțiuni */}
          <TabsContent value="actions" className="space-y-4 mt-4">
            <div>
              <h3 className="text-sm font-medium">Acțiuni la Declanșare</h3>
              <p className="text-xs text-muted-foreground">
                Ce se întâmplă când regula se declanșează
              </p>
            </div>

            <ScrollArea className="h-[350px] pr-4">
              <div className="space-y-3">
                {actionFields.map((field, index) => (
                  <Card key={field.id} className="p-4">
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <FormField
                          control={form.control}
                          name={`actions.${index}.type`}
                          render={({ field }) => (
                            <FormItem className="flex-1">
                              <FormLabel className="text-xs">Tip Acțiune</FormLabel>
                              <Select onValueChange={field.onChange} value={field.value}>
                                <FormControl>
                                  <SelectTrigger>
                                    <SelectValue />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  {triggerActions.map((action) => (
                                    <SelectItem key={action.value} value={action.value}>
                                      <div className="flex items-center gap-2">
                                        <Badge
                                          variant={
                                            action.severity === 'critical' ? 'destructive' :
                                            action.severity === 'warning' ? 'warning' :
                                            action.severity === 'high' ? 'destructive' :
                                            'secondary'
                                          }
                                          className="text-xs"
                                        >
                                          {action.severity}
                                        </Badge>
                                        {action.label}
                                      </div>
                                    </SelectItem>
                                  ))}
                                </SelectContent>
                              </Select>
                            </FormItem>
                          )}
                        />

                        <Button
                          type="button"
                          variant="ghost"
                          size="icon"
                          onClick={() => removeAction(index)}
                          disabled={actionFields.length === 1}
                        >
                          <Trash2 className="h-4 w-4 text-destructive" />
                        </Button>
                      </div>

                      <FormField
                        control={form.control}
                        name={`actions.${index}.message`}
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel className="text-xs">Mesaj/Motiv</FormLabel>
                            <FormControl>
                              <Input
                                placeholder="Mesajul afișat utilizatorului sau logat"
                                {...field}
                              />
                            </FormControl>
                          </FormItem>
                        )}
                      />

                      {/* Câmpuri specifice pentru tipul de acțiune */}
                      {form.watch(`actions.${index}.type`) === 'modify' && (
                        <FormField
                          control={form.control}
                          name={`actions.${index}.replacement`}
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel className="text-xs">Înlocuire Cu</FormLabel>
                              <FormControl>
                                <Input
                                  placeholder="Text de înlocuire (sau [REDACTED])"
                                  {...field}
                                />
                              </FormControl>
                            </FormItem>
                          )}
                        />
                      )}

                      {form.watch(`actions.${index}.type`) === 'escalate' && (
                        <FormField
                          control={form.control}
                          name={`actions.${index}.escalationLevel`}
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel className="text-xs">Nivel Escaladare</FormLabel>
                              <Select onValueChange={field.onChange} value={field.value || 'L1'}>
                                <FormControl>
                                  <SelectTrigger>
                                    <SelectValue />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  <SelectItem value="L1">L1 - Operator</SelectItem>
                                  <SelectItem value="L2">L2 - Manager</SelectItem>
                                  <SelectItem value="L3">L3 - Director</SelectItem>
                                </SelectContent>
                              </Select>
                            </FormItem>
                          )}
                        />
                      )}

                      {form.watch(`actions.${index}.type`) === 'retry' && (
                        <FormField
                          control={form.control}
                          name={`actions.${index}.retryCount`}
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel className="text-xs">Număr Reîncercări</FormLabel>
                              <FormControl>
                                <Input
                                  type="number"
                                  min={1}
                                  max={5}
                                  {...field}
                                  onChange={(e) => field.onChange(parseInt(e.target.value))}
                                />
                              </FormControl>
                            </FormItem>
                          )}
                        />
                      )}
                    </div>
                  </Card>
                ))}
              </div>
            </ScrollArea>

            <Button
              type="button"
              variant="outline"
              onClick={() => appendAction({ type: 'log', message: '' })}
              className="w-full"
            >
              <Plus className="h-4 w-4 mr-2" />
              Adaugă Acțiune
            </Button>
          </TabsContent>

          {/* Tab: Test */}
          <TabsContent value="test" className="space-y-4 mt-4">
            <Card>
              <CardHeader>
                <CardTitle className="text-sm flex items-center gap-2">
                  <TestTube className="h-4 w-4" />
                  Testează Regula
                </CardTitle>
                <CardDescription>
                  Verifică dacă regula funcționează corect înainte de salvare
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <FormLabel>Input de Test</FormLabel>
                  <Textarea
                    placeholder="Introduceți text pentru a testa regula..."
                    value={testInput}
                    onChange={(e) => setTestInput(e.target.value)}
                    rows={4}
                    className="mt-2"
                  />
                </div>

                <Button
                  type="button"
                  onClick={handleTestRule}
                  disabled={!testInput.trim()}
                >
                  <TestTube className="h-4 w-4 mr-2" />
                  Rulează Test
                </Button>

                {testResult && (
                  <Card className={testResult.triggered ? 'border-destructive' : 'border-green-500'}>
                    <CardHeader className="pb-2">
                      <CardTitle className="text-sm flex items-center gap-2">
                        {testResult.triggered ? (
                          <>
                            <AlertTriangle className="h-4 w-4 text-destructive" />
                            <span className="text-destructive">Regulă Declanșată</span>
                          </>
                        ) : (
                          <>
                            <Shield className="h-4 w-4 text-green-500" />
                            <span className="text-green-500">Regulă Nu S-a Declanșat</span>
                          </>
                        )}
                      </CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-2">
                      <div className="grid grid-cols-3 gap-4 text-sm">
                        <div>
                          <span className="text-muted-foreground">Scor:</span>
                          <span className="ml-2 font-medium">
                            {(testResult.score * 100).toFixed(0)}%
                          </span>
                        </div>
                        <div>
                          <span className="text-muted-foreground">Threshold:</span>
                          <span className="ml-2 font-medium">
                            {(threshold * 100).toFixed(0)}%
                          </span>
                        </div>
                        <div>
                          <span className="text-muted-foreground">Acțiune:</span>
                          <Badge variant="outline" className="ml-2">
                            {testResult.action}
                          </Badge>
                        </div>
                      </div>

                      {testResult.matches.length > 0 && (
                        <div>
                          <span className="text-sm text-muted-foreground">Matches găsite:</span>
                          <div className="flex flex-wrap gap-1 mt-1">
                            {testResult.matches.map((match, idx) => (
                              <Badge key={idx} variant="destructive" className="text-xs">
                                {match}
                              </Badge>
                            ))}
                          </div>
                        </div>
                      )}
                    </CardContent>
                  </Card>
                )}

                {/* Preview configurație */}
                <Collapsible>
                  <CollapsibleTrigger asChild>
                    <Button variant="ghost" size="sm" className="w-full">
                      <Eye className="h-4 w-4 mr-2" />
                      Preview Configurație JSON
                      <ChevronDown className="h-4 w-4 ml-auto" />
                    </Button>
                  </CollapsibleTrigger>
                  <CollapsibleContent>
                    <pre className="mt-2 p-3 bg-muted rounded-lg text-xs overflow-auto max-h-[200px]">
                      {JSON.stringify(form.getValues(), null, 2)}
                    </pre>
                  </CollapsibleContent>
                </Collapsible>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>

        {/* Footer cu acțiuni */}
        <div className="flex justify-between items-center pt-4 border-t">
          <div className="flex items-center gap-2">
            <Badge variant={form.watch('enabled') ? 'default' : 'secondary'}>
              {form.watch('enabled') ? 'Activă' : 'Inactivă'}
            </Badge>
            <Badge variant="outline">
              Prioritate: {form.watch('priority')}
            </Badge>
            <Badge variant="outline">
              {guardrailTypes.find(t => t.value === selectedType)?.label}
            </Badge>
          </div>

          <div className="flex gap-2">
            {onCancel && (
              <Button type="button" variant="outline" onClick={onCancel}>
                Anulează
              </Button>
            )}
            <Button type="submit" disabled={isSubmitting}>
              {isSubmitting ? (
                <Save className="h-4 w-4 mr-2 animate-spin" />
              ) : (
                <Save className="h-4 w-4 mr-2" />
              )}
              {isEdit ? 'Actualizează Regulă' : 'Creează Regulă'}
            </Button>
          </div>
        </div>
      </form>
    </Form>
  );
}
```

### 8.2 GuardrailTestDialog

Dialog pentru testarea în masă a regulilor guardrail.

```typescript
// components/dialogs/guardrails/guardrail-test-dialog.tsx
import { useState } from 'react';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import {
  TestTube,
  Play,
  CheckCircle2,
  XCircle,
  AlertTriangle,
  Upload,
  FileText,
  RefreshCw,
  Download,
} from 'lucide-react';
import { toast } from 'sonner';

interface GuardrailRule {
  id: string;
  name: string;
  type: string;
  enabled: boolean;
}

interface TestCase {
  id: string;
  input: string;
  expectedResult: 'pass' | 'fail' | 'warn';
  description?: string;
}

interface TestResult {
  testCaseId: string;
  ruleId: string;
  ruleName: string;
  triggered: boolean;
  score: number;
  action: string;
  passed: boolean;
  duration: number;
  matches?: string[];
}

interface GuardrailTestDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  rules: GuardrailRule[];
}

export function GuardrailTestDialog({
  open,
  onOpenChange,
  rules,
}: GuardrailTestDialogProps) {
  const [selectedRules, setSelectedRules] = useState<string[]>([]);
  const [testCases, setTestCases] = useState<TestCase[]>([
    { id: '1', input: '', expectedResult: 'pass' }
  ]);
  const [isRunning, setIsRunning] = useState(false);
  const [progress, setProgress] = useState(0);
  const [results, setResults] = useState<TestResult[]>([]);
  const [activeTab, setActiveTab] = useState<'setup' | 'results'>('setup');

  const enabledRules = rules.filter(r => r.enabled);

  const toggleRule = (ruleId: string) => {
    setSelectedRules(prev =>
      prev.includes(ruleId)
        ? prev.filter(id => id !== ruleId)
        : [...prev, ruleId]
    );
  };

  const selectAllRules = () => {
    setSelectedRules(enabledRules.map(r => r.id));
  };

  const addTestCase = () => {
    setTestCases(prev => [
      ...prev,
      {
        id: String(Date.now()),
        input: '',
        expectedResult: 'pass',
      }
    ]);
  };

  const removeTestCase = (id: string) => {
    if (testCases.length > 1) {
      setTestCases(prev => prev.filter(tc => tc.id !== id));
    }
  };

  const updateTestCase = (id: string, updates: Partial<TestCase>) => {
    setTestCases(prev =>
      prev.map(tc => tc.id === id ? { ...tc, ...updates } : tc)
    );
  };

  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    try {
      const text = await file.text();
      const lines = text.split('\n').filter(l => l.trim());
      
      const newCases: TestCase[] = lines.map((line, idx) => ({
        id: String(Date.now() + idx),
        input: line.trim(),
        expectedResult: 'pass' as const,
      }));

      setTestCases(prev => [...prev, ...newCases]);
      toast.success(`${newCases.length} cazuri de test adăugate`);
    } catch (error) {
      toast.error('Eroare la citirea fișierului');
    }
  };

  const runTests = async () => {
    if (selectedRules.length === 0) {
      toast.error('Selectați cel puțin o regulă');
      return;
    }

    const validCases = testCases.filter(tc => tc.input.trim());
    if (validCases.length === 0) {
      toast.error('Adăugați cel puțin un caz de test');
      return;
    }

    setIsRunning(true);
    setProgress(0);
    setResults([]);
    setActiveTab('results');

    const totalTests = validCases.length * selectedRules.length;
    let completed = 0;
    const allResults: TestResult[] = [];

    for (const testCase of validCases) {
      for (const ruleId of selectedRules) {
        const rule = rules.find(r => r.id === ruleId);
        if (!rule) continue;

        try {
          const response = await fetch('/api/v1/guardrails/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ruleId,
              input: testCase.input,
            }),
          });

          const data = await response.json();
          
          const triggered = data.triggered;
          const passed = 
            (testCase.expectedResult === 'pass' && !triggered) ||
            (testCase.expectedResult === 'fail' && triggered) ||
            (testCase.expectedResult === 'warn' && data.action === 'warn');

          allResults.push({
            testCaseId: testCase.id,
            ruleId,
            ruleName: rule.name,
            triggered,
            score: data.score || 0,
            action: data.action || 'none',
            passed,
            duration: data.duration || 0,
            matches: data.matches,
          });
        } catch (error) {
          allResults.push({
            testCaseId: testCase.id,
            ruleId,
            ruleName: rule.name,
            triggered: false,
            score: 0,
            action: 'error',
            passed: false,
            duration: 0,
          });
        }

        completed++;
        setProgress((completed / totalTests) * 100);
        setResults([...allResults]);
      }
    }

    setIsRunning(false);
    
    const passedCount = allResults.filter(r => r.passed).length;
    if (passedCount === allResults.length) {
      toast.success('Toate testele au trecut!');
    } else {
      toast.warning(`${passedCount}/${allResults.length} teste trecute`);
    }
  };

  const exportResults = () => {
    const csv = [
      ['Test Case', 'Rule', 'Triggered', 'Score', 'Action', 'Passed', 'Duration (ms)'].join(','),
      ...results.map(r => [
        testCases.find(tc => tc.id === r.testCaseId)?.input?.substring(0, 50) || '',
        r.ruleName,
        r.triggered,
        r.score.toFixed(2),
        r.action,
        r.passed,
        r.duration,
      ].join(','))
    ].join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `guardrail-test-results-${Date.now()}.csv`;
    a.click();
  };

  const passedCount = results.filter(r => r.passed).length;
  const failedCount = results.filter(r => !r.passed).length;

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-4xl max-h-[90vh]">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <TestTube className="h-5 w-5" />
            Test Guardrail Rules
          </DialogTitle>
          <DialogDescription>
            Testează regulile guardrail cu cazuri de test personalizate
          </DialogDescription>
        </DialogHeader>

        <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as 'setup' | 'results')}>
          <TabsList className="grid w-full grid-cols-2">
            <TabsTrigger value="setup">Configurare Test</TabsTrigger>
            <TabsTrigger value="results" disabled={results.length === 0}>
              Rezultate {results.length > 0 && `(${passedCount}/${results.length})`}
            </TabsTrigger>
          </TabsList>

          <TabsContent value="setup" className="space-y-4 mt-4">
            {/* Selectare reguli */}
            <div>
              <div className="flex items-center justify-between mb-2">
                <Label>Reguli de Testat</Label>
                <Button variant="ghost" size="sm" onClick={selectAllRules}>
                  Selectează Toate ({enabledRules.length})
                </Button>
              </div>
              <ScrollArea className="h-[120px] border rounded-lg p-2">
                <div className="space-y-2">
                  {enabledRules.map((rule) => (
                    <div
                      key={rule.id}
                      className="flex items-center gap-2 p-2 hover:bg-muted rounded cursor-pointer"
                      onClick={() => toggleRule(rule.id)}
                    >
                      <Checkbox
                        checked={selectedRules.includes(rule.id)}
                        onCheckedChange={() => toggleRule(rule.id)}
                      />
                      <span className="text-sm flex-1">{rule.name}</span>
                      <Badge variant="outline" className="text-xs">
                        {rule.type}
                      </Badge>
                    </div>
                  ))}
                </div>
              </ScrollArea>
              <p className="text-xs text-muted-foreground mt-1">
                {selectedRules.length} reguli selectate
              </p>
            </div>

            {/* Cazuri de test */}
            <div>
              <div className="flex items-center justify-between mb-2">
                <Label>Cazuri de Test</Label>
                <div className="flex gap-2">
                  <Button variant="outline" size="sm" asChild>
                    <label>
                      <Upload className="h-4 w-4 mr-1" />
                      Import
                      <input
                        type="file"
                        accept=".txt,.csv"
                        className="hidden"
                        onChange={handleFileUpload}
                      />
                    </label>
                  </Button>
                  <Button variant="outline" size="sm" onClick={addTestCase}>
                    + Adaugă
                  </Button>
                </div>
              </div>
              <ScrollArea className="h-[200px] border rounded-lg p-2">
                <div className="space-y-2">
                  {testCases.map((tc, idx) => (
                    <Card key={tc.id} className="p-3">
                      <div className="flex gap-2">
                        <div className="flex-1">
                          <Textarea
                            placeholder={`Test case ${idx + 1}...`}
                            value={tc.input}
                            onChange={(e) => updateTestCase(tc.id, { input: e.target.value })}
                            rows={2}
                            className="text-sm"
                          />
                        </div>
                        <div className="flex flex-col gap-2">
                          <Select
                            value={tc.expectedResult}
                            onValueChange={(v) => updateTestCase(tc.id, { 
                              expectedResult: v as 'pass' | 'fail' | 'warn' 
                            })}
                          >
                            <SelectTrigger className="w-[100px]">
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="pass">
                                <span className="flex items-center gap-1">
                                  <CheckCircle2 className="h-3 w-3 text-green-500" />
                                  Pass
                                </span>
                              </SelectItem>
                              <SelectItem value="fail">
                                <span className="flex items-center gap-1">
                                  <XCircle className="h-3 w-3 text-red-500" />
                                  Fail
                                </span>
                              </SelectItem>
                              <SelectItem value="warn">
                                <span className="flex items-center gap-1">
                                  <AlertTriangle className="h-3 w-3 text-yellow-500" />
                                  Warn
                                </span>
                              </SelectItem>
                            </SelectContent>
                          </Select>
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => removeTestCase(tc.id)}
                            disabled={testCases.length === 1}
                          >
                            <XCircle className="h-4 w-4" />
                          </Button>
                        </div>
                      </div>
                    </Card>
                  ))}
                </div>
              </ScrollArea>
            </div>
          </TabsContent>

          <TabsContent value="results" className="space-y-4 mt-4">
            {isRunning && (
              <div className="space-y-2">
                <div className="flex items-center gap-2">
                  <RefreshCw className="h-4 w-4 animate-spin" />
                  <span className="text-sm">Rulare teste...</span>
                </div>
                <Progress value={progress} />
              </div>
            )}

            {/* Summary */}
            {results.length > 0 && (
              <div className="grid grid-cols-3 gap-4">
                <Card className="p-3 bg-green-50 dark:bg-green-900/20">
                  <div className="flex items-center gap-2">
                    <CheckCircle2 className="h-5 w-5 text-green-500" />
                    <div>
                      <p className="text-2xl font-bold text-green-600">{passedCount}</p>
                      <p className="text-xs text-muted-foreground">Trecute</p>
                    </div>
                  </div>
                </Card>
                <Card className="p-3 bg-red-50 dark:bg-red-900/20">
                  <div className="flex items-center gap-2">
                    <XCircle className="h-5 w-5 text-red-500" />
                    <div>
                      <p className="text-2xl font-bold text-red-600">{failedCount}</p>
                      <p className="text-xs text-muted-foreground">Eșuate</p>
                    </div>
                  </div>
                </Card>
                <Card className="p-3">
                  <div className="flex items-center gap-2">
                    <TestTube className="h-5 w-5" />
                    <div>
                      <p className="text-2xl font-bold">{results.length}</p>
                      <p className="text-xs text-muted-foreground">Total</p>
                    </div>
                  </div>
                </Card>
              </div>
            )}

            {/* Results list */}
            <ScrollArea className="h-[250px] border rounded-lg">
              <div className="p-2 space-y-2">
                {results.map((result, idx) => (
                  <Card
                    key={idx}
                    className={`p-3 ${result.passed ? 'border-green-200' : 'border-red-200'}`}
                  >
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="flex items-center gap-2">
                          {result.passed ? (
                            <CheckCircle2 className="h-4 w-4 text-green-500" />
                          ) : (
                            <XCircle className="h-4 w-4 text-red-500" />
                          )}
                          <span className="text-sm font-medium">{result.ruleName}</span>
                        </div>
                        <p className="text-xs text-muted-foreground mt-1 line-clamp-1">
                          Input: {testCases.find(tc => tc.id === result.testCaseId)?.input}
                        </p>
                        {result.matches && result.matches.length > 0 && (
                          <div className="flex gap-1 mt-1">
                            {result.matches.map((m, i) => (
                              <Badge key={i} variant="destructive" className="text-xs">
                                {m}
                              </Badge>
                            ))}
                          </div>
                        )}
                      </div>
                      <div className="text-right text-xs">
                        <Badge variant={result.triggered ? 'destructive' : 'secondary'}>
                          {result.triggered ? 'Triggered' : 'Not Triggered'}
                        </Badge>
                        <p className="text-muted-foreground mt-1">
                          Score: {(result.score * 100).toFixed(0)}%
                        </p>
                        <p className="text-muted-foreground">
                          {result.duration}ms
                        </p>
                      </div>
                    </div>
                  </Card>
                ))}
              </div>
            </ScrollArea>
          </TabsContent>
        </Tabs>

        <DialogFooter>
          {activeTab === 'results' && results.length > 0 && (
            <Button variant="outline" onClick={exportResults}>
              <Download className="h-4 w-4 mr-2" />
              Export CSV
            </Button>
          )}
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Închide
          </Button>
          {activeTab === 'setup' && (
            <Button onClick={runTests} disabled={isRunning}>
              {isRunning ? (
                <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
              ) : (
                <Play className="h-4 w-4 mr-2" />
              )}
              Rulează Teste
            </Button>
          )}
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

## 9. HITL Approval Dialogs

### 9.1 ApprovalDialog

Dialog principal pentru aprobarea sau respingerea cererilor HITL.

```typescript
// components/dialogs/hitl/approval-dialog.tsx
import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Separator } from '@/components/ui/separator';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from '@/components/ui/collapsible';
import {
  CheckCircle2,
  XCircle,
  Clock,
  AlertTriangle,
  User,
  Calendar,
  FileText,
  MessageSquare,
  ChevronDown,
  History,
  Edit3,
  ThumbsUp,
  ThumbsDown,
  RefreshCw,
  ArrowUpRight,
} from 'lucide-react';
import { formatDistanceToNow, format, differenceInHours } from 'date-fns';
import { ro } from 'date-fns/locale';
import { toast } from 'sonner';

// Tipuri de cereri HITL
type ApprovalType = 
  | 'discount_approval'
  | 'price_override'
  | 'document_generation'
  | 'ai_response'
  | 'negotiation_stage'
  | 'custom_offer';

// Statusuri posibile
type ApprovalStatus = 'pending' | 'approved' | 'rejected' | 'escalated' | 'expired';

// Schema pentru decizie
const approvalDecisionSchema = z.object({
  decision: z.enum(['approve', 'reject', 'request_changes', 'escalate']),
  reason: z.string()
    .min(10, 'Motivul trebuie să aibă minim 10 caractere')
    .max(1000, 'Motivul poate avea maxim 1000 caractere'),
  modifications: z.string().optional(),
  internalNote: z.string().max(500).optional(),
  escalateTo: z.string().optional(),
});

type ApprovalDecisionData = z.infer<typeof approvalDecisionSchema>;

interface ApprovalRequest {
  id: string;
  type: ApprovalType;
  status: ApprovalStatus;
  priority: 'low' | 'medium' | 'high' | 'critical';
  createdAt: string;
  expiresAt: string;
  requestedBy: {
    id: string;
    name: string;
    role: string;
  };
  context: {
    negotiationId?: string;
    negotiationName?: string;
    clientName?: string;
    clientCui?: string;
    amount?: number;
    discountPercent?: number;
    originalContent?: string;
    proposedContent?: string;
  };
  metadata: Record<string, any>;
  slaLevel: 'L1' | 'L2' | 'L3';
  history: Array<{
    action: string;
    actor: string;
    timestamp: string;
    note?: string;
  }>;
}

interface ApprovalDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  request: ApprovalRequest | null;
  onDecision?: (requestId: string, decision: ApprovalDecisionData) => void;
}

export function ApprovalDialog({
  open,
  onOpenChange,
  request,
  onDecision,
}: ApprovalDialogProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showConfirm, setShowConfirm] = useState(false);
  const [pendingDecision, setPendingDecision] = useState<ApprovalDecisionData | null>(null);
  const [activeTab, setActiveTab] = useState('details');

  const form = useForm<ApprovalDecisionData>({
    resolver: zodResolver(approvalDecisionSchema),
    defaultValues: {
      decision: 'approve',
      reason: '',
      modifications: '',
      internalNote: '',
      escalateTo: '',
    },
  });

  const selectedDecision = form.watch('decision');

  // Reset form când se deschide dialogul
  useEffect(() => {
    if (open && request) {
      form.reset({
        decision: 'approve',
        reason: '',
        modifications: '',
        internalNote: '',
        escalateTo: '',
      });
      setActiveTab('details');
    }
  }, [open, request, form]);

  if (!request) return null;

  // Calculează timpul rămas
  const hoursRemaining = differenceInHours(new Date(request.expiresAt), new Date());
  const isExpiringSoon = hoursRemaining <= 4;
  const isExpired = hoursRemaining <= 0;

  // Funcție pentru label tip
  const getTypeLabel = (type: ApprovalType) => {
    const labels: Record<ApprovalType, string> = {
      discount_approval: 'Aprobare Discount',
      price_override: 'Modificare Preț',
      document_generation: 'Generare Document',
      ai_response: 'Răspuns AI',
      negotiation_stage: 'Etapă Negociere',
      custom_offer: 'Ofertă Personalizată',
    };
    return labels[type];
  };

  // Funcție pentru culoare prioritate
  const getPriorityColor = (priority: string) => {
    const colors: Record<string, string> = {
      low: 'bg-slate-100 text-slate-800',
      medium: 'bg-blue-100 text-blue-800',
      high: 'bg-orange-100 text-orange-800',
      critical: 'bg-red-100 text-red-800',
    };
    return colors[priority] || colors.medium;
  };

  const handleSubmitDecision = async (data: ApprovalDecisionData) => {
    // Pentru decizii critice, arată confirmare
    if (data.decision === 'reject' || data.decision === 'escalate') {
      setPendingDecision(data);
      setShowConfirm(true);
      return;
    }

    await processDecision(data);
  };

  const processDecision = async (data: ApprovalDecisionData) => {
    setIsSubmitting(true);

    try {
      const response = await fetch(`/api/v1/hitl/requests/${request.id}/decision`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Eroare la procesarea deciziei');
      }

      const decisionLabels = {
        approve: 'aprobată',
        reject: 'respinsă',
        request_changes: 'returnată pentru modificări',
        escalate: 'escaladată',
      };

      toast.success(`Cererea a fost ${decisionLabels[data.decision]}`);
      onDecision?.(request.id, data);
      onOpenChange(false);
    } catch (error) {
      toast.error('Eroare la procesarea deciziei');
      console.error(error);
    } finally {
      setIsSubmitting(false);
      setShowConfirm(false);
      setPendingDecision(null);
    }
  };

  return (
    <>
      <Dialog open={open} onOpenChange={onOpenChange}>
        <DialogContent className="max-w-3xl max-h-[90vh]">
          <DialogHeader>
            <div className="flex items-center justify-between">
              <DialogTitle className="flex items-center gap-2">
                <FileText className="h-5 w-5" />
                Cerere de Aprobare #{request.id.slice(-8)}
              </DialogTitle>
              <div className="flex items-center gap-2">
                <Badge className={getPriorityColor(request.priority)}>
                  {request.priority.toUpperCase()}
                </Badge>
                <Badge variant="outline">
                  {request.slaLevel}
                </Badge>
              </div>
            </div>
            <DialogDescription>
              {getTypeLabel(request.type)} • Creat {formatDistanceToNow(new Date(request.createdAt), { locale: ro, addSuffix: true })}
            </DialogDescription>
          </DialogHeader>

          {/* Alertă expirare */}
          {(isExpiringSoon || isExpired) && (
            <div className={`p-3 rounded-lg flex items-center gap-2 ${
              isExpired ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'
            }`}>
              <AlertTriangle className="h-4 w-4" />
              <span className="text-sm font-medium">
                {isExpired 
                  ? 'Această cerere a expirat!' 
                  : `Expiră în ${hoursRemaining} ore`
                }
              </span>
            </div>
          )}

          <Tabs value={activeTab} onValueChange={setActiveTab}>
            <TabsList className="grid w-full grid-cols-3">
              <TabsTrigger value="details">Detalii</TabsTrigger>
              <TabsTrigger value="content">Conținut</TabsTrigger>
              <TabsTrigger value="history">Istoric</TabsTrigger>
            </TabsList>

            {/* Tab: Detalii */}
            <TabsContent value="details" className="mt-4 space-y-4">
              <div className="grid grid-cols-2 gap-4">
                {/* Info Client */}
                <Card>
                  <CardHeader className="pb-2">
                    <CardTitle className="text-sm">Client</CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-2">
                    <div className="flex justify-between">
                      <span className="text-sm text-muted-foreground">Nume:</span>
                      <span className="text-sm font-medium">{request.context.clientName || '-'}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm text-muted-foreground">CUI:</span>
                      <span className="text-sm font-mono">{request.context.clientCui || '-'}</span>
                    </div>
                    {request.context.negotiationName && (
                      <div className="flex justify-between">
                        <span className="text-sm text-muted-foreground">Negociere:</span>
                        <span className="text-sm">{request.context.negotiationName}</span>
                      </div>
                    )}
                  </CardContent>
                </Card>

                {/* Info Cerere */}
                <Card>
                  <CardHeader className="pb-2">
                    <CardTitle className="text-sm">Cerere</CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-2">
                    <div className="flex justify-between">
                      <span className="text-sm text-muted-foreground">Solicitat de:</span>
                      <span className="text-sm font-medium flex items-center gap-1">
                        <User className="h-3 w-3" />
                        {request.requestedBy.name}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm text-muted-foreground">Rol:</span>
                      <span className="text-sm">{request.requestedBy.role}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm text-muted-foreground">SLA:</span>
                      <span className="text-sm">{request.slaLevel}</span>
                    </div>
                  </CardContent>
                </Card>
              </div>

              {/* Detalii specifice tipului */}
              {request.type === 'discount_approval' && request.context.discountPercent && (
                <Card className="border-orange-200 bg-orange-50/50">
                  <CardContent className="pt-4">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-muted-foreground">Discount Solicitat</p>
                        <p className="text-3xl font-bold text-orange-600">
                          {request.context.discountPercent}%
                        </p>
                      </div>
                      {request.context.amount && (
                        <div className="text-right">
                          <p className="text-sm text-muted-foreground">Valoare Afectată</p>
                          <p className="text-2xl font-bold">
                            {request.context.amount.toLocaleString('ro-RO')} RON
                          </p>
                        </div>
                      )}
                    </div>
                  </CardContent>
                </Card>
              )}

              {request.type === 'price_override' && request.context.amount && (
                <Card className="border-blue-200 bg-blue-50/50">
                  <CardContent className="pt-4">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-muted-foreground">Preț Nou Propus</p>
                        <p className="text-3xl font-bold text-blue-600">
                          {request.context.amount.toLocaleString('ro-RO')} RON
                        </p>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              )}

              {/* Metadata */}
              {Object.keys(request.metadata).length > 0 && (
                <Collapsible>
                  <CollapsibleTrigger asChild>
                    <Button variant="ghost" className="w-full justify-between">
                      <span className="text-sm">Metadata Adițională</span>
                      <ChevronDown className="h-4 w-4" />
                    </Button>
                  </CollapsibleTrigger>
                  <CollapsibleContent>
                    <pre className="mt-2 p-3 bg-muted rounded-lg text-xs overflow-auto">
                      {JSON.stringify(request.metadata, null, 2)}
                    </pre>
                  </CollapsibleContent>
                </Collapsible>
              )}
            </TabsContent>

            {/* Tab: Conținut */}
            <TabsContent value="content" className="mt-4 space-y-4">
              {request.context.originalContent && (
                <Card>
                  <CardHeader className="pb-2">
                    <CardTitle className="text-sm flex items-center gap-2">
                      <FileText className="h-4 w-4" />
                      Conținut Original
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <ScrollArea className="h-[150px]">
                      <div className="whitespace-pre-wrap text-sm bg-muted p-3 rounded">
                        {request.context.originalContent}
                      </div>
                    </ScrollArea>
                  </CardContent>
                </Card>
              )}

              {request.context.proposedContent && (
                <Card className="border-primary">
                  <CardHeader className="pb-2">
                    <CardTitle className="text-sm flex items-center gap-2">
                      <Edit3 className="h-4 w-4 text-primary" />
                      Conținut Propus
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <ScrollArea className="h-[150px]">
                      <div className="whitespace-pre-wrap text-sm bg-primary/5 p-3 rounded border border-primary/20">
                        {request.context.proposedContent}
                      </div>
                    </ScrollArea>
                  </CardContent>
                </Card>
              )}

              {!request.context.originalContent && !request.context.proposedContent && (
                <div className="text-center py-8 text-muted-foreground">
                  <MessageSquare className="h-12 w-12 mx-auto mb-2 opacity-50" />
                  <p>Nu există conținut de afișat pentru această cerere</p>
                </div>
              )}
            </TabsContent>

            {/* Tab: Istoric */}
            <TabsContent value="history" className="mt-4">
              <ScrollArea className="h-[300px]">
                <div className="space-y-4">
                  {request.history.length === 0 ? (
                    <div className="text-center py-8 text-muted-foreground">
                      <History className="h-12 w-12 mx-auto mb-2 opacity-50" />
                      <p>Nu există istoric pentru această cerere</p>
                    </div>
                  ) : (
                    request.history.map((event, idx) => (
                      <div key={idx} className="flex gap-3">
                        <div className="w-10 h-10 rounded-full bg-muted flex items-center justify-center shrink-0">
                          {event.action === 'created' && <FileText className="h-4 w-4" />}
                          {event.action === 'approved' && <CheckCircle2 className="h-4 w-4 text-green-500" />}
                          {event.action === 'rejected' && <XCircle className="h-4 w-4 text-red-500" />}
                          {event.action === 'escalated' && <ArrowUpRight className="h-4 w-4 text-orange-500" />}
                          {event.action === 'commented' && <MessageSquare className="h-4 w-4" />}
                        </div>
                        <div className="flex-1">
                          <div className="flex items-center justify-between">
                            <span className="text-sm font-medium">{event.actor}</span>
                            <span className="text-xs text-muted-foreground">
                              {format(new Date(event.timestamp), 'dd MMM yyyy, HH:mm', { locale: ro })}
                            </span>
                          </div>
                          <p className="text-sm text-muted-foreground capitalize">{event.action}</p>
                          {event.note && (
                            <p className="text-sm mt-1 p-2 bg-muted rounded">{event.note}</p>
                          )}
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </ScrollArea>
            </TabsContent>
          </Tabs>

          <Separator />

          {/* Form pentru decizie */}
          {request.status === 'pending' && (
            <Form {...form}>
              <form onSubmit={form.handleSubmit(handleSubmitDecision)} className="space-y-4">
                <FormField
                  control={form.control}
                  name="decision"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Decizie</FormLabel>
                      <div className="grid grid-cols-4 gap-2">
                        {[
                          { value: 'approve', label: 'Aprobă', icon: ThumbsUp, color: 'text-green-600' },
                          { value: 'reject', label: 'Respinge', icon: ThumbsDown, color: 'text-red-600' },
                          { value: 'request_changes', label: 'Modificări', icon: Edit3, color: 'text-yellow-600' },
                          { value: 'escalate', label: 'Escaladează', icon: ArrowUpRight, color: 'text-orange-600' },
                        ].map((option) => (
                          <Button
                            key={option.value}
                            type="button"
                            variant={field.value === option.value ? 'default' : 'outline'}
                            className={`flex flex-col h-auto py-3 ${field.value === option.value ? '' : option.color}`}
                            onClick={() => field.onChange(option.value)}
                          >
                            <option.icon className="h-5 w-5 mb-1" />
                            <span className="text-xs">{option.label}</span>
                          </Button>
                        ))}
                      </div>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="reason"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Motivare *</FormLabel>
                      <FormControl>
                        <Textarea
                          placeholder={
                            selectedDecision === 'approve' 
                              ? 'Motivul aprobării...'
                              : selectedDecision === 'reject'
                              ? 'Motivul respingerii...'
                              : selectedDecision === 'request_changes'
                              ? 'Ce modificări sunt necesare...'
                              : 'Motivul escaladării...'
                          }
                          rows={3}
                          {...field}
                        />
                      </FormControl>
                      <FormDescription>
                        {field.value?.length || 0}/1000 caractere
                      </FormDescription>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                {selectedDecision === 'request_changes' && (
                  <FormField
                    control={form.control}
                    name="modifications"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Modificări Sugerate</FormLabel>
                        <FormControl>
                          <Textarea
                            placeholder="Descrieți modificările necesare..."
                            rows={2}
                            {...field}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                )}

                {selectedDecision === 'escalate' && (
                  <FormField
                    control={form.control}
                    name="escalateTo"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Escaladează către</FormLabel>
                        <Select onValueChange={field.onChange} value={field.value}>
                          <FormControl>
                            <SelectTrigger>
                              <SelectValue placeholder="Selectează destinatar" />
                            </SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            <SelectItem value="L2">Manager (L2)</SelectItem>
                            <SelectItem value="L3">Director (L3)</SelectItem>
                            <SelectItem value="legal">Departament Legal</SelectItem>
                            <SelectItem value="finance">Departament Financiar</SelectItem>
                          </SelectContent>
                        </Select>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                )}

                <FormField
                  control={form.control}
                  name="internalNote"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Notă Internă (opțional)</FormLabel>
                      <FormControl>
                        <Input
                          placeholder="Notă vizibilă doar intern..."
                          {...field}
                        />
                      </FormControl>
                      <FormDescription>
                        Această notă nu va fi vizibilă pentru solicitant
                      </FormDescription>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <DialogFooter>
                  <Button type="button" variant="outline" onClick={() => onOpenChange(false)}>
                    Anulează
                  </Button>
                  <Button 
                    type="submit" 
                    disabled={isSubmitting || isExpired}
                    variant={selectedDecision === 'reject' ? 'destructive' : 'default'}
                  >
                    {isSubmitting ? (
                      <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                    ) : selectedDecision === 'approve' ? (
                      <ThumbsUp className="h-4 w-4 mr-2" />
                    ) : selectedDecision === 'reject' ? (
                      <ThumbsDown className="h-4 w-4 mr-2" />
                    ) : selectedDecision === 'escalate' ? (
                      <ArrowUpRight className="h-4 w-4 mr-2" />
                    ) : (
                      <Edit3 className="h-4 w-4 mr-2" />
                    )}
                    {selectedDecision === 'approve' && 'Aprobă'}
                    {selectedDecision === 'reject' && 'Respinge'}
                    {selectedDecision === 'request_changes' && 'Cere Modificări'}
                    {selectedDecision === 'escalate' && 'Escaladează'}
                  </Button>
                </DialogFooter>
              </form>
            </Form>
          )}

          {/* Status pentru cereri deja procesate */}
          {request.status !== 'pending' && (
            <div className="text-center py-4">
              <Badge 
                variant={
                  request.status === 'approved' ? 'default' :
                  request.status === 'rejected' ? 'destructive' :
                  request.status === 'escalated' ? 'warning' :
                  'secondary'
                }
                className="text-lg py-1 px-4"
              >
                {request.status === 'approved' && 'Aprobată'}
                {request.status === 'rejected' && 'Respinsă'}
                {request.status === 'escalated' && 'Escaladată'}
                {request.status === 'expired' && 'Expirată'}
              </Badge>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* Dialog confirmare pentru acțiuni critice */}
      <AlertDialog open={showConfirm} onOpenChange={setShowConfirm}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>
              {pendingDecision?.decision === 'reject' ? 'Confirmare Respingere' : 'Confirmare Escaladare'}
            </AlertDialogTitle>
            <AlertDialogDescription>
              {pendingDecision?.decision === 'reject'
                ? 'Sunteți sigur că doriți să respingeți această cerere? Această acțiune nu poate fi anulată.'
                : 'Sunteți sigur că doriți să escaladați această cerere? Aceasta va fi trimisă către nivelul superior pentru decizie.'
              }
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Anulează</AlertDialogCancel>
            <AlertDialogAction
              onClick={() => pendingDecision && processDecision(pendingDecision)}
              className={pendingDecision?.decision === 'reject' ? 'bg-destructive text-destructive-foreground' : ''}
            >
              {pendingDecision?.decision === 'reject' ? 'Da, Respinge' : 'Da, Escaladează'}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
}
```

### 9.2 EscalationDialog

Dialog pentru escaladarea manuală a unei cereri HITL.

```typescript
// components/dialogs/hitl/escalation-dialog.tsx
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent } from '@/components/ui/card';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Checkbox } from '@/components/ui/checkbox';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  ArrowUpRight,
  AlertTriangle,
  User,
  Clock,
  Shield,
  RefreshCw,
  Send,
} from 'lucide-react';
import { toast } from 'sonner';

const escalationSchema = z.object({
  targetLevel: z.enum(['L2', 'L3', 'department']),
  targetDepartment: z.string().optional(),
  targetUser: z.string().optional(),
  urgency: z.enum(['normal', 'urgent', 'critical']),
  reason: z.string()
    .min(20, 'Motivul trebuie să aibă minim 20 caractere')
    .max(1000, 'Motivul poate avea maxim 1000 caractere'),
  context: z.string().optional(),
  keepAssigned: z.boolean().default(false),
  notifyOriginator: z.boolean().default(true),
  requestedSLA: z.number().min(1).max(72).optional(),
});

type EscalationFormData = z.infer<typeof escalationSchema>;

interface EscalationDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  requestId: string;
  currentLevel: 'L1' | 'L2' | 'L3';
  onSuccess?: () => void;
}

export function EscalationDialog({
  open,
  onOpenChange,
  requestId,
  currentLevel,
  onSuccess,
}: EscalationDialogProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);

  const form = useForm<EscalationFormData>({
    resolver: zodResolver(escalationSchema),
    defaultValues: {
      targetLevel: currentLevel === 'L1' ? 'L2' : 'L3',
      urgency: 'normal',
      reason: '',
      context: '',
      keepAssigned: false,
      notifyOriginator: true,
    },
  });

  const targetLevel = form.watch('targetLevel');

  const handleSubmit = async (data: EscalationFormData) => {
    setIsSubmitting(true);

    try {
      const response = await fetch(`/api/v1/hitl/requests/${requestId}/escalate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Eroare la escaladare');
      }

      toast.success('Cererea a fost escaladată cu succes');
      onSuccess?.();
      onOpenChange(false);
    } catch (error) {
      toast.error('Eroare la escaladarea cererii');
      console.error(error);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-lg">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <ArrowUpRight className="h-5 w-5 text-orange-500" />
            Escaladare Cerere
          </DialogTitle>
          <DialogDescription>
            Escaladați această cerere către un nivel superior pentru decizie
          </DialogDescription>
        </DialogHeader>

        {/* Indicator nivel curent */}
        <Card className="bg-muted/50">
          <CardContent className="pt-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Shield className="h-4 w-4 text-muted-foreground" />
                <span className="text-sm">Nivel Curent:</span>
                <Badge variant="outline">{currentLevel}</Badge>
              </div>
              <ArrowUpRight className="h-4 w-4 text-muted-foreground" />
              <div className="flex items-center gap-2">
                <span className="text-sm">Destinație:</span>
                <Badge>{form.watch('targetLevel')}</Badge>
              </div>
            </div>
          </CardContent>
        </Card>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="targetLevel"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Escaladează către</FormLabel>
                  <FormControl>
                    <RadioGroup
                      onValueChange={field.onChange}
                      value={field.value}
                      className="grid grid-cols-3 gap-2"
                    >
                      <div>
                        <RadioGroupItem
                          value="L2"
                          id="L2"
                          className="peer sr-only"
                          disabled={currentLevel !== 'L1'}
                        />
                        <label
                          htmlFor="L2"
                          className={`flex flex-col items-center justify-center p-3 border rounded-lg cursor-pointer 
                            peer-data-[state=checked]:border-primary peer-data-[state=checked]:bg-primary/5
                            ${currentLevel !== 'L1' ? 'opacity-50 cursor-not-allowed' : 'hover:bg-muted'}`}
                        >
                          <User className="h-5 w-5 mb-1" />
                          <span className="text-sm font-medium">Manager</span>
                          <span className="text-xs text-muted-foreground">L2</span>
                        </label>
                      </div>
                      <div>
                        <RadioGroupItem
                          value="L3"
                          id="L3"
                          className="peer sr-only"
                          disabled={currentLevel === 'L3'}
                        />
                        <label
                          htmlFor="L3"
                          className={`flex flex-col items-center justify-center p-3 border rounded-lg cursor-pointer 
                            peer-data-[state=checked]:border-primary peer-data-[state=checked]:bg-primary/5
                            ${currentLevel === 'L3' ? 'opacity-50 cursor-not-allowed' : 'hover:bg-muted'}`}
                        >
                          <Shield className="h-5 w-5 mb-1" />
                          <span className="text-sm font-medium">Director</span>
                          <span className="text-xs text-muted-foreground">L3</span>
                        </label>
                      </div>
                      <div>
                        <RadioGroupItem
                          value="department"
                          id="department"
                          className="peer sr-only"
                        />
                        <label
                          htmlFor="department"
                          className="flex flex-col items-center justify-center p-3 border rounded-lg cursor-pointer 
                            peer-data-[state=checked]:border-primary peer-data-[state=checked]:bg-primary/5
                            hover:bg-muted"
                        >
                          <AlertTriangle className="h-5 w-5 mb-1" />
                          <span className="text-sm font-medium">Departament</span>
                          <span className="text-xs text-muted-foreground">Specific</span>
                        </label>
                      </div>
                    </RadioGroup>
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            {targetLevel === 'department' && (
              <FormField
                control={form.control}
                name="targetDepartment"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Departament</FormLabel>
                    <Select onValueChange={field.onChange} value={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selectează departamentul" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        <SelectItem value="legal">Legal</SelectItem>
                        <SelectItem value="finance">Financiar</SelectItem>
                        <SelectItem value="sales_director">Director Vânzări</SelectItem>
                        <SelectItem value="compliance">Conformitate</SelectItem>
                        <SelectItem value="technical">Tehnic</SelectItem>
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />
            )}

            <FormField
              control={form.control}
              name="urgency"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Urgență</FormLabel>
                  <Select onValueChange={field.onChange} value={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="normal">
                        <span className="flex items-center gap-2">
                          <Clock className="h-4 w-4 text-blue-500" />
                          Normal (SLA standard)
                        </span>
                      </SelectItem>
                      <SelectItem value="urgent">
                        <span className="flex items-center gap-2">
                          <Clock className="h-4 w-4 text-orange-500" />
                          Urgent (SLA/2)
                        </span>
                      </SelectItem>
                      <SelectItem value="critical">
                        <span className="flex items-center gap-2">
                          <AlertTriangle className="h-4 w-4 text-red-500" />
                          Critic (Imediat)
                        </span>
                      </SelectItem>
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="reason"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Motiv Escaladare *</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="Explicați de ce această cerere necesită escaladare..."
                      rows={3}
                      {...field}
                    />
                  </FormControl>
                  <FormDescription>
                    {field.value?.length || 0}/1000 caractere
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="context"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Context Adițional (opțional)</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="Informații suplimentare relevante..."
                      rows={2}
                      {...field}
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="space-y-2">
              <FormField
                control={form.control}
                name="keepAssigned"
                render={({ field }) => (
                  <FormItem className="flex items-center gap-2">
                    <FormControl>
                      <Checkbox
                        checked={field.value}
                        onCheckedChange={field.onChange}
                      />
                    </FormControl>
                    <FormLabel className="!mt-0 font-normal">
                      Păstrează-mă asignat ca backup
                    </FormLabel>
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="notifyOriginator"
                render={({ field }) => (
                  <FormItem className="flex items-center gap-2">
                    <FormControl>
                      <Checkbox
                        checked={field.value}
                        onCheckedChange={field.onChange}
                      />
                    </FormControl>
                    <FormLabel className="!mt-0 font-normal">
                      Notifică solicitantul despre escaladare
                    </FormLabel>
                  </FormItem>
                )}
              />
            </div>

            <DialogFooter>
              <Button type="button" variant="outline" onClick={() => onOpenChange(false)}>
                Anulează
              </Button>
              <Button type="submit" disabled={isSubmitting}>
                {isSubmitting ? (
                  <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                ) : (
                  <Send className="h-4 w-4 mr-2" />
                )}
                Escaladează
              </Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```

### 9.3 TakeoverDialog

Dialog pentru preluarea manuală a unei negocieri de la AI.

```typescript
// components/dialogs/hitl/takeover-dialog.tsx
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Checkbox } from '@/components/ui/checkbox';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import {
  UserCheck,
  Bot,
  ArrowRight,
  AlertTriangle,
  Clock,
  Shield,
  RefreshCw,
  Play,
  Pause,
  MessageSquare,
} from 'lucide-react';
import { toast } from 'sonner';

const takeoverSchema = z.object({
  takeoverType: z.enum(['full', 'temporary', 'supervised']),
  reason: z.string()
    .min(10, 'Motivul trebuie să aibă minim 10 caractere')
    .max(500, 'Motivul poate avea maxim 500 caractere'),
  duration: z.number().min(1).max(168).optional(), // ore, max 7 zile
  notifyClient: z.boolean().default(false),
  pauseAutomation: z.boolean().default(true),
  transferNotes: z.string().optional(),
  priority: z.enum(['normal', 'high', 'critical']).default('normal'),
});

type TakeoverFormData = z.infer<typeof takeoverSchema>;

interface NegotiationContext {
  id: string;
  name: string;
  clientName: string;
  stage: string;
  aiConfidence: number;
  lastActivity: string;
  pendingActions: number;
}

interface TakeoverDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  negotiation: NegotiationContext;
  onSuccess?: () => void;
}

export function TakeoverDialog({
  open,
  onOpenChange,
  negotiation,
  onSuccess,
}: TakeoverDialogProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showConfirm, setShowConfirm] = useState(false);
  const [pendingData, setPendingData] = useState<TakeoverFormData | null>(null);

  const form = useForm<TakeoverFormData>({
    resolver: zodResolver(takeoverSchema),
    defaultValues: {
      takeoverType: 'temporary',
      reason: '',
      duration: 24,
      notifyClient: false,
      pauseAutomation: true,
      transferNotes: '',
      priority: 'normal',
    },
  });

  const takeoverType = form.watch('takeoverType');

  const handleSubmit = async (data: TakeoverFormData) => {
    // Confirmare pentru preluare completă
    if (data.takeoverType === 'full') {
      setPendingData(data);
      setShowConfirm(true);
      return;
    }

    await processTakeover(data);
  };

  const processTakeover = async (data: TakeoverFormData) => {
    setIsSubmitting(true);

    try {
      const response = await fetch(`/api/v1/negotiations/${negotiation.id}/takeover`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Eroare la preluare');
      }

      const labels = {
        full: 'preluată complet',
        temporary: 'preluată temporar',
        supervised: 'pusă în mod supervizat',
      };

      toast.success(`Negocierea a fost ${labels[data.takeoverType]}`);
      onSuccess?.();
      onOpenChange(false);
    } catch (error) {
      toast.error('Eroare la preluarea negocierii');
      console.error(error);
    } finally {
      setIsSubmitting(false);
      setShowConfirm(false);
      setPendingData(null);
    }
  };

  return (
    <>
      <Dialog open={open} onOpenChange={onOpenChange}>
        <DialogContent className="max-w-lg">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <UserCheck className="h-5 w-5 text-primary" />
              Preluare Negociere
            </DialogTitle>
            <DialogDescription>
              Preluați controlul acestei negocieri de la AI
            </DialogDescription>
          </DialogHeader>

          {/* Context negociere */}
          <Card className="bg-muted/50">
            <CardHeader className="pb-2">
              <CardTitle className="text-sm">{negotiation.name}</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-2 gap-2 text-sm">
                <div>
                  <span className="text-muted-foreground">Client:</span>
                  <span className="ml-2">{negotiation.clientName}</span>
                </div>
                <div>
                  <span className="text-muted-foreground">Etapă:</span>
                  <Badge variant="outline" className="ml-2">{negotiation.stage}</Badge>
                </div>
                <div>
                  <span className="text-muted-foreground">Confidență AI:</span>
                  <Badge 
                    variant={negotiation.aiConfidence > 0.7 ? 'default' : 'destructive'}
                    className="ml-2"
                  >
                    {(negotiation.aiConfidence * 100).toFixed(0)}%
                  </Badge>
                </div>
                <div>
                  <span className="text-muted-foreground">Acțiuni în așteptare:</span>
                  <span className="ml-2">{negotiation.pendingActions}</span>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Alertă dacă AI are confidență scăzută */}
          {negotiation.aiConfidence < 0.5 && (
            <div className="p-3 rounded-lg bg-yellow-100 text-yellow-800 flex items-center gap-2">
              <AlertTriangle className="h-4 w-4" />
              <span className="text-sm">
                AI-ul are confidență scăzută pentru această negociere
              </span>
            </div>
          )}

          <Form {...form}>
            <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-4">
              <FormField
                control={form.control}
                name="takeoverType"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Tip Preluare</FormLabel>
                    <FormControl>
                      <RadioGroup
                        onValueChange={field.onChange}
                        value={field.value}
                        className="space-y-2"
                      >
                        <div className="flex items-start space-x-3 p-3 border rounded-lg hover:bg-muted/50 cursor-pointer">
                          <RadioGroupItem value="temporary" id="temporary" className="mt-1" />
                          <label htmlFor="temporary" className="flex-1 cursor-pointer">
                            <div className="flex items-center gap-2">
                              <Clock className="h-4 w-4 text-blue-500" />
                              <span className="font-medium">Temporară</span>
                            </div>
                            <p className="text-sm text-muted-foreground">
                              Preluați temporar, AI-ul va relua după perioada specificată
                            </p>
                          </label>
                        </div>

                        <div className="flex items-start space-x-3 p-3 border rounded-lg hover:bg-muted/50 cursor-pointer">
                          <RadioGroupItem value="supervised" id="supervised" className="mt-1" />
                          <label htmlFor="supervised" className="flex-1 cursor-pointer">
                            <div className="flex items-center gap-2">
                              <Shield className="h-4 w-4 text-purple-500" />
                              <span className="font-medium">Supervizată</span>
                            </div>
                            <p className="text-sm text-muted-foreground">
                              AI-ul continuă să lucreze, dar toate acțiunile necesită aprobare
                            </p>
                          </label>
                        </div>

                        <div className="flex items-start space-x-3 p-3 border rounded-lg hover:bg-muted/50 cursor-pointer border-orange-200">
                          <RadioGroupItem value="full" id="full" className="mt-1" />
                          <label htmlFor="full" className="flex-1 cursor-pointer">
                            <div className="flex items-center gap-2">
                              <UserCheck className="h-4 w-4 text-orange-500" />
                              <span className="font-medium">Completă</span>
                              <Badge variant="destructive" className="text-xs">Permanent</Badge>
                            </div>
                            <p className="text-sm text-muted-foreground">
                              Dezactivați complet AI-ul pentru această negociere
                            </p>
                          </label>
                        </div>
                      </RadioGroup>
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              {takeoverType === 'temporary' && (
                <FormField
                  control={form.control}
                  name="duration"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Durată (ore)</FormLabel>
                      <Select 
                        onValueChange={(v) => field.onChange(parseInt(v))} 
                        value={field.value?.toString()}
                      >
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          <SelectItem value="4">4 ore</SelectItem>
                          <SelectItem value="8">8 ore</SelectItem>
                          <SelectItem value="24">24 ore (1 zi)</SelectItem>
                          <SelectItem value="48">48 ore (2 zile)</SelectItem>
                          <SelectItem value="72">72 ore (3 zile)</SelectItem>
                          <SelectItem value="168">168 ore (7 zile)</SelectItem>
                        </SelectContent>
                      </Select>
                      <FormDescription>
                        După această perioadă, AI-ul va relua automat controlul
                      </FormDescription>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              )}

              <FormField
                control={form.control}
                name="reason"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Motiv Preluare *</FormLabel>
                    <FormControl>
                      <Textarea
                        placeholder="De ce preluați această negociere..."
                        rows={2}
                        {...field}
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="priority"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Prioritate</FormLabel>
                    <Select onValueChange={field.onChange} value={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        <SelectItem value="normal">Normal</SelectItem>
                        <SelectItem value="high">Ridicat</SelectItem>
                        <SelectItem value="critical">Critic</SelectItem>
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <div className="space-y-2">
                <FormField
                  control={form.control}
                  name="pauseAutomation"
                  render={({ field }) => (
                    <FormItem className="flex items-center gap-2">
                      <FormControl>
                        <Checkbox
                          checked={field.value}
                          onCheckedChange={field.onChange}
                        />
                      </FormControl>
                      <FormLabel className="!mt-0 font-normal flex items-center gap-1">
                        <Pause className="h-3 w-3" />
                        Pune în pauză automatizările programate
                      </FormLabel>
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="notifyClient"
                  render={({ field }) => (
                    <FormItem className="flex items-center gap-2">
                      <FormControl>
                        <Checkbox
                          checked={field.value}
                          onCheckedChange={field.onChange}
                        />
                      </FormControl>
                      <FormLabel className="!mt-0 font-normal flex items-center gap-1">
                        <MessageSquare className="h-3 w-3" />
                        Notifică clientul despre schimbarea reprezentantului
                      </FormLabel>
                    </FormItem>
                  )}
                />
              </div>

              <FormField
                control={form.control}
                name="transferNotes"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Note Transfer (opțional)</FormLabel>
                    <FormControl>
                      <Textarea
                        placeholder="Informații importante pentru transfer..."
                        rows={2}
                        {...field}
                      />
                    </FormControl>
                    <FormDescription>
                      Aceste note vor fi vizibile când AI-ul preia înapoi controlul
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <DialogFooter>
                <Button type="button" variant="outline" onClick={() => onOpenChange(false)}>
                  Anulează
                </Button>
                <Button type="submit" disabled={isSubmitting}>
                  {isSubmitting ? (
                    <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                  ) : (
                    <UserCheck className="h-4 w-4 mr-2" />
                  )}
                  Preia Negocierea
                </Button>
              </DialogFooter>
            </form>
          </Form>
        </DialogContent>
      </Dialog>

      {/* Dialog confirmare preluare completă */}
      <AlertDialog open={showConfirm} onOpenChange={setShowConfirm}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle className="flex items-center gap-2">
              <AlertTriangle className="h-5 w-5 text-orange-500" />
              Confirmare Preluare Completă
            </AlertDialogTitle>
            <AlertDialogDescription>
              Sunteți sigur că doriți să dezactivați complet AI-ul pentru această negociere?
              Această acțiune este permanentă și AI-ul nu va mai interveni în această negociere
              decât dacă reactivați manual.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Anulează</AlertDialogCancel>
            <AlertDialogAction
              onClick={() => pendingData && processTakeover(pendingData)}
              className="bg-orange-500 hover:bg-orange-600"
            >
              Da, Preia Complet
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
}
```

## 10. Integration Forms

### 10.1 OblioConnectForm

Form pentru conectarea și configurarea integrării cu Oblio.eu.

```typescript
// components/forms/integrations/oblio-connect-form.tsx
import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Switch } from '@/components/ui/switch';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Separator } from '@/components/ui/separator';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Alert,
  AlertDescription,
  AlertTitle,
} from '@/components/ui/alert';
import {
  Link2,
  Unlink,
  CheckCircle2,
  XCircle,
  RefreshCw,
  Key,
  Building2,
  FileText,
  Settings,
  TestTube,
  Shield,
} from 'lucide-react';
import { toast } from 'sonner';

const oblioConnectSchema = z.object({
  email: z.string().email('Email invalid'),
  apiSecret: z.string().min(32, 'API Secret trebuie să aibă minim 32 caractere'),
  companyName: z.string().min(2, 'Numele companiei este obligatoriu'),
  companyCif: z.string().regex(/^RO?\d{2,10}$/, 'CIF/CUI invalid'),
  
  // Setări sincronizare
  syncInvoices: z.boolean().default(true),
  syncProformas: z.boolean().default(true),
  syncClients: z.boolean().default(true),
  syncProducts: z.boolean().default(false),
  
  // Setări automate
  autoCreateInvoice: z.boolean().default(false),
  autoSendToEFactura: z.boolean().default(false),
  defaultSeries: z.string().optional(),
  
  // Notificări
  notifyOnSync: z.boolean().default(true),
  notifyOnError: z.boolean().default(true),
});

type OblioConnectFormData = z.infer<typeof oblioConnectSchema>;

interface OblioConnectionStatus {
  connected: boolean;
  lastSync?: string;
  companyName?: string;
  availableSeries?: string[];
}

interface OblioConnectFormProps {
  initialData?: Partial<OblioConnectFormData>;
  onSuccess?: () => void;
}

export function OblioConnectForm({ initialData, onSuccess }: OblioConnectFormProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isTesting, setIsTesting] = useState(false);
  const [connectionStatus, setConnectionStatus] = useState<OblioConnectionStatus>({
    connected: false,
  });
  const [availableSeries, setAvailableSeries] = useState<string[]>([]);

  const form = useForm<OblioConnectFormData>({
    resolver: zodResolver(oblioConnectSchema),
    defaultValues: {
      email: initialData?.email || '',
      apiSecret: initialData?.apiSecret || '',
      companyName: initialData?.companyName || '',
      companyCif: initialData?.companyCif || '',
      syncInvoices: initialData?.syncInvoices ?? true,
      syncProformas: initialData?.syncProformas ?? true,
      syncClients: initialData?.syncClients ?? true,
      syncProducts: initialData?.syncProducts ?? false,
      autoCreateInvoice: initialData?.autoCreateInvoice ?? false,
      autoSendToEFactura: initialData?.autoSendToEFactura ?? false,
      defaultSeries: initialData?.defaultSeries || '',
      notifyOnSync: initialData?.notifyOnSync ?? true,
      notifyOnError: initialData?.notifyOnError ?? true,
    },
  });

  // Verifică statusul conexiunii la load
  useEffect(() => {
    const checkConnection = async () => {
      try {
        const response = await fetch('/api/v1/integrations/oblio/status');
        if (response.ok) {
          const data = await response.json();
          setConnectionStatus(data);
          if (data.availableSeries) {
            setAvailableSeries(data.availableSeries);
          }
        }
      } catch (error) {
        console.error('Failed to check Oblio status:', error);
      }
    };
    checkConnection();
  }, []);

  const testConnection = async () => {
    setIsTesting(true);
    
    try {
      const values = form.getValues();
      const response = await fetch('/api/v1/integrations/oblio/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: values.email,
          apiSecret: values.apiSecret,
        }),
      });

      if (!response.ok) {
        throw new Error('Conexiune eșuată');
      }

      const data = await response.json();
      
      if (data.success) {
        toast.success('Conexiune reușită cu Oblio');
        setAvailableSeries(data.series || []);
        form.setValue('companyName', data.companyName || '');
      } else {
        toast.error(data.message || 'Conexiune eșuată');
      }
    } catch (error) {
      toast.error('Eroare la testarea conexiunii');
    } finally {
      setIsTesting(false);
    }
  };

  const handleSubmit = async (data: OblioConnectFormData) => {
    setIsSubmitting(true);

    try {
      const response = await fetch('/api/v1/integrations/oblio/configure', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Eroare la salvare');
      }

      toast.success('Integrare Oblio configurată cu succes');
      setConnectionStatus({ ...connectionStatus, connected: true });
      onSuccess?.();
    } catch (error) {
      toast.error('Eroare la configurarea integrării');
      console.error(error);
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleDisconnect = async () => {
    if (!confirm('Sigur doriți să deconectați Oblio?')) return;

    try {
      await fetch('/api/v1/integrations/oblio/disconnect', {
        method: 'POST',
      });
      
      toast.success('Oblio deconectat');
      setConnectionStatus({ connected: false });
      form.reset();
    } catch (error) {
      toast.error('Eroare la deconectare');
    }
  };

  return (
    <div className="space-y-6">
      {/* Status Header */}
      <Card>
        <CardHeader className="pb-3">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center">
                <Building2 className="h-6 w-6 text-blue-600" />
              </div>
              <div>
                <CardTitle className="text-lg">Oblio.eu</CardTitle>
                <CardDescription>Facturare & Contabilitate</CardDescription>
              </div>
            </div>
            <Badge 
              variant={connectionStatus.connected ? 'default' : 'secondary'}
              className="flex items-center gap-1"
            >
              {connectionStatus.connected ? (
                <>
                  <CheckCircle2 className="h-3 w-3" />
                  Conectat
                </>
              ) : (
                <>
                  <XCircle className="h-3 w-3" />
                  Deconectat
                </>
              )}
            </Badge>
          </div>
        </CardHeader>
        {connectionStatus.connected && connectionStatus.lastSync && (
          <CardContent className="pt-0">
            <p className="text-sm text-muted-foreground">
              Ultima sincronizare: {new Date(connectionStatus.lastSync).toLocaleString('ro-RO')}
            </p>
          </CardContent>
        )}
      </Card>

      <Form {...form}>
        <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-6">
          {/* Credențiale API */}
          <Card>
            <CardHeader>
              <CardTitle className="text-sm flex items-center gap-2">
                <Key className="h-4 w-4" />
                Credențiale API
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <FormField
                  control={form.control}
                  name="email"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Email Cont Oblio</FormLabel>
                      <FormControl>
                        <Input type="email" placeholder="email@company.ro" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="apiSecret"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>API Secret</FormLabel>
                      <FormControl>
                        <Input 
                          type="password" 
                          placeholder="••••••••••••••••"
                          {...field} 
                        />
                      </FormControl>
                      <FormDescription>
                        Obține din Oblio {'>'} Setări {'>'} API
                      </FormDescription>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <FormField
                  control={form.control}
                  name="companyName"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Nume Companie</FormLabel>
                      <FormControl>
                        <Input placeholder="SC Exemplu SRL" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="companyCif"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>CIF/CUI</FormLabel>
                      <FormControl>
                        <Input placeholder="RO12345678" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </div>

              <Button
                type="button"
                variant="outline"
                onClick={testConnection}
                disabled={isTesting || !form.getValues('email') || !form.getValues('apiSecret')}
              >
                {isTesting ? (
                  <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                ) : (
                  <TestTube className="h-4 w-4 mr-2" />
                )}
                Testează Conexiunea
              </Button>
            </CardContent>
          </Card>

          {/* Setări Sincronizare */}
          <Card>
            <CardHeader>
              <CardTitle className="text-sm flex items-center gap-2">
                <RefreshCw className="h-4 w-4" />
                Sincronizare Date
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <FormField
                  control={form.control}
                  name="syncInvoices"
                  render={({ field }) => (
                    <FormItem className="flex items-center justify-between rounded-lg border p-3">
                      <div>
                        <FormLabel>Facturi</FormLabel>
                        <FormDescription className="text-xs">
                          Sincronizează facturile cu Oblio
                        </FormDescription>
                      </div>
                      <FormControl>
                        <Switch
                          checked={field.value}
                          onCheckedChange={field.onChange}
                        />
                      </FormControl>
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="syncProformas"
                  render={({ field }) => (
                    <FormItem className="flex items-center justify-between rounded-lg border p-3">
                      <div>
                        <FormLabel>Proforme</FormLabel>
                        <FormDescription className="text-xs">
                          Sincronizează proformele cu Oblio
                        </FormDescription>
                      </div>
                      <FormControl>
                        <Switch
                          checked={field.value}
                          onCheckedChange={field.onChange}
                        />
                      </FormControl>
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="syncClients"
                  render={({ field }) => (
                    <FormItem className="flex items-center justify-between rounded-lg border p-3">
                      <div>
                        <FormLabel>Clienți</FormLabel>
                        <FormDescription className="text-xs">
                          Sincronizează clienții cu Oblio
                        </FormDescription>
                      </div>
                      <FormControl>
                        <Switch
                          checked={field.value}
                          onCheckedChange={field.onChange}
                        />
                      </FormControl>
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="syncProducts"
                  render={({ field }) => (
                    <FormItem className="flex items-center justify-between rounded-lg border p-3">
                      <div>
                        <FormLabel>Produse</FormLabel>
                        <FormDescription className="text-xs">
                          Sincronizează catalogul de produse
                        </FormDescription>
                      </div>
                      <FormControl>
                        <Switch
                          checked={field.value}
                          onCheckedChange={field.onChange}
                        />
                      </FormControl>
                    </FormItem>
                  )}
                />
              </div>
            </CardContent>
          </Card>

          {/* Automatizări */}
          <Card>
            <CardHeader>
              <CardTitle className="text-sm flex items-center gap-2">
                <Settings className="h-4 w-4" />
                Automatizări
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <FormField
                control={form.control}
                name="autoCreateInvoice"
                render={({ field }) => (
                  <FormItem className="flex items-center justify-between rounded-lg border p-3">
                    <div>
                      <FormLabel>Creare Automată Facturi</FormLabel>
                      <FormDescription className="text-xs">
                        Creează automat factura în Oblio când se finalizează o negociere
                      </FormDescription>
                    </div>
                    <FormControl>
                      <Switch
                        checked={field.value}
                        onCheckedChange={field.onChange}
                      />
                    </FormControl>
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="autoSendToEFactura"
                render={({ field }) => (
                  <FormItem className="flex items-center justify-between rounded-lg border p-3">
                    <div>
                      <FormLabel>Auto e-Factura</FormLabel>
                      <FormDescription className="text-xs">
                        Trimite automat la ANAF SPV după creare
                      </FormDescription>
                    </div>
                    <FormControl>
                      <Switch
                        checked={field.value}
                        onCheckedChange={field.onChange}
                      />
                    </FormControl>
                  </FormItem>
                )}
              />

              {availableSeries.length > 0 && (
                <FormField
                  control={form.control}
                  name="defaultSeries"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Serie Implicită Facturi</FormLabel>
                      <Select onValueChange={field.onChange} value={field.value}>
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Selectează seria" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          {availableSeries.map((series) => (
                            <SelectItem key={series} value={series}>
                              {series}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              )}
            </CardContent>
          </Card>

          {/* Notificări */}
          <Card>
            <CardHeader>
              <CardTitle className="text-sm flex items-center gap-2">
                <Shield className="h-4 w-4" />
                Notificări
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <FormField
                  control={form.control}
                  name="notifyOnSync"
                  render={({ field }) => (
                    <FormItem className="flex items-center justify-between rounded-lg border p-3">
                      <div>
                        <FormLabel>Notificare Sincronizare</FormLabel>
                        <FormDescription className="text-xs">
                          Primește notificări după sincronizări
                        </FormDescription>
                      </div>
                      <FormControl>
                        <Switch
                          checked={field.value}
                          onCheckedChange={field.onChange}
                        />
                      </FormControl>
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="notifyOnError"
                  render={({ field }) => (
                    <FormItem className="flex items-center justify-between rounded-lg border p-3">
                      <div>
                        <FormLabel>Notificare Erori</FormLabel>
                        <FormDescription className="text-xs">
                          Primește alerte pentru erori
                        </FormDescription>
                      </div>
                      <FormControl>
                        <Switch
                          checked={field.value}
                          onCheckedChange={field.onChange}
                        />
                      </FormControl>
                    </FormItem>
                  )}
                />
              </div>
            </CardContent>
          </Card>

          {/* Footer Actions */}
          <div className="flex justify-between">
            {connectionStatus.connected && (
              <Button
                type="button"
                variant="destructive"
                onClick={handleDisconnect}
              >
                <Unlink className="h-4 w-4 mr-2" />
                Deconectează
              </Button>
            )}
            
            <div className="flex gap-2 ml-auto">
              <Button type="submit" disabled={isSubmitting}>
                {isSubmitting ? (
                  <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                ) : (
                  <Link2 className="h-4 w-4 mr-2" />
                )}
                {connectionStatus.connected ? 'Actualizează' : 'Conectează'}
              </Button>
            </div>
          </div>
        </form>
      </Form>
    </div>
  );
}
```

### 10.2 ANAFVerifyForm

Form pentru verificarea și configurarea accesului la ANAF.

```typescript
// components/forms/integrations/anaf-verify-form.tsx
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  Alert,
  AlertDescription,
  AlertTitle,
} from '@/components/ui/alert';
import {
  Building,
  CheckCircle2,
  XCircle,
  RefreshCw,
  Shield,
  FileText,
  AlertTriangle,
  ExternalLink,
  Clock,
} from 'lucide-react';
import { toast } from 'sonner';

const anafVerifySchema = z.object({
  cui: z.string()
    .min(2, 'CUI trebuie să aibă minim 2 caractere')
    .max(10, 'CUI poate avea maxim 10 caractere')
    .regex(/^\d+$/, 'CUI trebuie să conțină doar cifre'),
});

type ANAFVerifyFormData = z.infer<typeof anafVerifySchema>;

interface ANAFCompanyInfo {
  cui: string;
  denumire: string;
  adresa: string;
  judet: string;
  codPostal: string;
  telefon?: string;
  stareInregistrare: string;
  scpTVA: boolean;
  dataInregistrareTVA?: string;
  dataAnulareTVA?: string;
  statusTVA: string;
  statusInactiv: boolean;
  dataInactivare?: string;
  dataReactivare?: string;
  statusSplitTVA: boolean;
  dataAnulareEFactura?: string;
  statusEFactura: boolean;
}

interface ANAFVerifyFormProps {
  defaultCui?: string;
  onVerified?: (info: ANAFCompanyInfo) => void;
}

export function ANAFVerifyForm({ defaultCui, onVerified }: ANAFVerifyFormProps) {
  const [isVerifying, setIsVerifying] = useState(false);
  const [verificationProgress, setVerificationProgress] = useState(0);
  const [companyInfo, setCompanyInfo] = useState<ANAFCompanyInfo | null>(null);
  const [verificationError, setVerificationError] = useState<string | null>(null);

  const form = useForm<ANAFVerifyFormData>({
    resolver: zodResolver(anafVerifySchema),
    defaultValues: {
      cui: defaultCui || '',
    },
  });

  const handleVerify = async (data: ANAFVerifyFormData) => {
    setIsVerifying(true);
    setVerificationProgress(0);
    setVerificationError(null);
    setCompanyInfo(null);

    try {
      // Simulare progress
      const progressInterval = setInterval(() => {
        setVerificationProgress(prev => Math.min(prev + 20, 90));
      }, 200);

      const response = await fetch(`/api/v1/anaf/verify/${data.cui}`);
      
      clearInterval(progressInterval);
      setVerificationProgress(100);

      if (!response.ok) {
        throw new Error('Eroare la verificare');
      }

      const info = await response.json();
      setCompanyInfo(info);
      onVerified?.(info);
      toast.success('Verificare completă');
    } catch (error) {
      setVerificationError('Nu s-au putut obține date de la ANAF');
      toast.error('Eroare la verificarea CUI');
    } finally {
      setIsVerifying(false);
    }
  };

  const getStatusBadge = (status: boolean, label: string) => (
    <Badge variant={status ? 'default' : 'secondary'} className="flex items-center gap-1">
      {status ? <CheckCircle2 className="h-3 w-3" /> : <XCircle className="h-3 w-3" />}
      {label}
    </Badge>
  );

  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-lg bg-blue-600 flex items-center justify-center">
              <Building className="h-6 w-6 text-white" />
            </div>
            <div>
              <CardTitle>Verificare ANAF</CardTitle>
              <CardDescription>
                Verifică date fiscale și status TVA
              </CardDescription>
            </div>
          </div>
        </CardHeader>
        <CardContent>
          <Form {...form}>
            <form onSubmit={form.handleSubmit(handleVerify)} className="space-y-4">
              <div className="flex gap-2">
                <FormField
                  control={form.control}
                  name="cui"
                  render={({ field }) => (
                    <FormItem className="flex-1">
                      <FormLabel>CUI/CIF (fără RO)</FormLabel>
                      <FormControl>
                        <Input 
                          placeholder="12345678" 
                          {...field} 
                          disabled={isVerifying}
                        />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                <Button 
                  type="submit" 
                  disabled={isVerifying}
                  className="mt-8"
                >
                  {isVerifying ? (
                    <RefreshCw className="h-4 w-4 animate-spin" />
                  ) : (
                    <Shield className="h-4 w-4" />
                  )}
                  <span className="ml-2">Verifică</span>
                </Button>
              </div>

              {isVerifying && (
                <div className="space-y-2">
                  <div className="flex justify-between text-sm">
                    <span>Verificare în curs...</span>
                    <span>{verificationProgress}%</span>
                  </div>
                  <Progress value={verificationProgress} />
                </div>
              )}
            </form>
          </Form>
        </CardContent>
      </Card>

      {verificationError && (
        <Alert variant="destructive">
          <AlertTriangle className="h-4 w-4" />
          <AlertTitle>Eroare</AlertTitle>
          <AlertDescription>{verificationError}</AlertDescription>
        </Alert>
      )}

      {companyInfo && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center justify-between">
              <span>{companyInfo.denumire}</span>
              {getStatusBadge(!companyInfo.statusInactiv, companyInfo.statusInactiv ? 'Inactiv' : 'Activ')}
            </CardTitle>
            <CardDescription>CUI: {companyInfo.cui}</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            {/* Adresă */}
            <div>
              <h4 className="text-sm font-medium mb-1">Adresă Sediu</h4>
              <p className="text-sm text-muted-foreground">
                {companyInfo.adresa}, {companyInfo.judet} {companyInfo.codPostal}
              </p>
            </div>

            {/* Status-uri */}
            <div>
              <h4 className="text-sm font-medium mb-2">Status Fiscal</h4>
              <div className="flex flex-wrap gap-2">
                {getStatusBadge(companyInfo.scpTVA, 'Plătitor TVA')}
                {getStatusBadge(companyInfo.statusEFactura, 'e-Factura Obligatoriu')}
                {getStatusBadge(companyInfo.statusSplitTVA, 'Split TVA')}
              </div>
            </div>

            {/* Detalii TVA */}
            {companyInfo.scpTVA && (
              <div className="p-3 bg-muted rounded-lg">
                <h4 className="text-sm font-medium mb-2 flex items-center gap-2">
                  <FileText className="h-4 w-4" />
                  Detalii TVA
                </h4>
                <div className="grid grid-cols-2 gap-2 text-sm">
                  <div>
                    <span className="text-muted-foreground">Data Înregistrare:</span>
                    <span className="ml-2">{companyInfo.dataInregistrareTVA || '-'}</span>
                  </div>
                  <div>
                    <span className="text-muted-foreground">Status:</span>
                    <span className="ml-2">{companyInfo.statusTVA}</span>
                  </div>
                </div>
              </div>
            )}

            {/* e-Factura Alert */}
            {companyInfo.statusEFactura && (
              <Alert>
                <AlertTriangle className="h-4 w-4" />
                <AlertTitle>e-Factura Obligatoriu</AlertTitle>
                <AlertDescription>
                  Această companie este înregistrată în sistemul e-Factura.
                  Toate facturile B2B trebuie transmise prin ANAF SPV.
                </AlertDescription>
              </Alert>
            )}

            {/* Link extern */}
            <Button variant="outline" asChild className="w-full">
              <a
                href={`https://www.anaf.ro/RegistruTVA/regTva.xhtml?cui=${companyInfo.cui}`}
                target="_blank"
                rel="noopener noreferrer"
              >
                <ExternalLink className="h-4 w-4 mr-2" />
                Verifică pe site-ul ANAF
              </a>
            </Button>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
```

### 10.3 WebhookConfigForm

Form pentru configurarea webhook-urilor.

```typescript
// components/forms/integrations/webhook-config-form.tsx
import { useState } from 'react';
import { useForm, useFieldArray } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Switch } from '@/components/ui/switch';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Checkbox } from '@/components/ui/checkbox';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from '@/components/ui/accordion';
import {
  Webhook,
  Plus,
  Trash2,
  Save,
  RefreshCw,
  TestTube,
  CheckCircle2,
  XCircle,
  Key,
  Lock,
} from 'lucide-react';
import { toast } from 'sonner';

// Evenimente disponibile
const availableEvents = [
  { category: 'Negocieri', events: [
    { value: 'negotiation.created', label: 'Negociere Creată' },
    { value: 'negotiation.updated', label: 'Negociere Actualizată' },
    { value: 'negotiation.stage_changed', label: 'Etapă Schimbată' },
    { value: 'negotiation.completed', label: 'Negociere Finalizată' },
    { value: 'negotiation.cancelled', label: 'Negociere Anulată' },
  ]},
  { category: 'Documente', events: [
    { value: 'document.proforma_created', label: 'Proformă Creată' },
    { value: 'document.invoice_created', label: 'Factură Creată' },
    { value: 'document.efactura_sent', label: 'e-Factura Trimisă' },
    { value: 'document.efactura_status', label: 'Status e-Factura' },
  ]},
  { category: 'AI & HITL', events: [
    { value: 'ai.response_generated', label: 'Răspuns AI Generat' },
    { value: 'ai.guardrail_triggered', label: 'Guardrail Declanșat' },
    { value: 'hitl.approval_required', label: 'Aprobare Necesară' },
    { value: 'hitl.approval_completed', label: 'Aprobare Finalizată' },
  ]},
  { category: 'Contacte', events: [
    { value: 'contact.created', label: 'Contact Creat' },
    { value: 'contact.enriched', label: 'Contact Îmbogățit' },
    { value: 'contact.tier_changed', label: 'Tier Contact Schimbat' },
  ]},
];

const headerSchema = z.object({
  key: z.string().min(1, 'Cheia este obligatorie'),
  value: z.string().min(1, 'Valoarea este obligatorie'),
});

const webhookSchema = z.object({
  name: z.string()
    .min(3, 'Numele trebuie să aibă minim 3 caractere')
    .max(100, 'Numele poate avea maxim 100 caractere'),
  url: z.string()
    .url('URL invalid')
    .startsWith('https://', 'URL-ul trebuie să folosească HTTPS'),
  enabled: z.boolean().default(true),
  events: z.array(z.string()).min(1, 'Selectează cel puțin un eveniment'),
  secret: z.string().optional(),
  headers: z.array(headerSchema).optional(),
  retryPolicy: z.object({
    maxRetries: z.number().min(0).max(10).default(3),
    retryDelay: z.number().min(1).max(300).default(30),
  }),
  timeout: z.number().min(5).max(60).default(30),
});

type WebhookFormData = z.infer<typeof webhookSchema>;

interface WebhookConfigFormProps {
  webhook?: Partial<WebhookFormData> & { id?: string };
  onSuccess?: (webhook: WebhookFormData) => void;
  onCancel?: () => void;
}

export function WebhookConfigForm({ webhook, onSuccess, onCancel }: WebhookConfigFormProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isTesting, setIsTesting] = useState(false);
  const [testResult, setTestResult] = useState<{ success: boolean; message: string } | null>(null);

  const isEdit = !!webhook?.id;

  const form = useForm<WebhookFormData>({
    resolver: zodResolver(webhookSchema),
    defaultValues: {
      name: webhook?.name || '',
      url: webhook?.url || '',
      enabled: webhook?.enabled ?? true,
      events: webhook?.events || [],
      secret: webhook?.secret || '',
      headers: webhook?.headers || [],
      retryPolicy: webhook?.retryPolicy || {
        maxRetries: 3,
        retryDelay: 30,
      },
      timeout: webhook?.timeout || 30,
    },
  });

  const {
    fields: headerFields,
    append: appendHeader,
    remove: removeHeader,
  } = useFieldArray({
    control: form.control,
    name: 'headers',
  });

  const selectedEvents = form.watch('events');

  const toggleEvent = (event: string) => {
    const current = form.getValues('events');
    if (current.includes(event)) {
      form.setValue('events', current.filter(e => e !== event));
    } else {
      form.setValue('events', [...current, event]);
    }
  };

  const selectAllInCategory = (categoryEvents: { value: string }[]) => {
    const current = form.getValues('events');
    const categoryValues = categoryEvents.map(e => e.value);
    const allSelected = categoryValues.every(v => current.includes(v));
    
    if (allSelected) {
      form.setValue('events', current.filter(e => !categoryValues.includes(e)));
    } else {
      const newEvents = [...new Set([...current, ...categoryValues])];
      form.setValue('events', newEvents);
    }
  };

  const generateSecret = () => {
    const secret = Array.from(crypto.getRandomValues(new Uint8Array(32)))
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
    form.setValue('secret', secret);
    toast.success('Secret generat');
  };

  const testWebhook = async () => {
    const url = form.getValues('url');
    if (!url) {
      toast.error('Introduceți URL-ul');
      return;
    }

    setIsTesting(true);
    setTestResult(null);

    try {
      const response = await fetch('/api/v1/webhooks/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          url,
          secret: form.getValues('secret'),
          headers: form.getValues('headers'),
        }),
      });

      const data = await response.json();
      setTestResult({
        success: data.success,
        message: data.message || (data.success ? 'Test reușit!' : 'Test eșuat'),
      });
    } catch (error) {
      setTestResult({
        success: false,
        message: 'Eroare la testare',
      });
    } finally {
      setIsTesting(false);
    }
  };

  const handleSubmit = async (data: WebhookFormData) => {
    setIsSubmitting(true);

    try {
      const endpoint = isEdit 
        ? `/api/v1/webhooks/${webhook.id}`
        : '/api/v1/webhooks';
      
      const response = await fetch(endpoint, {
        method: isEdit ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Eroare la salvare');
      }

      toast.success(isEdit ? 'Webhook actualizat' : 'Webhook creat');
      onSuccess?.(data);
    } catch (error) {
      toast.error('Eroare la salvarea webhook-ului');
      console.error(error);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-6">
        {/* Configurare de bază */}
        <Card>
          <CardHeader>
            <CardTitle className="text-sm flex items-center gap-2">
              <Webhook className="h-4 w-4" />
              Configurare Webhook
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="name"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Nume Webhook</FormLabel>
                    <FormControl>
                      <Input placeholder="ex: CRM Integration" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="enabled"
                render={({ field }) => (
                  <FormItem className="flex items-center justify-between rounded-lg border p-3 mt-2">
                    <FormLabel>Activ</FormLabel>
                    <FormControl>
                      <Switch
                        checked={field.value}
                        onCheckedChange={field.onChange}
                      />
                    </FormControl>
                  </FormItem>
                )}
              />
            </div>

            <FormField
              control={form.control}
              name="url"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>URL Endpoint *</FormLabel>
                  <div className="flex gap-2">
                    <FormControl>
                      <Input 
                        placeholder="https://your-server.com/webhook" 
                        {...field} 
                      />
                    </FormControl>
                    <Button
                      type="button"
                      variant="outline"
                      onClick={testWebhook}
                      disabled={isTesting}
                    >
                      {isTesting ? (
                        <RefreshCw className="h-4 w-4 animate-spin" />
                      ) : (
                        <TestTube className="h-4 w-4" />
                      )}
                    </Button>
                  </div>
                  <FormMessage />
                </FormItem>
              )}
            />

            {testResult && (
              <div className={`p-3 rounded-lg flex items-center gap-2 ${
                testResult.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
              }`}>
                {testResult.success ? (
                  <CheckCircle2 className="h-4 w-4" />
                ) : (
                  <XCircle className="h-4 w-4" />
                )}
                <span className="text-sm">{testResult.message}</span>
              </div>
            )}

            <FormField
              control={form.control}
              name="secret"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Secret (pentru semnătură HMAC)</FormLabel>
                  <div className="flex gap-2">
                    <FormControl>
                      <Input 
                        type="password"
                        placeholder="Secret pentru validare"
                        {...field} 
                      />
                    </FormControl>
                    <Button
                      type="button"
                      variant="outline"
                      onClick={generateSecret}
                    >
                      <Key className="h-4 w-4" />
                    </Button>
                  </div>
                  <FormDescription>
                    Vom semna payload-ul cu HMAC-SHA256 folosind acest secret
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />
          </CardContent>
        </Card>

        {/* Selecție Evenimente */}
        <Card>
          <CardHeader>
            <CardTitle className="text-sm">Evenimente</CardTitle>
          </CardHeader>
          <CardContent>
            <ScrollArea className="h-[250px] pr-4">
              <Accordion type="multiple" className="w-full">
                {availableEvents.map((category) => (
                  <AccordionItem key={category.category} value={category.category}>
                    <AccordionTrigger className="text-sm">
                      <div className="flex items-center gap-2">
                        {category.category}
                        <Badge variant="secondary" className="ml-2">
                          {category.events.filter(e => selectedEvents.includes(e.value)).length}/
                          {category.events.length}
                        </Badge>
                      </div>
                    </AccordionTrigger>
                    <AccordionContent>
                      <div className="space-y-2 pt-2">
                        <Button
                          type="button"
                          variant="ghost"
                          size="sm"
                          onClick={() => selectAllInCategory(category.events)}
                          className="mb-2"
                        >
                          {category.events.every(e => selectedEvents.includes(e.value))
                            ? 'Deselectează Toate'
                            : 'Selectează Toate'
                          }
                        </Button>
                        {category.events.map((event) => (
                          <div
                            key={event.value}
                            className="flex items-center gap-2 p-2 hover:bg-muted rounded cursor-pointer"
                            onClick={() => toggleEvent(event.value)}
                          >
                            <Checkbox
                              checked={selectedEvents.includes(event.value)}
                              onCheckedChange={() => toggleEvent(event.value)}
                            />
                            <span className="text-sm">{event.label}</span>
                            <code className="text-xs text-muted-foreground ml-auto">
                              {event.value}
                            </code>
                          </div>
                        ))}
                      </div>
                    </AccordionContent>
                  </AccordionItem>
                ))}
              </Accordion>
            </ScrollArea>
            {form.formState.errors.events && (
              <p className="text-sm text-destructive mt-2">
                {form.formState.errors.events.message}
              </p>
            )}
          </CardContent>
        </Card>

        {/* Headers Custom */}
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <CardTitle className="text-sm">Headers Custom (opțional)</CardTitle>
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={() => appendHeader({ key: '', value: '' })}
              >
                <Plus className="h-4 w-4 mr-1" />
                Adaugă
              </Button>
            </div>
          </CardHeader>
          {headerFields.length > 0 && (
            <CardContent>
              <div className="space-y-2">
                {headerFields.map((field, index) => (
                  <div key={field.id} className="flex gap-2">
                    <FormField
                      control={form.control}
                      name={`headers.${index}.key`}
                      render={({ field }) => (
                        <FormItem className="flex-1">
                          <FormControl>
                            <Input placeholder="Header-Name" {...field} />
                          </FormControl>
                        </FormItem>
                      )}
                    />
                    <FormField
                      control={form.control}
                      name={`headers.${index}.value`}
                      render={({ field }) => (
                        <FormItem className="flex-1">
                          <FormControl>
                            <Input placeholder="Value" {...field} />
                          </FormControl>
                        </FormItem>
                      )}
                    />
                    <Button
                      type="button"
                      variant="ghost"
                      size="icon"
                      onClick={() => removeHeader(index)}
                    >
                      <Trash2 className="h-4 w-4 text-destructive" />
                    </Button>
                  </div>
                ))}
              </div>
            </CardContent>
          )}
        </Card>

        {/* Retry Policy */}
        <Card>
          <CardHeader>
            <CardTitle className="text-sm">Politică Reîncercare</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-3 gap-4">
              <FormField
                control={form.control}
                name="retryPolicy.maxRetries"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Max Reîncercări</FormLabel>
                    <FormControl>
                      <Input
                        type="number"
                        min={0}
                        max={10}
                        {...field}
                        onChange={(e) => field.onChange(parseInt(e.target.value))}
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="retryPolicy.retryDelay"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Delay (secunde)</FormLabel>
                    <FormControl>
                      <Input
                        type="number"
                        min={1}
                        max={300}
                        {...field}
                        onChange={(e) => field.onChange(parseInt(e.target.value))}
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="timeout"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Timeout (secunde)</FormLabel>
                    <FormControl>
                      <Input
                        type="number"
                        min={5}
                        max={60}
                        {...field}
                        onChange={(e) => field.onChange(parseInt(e.target.value))}
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
          </CardContent>
        </Card>

        {/* Footer */}
        <div className="flex justify-end gap-2">
          {onCancel && (
            <Button type="button" variant="outline" onClick={onCancel}>
              Anulează
            </Button>
          )}
          <Button type="submit" disabled={isSubmitting}>
            {isSubmitting ? (
              <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
            ) : (
              <Save className="h-4 w-4 mr-2" />
            )}
            {isEdit ? 'Actualizează' : 'Creează'} Webhook
          </Button>
        </div>
      </form>
    </Form>
  );
}
```

**API Reference:**

```typescript
// POST /api/v1/webhooks
// PUT /api/v1/webhooks/{id}
interface WebhookConfigRequest {
  name: string;
  url: string;
  enabled: boolean;
  secret?: string;
  events: string[];
  headers?: Array<{ key: string; value: string }>;
  retryPolicy: {
    maxRetries: number;
    retryDelay: number;
  };
  timeout: number;
}

// POST /api/v1/webhooks/test
interface WebhookTestRequest {
  url: string;
  secret?: string;
  headers?: Array<{ key: string; value: string }>;
  timeout?: number;
}

interface WebhookTestResponse {
  success: boolean;
  statusCode?: number;
  responseTime?: number;
  error?: string;
}

// Webhook Payload Structure
interface WebhookPayload {
  id: string;
  event: string;
  timestamp: string;
  data: Record<string, unknown>;
  signature: string; // HMAC-SHA256(payload, secret)
}
```

**Validare Semnătură (recipient side):**

```typescript
import crypto from 'crypto';

function verifyWebhookSignature(
  payload: string,
  signature: string,
  secret: string
): boolean {
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(payload)
    .digest('hex');
  
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature)
  );
}
```

---

## 11. Settings Forms

Formularele pentru configurări utilizator, tenant și preferințe notificări.

### 11.1 UserSettingsForm

Formular pentru setări utilizator personale.

```typescript
// src/features/settings/components/UserSettingsForm.tsx

import React, { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Switch } from '@/components/ui/switch';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Separator } from '@/components/ui/separator';
import { Badge } from '@/components/ui/badge';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog';
import {
  User,
  Mail,
  Phone,
  Lock,
  Bell,
  Palette,
  Globe,
  Shield,
  Key,
  LogOut,
  Trash2,
  Save,
  RefreshCw,
  Camera,
  Eye,
  EyeOff,
  Check,
  X,
} from 'lucide-react';
import { toast } from 'sonner';

// Schema pentru profil
const profileSchema = z.object({
  firstName: z.string().min(2, 'Minim 2 caractere').max(50),
  lastName: z.string().min(2, 'Minim 2 caractere').max(50),
  email: z.string().email('Email invalid'),
  phone: z.string().regex(/^(\+40|0)[0-9]{9}$/, 'Telefon invalid').optional().or(z.literal('')),
  avatar: z.string().url().optional().or(z.literal('')),
  jobTitle: z.string().max(100).optional(),
  department: z.string().max(100).optional(),
});

// Schema pentru preferințe
const preferencesSchema = z.object({
  language: z.enum(['ro', 'en']),
  timezone: z.string(),
  dateFormat: z.enum(['DD/MM/YYYY', 'MM/DD/YYYY', 'YYYY-MM-DD']),
  timeFormat: z.enum(['24h', '12h']),
  currency: z.enum(['RON', 'EUR', 'USD']),
  theme: z.enum(['light', 'dark', 'system']),
  compactMode: z.boolean(),
  showTips: z.boolean(),
});

// Schema pentru notificări
const notificationSettingsSchema = z.object({
  emailNotifications: z.boolean(),
  pushNotifications: z.boolean(),
  smsNotifications: z.boolean(),
  
  // Categorii notificări
  negotiationUpdates: z.boolean(),
  approvalRequests: z.boolean(),
  documentGenerated: z.boolean(),
  aiAlerts: z.boolean(),
  systemAlerts: z.boolean(),
  
  // Digest
  dailyDigest: z.boolean(),
  weeklyReport: z.boolean(),
  digestTime: z.string().regex(/^([01]\d|2[0-3]):([0-5]\d)$/),
  
  // Do Not Disturb
  dndEnabled: z.boolean(),
  dndStart: z.string().regex(/^([01]\d|2[0-3]):([0-5]\d)$/),
  dndEnd: z.string().regex(/^([01]\d|2[0-3]):([0-5]\d)$/),
});

// Schema pentru securitate
const securitySchema = z.object({
  currentPassword: z.string().min(1, 'Parola curentă este obligatorie'),
  newPassword: z.string()
    .min(8, 'Minim 8 caractere')
    .regex(/[A-Z]/, 'Cel puțin o literă mare')
    .regex(/[a-z]/, 'Cel puțin o literă mică')
    .regex(/[0-9]/, 'Cel puțin o cifră')
    .regex(/[^A-Za-z0-9]/, 'Cel puțin un caracter special'),
  confirmPassword: z.string(),
}).refine((data) => data.newPassword === data.confirmPassword, {
  message: 'Parolele nu coincid',
  path: ['confirmPassword'],
});

type ProfileFormData = z.infer<typeof profileSchema>;
type PreferencesFormData = z.infer<typeof preferencesSchema>;
type NotificationSettingsFormData = z.infer<typeof notificationSettingsSchema>;
type SecurityFormData = z.infer<typeof securitySchema>;

interface UserSettings {
  profile: ProfileFormData;
  preferences: PreferencesFormData;
  notifications: NotificationSettingsFormData;
  twoFactorEnabled: boolean;
  sessions: Array<{
    id: string;
    device: string;
    location: string;
    lastActive: string;
    current: boolean;
  }>;
}

interface UserSettingsFormProps {
  initialData?: UserSettings;
  onSave: (section: string, data: unknown) => Promise<void>;
  onAvatarUpload: (file: File) => Promise<string>;
  onLogoutAllSessions: () => Promise<void>;
  onDeleteAccount: () => Promise<void>;
  onEnable2FA: () => Promise<void>;
  onDisable2FA: () => Promise<void>;
}

export function UserSettingsForm({
  initialData,
  onSave,
  onAvatarUpload,
  onLogoutAllSessions,
  onDeleteAccount,
  onEnable2FA,
  onDisable2FA,
}: UserSettingsFormProps) {
  const [activeTab, setActiveTab] = useState('profile');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showCurrentPassword, setShowCurrentPassword] = useState(false);
  const [showNewPassword, setShowNewPassword] = useState(false);
  const [uploadingAvatar, setUploadingAvatar] = useState(false);

  // Profile Form
  const profileForm = useForm<ProfileFormData>({
    resolver: zodResolver(profileSchema),
    defaultValues: initialData?.profile || {
      firstName: '',
      lastName: '',
      email: '',
      phone: '',
      avatar: '',
      jobTitle: '',
      department: '',
    },
  });

  // Preferences Form
  const preferencesForm = useForm<PreferencesFormData>({
    resolver: zodResolver(preferencesSchema),
    defaultValues: initialData?.preferences || {
      language: 'ro',
      timezone: 'Europe/Bucharest',
      dateFormat: 'DD/MM/YYYY',
      timeFormat: '24h',
      currency: 'RON',
      theme: 'system',
      compactMode: false,
      showTips: true,
    },
  });

  // Notifications Form
  const notificationsForm = useForm<NotificationSettingsFormData>({
    resolver: zodResolver(notificationSettingsSchema),
    defaultValues: initialData?.notifications || {
      emailNotifications: true,
      pushNotifications: true,
      smsNotifications: false,
      negotiationUpdates: true,
      approvalRequests: true,
      documentGenerated: true,
      aiAlerts: true,
      systemAlerts: true,
      dailyDigest: false,
      weeklyReport: true,
      digestTime: '09:00',
      dndEnabled: false,
      dndStart: '22:00',
      dndEnd: '08:00',
    },
  });

  // Security Form
  const securityForm = useForm<SecurityFormData>({
    resolver: zodResolver(securitySchema),
    defaultValues: {
      currentPassword: '',
      newPassword: '',
      confirmPassword: '',
    },
  });

  const handleAvatarChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
      toast.error('Fișierul este prea mare (max 5MB)');
      return;
    }

    if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
      toast.error('Format invalid (acceptăm: JPEG, PNG, WebP)');
      return;
    }

    setUploadingAvatar(true);
    try {
      const avatarUrl = await onAvatarUpload(file);
      profileForm.setValue('avatar', avatarUrl);
      toast.success('Avatar actualizat');
    } catch (error) {
      toast.error('Eroare la încărcare avatar');
    } finally {
      setUploadingAvatar(false);
    }
  };

  const handleProfileSubmit = async (data: ProfileFormData) => {
    setIsSubmitting(true);
    try {
      await onSave('profile', data);
      toast.success('Profil actualizat');
    } catch (error) {
      toast.error('Eroare la salvare profil');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handlePreferencesSubmit = async (data: PreferencesFormData) => {
    setIsSubmitting(true);
    try {
      await onSave('preferences', data);
      toast.success('Preferințe salvate');
    } catch (error) {
      toast.error('Eroare la salvare preferințe');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleNotificationsSubmit = async (data: NotificationSettingsFormData) => {
    setIsSubmitting(true);
    try {
      await onSave('notifications', data);
      toast.success('Setări notificări salvate');
    } catch (error) {
      toast.error('Eroare la salvare notificări');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handlePasswordChange = async (data: SecurityFormData) => {
    setIsSubmitting(true);
    try {
      await onSave('password', {
        currentPassword: data.currentPassword,
        newPassword: data.newPassword,
      });
      securityForm.reset();
      toast.success('Parola schimbată cu succes');
    } catch (error) {
      toast.error('Eroare la schimbare parolă');
    } finally {
      setIsSubmitting(false);
    }
  };

  const getInitials = (firstName: string, lastName: string) => {
    return `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();
  };

  const timezones = [
    { value: 'Europe/Bucharest', label: 'București (GMT+2/+3)' },
    { value: 'Europe/London', label: 'Londra (GMT+0/+1)' },
    { value: 'Europe/Paris', label: 'Paris (GMT+1/+2)' },
    { value: 'America/New_York', label: 'New York (GMT-5/-4)' },
    { value: 'America/Los_Angeles', label: 'Los Angeles (GMT-8/-7)' },
    { value: 'Asia/Tokyo', label: 'Tokyo (GMT+9)' },
  ];

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-2xl font-bold">Setări Cont</h2>
        <p className="text-muted-foreground">
          Gestionează profilul, preferințele și securitatea contului
        </p>
      </div>

      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <TabsList className="grid w-full grid-cols-4">
          <TabsTrigger value="profile" className="gap-2">
            <User className="h-4 w-4" />
            Profil
          </TabsTrigger>
          <TabsTrigger value="preferences" className="gap-2">
            <Palette className="h-4 w-4" />
            Preferințe
          </TabsTrigger>
          <TabsTrigger value="notifications" className="gap-2">
            <Bell className="h-4 w-4" />
            Notificări
          </TabsTrigger>
          <TabsTrigger value="security" className="gap-2">
            <Shield className="h-4 w-4" />
            Securitate
          </TabsTrigger>
        </TabsList>

        {/* Profile Tab */}
        <TabsContent value="profile" className="space-y-4">
          <Form {...profileForm}>
            <form onSubmit={profileForm.handleSubmit(handleProfileSubmit)} className="space-y-4">
              <Card>
                <CardHeader>
                  <CardTitle>Informații Personale</CardTitle>
                  <CardDescription>
                    Actualizează informațiile tale de profil
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-6">
                  {/* Avatar Section */}
                  <div className="flex items-center gap-6">
                    <Avatar className="h-24 w-24">
                      <AvatarImage src={profileForm.watch('avatar')} />
                      <AvatarFallback className="text-2xl">
                        {getInitials(
                          profileForm.watch('firstName'),
                          profileForm.watch('lastName')
                        )}
                      </AvatarFallback>
                    </Avatar>
                    <div className="space-y-2">
                      <label htmlFor="avatar-upload">
                        <Button
                          type="button"
                          variant="outline"
                          disabled={uploadingAvatar}
                          asChild
                        >
                          <span className="cursor-pointer">
                            {uploadingAvatar ? (
                              <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                            ) : (
                              <Camera className="h-4 w-4 mr-2" />
                            )}
                            Schimbă Avatar
                          </span>
                        </Button>
                      </label>
                      <input
                        id="avatar-upload"
                        type="file"
                        accept="image/jpeg,image/png,image/webp"
                        className="hidden"
                        onChange={handleAvatarChange}
                      />
                      <p className="text-xs text-muted-foreground">
                        JPEG, PNG sau WebP. Max 5MB.
                      </p>
                    </div>
                  </div>

                  <Separator />

                  {/* Name Fields */}
                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={profileForm.control}
                      name="firstName"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Prenume</FormLabel>
                          <FormControl>
                            <Input placeholder="Ion" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={profileForm.control}
                      name="lastName"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Nume</FormLabel>
                          <FormControl>
                            <Input placeholder="Popescu" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  {/* Contact Fields */}
                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={profileForm.control}
                      name="email"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Email</FormLabel>
                          <FormControl>
                            <div className="relative">
                              <Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                              <Input
                                type="email"
                                placeholder="ion@company.ro"
                                className="pl-10"
                                {...field}
                              />
                            </div>
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={profileForm.control}
                      name="phone"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Telefon (opțional)</FormLabel>
                          <FormControl>
                            <div className="relative">
                              <Phone className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                              <Input
                                placeholder="+40721234567"
                                className="pl-10"
                                {...field}
                              />
                            </div>
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  {/* Job Info */}
                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={profileForm.control}
                      name="jobTitle"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Funcție (opțional)</FormLabel>
                          <FormControl>
                            <Input placeholder="Sales Manager" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={profileForm.control}
                      name="department"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Departament (opțional)</FormLabel>
                          <FormControl>
                            <Input placeholder="Vânzări" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                </CardContent>
              </Card>

              <div className="flex justify-end">
                <Button type="submit" disabled={isSubmitting}>
                  {isSubmitting ? (
                    <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                  ) : (
                    <Save className="h-4 w-4 mr-2" />
                  )}
                  Salvează Profil
                </Button>
              </div>
            </form>
          </Form>
        </TabsContent>

        {/* Preferences Tab */}
        <TabsContent value="preferences" className="space-y-4">
          <Form {...preferencesForm}>
            <form onSubmit={preferencesForm.handleSubmit(handlePreferencesSubmit)} className="space-y-4">
              <Card>
                <CardHeader>
                  <CardTitle>Regionale</CardTitle>
                  <CardDescription>
                    Setări pentru limbă, fus orar și formate
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={preferencesForm.control}
                      name="language"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Limbă</FormLabel>
                          <Select
                            value={field.value}
                            onValueChange={field.onChange}
                          >
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="ro">
                                <span className="flex items-center gap-2">
                                  🇷🇴 Română
                                </span>
                              </SelectItem>
                              <SelectItem value="en">
                                <span className="flex items-center gap-2">
                                  🇬🇧 English
                                </span>
                              </SelectItem>
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={preferencesForm.control}
                      name="timezone"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Fus Orar</FormLabel>
                          <Select
                            value={field.value}
                            onValueChange={field.onChange}
                          >
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              {timezones.map((tz) => (
                                <SelectItem key={tz.value} value={tz.value}>
                                  {tz.label}
                                </SelectItem>
                              ))}
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <div className="grid grid-cols-3 gap-4">
                    <FormField
                      control={preferencesForm.control}
                      name="dateFormat"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Format Dată</FormLabel>
                          <Select
                            value={field.value}
                            onValueChange={field.onChange}
                          >
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="DD/MM/YYYY">DD/MM/YYYY</SelectItem>
                              <SelectItem value="MM/DD/YYYY">MM/DD/YYYY</SelectItem>
                              <SelectItem value="YYYY-MM-DD">YYYY-MM-DD</SelectItem>
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={preferencesForm.control}
                      name="timeFormat"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Format Oră</FormLabel>
                          <Select
                            value={field.value}
                            onValueChange={field.onChange}
                          >
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="24h">24 ore (14:30)</SelectItem>
                              <SelectItem value="12h">12 ore (2:30 PM)</SelectItem>
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={preferencesForm.control}
                      name="currency"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Monedă Implicită</FormLabel>
                          <Select
                            value={field.value}
                            onValueChange={field.onChange}
                          >
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="RON">RON (Lei)</SelectItem>
                              <SelectItem value="EUR">EUR (Euro)</SelectItem>
                              <SelectItem value="USD">USD (Dolari)</SelectItem>
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle>Aspect</CardTitle>
                  <CardDescription>
                    Personalizează aspectul aplicației
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <FormField
                    control={preferencesForm.control}
                    name="theme"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Temă</FormLabel>
                        <div className="flex gap-2">
                          {[
                            { value: 'light', label: 'Luminoasă', icon: '☀️' },
                            { value: 'dark', label: 'Întunecată', icon: '🌙' },
                            { value: 'system', label: 'Sistem', icon: '💻' },
                          ].map((theme) => (
                            <Button
                              key={theme.value}
                              type="button"
                              variant={field.value === theme.value ? 'default' : 'outline'}
                              className="flex-1"
                              onClick={() => field.onChange(theme.value)}
                            >
                              <span className="mr-2">{theme.icon}</span>
                              {theme.label}
                            </Button>
                          ))}
                        </div>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <div className="space-y-4">
                    <FormField
                      control={preferencesForm.control}
                      name="compactMode"
                      render={({ field }) => (
                        <FormItem className="flex items-center justify-between rounded-lg border p-4">
                          <div className="space-y-0.5">
                            <FormLabel className="text-base">Mod Compact</FormLabel>
                            <FormDescription>
                              Reduce spațierea pentru a afișa mai mult conținut
                            </FormDescription>
                          </div>
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={preferencesForm.control}
                      name="showTips"
                      render={({ field }) => (
                        <FormItem className="flex items-center justify-between rounded-lg border p-4">
                          <div className="space-y-0.5">
                            <FormLabel className="text-base">Afișează Tips</FormLabel>
                            <FormDescription>
                              Arată sfaturi și sugestii contextuale
                            </FormDescription>
                          </div>
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />
                  </div>
                </CardContent>
              </Card>

              <div className="flex justify-end">
                <Button type="submit" disabled={isSubmitting}>
                  {isSubmitting ? (
                    <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                  ) : (
                    <Save className="h-4 w-4 mr-2" />
                  )}
                  Salvează Preferințe
                </Button>
              </div>
            </form>
          </Form>
        </TabsContent>

        {/* Notifications Tab */}
        <TabsContent value="notifications" className="space-y-4">
          <Form {...notificationsForm}>
            <form onSubmit={notificationsForm.handleSubmit(handleNotificationsSubmit)} className="space-y-4">
              <Card>
                <CardHeader>
                  <CardTitle>Canale Notificare</CardTitle>
                  <CardDescription>
                    Alege cum vrei să primești notificări
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <FormField
                    control={notificationsForm.control}
                    name="emailNotifications"
                    render={({ field }) => (
                      <FormItem className="flex items-center justify-between rounded-lg border p-4">
                        <div className="space-y-0.5">
                          <FormLabel className="text-base flex items-center gap-2">
                            <Mail className="h-4 w-4" />
                            Email
                          </FormLabel>
                          <FormDescription>
                            Primește notificări pe email
                          </FormDescription>
                        </div>
                        <FormControl>
                          <Switch
                            checked={field.value}
                            onCheckedChange={field.onChange}
                          />
                        </FormControl>
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={notificationsForm.control}
                    name="pushNotifications"
                    render={({ field }) => (
                      <FormItem className="flex items-center justify-between rounded-lg border p-4">
                        <div className="space-y-0.5">
                          <FormLabel className="text-base flex items-center gap-2">
                            <Bell className="h-4 w-4" />
                            Push Notifications
                          </FormLabel>
                          <FormDescription>
                            Primește notificări în browser
                          </FormDescription>
                        </div>
                        <FormControl>
                          <Switch
                            checked={field.value}
                            onCheckedChange={field.onChange}
                          />
                        </FormControl>
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={notificationsForm.control}
                    name="smsNotifications"
                    render={({ field }) => (
                      <FormItem className="flex items-center justify-between rounded-lg border p-4">
                        <div className="space-y-0.5">
                          <FormLabel className="text-base flex items-center gap-2">
                            <Phone className="h-4 w-4" />
                            SMS
                          </FormLabel>
                          <FormDescription>
                            Primește notificări critice prin SMS
                          </FormDescription>
                        </div>
                        <FormControl>
                          <Switch
                            checked={field.value}
                            onCheckedChange={field.onChange}
                          />
                        </FormControl>
                      </FormItem>
                    )}
                  />
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle>Tipuri Notificări</CardTitle>
                  <CardDescription>
                    Selectează ce notificări vrei să primești
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={notificationsForm.control}
                      name="negotiationUpdates"
                      render={({ field }) => (
                        <FormItem className="flex items-center space-x-3 space-y-0 rounded-lg border p-4">
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                          <div>
                            <FormLabel className="text-base">Actualizări Negocieri</FormLabel>
                            <FormDescription>
                              Status și progres negocieri
                            </FormDescription>
                          </div>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={notificationsForm.control}
                      name="approvalRequests"
                      render={({ field }) => (
                        <FormItem className="flex items-center space-x-3 space-y-0 rounded-lg border p-4">
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                          <div>
                            <FormLabel className="text-base">Cereri Aprobare</FormLabel>
                            <FormDescription>
                              HITL și aprobări preț
                            </FormDescription>
                          </div>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={notificationsForm.control}
                      name="documentGenerated"
                      render={({ field }) => (
                        <FormItem className="flex items-center space-x-3 space-y-0 rounded-lg border p-4">
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                          <div>
                            <FormLabel className="text-base">Documente Generate</FormLabel>
                            <FormDescription>
                              Oferte, proforme, facturi
                            </FormDescription>
                          </div>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={notificationsForm.control}
                      name="aiAlerts"
                      render={({ field }) => (
                        <FormItem className="flex items-center space-x-3 space-y-0 rounded-lg border p-4">
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                          <div>
                            <FormLabel className="text-base">Alerte AI</FormLabel>
                            <FormDescription>
                              Guardrails, intervenții
                            </FormDescription>
                          </div>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={notificationsForm.control}
                      name="systemAlerts"
                      render={({ field }) => (
                        <FormItem className="flex items-center space-x-3 space-y-0 rounded-lg border p-4">
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                          <div>
                            <FormLabel className="text-base">Alerte Sistem</FormLabel>
                            <FormDescription>
                              Erori, mentenanță
                            </FormDescription>
                          </div>
                        </FormItem>
                      )}
                    />
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle>Digest & Rapoarte</CardTitle>
                  <CardDescription>
                    Rezumate periodice ale activității
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={notificationsForm.control}
                      name="dailyDigest"
                      render={({ field }) => (
                        <FormItem className="flex items-center space-x-3 space-y-0 rounded-lg border p-4">
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                          <div>
                            <FormLabel className="text-base">Digest Zilnic</FormLabel>
                            <FormDescription>
                              Rezumat activitate zilnică
                            </FormDescription>
                          </div>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={notificationsForm.control}
                      name="weeklyReport"
                      render={({ field }) => (
                        <FormItem className="flex items-center space-x-3 space-y-0 rounded-lg border p-4">
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                          <div>
                            <FormLabel className="text-base">Raport Săptămânal</FormLabel>
                            <FormDescription>
                              KPIs și statistici
                            </FormDescription>
                          </div>
                        </FormItem>
                      )}
                    />
                  </div>

                  {(notificationsForm.watch('dailyDigest') || notificationsForm.watch('weeklyReport')) && (
                    <FormField
                      control={notificationsForm.control}
                      name="digestTime"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Oră Trimitere</FormLabel>
                          <FormControl>
                            <Input type="time" {...field} className="w-32" />
                          </FormControl>
                          <FormDescription>
                            Ora la care primești digest/raport
                          </FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  )}
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle>Do Not Disturb</CardTitle>
                  <CardDescription>
                    Dezactivează notificările în anumite intervale
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <FormField
                    control={notificationsForm.control}
                    name="dndEnabled"
                    render={({ field }) => (
                      <FormItem className="flex items-center justify-between rounded-lg border p-4">
                        <div className="space-y-0.5">
                          <FormLabel className="text-base">Activează DND</FormLabel>
                          <FormDescription>
                            Nu primi notificări în intervalul setat
                          </FormDescription>
                        </div>
                        <FormControl>
                          <Switch
                            checked={field.value}
                            onCheckedChange={field.onChange}
                          />
                        </FormControl>
                      </FormItem>
                    )}
                  />

                  {notificationsForm.watch('dndEnabled') && (
                    <div className="flex items-center gap-4">
                      <FormField
                        control={notificationsForm.control}
                        name="dndStart"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>De la</FormLabel>
                            <FormControl>
                              <Input type="time" {...field} className="w-32" />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                      <span className="text-muted-foreground mt-6">până la</span>
                      <FormField
                        control={notificationsForm.control}
                        name="dndEnd"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Până la</FormLabel>
                            <FormControl>
                              <Input type="time" {...field} className="w-32" />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    </div>
                  )}
                </CardContent>
              </Card>

              <div className="flex justify-end">
                <Button type="submit" disabled={isSubmitting}>
                  {isSubmitting ? (
                    <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                  ) : (
                    <Save className="h-4 w-4 mr-2" />
                  )}
                  Salvează Notificări
                </Button>
              </div>
            </form>
          </Form>
        </TabsContent>

        {/* Security Tab */}
        <TabsContent value="security" className="space-y-4">
          {/* Change Password */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Lock className="h-5 w-5" />
                Schimbă Parola
              </CardTitle>
              <CardDescription>
                Actualizează parola contului tău
              </CardDescription>
            </CardHeader>
            <CardContent>
              <Form {...securityForm}>
                <form onSubmit={securityForm.handleSubmit(handlePasswordChange)} className="space-y-4">
                  <FormField
                    control={securityForm.control}
                    name="currentPassword"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Parola Curentă</FormLabel>
                        <FormControl>
                          <div className="relative">
                            <Input
                              type={showCurrentPassword ? 'text' : 'password'}
                              placeholder="••••••••"
                              {...field}
                            />
                            <Button
                              type="button"
                              variant="ghost"
                              size="icon"
                              className="absolute right-0 top-0"
                              onClick={() => setShowCurrentPassword(!showCurrentPassword)}
                            >
                              {showCurrentPassword ? (
                                <EyeOff className="h-4 w-4" />
                              ) : (
                                <Eye className="h-4 w-4" />
                              )}
                            </Button>
                          </div>
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={securityForm.control}
                    name="newPassword"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Parola Nouă</FormLabel>
                        <FormControl>
                          <div className="relative">
                            <Input
                              type={showNewPassword ? 'text' : 'password'}
                              placeholder="••••••••"
                              {...field}
                            />
                            <Button
                              type="button"
                              variant="ghost"
                              size="icon"
                              className="absolute right-0 top-0"
                              onClick={() => setShowNewPassword(!showNewPassword)}
                            >
                              {showNewPassword ? (
                                <EyeOff className="h-4 w-4" />
                              ) : (
                                <Eye className="h-4 w-4" />
                              )}
                            </Button>
                          </div>
                        </FormControl>
                        <FormDescription>
                          <div className="mt-2 space-y-1 text-xs">
                            <div className={`flex items-center gap-1 ${
                              field.value.length >= 8 ? 'text-green-600' : 'text-muted-foreground'
                            }`}>
                              {field.value.length >= 8 ? <Check className="h-3 w-3" /> : <X className="h-3 w-3" />}
                              Minim 8 caractere
                            </div>
                            <div className={`flex items-center gap-1 ${
                              /[A-Z]/.test(field.value) ? 'text-green-600' : 'text-muted-foreground'
                            }`}>
                              {/[A-Z]/.test(field.value) ? <Check className="h-3 w-3" /> : <X className="h-3 w-3" />}
                              Cel puțin o literă mare
                            </div>
                            <div className={`flex items-center gap-1 ${
                              /[a-z]/.test(field.value) ? 'text-green-600' : 'text-muted-foreground'
                            }`}>
                              {/[a-z]/.test(field.value) ? <Check className="h-3 w-3" /> : <X className="h-3 w-3" />}
                              Cel puțin o literă mică
                            </div>
                            <div className={`flex items-center gap-1 ${
                              /[0-9]/.test(field.value) ? 'text-green-600' : 'text-muted-foreground'
                            }`}>
                              {/[0-9]/.test(field.value) ? <Check className="h-3 w-3" /> : <X className="h-3 w-3" />}
                              Cel puțin o cifră
                            </div>
                            <div className={`flex items-center gap-1 ${
                              /[^A-Za-z0-9]/.test(field.value) ? 'text-green-600' : 'text-muted-foreground'
                            }`}>
                              {/[^A-Za-z0-9]/.test(field.value) ? <Check className="h-3 w-3" /> : <X className="h-3 w-3" />}
                              Cel puțin un caracter special
                            </div>
                          </div>
                        </FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={securityForm.control}
                    name="confirmPassword"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Confirmă Parola</FormLabel>
                        <FormControl>
                          <Input
                            type="password"
                            placeholder="••••••••"
                            {...field}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <Button type="submit" disabled={isSubmitting}>
                    {isSubmitting ? (
                      <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                    ) : (
                      <Lock className="h-4 w-4 mr-2" />
                    )}
                    Schimbă Parola
                  </Button>
                </form>
              </Form>
            </CardContent>
          </Card>

          {/* Two-Factor Authentication */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Key className="h-5 w-5" />
                Autentificare în Doi Pași (2FA)
              </CardTitle>
              <CardDescription>
                Adaugă un nivel suplimentar de securitate
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="flex items-center justify-between">
                <div className="space-y-1">
                  <div className="flex items-center gap-2">
                    <span className="font-medium">Status:</span>
                    {initialData?.twoFactorEnabled ? (
                      <Badge variant="default" className="bg-green-600">
                        <Check className="h-3 w-3 mr-1" />
                        Activat
                      </Badge>
                    ) : (
                      <Badge variant="secondary">
                        <X className="h-3 w-3 mr-1" />
                        Dezactivat
                      </Badge>
                    )}
                  </div>
                  <p className="text-sm text-muted-foreground">
                    {initialData?.twoFactorEnabled
                      ? 'Contul tău este protejat cu 2FA'
                      : 'Activează 2FA pentru securitate sporită'}
                  </p>
                </div>
                {initialData?.twoFactorEnabled ? (
                  <AlertDialog>
                    <AlertDialogTrigger asChild>
                      <Button variant="destructive">
                        Dezactivează 2FA
                      </Button>
                    </AlertDialogTrigger>
                    <AlertDialogContent>
                      <AlertDialogHeader>
                        <AlertDialogTitle>Dezactivează 2FA?</AlertDialogTitle>
                        <AlertDialogDescription>
                          Ești sigur că vrei să dezactivezi autentificarea în doi pași?
                          Contul tău va fi mai puțin securizat.
                        </AlertDialogDescription>
                      </AlertDialogHeader>
                      <AlertDialogFooter>
                        <AlertDialogCancel>Anulează</AlertDialogCancel>
                        <AlertDialogAction
                          onClick={onDisable2FA}
                          className="bg-destructive text-destructive-foreground"
                        >
                          Dezactivează
                        </AlertDialogAction>
                      </AlertDialogFooter>
                    </AlertDialogContent>
                  </AlertDialog>
                ) : (
                  <Button onClick={onEnable2FA}>
                    <Shield className="h-4 w-4 mr-2" />
                    Activează 2FA
                  </Button>
                )}
              </div>
            </CardContent>
          </Card>

          {/* Active Sessions */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Globe className="h-5 w-5" />
                Sesiuni Active
              </CardTitle>
              <CardDescription>
                Dispozitivele pe care ești autentificat
              </CardDescription>
            </CardHeader>
            <CardContent>
              <ScrollArea className="h-[200px]">
                <div className="space-y-3">
                  {initialData?.sessions?.map((session) => (
                    <div
                      key={session.id}
                      className={`flex items-center justify-between p-3 rounded-lg border ${
                        session.current ? 'bg-primary/5 border-primary' : ''
                      }`}
                    >
                      <div className="space-y-1">
                        <div className="flex items-center gap-2">
                          <span className="font-medium">{session.device}</span>
                          {session.current && (
                            <Badge variant="outline" className="text-xs">
                              Sesiune Curentă
                            </Badge>
                          )}
                        </div>
                        <div className="text-sm text-muted-foreground">
                          {session.location} • Ultima activitate: {session.lastActive}
                        </div>
                      </div>
                      {!session.current && (
                        <Button variant="ghost" size="sm">
                          <LogOut className="h-4 w-4" />
                        </Button>
                      )}
                    </div>
                  ))}
                </div>
              </ScrollArea>

              <Separator className="my-4" />

              <AlertDialog>
                <AlertDialogTrigger asChild>
                  <Button variant="outline" className="w-full">
                    <LogOut className="h-4 w-4 mr-2" />
                    Deconectează Toate Sesiunile
                  </Button>
                </AlertDialogTrigger>
                <AlertDialogContent>
                  <AlertDialogHeader>
                    <AlertDialogTitle>Deconectează toate sesiunile?</AlertDialogTitle>
                    <AlertDialogDescription>
                      Vei fi deconectat de pe toate dispozitivele, inclusiv acesta.
                      Va trebui să te autentifici din nou.
                    </AlertDialogDescription>
                  </AlertDialogHeader>
                  <AlertDialogFooter>
                    <AlertDialogCancel>Anulează</AlertDialogCancel>
                    <AlertDialogAction onClick={onLogoutAllSessions}>
                      Deconectează Toate
                    </AlertDialogAction>
                  </AlertDialogFooter>
                </AlertDialogContent>
              </AlertDialog>
            </CardContent>
          </Card>

          {/* Danger Zone */}
          <Card className="border-destructive">
            <CardHeader>
              <CardTitle className="text-destructive flex items-center gap-2">
                <Trash2 className="h-5 w-5" />
                Zonă Periculoasă
              </CardTitle>
              <CardDescription>
                Acțiuni ireversibile
              </CardDescription>
            </CardHeader>
            <CardContent>
              <AlertDialog>
                <AlertDialogTrigger asChild>
                  <Button variant="destructive">
                    <Trash2 className="h-4 w-4 mr-2" />
                    Șterge Contul
                  </Button>
                </AlertDialogTrigger>
                <AlertDialogContent>
                  <AlertDialogHeader>
                    <AlertDialogTitle>Șterge contul permanent?</AlertDialogTitle>
                    <AlertDialogDescription>
                      Această acțiune nu poate fi anulată. Toate datele tale vor fi
                      șterse permanent, incluzând negocierile, documentele și setările.
                    </AlertDialogDescription>
                  </AlertDialogHeader>
                  <AlertDialogFooter>
                    <AlertDialogCancel>Anulează</AlertDialogCancel>
                    <AlertDialogAction
                      onClick={onDeleteAccount}
                      className="bg-destructive text-destructive-foreground"
                    >
                      Șterge Permanent
                    </AlertDialogAction>
                  </AlertDialogFooter>
                </AlertDialogContent>
              </AlertDialog>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}
```

**API Reference:**

```typescript
// PUT /api/v1/users/me/profile
interface UpdateProfileRequest {
  firstName: string;
  lastName: string;
  email: string;
  phone?: string;
  avatar?: string;
  jobTitle?: string;
  department?: string;
}

// PUT /api/v1/users/me/preferences
interface UpdatePreferencesRequest {
  language: 'ro' | 'en';
  timezone: string;
  dateFormat: string;
  timeFormat: string;
  currency: string;
  theme: 'light' | 'dark' | 'system';
  compactMode: boolean;
  showTips: boolean;
}

// PUT /api/v1/users/me/notifications
interface UpdateNotificationsRequest {
  emailNotifications: boolean;
  pushNotifications: boolean;
  smsNotifications: boolean;
  negotiationUpdates: boolean;
  approvalRequests: boolean;
  documentGenerated: boolean;
  aiAlerts: boolean;
  systemAlerts: boolean;
  dailyDigest: boolean;
  weeklyReport: boolean;
  digestTime: string;
  dndEnabled: boolean;
  dndStart: string;
  dndEnd: string;
}

// PUT /api/v1/users/me/password
interface ChangePasswordRequest {
  currentPassword: string;
  newPassword: string;
}

// POST /api/v1/users/me/avatar
// Content-Type: multipart/form-data
// Returns: { url: string }

// POST /api/v1/users/me/2fa/enable
// POST /api/v1/users/me/2fa/disable
// POST /api/v1/users/me/sessions/logout-all
// DELETE /api/v1/users/me
```

---

### 11.2 TenantSettingsForm

Formular pentru configurarea setărilor la nivel de organizație/tenant.

```typescript
// src/features/settings/components/TenantSettingsForm.tsx

import React, { useState } from 'react';
import { useForm, useFieldArray } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { Switch } from '@/components/ui/switch';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Slider } from '@/components/ui/slider';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Separator } from '@/components/ui/separator';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog';
import {
  Building2,
  Users,
  Shield,
  CreditCard,
  Brain,
  FileText,
  Mail,
  Globe,
  Palette,
  Save,
  RefreshCw,
  Plus,
  Trash2,
  Edit,
  Check,
  X,
  Upload,
  Download,
  AlertTriangle,
} from 'lucide-react';
import { toast } from 'sonner';

// Schema validare
const tenantSettingsSchema = z.object({
  // Company Info
  companyName: z.string().min(2, 'Minim 2 caractere').max(200),
  cui: z.string().regex(/^RO?\d{2,10}$/, 'CUI invalid'),
  regCom: z.string().regex(/^J\d{2}\/\d+\/\d{4}$/, 'Reg. Com. invalid').optional().or(z.literal('')),
  address: z.string().min(10, 'Adresă incompletă').max(500),
  city: z.string().min(2).max(100),
  county: z.string().min(2).max(100),
  postalCode: z.string().regex(/^\d{6}$/, 'Cod poștal invalid'),
  phone: z.string().regex(/^(\+40|0)[0-9]{9}$/, 'Telefon invalid'),
  email: z.string().email('Email invalid'),
  website: z.string().url('URL invalid').optional().or(z.literal('')),
  logo: z.string().url().optional().or(z.literal('')),
  
  // Fiscal Settings
  vatPayer: z.boolean(),
  vatRate: z.number().min(0).max(50),
  eFacturaEnabled: z.boolean(),
  eFacturaAutoSend: z.boolean(),
  defaultPaymentTerms: z.number().min(0).max(180),
  defaultCurrency: z.enum(['RON', 'EUR', 'USD']),
  bankAccounts: z.array(z.object({
    id: z.string(),
    bankName: z.string().min(2),
    iban: z.string().regex(/^RO\d{2}[A-Z]{4}[A-Z0-9]{16}$/, 'IBAN invalid'),
    currency: z.enum(['RON', 'EUR', 'USD']),
    isDefault: z.boolean(),
  })),
  
  // AI Settings
  aiEnabled: z.boolean(),
  defaultModel: z.string(),
  maxTokensPerRequest: z.number().min(1000).max(100000),
  monthlyTokenBudget: z.number().min(0),
  guardrailsEnabled: z.boolean(),
  autoApprovalThreshold: z.number().min(0).max(100),
  humanReviewRequired: z.array(z.string()),
  
  // HITL Settings
  hitlEnabled: z.boolean(),
  defaultSLA: z.number().min(1).max(168),
  escalationLevels: z.array(z.object({
    level: z.number(),
    name: z.string(),
    role: z.string(),
    slaHours: z.number(),
  })),
  autoEscalate: z.boolean(),
  
  // Document Templates
  documentPrefix: z.string().max(10),
  offerNumberFormat: z.string(),
  invoiceNumberFormat: z.string(),
  defaultSignatory: z.string(),
  defaultFooterText: z.string().max(1000),
  
  // Email Settings
  emailFromName: z.string().min(2).max(100),
  emailFromAddress: z.string().email(),
  smtpEnabled: z.boolean(),
  smtpHost: z.string().optional(),
  smtpPort: z.number().optional(),
  smtpUsername: z.string().optional(),
  smtpPassword: z.string().optional(),
  smtpSecure: z.boolean().optional(),
  
  // Branding
  primaryColor: z.string().regex(/^#[0-9A-Fa-f]{6}$/, 'Cod culoare invalid'),
  accentColor: z.string().regex(/^#[0-9A-Fa-f]{6}$/, 'Cod culoare invalid'),
  fontFamily: z.string(),
});

type TenantSettingsFormData = z.infer<typeof tenantSettingsSchema>;

interface TenantSettingsFormProps {
  initialData?: Partial<TenantSettingsFormData>;
  onSave: (data: TenantSettingsFormData) => Promise<void>;
  onLogoUpload: (file: File) => Promise<string>;
  onExportData: () => Promise<void>;
  subscription?: {
    plan: string;
    status: string;
    tokensUsed: number;
    tokensLimit: number;
    expiresAt: string;
  };
}

const AI_MODELS = [
  { value: 'claude-3-5-sonnet', label: 'Claude 3.5 Sonnet', description: 'Optim cost/performanță' },
  { value: 'claude-3-opus', label: 'Claude 3 Opus', description: 'Cel mai capabil' },
  { value: 'claude-3-haiku', label: 'Claude 3 Haiku', description: 'Cel mai rapid' },
  { value: 'gpt-4-turbo', label: 'GPT-4 Turbo', description: 'OpenAI flagship' },
  { value: 'gpt-4o', label: 'GPT-4o', description: 'OpenAI multimodal' },
];

const REVIEW_TYPES = [
  { value: 'discount_over_15', label: 'Discount > 15%' },
  { value: 'price_override', label: 'Override Preț' },
  { value: 'new_client', label: 'Client Nou' },
  { value: 'large_order', label: 'Comandă Mare (> 50k RON)' },
  { value: 'custom_terms', label: 'Termeni Custom' },
  { value: 'ai_low_confidence', label: 'AI Încredere Scăzută' },
];

export function TenantSettingsForm({
  initialData,
  onSave,
  onLogoUpload,
  onExportData,
  subscription,
}: TenantSettingsFormProps) {
  const [activeTab, setActiveTab] = useState('company');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [uploadingLogo, setUploadingLogo] = useState(false);
  const [testingSmtp, setTestingSmtp] = useState(false);

  const form = useForm<TenantSettingsFormData>({
    resolver: zodResolver(tenantSettingsSchema),
    defaultValues: {
      companyName: '',
      cui: '',
      regCom: '',
      address: '',
      city: '',
      county: '',
      postalCode: '',
      phone: '',
      email: '',
      website: '',
      logo: '',
      vatPayer: true,
      vatRate: 19,
      eFacturaEnabled: false,
      eFacturaAutoSend: false,
      defaultPaymentTerms: 30,
      defaultCurrency: 'RON',
      bankAccounts: [],
      aiEnabled: true,
      defaultModel: 'claude-3-5-sonnet',
      maxTokensPerRequest: 4000,
      monthlyTokenBudget: 1000000,
      guardrailsEnabled: true,
      autoApprovalThreshold: 80,
      humanReviewRequired: ['discount_over_15', 'price_override'],
      hitlEnabled: true,
      defaultSLA: 24,
      escalationLevels: [
        { level: 1, name: 'L1 - Agent', role: 'sales_agent', slaHours: 4 },
        { level: 2, name: 'L2 - Manager', role: 'sales_manager', slaHours: 8 },
        { level: 3, name: 'L3 - Director', role: 'director', slaHours: 24 },
      ],
      autoEscalate: true,
      documentPrefix: 'CQ',
      offerNumberFormat: '{PREFIX}-OFR-{YYYY}-{####}',
      invoiceNumberFormat: '{PREFIX}-INV-{YYYY}-{####}',
      defaultSignatory: '',
      defaultFooterText: '',
      emailFromName: '',
      emailFromAddress: '',
      smtpEnabled: false,
      primaryColor: '#2563eb',
      accentColor: '#059669',
      fontFamily: 'Inter',
      ...initialData,
    },
  });

  const { fields: bankFields, append: appendBank, remove: removeBank } = useFieldArray({
    control: form.control,
    name: 'bankAccounts',
  });

  const { fields: escalationFields, update: updateEscalation } = useFieldArray({
    control: form.control,
    name: 'escalationLevels',
  });

  const handleSubmit = async (data: TenantSettingsFormData) => {
    setIsSubmitting(true);
    try {
      await onSave(data);
      toast.success('Setări salvate cu succes');
    } catch (error) {
      toast.error('Eroare la salvare setări');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleLogoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (file.size > 2 * 1024 * 1024) {
      toast.error('Logo prea mare (max 2MB)');
      return;
    }

    setUploadingLogo(true);
    try {
      const url = await onLogoUpload(file);
      form.setValue('logo', url);
      toast.success('Logo actualizat');
    } catch (error) {
      toast.error('Eroare la încărcare logo');
    } finally {
      setUploadingLogo(false);
    }
  };

  const handleTestSmtp = async () => {
    setTestingSmtp(true);
    try {
      // API call to test SMTP
      await new Promise((resolve) => setTimeout(resolve, 2000));
      toast.success('Conexiune SMTP reușită');
    } catch (error) {
      toast.error('Eroare la testare SMTP');
    } finally {
      setTestingSmtp(false);
    }
  };

  const tokenUsagePercent = subscription 
    ? Math.round((subscription.tokensUsed / subscription.tokensLimit) * 100)
    : 0;

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold">Setări Organizație</h2>
          <p className="text-muted-foreground">
            Configurează setările companiei și platformei
          </p>
        </div>
        {subscription && (
          <Card className="w-64">
            <CardContent className="p-4">
              <div className="text-sm font-medium">{subscription.plan}</div>
              <div className="mt-2">
                <div className="flex justify-between text-xs text-muted-foreground mb-1">
                  <span>Tokeni folosiți</span>
                  <span>{tokenUsagePercent}%</span>
                </div>
                <div className="h-2 bg-muted rounded-full overflow-hidden">
                  <div
                    className={`h-full transition-all ${
                      tokenUsagePercent > 90 ? 'bg-destructive' :
                      tokenUsagePercent > 70 ? 'bg-yellow-500' : 'bg-primary'
                    }`}
                    style={{ width: `${tokenUsagePercent}%` }}
                  />
                </div>
              </div>
            </CardContent>
          </Card>
        )}
      </div>

      <Form {...form}>
        <form onSubmit={form.handleSubmit(handleSubmit)}>
          <Tabs value={activeTab} onValueChange={setActiveTab}>
            <TabsList className="grid w-full grid-cols-6">
              <TabsTrigger value="company" className="gap-2">
                <Building2 className="h-4 w-4" />
                Companie
              </TabsTrigger>
              <TabsTrigger value="fiscal" className="gap-2">
                <CreditCard className="h-4 w-4" />
                Fiscal
              </TabsTrigger>
              <TabsTrigger value="ai" className="gap-2">
                <Brain className="h-4 w-4" />
                AI
              </TabsTrigger>
              <TabsTrigger value="documents" className="gap-2">
                <FileText className="h-4 w-4" />
                Documente
              </TabsTrigger>
              <TabsTrigger value="email" className="gap-2">
                <Mail className="h-4 w-4" />
                Email
              </TabsTrigger>
              <TabsTrigger value="branding" className="gap-2">
                <Palette className="h-4 w-4" />
                Branding
              </TabsTrigger>
            </TabsList>

            {/* Company Tab */}
            <TabsContent value="company" className="space-y-4">
              <Card>
                <CardHeader>
                  <CardTitle>Informații Companie</CardTitle>
                  <CardDescription>
                    Date de identificare firmă
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  {/* Logo Section */}
                  <div className="flex items-center gap-6">
                    <div className="h-24 w-24 rounded-lg border flex items-center justify-center bg-muted">
                      {form.watch('logo') ? (
                        <img
                          src={form.watch('logo')}
                          alt="Logo"
                          className="h-full w-full object-contain rounded-lg"
                        />
                      ) : (
                        <Building2 className="h-12 w-12 text-muted-foreground" />
                      )}
                    </div>
                    <div className="space-y-2">
                      <label htmlFor="logo-upload">
                        <Button
                          type="button"
                          variant="outline"
                          disabled={uploadingLogo}
                          asChild
                        >
                          <span className="cursor-pointer">
                            {uploadingLogo ? (
                              <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                            ) : (
                              <Upload className="h-4 w-4 mr-2" />
                            )}
                            Încarcă Logo
                          </span>
                        </Button>
                      </label>
                      <input
                        id="logo-upload"
                        type="file"
                        accept="image/png,image/jpeg,image/svg+xml"
                        className="hidden"
                        onChange={handleLogoUpload}
                      />
                      <p className="text-xs text-muted-foreground">
                        PNG, JPG sau SVG. Max 2MB.
                      </p>
                    </div>
                  </div>

                  <Separator />

                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="companyName"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Denumire Firmă *</FormLabel>
                          <FormControl>
                            <Input placeholder="SC Example SRL" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <div className="grid grid-cols-2 gap-2">
                      <FormField
                        control={form.control}
                        name="cui"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>CUI/CIF *</FormLabel>
                            <FormControl>
                              <Input placeholder="RO12345678" {...field} />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      <FormField
                        control={form.control}
                        name="regCom"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Reg. Com.</FormLabel>
                            <FormControl>
                              <Input placeholder="J40/1234/2020" {...field} />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    </div>
                  </div>

                  <FormField
                    control={form.control}
                    name="address"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Adresă *</FormLabel>
                        <FormControl>
                          <Input placeholder="Str. Exemplu nr. 10" {...field} />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <div className="grid grid-cols-3 gap-4">
                    <FormField
                      control={form.control}
                      name="city"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Oraș *</FormLabel>
                          <FormControl>
                            <Input placeholder="București" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="county"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Județ *</FormLabel>
                          <FormControl>
                            <Input placeholder="Sector 1" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="postalCode"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Cod Poștal *</FormLabel>
                          <FormControl>
                            <Input placeholder="010101" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <div className="grid grid-cols-3 gap-4">
                    <FormField
                      control={form.control}
                      name="phone"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Telefon *</FormLabel>
                          <FormControl>
                            <Input placeholder="+40212345678" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="email"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Email *</FormLabel>
                          <FormControl>
                            <Input type="email" placeholder="office@company.ro" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="website"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Website</FormLabel>
                          <FormControl>
                            <Input placeholder="https://company.ro" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                </CardContent>
              </Card>
            </TabsContent>

            {/* Fiscal Tab */}
            <TabsContent value="fiscal" className="space-y-4">
              <Card>
                <CardHeader>
                  <CardTitle>Setări TVA</CardTitle>
                  <CardDescription>
                    Configurare TVA și e-Factura
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="vatPayer"
                      render={({ field }) => (
                        <FormItem className="flex items-center justify-between rounded-lg border p-4">
                          <div className="space-y-0.5">
                            <FormLabel className="text-base">Plătitor TVA</FormLabel>
                            <FormDescription>
                              Compania este înregistrată în scopuri de TVA
                            </FormDescription>
                          </div>
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />

                    {form.watch('vatPayer') && (
                      <FormField
                        control={form.control}
                        name="vatRate"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Cotă TVA Standard (%)</FormLabel>
                            <FormControl>
                              <div className="flex items-center gap-4">
                                <Slider
                                  value={[field.value]}
                                  onValueChange={(v) => field.onChange(v[0])}
                                  min={0}
                                  max={50}
                                  step={1}
                                  className="flex-1"
                                />
                                <span className="w-12 text-right font-mono">
                                  {field.value}%
                                </span>
                              </div>
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    )}
                  </div>

                  <Separator />

                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="eFacturaEnabled"
                      render={({ field }) => (
                        <FormItem className="flex items-center justify-between rounded-lg border p-4">
                          <div className="space-y-0.5">
                            <FormLabel className="text-base">e-Factura ANAF</FormLabel>
                            <FormDescription>
                              Transmitere automată facturi prin SPV
                            </FormDescription>
                          </div>
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />

                    {form.watch('eFacturaEnabled') && (
                      <FormField
                        control={form.control}
                        name="eFacturaAutoSend"
                        render={({ field }) => (
                          <FormItem className="flex items-center justify-between rounded-lg border p-4">
                            <div className="space-y-0.5">
                              <FormLabel className="text-base">Trimitere Automată</FormLabel>
                              <FormDescription>
                                Trimite automat la generare
                              </FormDescription>
                            </div>
                            <FormControl>
                              <Switch
                                checked={field.value}
                                onCheckedChange={field.onChange}
                              />
                            </FormControl>
                          </FormItem>
                        )}
                      />
                    )}
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle>Setări Plăți</CardTitle>
                  <CardDescription>
                    Termeni plată și monedă implicită
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="defaultPaymentTerms"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Termen Plată Implicit (zile)</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min={0}
                              max={180}
                              {...field}
                              onChange={(e) => field.onChange(parseInt(e.target.value))}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="defaultCurrency"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Monedă Implicită</FormLabel>
                          <Select
                            value={field.value}
                            onValueChange={field.onChange}
                          >
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="RON">RON (Lei)</SelectItem>
                              <SelectItem value="EUR">EUR (Euro)</SelectItem>
                              <SelectItem value="USD">USD (Dolari)</SelectItem>
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between">
                  <div>
                    <CardTitle>Conturi Bancare</CardTitle>
                    <CardDescription>
                      Conturile pentru încasări
                    </CardDescription>
                  </div>
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => appendBank({
                      id: crypto.randomUUID(),
                      bankName: '',
                      iban: '',
                      currency: 'RON',
                      isDefault: bankFields.length === 0,
                    })}
                  >
                    <Plus className="h-4 w-4 mr-2" />
                    Adaugă Cont
                  </Button>
                </CardHeader>
                <CardContent>
                  {bankFields.length === 0 ? (
                    <div className="text-center py-6 text-muted-foreground">
                      Niciun cont bancar adăugat
                    </div>
                  ) : (
                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead>Bancă</TableHead>
                          <TableHead>IBAN</TableHead>
                          <TableHead>Monedă</TableHead>
                          <TableHead>Implicit</TableHead>
                          <TableHead className="w-[50px]" />
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {bankFields.map((bank, index) => (
                          <TableRow key={bank.id}>
                            <TableCell>
                              <FormField
                                control={form.control}
                                name={`bankAccounts.${index}.bankName`}
                                render={({ field }) => (
                                  <Input placeholder="BCR" {...field} className="h-8" />
                                )}
                              />
                            </TableCell>
                            <TableCell>
                              <FormField
                                control={form.control}
                                name={`bankAccounts.${index}.iban`}
                                render={({ field }) => (
                                  <Input
                                    placeholder="RO49AAAA..."
                                    {...field}
                                    className="h-8 font-mono text-xs"
                                  />
                                )}
                              />
                            </TableCell>
                            <TableCell>
                              <FormField
                                control={form.control}
                                name={`bankAccounts.${index}.currency`}
                                render={({ field }) => (
                                  <Select value={field.value} onValueChange={field.onChange}>
                                    <SelectTrigger className="h-8 w-20">
                                      <SelectValue />
                                    </SelectTrigger>
                                    <SelectContent>
                                      <SelectItem value="RON">RON</SelectItem>
                                      <SelectItem value="EUR">EUR</SelectItem>
                                      <SelectItem value="USD">USD</SelectItem>
                                    </SelectContent>
                                  </Select>
                                )}
                              />
                            </TableCell>
                            <TableCell>
                              <FormField
                                control={form.control}
                                name={`bankAccounts.${index}.isDefault`}
                                render={({ field }) => (
                                  <Switch
                                    checked={field.value}
                                    onCheckedChange={(checked) => {
                                      // Uncheck all others
                                      bankFields.forEach((_, i) => {
                                        if (i !== index) {
                                          form.setValue(`bankAccounts.${i}.isDefault`, false);
                                        }
                                      });
                                      field.onChange(checked);
                                    }}
                                  />
                                )}
                              />
                            </TableCell>
                            <TableCell>
                              <Button
                                type="button"
                                variant="ghost"
                                size="icon"
                                onClick={() => removeBank(index)}
                              >
                                <Trash2 className="h-4 w-4 text-destructive" />
                              </Button>
                            </TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  )}
                </CardContent>
              </Card>
            </TabsContent>

            {/* Advanced Settings Tab */}
            <TabsContent value="advanced" className="space-y-6 pt-4">
              <div className="grid grid-cols-2 gap-6">
                {/* Default Settings */}
                <Card>
                  <CardHeader>
                    <CardTitle className="text-base">Setări Implicite Negocieri</CardTitle>
                    <CardDescription>
                      Valori implicite pentru negocierile noi
                    </CardDescription>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <FormField
                      control={form.control}
                      name="defaults.currency"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Monedă Implicită</FormLabel>
                          <Select value={field.value} onValueChange={field.onChange}>
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="RON">RON - Leu Românesc</SelectItem>
                              <SelectItem value="EUR">EUR - Euro</SelectItem>
                              <SelectItem value="USD">USD - Dolar American</SelectItem>
                            </SelectContent>
                          </Select>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="defaults.paymentTerms"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Termen de Plată (zile)</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min={0}
                              max={180}
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                          <FormDescription>
                            Termen implicit pentru facturi (0-180 zile)
                          </FormDescription>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="defaults.validityDays"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Valabilitate Ofertă (zile)</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min={1}
                              max={90}
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                          <FormDescription>
                            Perioada de valabilitate pentru oferte și proforme
                          </FormDescription>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="defaults.discountApprovalThreshold"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Prag Aprobare Discount (%)</FormLabel>
                          <FormControl>
                            <Slider
                              min={0}
                              max={50}
                              step={5}
                              value={[field.value]}
                              onValueChange={([val]) => field.onChange(val)}
                            />
                          </FormControl>
                          <div className="flex justify-between text-xs text-muted-foreground">
                            <span>0%</span>
                            <span className="font-medium">{field.value}%</span>
                            <span>50%</span>
                          </div>
                          <FormDescription>
                            Discounturi peste acest prag necesită aprobare
                          </FormDescription>
                        </FormItem>
                      )}
                    />
                  </CardContent>
                </Card>

                {/* Limits & Quotas */}
                <Card>
                  <CardHeader>
                    <CardTitle className="text-base">Limite și Cote</CardTitle>
                    <CardDescription>
                      Restricții pentru operațiuni și API
                    </CardDescription>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <FormField
                      control={form.control}
                      name="limits.maxUsersCount"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Nr. Maxim Utilizatori</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min={1}
                              max={1000}
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="limits.maxContactsCount"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Nr. Maxim Contacte</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min={100}
                              max={1000000}
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="limits.maxProductsCount"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Nr. Maxim Produse</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min={10}
                              max={100000}
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="limits.apiRateLimit"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Rate Limit API (req/min)</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min={10}
                              max={10000}
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="limits.storageQuotaGB"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Cotă Stocare (GB)</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min={1}
                              max={1000}
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />
                  </CardContent>
                </Card>
              </div>

              {/* AI Settings */}
              <Card>
                <CardHeader>
                  <CardTitle className="text-base">Setări AI</CardTitle>
                  <CardDescription>
                    Configurarea agentului AI pentru negocieri
                  </CardDescription>
                </CardHeader>
                <CardContent className="grid grid-cols-2 gap-6">
                  <div className="space-y-4">
                    <FormField
                      control={form.control}
                      name="aiSettings.enabled"
                      render={({ field }) => (
                        <FormItem className="flex items-center justify-between rounded-lg border p-4">
                          <div className="space-y-0.5">
                            <FormLabel>Activare Agent AI</FormLabel>
                            <FormDescription>
                              Permite utilizarea AI pentru negocieri automate
                            </FormDescription>
                          </div>
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="aiSettings.autoApproveThreshold"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Prag Auto-Aprobare Confidence</FormLabel>
                          <FormControl>
                            <Slider
                              min={50}
                              max={100}
                              step={5}
                              value={[field.value]}
                              onValueChange={([val]) => field.onChange(val)}
                            />
                          </FormControl>
                          <div className="flex justify-between text-xs text-muted-foreground">
                            <span>50%</span>
                            <span className="font-medium">{field.value}%</span>
                            <span>100%</span>
                          </div>
                          <FormDescription>
                            Răspunsurile AI cu confidence sub acest prag necesită aprobare umană
                          </FormDescription>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="aiSettings.maxDailyTokens"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Limită Tokeni/zi</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min={10000}
                              max={10000000}
                              step={10000}
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                          <FormDescription>
                            {(field.value / 1000).toFixed(0)}K tokeni ≈ ${((field.value / 1000000) * 3).toFixed(2)}/zi
                          </FormDescription>
                        </FormItem>
                      )}
                    />
                  </div>

                  <div className="space-y-4">
                    <FormField
                      control={form.control}
                      name="aiSettings.defaultModel"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Model AI Implicit</FormLabel>
                          <Select value={field.value} onValueChange={field.onChange}>
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="claude-3-5-haiku-20241022">
                                Claude 3.5 Haiku (rapid, economic)
                              </SelectItem>
                              <SelectItem value="claude-sonnet-4-20250514">
                                Claude Sonnet 4 (echilibrat)
                              </SelectItem>
                              <SelectItem value="claude-opus-4-20250514">
                                Claude Opus 4 (avansat)
                              </SelectItem>
                            </SelectContent>
                          </Select>
                          <FormDescription>
                            Model utilizat implicit pentru toate operațiunile AI
                          </FormDescription>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="aiSettings.defaultTemperature"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Temperatură Implicită</FormLabel>
                          <FormControl>
                            <Slider
                              min={0}
                              max={1}
                              step={0.1}
                              value={[field.value]}
                              onValueChange={([val]) => field.onChange(val)}
                            />
                          </FormControl>
                          <div className="flex justify-between text-xs text-muted-foreground">
                            <span>0 (deterministic)</span>
                            <span className="font-medium">{field.value}</span>
                            <span>1 (creativ)</span>
                          </div>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="aiSettings.guardrailsProfile"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Profil Guardrails</FormLabel>
                          <Select value={field.value} onValueChange={field.onChange}>
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="strict">Strict - Toate verificările active</SelectItem>
                              <SelectItem value="balanced">Echilibrat - Verificări standard</SelectItem>
                              <SelectItem value="permissive">Permisiv - Verificări minimale</SelectItem>
                              <SelectItem value="custom">Personalizat</SelectItem>
                            </SelectContent>
                          </Select>
                        </FormItem>
                      )}
                    />
                  </div>
                </CardContent>
              </Card>

              {/* Compliance & Audit */}
              <Card>
                <CardHeader>
                  <CardTitle className="text-base">Conformitate & Audit</CardTitle>
                  <CardDescription>
                    Setări GDPR, retenție date și audit
                  </CardDescription>
                </CardHeader>
                <CardContent className="grid grid-cols-2 gap-6">
                  <div className="space-y-4">
                    <FormField
                      control={form.control}
                      name="compliance.dataRetentionDays"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Retenție Date (zile)</FormLabel>
                          <Select
                            value={field.value.toString()}
                            onValueChange={(val) => field.onChange(Number(val))}
                          >
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="365">1 an (365 zile)</SelectItem>
                              <SelectItem value="730">2 ani (730 zile)</SelectItem>
                              <SelectItem value="1825">5 ani (1825 zile)</SelectItem>
                              <SelectItem value="3650">10 ani (3650 zile)</SelectItem>
                            </SelectContent>
                          </Select>
                          <FormDescription>
                            Perioada de păstrare a datelor conform GDPR
                          </FormDescription>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="compliance.auditLogEnabled"
                      render={({ field }) => (
                        <FormItem className="flex items-center justify-between rounded-lg border p-4">
                          <div className="space-y-0.5">
                            <FormLabel>Audit Log Activ</FormLabel>
                            <FormDescription>
                              Înregistrează toate acțiunile pentru conformitate
                            </FormDescription>
                          </div>
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="compliance.ipWhitelist"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>IP Whitelist (opțional)</FormLabel>
                          <FormControl>
                            <Textarea
                              placeholder="192.168.1.0/24&#10;10.0.0.1&#10;203.0.113.0/25"
                              className="font-mono text-sm h-24"
                              {...field}
                              value={field.value?.join('\n') || ''}
                              onChange={(e) =>
                                field.onChange(
                                  e.target.value.split('\n').filter((ip) => ip.trim())
                                )
                              }
                            />
                          </FormControl>
                          <FormDescription>
                            IP-uri/CIDR permise (unul per linie, gol = toate)
                          </FormDescription>
                        </FormItem>
                      )}
                    />
                  </div>

                  <div className="space-y-4">
                    <FormField
                      control={form.control}
                      name="compliance.twoFactorRequired"
                      render={({ field }) => (
                        <FormItem className="flex items-center justify-between rounded-lg border p-4">
                          <div className="space-y-0.5">
                            <FormLabel>2FA Obligatoriu</FormLabel>
                            <FormDescription>
                              Toți utilizatorii trebuie să activeze 2FA
                            </FormDescription>
                          </div>
                          <FormControl>
                            <Switch
                              checked={field.value}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="compliance.passwordPolicy"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Politică Parole</FormLabel>
                          <Select value={field.value} onValueChange={field.onChange}>
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="standard">Standard (8+ caractere, 1 cifră)</SelectItem>
                              <SelectItem value="strong">Puternică (12+ caractere, complexitate)</SelectItem>
                              <SelectItem value="enterprise">Enterprise (16+ caractere, rotație)</SelectItem>
                            </SelectContent>
                          </Select>
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="compliance.sessionTimeoutMinutes"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Timeout Sesiune (minute)</FormLabel>
                          <Select
                            value={field.value.toString()}
                            onValueChange={(val) => field.onChange(Number(val))}
                          >
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="15">15 minute</SelectItem>
                              <SelectItem value="30">30 minute</SelectItem>
                              <SelectItem value="60">1 oră</SelectItem>
                              <SelectItem value="120">2 ore</SelectItem>
                              <SelectItem value="480">8 ore (zi de lucru)</SelectItem>
                            </SelectContent>
                          </Select>
                        </FormItem>
                      )}
                    />
                  </div>
                </CardContent>
              </Card>
            </TabsContent>
          </Tabs>

          {/* Form Actions */}
          <div className="flex justify-between items-center pt-6 border-t">
            <div className="text-sm text-muted-foreground">
              {form.formState.isDirty && (
                <span className="flex items-center gap-2">
                  <div className="h-2 w-2 rounded-full bg-yellow-500" />
                  Modificări nesalvate
                </span>
              )}
            </div>
            <div className="flex gap-2">
              <Button
                type="button"
                variant="outline"
                onClick={() => form.reset()}
                disabled={!form.formState.isDirty || isSubmitting}
              >
                Resetează
              </Button>
              <Button type="submit" disabled={isSubmitting || !form.formState.isDirty}>
                {isSubmitting ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Salvare...
                  </>
                ) : (
                  <>
                    <Save className="h-4 w-4 mr-2" />
                    Salvează Setările
                  </>
                )}
              </Button>
            </div>
          </div>
        </form>
      </Form>
    </div>
  );
}
```

**Validare Schema TenantSettingsForm:**

```typescript
// src/schemas/tenant-settings.schema.ts

import { z } from 'zod';

// Romanian IBAN validation
const ibanRegex = /^RO[0-9]{2}[A-Z]{4}[A-Z0-9]{16}$/;

export const bankAccountSchema = z.object({
  bankName: z.string().min(2, 'Numele băncii este obligatoriu'),
  iban: z.string().regex(ibanRegex, 'IBAN invalid (format: RO49AAAA1B31007593840000)'),
  currency: z.enum(['RON', 'EUR', 'USD']),
  isDefault: z.boolean().default(false),
});

export const tenantSettingsSchema = z.object({
  // Company Info
  companyName: z
    .string()
    .min(2, 'Numele companiei trebuie să aibă minim 2 caractere')
    .max(200, 'Numele companiei trebuie să aibă maxim 200 caractere'),
  cui: z
    .string()
    .regex(/^(RO)?[0-9]{2,10}$/, 'CUI invalid (format: RO12345678 sau 12345678)'),
  regCom: z
    .string()
    .regex(
      /^J[0-9]{1,2}\/[0-9]{1,6}\/[0-9]{4}$/,
      'Nr. Reg. Com. invalid (format: J40/123/2020)'
    )
    .optional()
    .or(z.literal('')),
  address: z.string().min(10, 'Adresa trebuie să aibă minim 10 caractere'),
  city: z.string().min(2, 'Orașul este obligatoriu'),
  county: z.string().min(2, 'Județul este obligatoriu'),
  postalCode: z.string().regex(/^[0-9]{6}$/, 'Cod poștal invalid (6 cifre)'),
  country: z.string().default('România'),
  phone: z.string().regex(/^\+?[0-9]{10,15}$/, 'Telefon invalid'),
  email: z.string().email('Email invalid'),
  website: z.string().url('URL invalid').optional().or(z.literal('')),
  logo: z.string().url().optional().nullable(),

  // Bank Accounts
  bankAccounts: z.array(bankAccountSchema).min(1, 'Adăugați cel puțin un cont bancar'),

  // Defaults
  defaults: z.object({
    currency: z.enum(['RON', 'EUR', 'USD']).default('RON'),
    paymentTerms: z.number().int().min(0).max(180).default(30),
    validityDays: z.number().int().min(1).max(90).default(15),
    discountApprovalThreshold: z.number().int().min(0).max(50).default(15),
  }),

  // Limits
  limits: z.object({
    maxUsersCount: z.number().int().min(1).max(1000).default(10),
    maxContactsCount: z.number().int().min(100).max(1000000).default(10000),
    maxProductsCount: z.number().int().min(10).max(100000).default(1000),
    apiRateLimit: z.number().int().min(10).max(10000).default(100),
    storageQuotaGB: z.number().int().min(1).max(1000).default(10),
  }),

  // AI Settings
  aiSettings: z.object({
    enabled: z.boolean().default(true),
    autoApproveThreshold: z.number().int().min(50).max(100).default(85),
    maxDailyTokens: z.number().int().min(10000).max(10000000).default(1000000),
    defaultModel: z
      .enum([
        'claude-3-5-haiku-20241022',
        'claude-sonnet-4-20250514',
        'claude-opus-4-20250514',
      ])
      .default('claude-sonnet-4-20250514'),
    defaultTemperature: z.number().min(0).max(1).default(0.3),
    guardrailsProfile: z.enum(['strict', 'balanced', 'permissive', 'custom']).default('balanced'),
  }),

  // Compliance
  compliance: z.object({
    dataRetentionDays: z.number().int().min(365).max(3650).default(1825),
    auditLogEnabled: z.boolean().default(true),
    ipWhitelist: z.array(z.string()).optional(),
    twoFactorRequired: z.boolean().default(false),
    passwordPolicy: z.enum(['standard', 'strong', 'enterprise']).default('standard'),
    sessionTimeoutMinutes: z.number().int().min(15).max(480).default(60),
  }),
});

export type TenantSettingsFormData = z.infer<typeof tenantSettingsSchema>;
```

### 11.3 NotificationPreferencesForm

Formular pentru configurarea preferințelor de notificare ale utilizatorului.

```typescript
// src/components/forms/NotificationPreferencesForm.tsx

'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { toast } from 'sonner';
import {
  Bell,
  Mail,
  MessageSquare,
  Smartphone,
  Clock,
  Save,
  Loader2,
  BellRing,
  BellOff,
  Volume2,
  VolumeX,
} from 'lucide-react';

import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
} from '@/components/ui/form';
import { Switch } from '@/components/ui/switch';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Checkbox } from '@/components/ui/checkbox';

// Notification Preferences Schema
const notificationPreferencesSchema = z.object({
  // Global Settings
  global: z.object({
    enabled: z.boolean().default(true),
    sound: z.boolean().default(true),
    desktop: z.boolean().default(true),
  }),

  // Channel Preferences
  channels: z.object({
    email: z.object({
      enabled: z.boolean().default(true),
      address: z.string().email().optional(),
      digest: z.enum(['immediate', 'hourly', 'daily', 'weekly']).default('immediate'),
    }),
    push: z.object({
      enabled: z.boolean().default(true),
      devices: z.array(z.string()).optional(),
    }),
    sms: z.object({
      enabled: z.boolean().default(false),
      phone: z.string().optional(),
      urgentOnly: z.boolean().default(true),
    }),
    whatsapp: z.object({
      enabled: z.boolean().default(false),
      phone: z.string().optional(),
    }),
  }),

  // Event Subscriptions
  events: z.object({
    // Negocieri
    negotiation_created: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),
    negotiation_updated: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),
    negotiation_stage_changed: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),
    negotiation_completed: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),
    negotiation_expired: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),

    // AI & Responses
    ai_response_generated: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),
    ai_confidence_low: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),
    guardrail_triggered: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),

    // HITL
    approval_required: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),
    approval_reminder: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),
    approval_escalated: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),
    takeover_requested: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),

    // Documente
    document_generated: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),
    efactura_sent: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),
    efactura_status: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),
    payment_received: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),

    // Sistem
    system_maintenance: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),
    quota_warning: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),
    security_alert: z.object({ email: z.boolean(), push: z.boolean(), sms: z.boolean() }),
  }),

  // Schedule
  schedule: z.object({
    quietHours: z.object({
      enabled: z.boolean().default(false),
      start: z.string().default('22:00'),
      end: z.string().default('08:00'),
    }),
    weekendPause: z.boolean().default(false),
    timezone: z.string().default('Europe/Bucharest'),
  }),
});

type NotificationPreferencesFormData = z.infer<typeof notificationPreferencesSchema>;

// Event categories for UI organization
const eventCategories = {
  negotiations: {
    label: 'Negocieri',
    icon: MessageSquare,
    events: [
      { key: 'negotiation_created', label: 'Negociere nouă', description: 'Când începe o negociere nouă' },
      { key: 'negotiation_updated', label: 'Actualizare negociere', description: 'Când se modifică o negociere' },
      { key: 'negotiation_stage_changed', label: 'Schimbare etapă', description: 'Tranziție la etapă nouă' },
      { key: 'negotiation_completed', label: 'Negociere finalizată', description: 'Când se încheie cu succes' },
      { key: 'negotiation_expired', label: 'Negociere expirată', description: 'Când expiră valabilitatea' },
    ],
  },
  ai: {
    label: 'AI & Răspunsuri',
    icon: BellRing,
    events: [
      { key: 'ai_response_generated', label: 'Răspuns AI generat', description: 'Răspuns pregătit pentru aprobare' },
      { key: 'ai_confidence_low', label: 'Confidence scăzut', description: 'AI necesită intervenție umană' },
      { key: 'guardrail_triggered', label: 'Guardrail activat', description: 'Regulă de siguranță declanșată' },
    ],
  },
  hitl: {
    label: 'Aprobări (HITL)',
    icon: Clock,
    events: [
      { key: 'approval_required', label: 'Aprobare necesară', description: 'Cerere nouă de aprobare' },
      { key: 'approval_reminder', label: 'Reminder aprobare', description: 'Aprobare în așteptare' },
      { key: 'approval_escalated', label: 'Aprobare escaladată', description: 'Cerere transferată la nivel superior' },
      { key: 'takeover_requested', label: 'Takeover solicitat', description: 'Cerere de preluare manuală' },
    ],
  },
  documents: {
    label: 'Documente & Plăți',
    icon: Mail,
    events: [
      { key: 'document_generated', label: 'Document generat', description: 'Ofertă/Proformă/Factură' },
      { key: 'efactura_sent', label: 'e-Factura trimisă', description: 'Transmis la ANAF SPV' },
      { key: 'efactura_status', label: 'Status e-Factura', description: 'Actualizare status ANAF' },
      { key: 'payment_received', label: 'Plată primită', description: 'Confirmare încasare' },
    ],
  },
  system: {
    label: 'Sistem',
    icon: Bell,
    events: [
      { key: 'system_maintenance', label: 'Mentenanță', description: 'Întreruperi planificate' },
      { key: 'quota_warning', label: 'Avertisment cotă', description: 'Aproape de limitele contului' },
      { key: 'security_alert', label: 'Alertă securitate', description: 'Activitate suspectă detectată' },
    ],
  },
};

interface NotificationPreferencesFormProps {
  initialData?: Partial<NotificationPreferencesFormData>;
  onSave?: (data: NotificationPreferencesFormData) => Promise<void>;
}

export function NotificationPreferencesForm({
  initialData,
  onSave,
}: NotificationPreferencesFormProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);

  // Default values with all events enabled for push
  const defaultEventSettings = {
    email: true,
    push: true,
    sms: false,
  };

  const defaultEvents = Object.keys(eventCategories).reduce(
    (acc, category) => {
      const events = eventCategories[category as keyof typeof eventCategories].events;
      events.forEach((event) => {
        acc[event.key as keyof NotificationPreferencesFormData['events']] = defaultEventSettings;
      });
      return acc;
    },
    {} as NotificationPreferencesFormData['events']
  );

  const form = useForm<NotificationPreferencesFormData>({
    resolver: zodResolver(notificationPreferencesSchema),
    defaultValues: {
      global: {
        enabled: true,
        sound: true,
        desktop: true,
      },
      channels: {
        email: {
          enabled: true,
          digest: 'immediate',
        },
        push: {
          enabled: true,
        },
        sms: {
          enabled: false,
          urgentOnly: true,
        },
        whatsapp: {
          enabled: false,
        },
      },
      events: defaultEvents,
      schedule: {
        quietHours: {
          enabled: false,
          start: '22:00',
          end: '08:00',
        },
        weekendPause: false,
        timezone: 'Europe/Bucharest',
      },
      ...initialData,
    },
  });

  const globalEnabled = form.watch('global.enabled');
  const emailEnabled = form.watch('channels.email.enabled');
  const pushEnabled = form.watch('channels.push.enabled');
  const smsEnabled = form.watch('channels.sms.enabled');
  const quietHoursEnabled = form.watch('schedule.quietHours.enabled');

  // Toggle all events for a channel
  const toggleAllForChannel = (channel: 'email' | 'push' | 'sms', enabled: boolean) => {
    const events = form.getValues('events');
    const updatedEvents = { ...events };

    Object.keys(events).forEach((eventKey) => {
      updatedEvents[eventKey as keyof typeof events] = {
        ...events[eventKey as keyof typeof events],
        [channel]: enabled,
      };
    });

    form.setValue('events', updatedEvents, { shouldDirty: true });
  };

  // Toggle all events for a category
  const toggleAllForCategory = (categoryKey: string, enabled: boolean) => {
    const category = eventCategories[categoryKey as keyof typeof eventCategories];
    if (!category) return;

    category.events.forEach((event) => {
      form.setValue(
        `events.${event.key as keyof NotificationPreferencesFormData['events']}`,
        {
          email: enabled,
          push: enabled,
          sms: enabled,
        },
        { shouldDirty: true }
      );
    });
  };

  const onSubmit = async (data: NotificationPreferencesFormData) => {
    setIsSubmitting(true);
    try {
      if (onSave) {
        await onSave(data);
      } else {
        // Default API call
        const response = await fetch('/api/v1/users/me/notifications', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          throw new Error('Failed to save preferences');
        }
      }

      toast.success('Preferințele de notificare au fost salvate');
    } catch (error) {
      toast.error('Eroare la salvarea preferințelor');
      console.error(error);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-xl font-semibold">Preferințe Notificări</h2>
          <p className="text-sm text-muted-foreground">
            Configurează cum și când primești notificări
          </p>
        </div>
        <div className="flex items-center gap-2">
          {globalEnabled ? (
            <Badge variant="default" className="gap-1">
              <BellRing className="h-3 w-3" />
              Active
            </Badge>
          ) : (
            <Badge variant="secondary" className="gap-1">
              <BellOff className="h-3 w-3" />
              Dezactivate
            </Badge>
          )}
        </div>
      </div>

      <Form {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
          {/* Global Toggle */}
          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <div className="p-3 rounded-full bg-primary/10">
                    <Bell className="h-6 w-6 text-primary" />
                  </div>
                  <div>
                    <FormLabel className="text-base">Notificări Globale</FormLabel>
                    <FormDescription>
                      Activează sau dezactivează toate notificările
                    </FormDescription>
                  </div>
                </div>
                <FormField
                  control={form.control}
                  name="global.enabled"
                  render={({ field }) => (
                    <FormItem>
                      <FormControl>
                        <Switch
                          checked={field.value}
                          onCheckedChange={field.onChange}
                        />
                      </FormControl>
                    </FormItem>
                  )}
                />
              </div>

              {globalEnabled && (
                <div className="flex gap-6 mt-4 pt-4 border-t">
                  <FormField
                    control={form.control}
                    name="global.sound"
                    render={({ field }) => (
                      <FormItem className="flex items-center gap-2">
                        <FormControl>
                          <Checkbox
                            checked={field.value}
                            onCheckedChange={field.onChange}
                          />
                        </FormControl>
                        <FormLabel className="flex items-center gap-1 font-normal cursor-pointer">
                          {field.value ? (
                            <Volume2 className="h-4 w-4" />
                          ) : (
                            <VolumeX className="h-4 w-4 text-muted-foreground" />
                          )}
                          Sunet
                        </FormLabel>
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="global.desktop"
                    render={({ field }) => (
                      <FormItem className="flex items-center gap-2">
                        <FormControl>
                          <Checkbox
                            checked={field.value}
                            onCheckedChange={field.onChange}
                          />
                        </FormControl>
                        <FormLabel className="flex items-center gap-1 font-normal cursor-pointer">
                          <Smartphone className="h-4 w-4" />
                          Desktop Push
                        </FormLabel>
                      </FormItem>
                    )}
                  />
                </div>
              )}
            </CardContent>
          </Card>

          {globalEnabled && (
            <Tabs defaultValue="channels" className="space-y-4">
              <TabsList className="grid w-full grid-cols-3">
                <TabsTrigger value="channels">Canale</TabsTrigger>
                <TabsTrigger value="events">Evenimente</TabsTrigger>
                <TabsTrigger value="schedule">Program</TabsTrigger>
              </TabsList>

              {/* Channels Tab */}
              <TabsContent value="channels" className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  {/* Email Channel */}
                  <Card>
                    <CardHeader className="pb-3">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <Mail className="h-5 w-5 text-primary" />
                          <CardTitle className="text-base">Email</CardTitle>
                        </div>
                        <FormField
                          control={form.control}
                          name="channels.email.enabled"
                          render={({ field }) => (
                            <FormItem>
                              <FormControl>
                                <Switch
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                            </FormItem>
                          )}
                        />
                      </div>
                    </CardHeader>
                    {emailEnabled && (
                      <CardContent className="space-y-4">
                        <FormField
                          control={form.control}
                          name="channels.email.address"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Adresă Email</FormLabel>
                              <FormControl>
                                <Input
                                  type="email"
                                  placeholder="email@exemplu.com"
                                  {...field}
                                />
                              </FormControl>
                              <FormDescription>
                                Lasă gol pentru email-ul contului
                              </FormDescription>
                            </FormItem>
                          )}
                        />

                        <FormField
                          control={form.control}
                          name="channels.email.digest"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Frecvență</FormLabel>
                              <Select value={field.value} onValueChange={field.onChange}>
                                <FormControl>
                                  <SelectTrigger>
                                    <SelectValue />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  <SelectItem value="immediate">Imediat</SelectItem>
                                  <SelectItem value="hourly">Sumar orar</SelectItem>
                                  <SelectItem value="daily">Sumar zilnic</SelectItem>
                                  <SelectItem value="weekly">Sumar săptămânal</SelectItem>
                                </SelectContent>
                              </Select>
                            </FormItem>
                          )}
                        />
                      </CardContent>
                    )}
                  </Card>

                  {/* Push Channel */}
                  <Card>
                    <CardHeader className="pb-3">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <Bell className="h-5 w-5 text-primary" />
                          <CardTitle className="text-base">Push</CardTitle>
                        </div>
                        <FormField
                          control={form.control}
                          name="channels.push.enabled"
                          render={({ field }) => (
                            <FormItem>
                              <FormControl>
                                <Switch
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                            </FormItem>
                          )}
                        />
                      </div>
                    </CardHeader>
                    {pushEnabled && (
                      <CardContent>
                        <p className="text-sm text-muted-foreground">
                          Notificări push în browser și aplicație mobilă.
                          Asigură-te că ai permis notificările în browser.
                        </p>
                        <Button
                          type="button"
                          variant="outline"
                          size="sm"
                          className="mt-3"
                          onClick={async () => {
                            if ('Notification' in window) {
                              const permission = await Notification.requestPermission();
                              if (permission === 'granted') {
                                toast.success('Notificări push activate');
                              } else {
                                toast.error('Notificările push sunt blocate');
                              }
                            }
                          }}
                        >
                          Testează Push
                        </Button>
                      </CardContent>
                    )}
                  </Card>

                  {/* SMS Channel */}
                  <Card>
                    <CardHeader className="pb-3">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <Smartphone className="h-5 w-5 text-primary" />
                          <CardTitle className="text-base">SMS</CardTitle>
                        </div>
                        <FormField
                          control={form.control}
                          name="channels.sms.enabled"
                          render={({ field }) => (
                            <FormItem>
                              <FormControl>
                                <Switch
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                            </FormItem>
                          )}
                        />
                      </div>
                    </CardHeader>
                    {smsEnabled && (
                      <CardContent className="space-y-4">
                        <FormField
                          control={form.control}
                          name="channels.sms.phone"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Telefon</FormLabel>
                              <FormControl>
                                <Input
                                  type="tel"
                                  placeholder="+40721234567"
                                  {...field}
                                />
                              </FormControl>
                            </FormItem>
                          )}
                        />

                        <FormField
                          control={form.control}
                          name="channels.sms.urgentOnly"
                          render={({ field }) => (
                            <FormItem className="flex items-center gap-2">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <FormLabel className="font-normal cursor-pointer">
                                Doar notificări urgente
                              </FormLabel>
                            </FormItem>
                          )}
                        />
                      </CardContent>
                    )}
                  </Card>

                  {/* WhatsApp Channel */}
                  <Card>
                    <CardHeader className="pb-3">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <MessageSquare className="h-5 w-5 text-green-600" />
                          <CardTitle className="text-base">WhatsApp</CardTitle>
                        </div>
                        <FormField
                          control={form.control}
                          name="channels.whatsapp.enabled"
                          render={({ field }) => (
                            <FormItem>
                              <FormControl>
                                <Switch
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                            </FormItem>
                          )}
                        />
                      </div>
                    </CardHeader>
                    {form.watch('channels.whatsapp.enabled') && (
                      <CardContent>
                        <FormField
                          control={form.control}
                          name="channels.whatsapp.phone"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Număr WhatsApp</FormLabel>
                              <FormControl>
                                <Input
                                  type="tel"
                                  placeholder="+40721234567"
                                  {...field}
                                />
                              </FormControl>
                            </FormItem>
                          )}
                        />
                      </CardContent>
                    )}
                  </Card>
                </div>
              </TabsContent>

              {/* Events Tab */}
              <TabsContent value="events">
                <Card>
                  <CardHeader className="pb-3">
                    <div className="flex items-center justify-between">
                      <div>
                        <CardTitle className="text-base">Evenimente</CardTitle>
                        <CardDescription>
                          Selectează pentru ce evenimente vrei notificări
                        </CardDescription>
                      </div>
                      <div className="flex gap-2 text-xs">
                        <Button
                          type="button"
                          variant="outline"
                          size="sm"
                          onClick={() => toggleAllForChannel('email', true)}
                        >
                          Email Toate
                        </Button>
                        <Button
                          type="button"
                          variant="outline"
                          size="sm"
                          onClick={() => toggleAllForChannel('push', true)}
                        >
                          Push Toate
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                  <CardContent>
                    <ScrollArea className="h-[500px] pr-4">
                      <div className="space-y-6">
                        {Object.entries(eventCategories).map(([categoryKey, category]) => (
                          <div key={categoryKey}>
                            <div className="flex items-center justify-between mb-3">
                              <div className="flex items-center gap-2">
                                <category.icon className="h-4 w-4 text-muted-foreground" />
                                <span className="font-medium">{category.label}</span>
                              </div>
                              <div className="flex gap-1">
                                <Button
                                  type="button"
                                  variant="ghost"
                                  size="sm"
                                  className="h-6 text-xs"
                                  onClick={() => toggleAllForCategory(categoryKey, true)}
                                >
                                  Toate
                                </Button>
                                <Button
                                  type="button"
                                  variant="ghost"
                                  size="sm"
                                  className="h-6 text-xs"
                                  onClick={() => toggleAllForCategory(categoryKey, false)}
                                >
                                  Niciunul
                                </Button>
                              </div>
                            </div>

                            <div className="space-y-2 pl-6">
                              {category.events.map((event) => (
                                <div
                                  key={event.key}
                                  className="flex items-center justify-between py-2 border-b last:border-0"
                                >
                                  <div>
                                    <p className="text-sm font-medium">{event.label}</p>
                                    <p className="text-xs text-muted-foreground">
                                      {event.description}
                                    </p>
                                  </div>
                                  <div className="flex gap-4">
                                    <FormField
                                      control={form.control}
                                      name={`events.${event.key as keyof NotificationPreferencesFormData['events']}.email`}
                                      render={({ field }) => (
                                        <FormItem className="flex items-center gap-1">
                                          <FormControl>
                                            <Checkbox
                                              checked={field.value}
                                              onCheckedChange={field.onChange}
                                              disabled={!emailEnabled}
                                            />
                                          </FormControl>
                                          <FormLabel className="text-xs font-normal">
                                            Email
                                          </FormLabel>
                                        </FormItem>
                                      )}
                                    />
                                    <FormField
                                      control={form.control}
                                      name={`events.${event.key as keyof NotificationPreferencesFormData['events']}.push`}
                                      render={({ field }) => (
                                        <FormItem className="flex items-center gap-1">
                                          <FormControl>
                                            <Checkbox
                                              checked={field.value}
                                              onCheckedChange={field.onChange}
                                              disabled={!pushEnabled}
                                            />
                                          </FormControl>
                                          <FormLabel className="text-xs font-normal">
                                            Push
                                          </FormLabel>
                                        </FormItem>
                                      )}
                                    />
                                    <FormField
                                      control={form.control}
                                      name={`events.${event.key as keyof NotificationPreferencesFormData['events']}.sms`}
                                      render={({ field }) => (
                                        <FormItem className="flex items-center gap-1">
                                          <FormControl>
                                            <Checkbox
                                              checked={field.value}
                                              onCheckedChange={field.onChange}
                                              disabled={!smsEnabled}
                                            />
                                          </FormControl>
                                          <FormLabel className="text-xs font-normal">
                                            SMS
                                          </FormLabel>
                                        </FormItem>
                                      )}
                                    />
                                  </div>
                                </div>
                              ))}
                            </div>

                            <Separator className="my-4" />
                          </div>
                        ))}
                      </div>
                    </ScrollArea>
                  </CardContent>
                </Card>
              </TabsContent>

              {/* Schedule Tab */}
              <TabsContent value="schedule">
                <div className="grid grid-cols-2 gap-4">
                  <Card>
                    <CardHeader>
                      <CardTitle className="text-base flex items-center gap-2">
                        <Clock className="h-4 w-4" />
                        Ore de Liniște
                      </CardTitle>
                      <CardDescription>
                        Suspendă notificările în intervalul specificat
                      </CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <FormField
                        control={form.control}
                        name="schedule.quietHours.enabled"
                        render={({ field }) => (
                          <FormItem className="flex items-center justify-between">
                            <FormLabel>Activează Ore de Liniște</FormLabel>
                            <FormControl>
                              <Switch
                                checked={field.value}
                                onCheckedChange={field.onChange}
                              />
                            </FormControl>
                          </FormItem>
                        )}
                      />

                      {quietHoursEnabled && (
                        <div className="grid grid-cols-2 gap-4">
                          <FormField
                            control={form.control}
                            name="schedule.quietHours.start"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Început</FormLabel>
                                <FormControl>
                                  <Input type="time" {...field} />
                                </FormControl>
                              </FormItem>
                            )}
                          />

                          <FormField
                            control={form.control}
                            name="schedule.quietHours.end"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Sfârșit</FormLabel>
                                <FormControl>
                                  <Input type="time" {...field} />
                                </FormControl>
                              </FormItem>
                            )}
                          />
                        </div>
                      )}

                      <FormField
                        control={form.control}
                        name="schedule.weekendPause"
                        render={({ field }) => (
                          <FormItem className="flex items-center gap-2 pt-2">
                            <FormControl>
                              <Checkbox
                                checked={field.value}
                                onCheckedChange={field.onChange}
                              />
                            </FormControl>
                            <FormLabel className="font-normal cursor-pointer">
                              Pauză în weekend (Sâmbătă-Duminică)
                            </FormLabel>
                          </FormItem>
                        )}
                      />
                    </CardContent>
                  </Card>

                  <Card>
                    <CardHeader>
                      <CardTitle className="text-base">Fus Orar</CardTitle>
                      <CardDescription>
                        Toate orele sunt interpretate în acest fus orar
                      </CardDescription>
                    </CardHeader>
                    <CardContent>
                      <FormField
                        control={form.control}
                        name="schedule.timezone"
                        render={({ field }) => (
                          <FormItem>
                            <Select value={field.value} onValueChange={field.onChange}>
                              <FormControl>
                                <SelectTrigger>
                                  <SelectValue />
                                </SelectTrigger>
                              </FormControl>
                              <SelectContent>
                                <SelectItem value="Europe/Bucharest">
                                  Europe/București (EET/EEST)
                                </SelectItem>
                                <SelectItem value="Europe/London">
                                  Europe/Londra (GMT/BST)
                                </SelectItem>
                                <SelectItem value="Europe/Paris">
                                  Europe/Paris (CET/CEST)
                                </SelectItem>
                                <SelectItem value="America/New_York">
                                  America/New York (EST/EDT)
                                </SelectItem>
                                <SelectItem value="UTC">UTC</SelectItem>
                              </SelectContent>
                            </Select>
                          </FormItem>
                        )}
                      />
                    </CardContent>
                  </Card>
                </div>
              </TabsContent>
            </Tabs>
          )}

          {/* Form Actions */}
          <div className="flex justify-between items-center pt-4 border-t">
            <div className="text-sm text-muted-foreground">
              {form.formState.isDirty && (
                <span className="flex items-center gap-2">
                  <div className="h-2 w-2 rounded-full bg-yellow-500" />
                  Modificări nesalvate
                </span>
              )}
            </div>
            <div className="flex gap-2">
              <Button
                type="button"
                variant="outline"
                onClick={() => form.reset()}
                disabled={!form.formState.isDirty || isSubmitting}
              >
                Resetează
              </Button>
              <Button type="submit" disabled={isSubmitting || !form.formState.isDirty}>
                {isSubmitting ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Salvare...
                  </>
                ) : (
                  <>
                    <Save className="h-4 w-4 mr-2" />
                    Salvează Preferințe
                  </>
                )}
              </Button>
            </div>
          </div>
        </form>
      </Form>
    </div>
  );
}
```

**API Endpoint:**

```
PUT /api/v1/users/me/notifications
Content-Type: application/json

Request Body: NotificationPreferencesFormData
Response: { success: true, data: NotificationPreferencesFormData }
```

---

## 12. Confirmation Dialogs

Dialoguri de confirmare pentru acțiuni distructive sau ireversibile.

### 12.1 DeleteConfirmDialog

Dialog generic pentru confirmarea ștergerii cu suport pentru delete cascadă.

```typescript
// src/components/dialogs/DeleteConfirmDialog.tsx

'use client';

import { useState, useEffect } from 'react';
import { toast } from 'sonner';
import {
  AlertTriangle,
  Trash2,
  Loader2,
  AlertCircle,
  CheckCircle2,
  XCircle,
} from 'lucide-react';

import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Badge } from '@/components/ui/badge';
import { Checkbox } from '@/components/ui/checkbox';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Alert, AlertDescription } from '@/components/ui/alert';

// Types for different resource types
type ResourceType =
  | 'contact'
  | 'product'
  | 'negotiation'
  | 'document'
  | 'user'
  | 'campaign'
  | 'template'
  | 'guardrail'
  | 'webhook'
  | 'generic';

interface CascadeItem {
  type: string;
  count: number;
  description: string;
  canOrphan?: boolean;
}

interface DeleteConfirmDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  resourceType: ResourceType;
  resourceName: string;
  resourceId: string;
  cascadeItems?: CascadeItem[];
  requireConfirmation?: boolean;
  confirmationText?: string;
  warningMessage?: string;
  onConfirm: () => Promise<void>;
  onSuccess?: () => void;
}

// Resource type labels in Romanian
const resourceLabels: Record<ResourceType, { singular: string; plural: string }> = {
  contact: { singular: 'contactul', plural: 'contactele' },
  product: { singular: 'produsul', plural: 'produsele' },
  negotiation: { singular: 'negocierea', plural: 'negocierile' },
  document: { singular: 'documentul', plural: 'documentele' },
  user: { singular: 'utilizatorul', plural: 'utilizatorii' },
  campaign: { singular: 'campania', plural: 'campaniile' },
  template: { singular: 'șablonul', plural: 'șabloanele' },
  guardrail: { singular: 'regula', plural: 'regulile' },
  webhook: { singular: 'webhook-ul', plural: 'webhook-urile' },
  generic: { singular: 'elementul', plural: 'elementele' },
};

export function DeleteConfirmDialog({
  open,
  onOpenChange,
  resourceType,
  resourceName,
  resourceId,
  cascadeItems = [],
  requireConfirmation = false,
  confirmationText,
  warningMessage,
  onConfirm,
  onSuccess,
}: DeleteConfirmDialogProps) {
  const [isDeleting, setIsDeleting] = useState(false);
  const [confirmInput, setConfirmInput] = useState('');
  const [cascadeAcknowledged, setCascadeAcknowledged] = useState(false);

  const label = resourceLabels[resourceType];
  const expectedConfirmation = confirmationText || resourceName;
  const hasCascade = cascadeItems.length > 0;
  const totalCascadeItems = cascadeItems.reduce((sum, item) => sum + item.count, 0);

  // Reset state when dialog opens/closes
  useEffect(() => {
    if (!open) {
      setConfirmInput('');
      setCascadeAcknowledged(false);
    }
  }, [open]);

  // Validation
  const isConfirmationValid = !requireConfirmation || confirmInput === expectedConfirmation;
  const isCascadeAcknowledged = !hasCascade || cascadeAcknowledged;
  const canDelete = isConfirmationValid && isCascadeAcknowledged;

  const handleDelete = async () => {
    if (!canDelete) return;

    setIsDeleting(true);
    try {
      await onConfirm();
      toast.success(`${label.singular.charAt(0).toUpperCase() + label.singular.slice(1)} a fost șters`);
      onOpenChange(false);
      onSuccess?.();
    } catch (error) {
      toast.error('Eroare la ștergere', {
        description: error instanceof Error ? error.message : 'A apărut o eroare',
      });
    } finally {
      setIsDeleting(false);
    }
  };

  return (
    <AlertDialog open={open} onOpenChange={onOpenChange}>
      <AlertDialogContent className="max-w-lg">
        <AlertDialogHeader>
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-full bg-destructive/10">
              <Trash2 className="h-5 w-5 text-destructive" />
            </div>
            <AlertDialogTitle>
              Șterge {label.singular}
            </AlertDialogTitle>
          </div>
          <AlertDialogDescription className="text-left pt-2">
            Ești sigur că vrei să ștergi{' '}
            <span className="font-semibold text-foreground">"{resourceName}"</span>?
            <br />
            <span className="text-destructive font-medium">
              Această acțiune nu poate fi anulată.
            </span>
          </AlertDialogDescription>
        </AlertDialogHeader>

        <div className="space-y-4 py-4">
          {/* Warning Message */}
          {warningMessage && (
            <Alert variant="destructive">
              <AlertTriangle className="h-4 w-4" />
              <AlertDescription>{warningMessage}</AlertDescription>
            </Alert>
          )}

          {/* Cascade Items Warning */}
          {hasCascade && (
            <div className="space-y-3">
              <Alert>
                <AlertCircle className="h-4 w-4" />
                <AlertDescription>
                  Ștergerea va afecta și următoarele elemente asociate:
                </AlertDescription>
              </Alert>

              <ScrollArea className="max-h-40">
                <div className="space-y-2 pr-4">
                  {cascadeItems.map((item, index) => (
                    <div
                      key={index}
                      className="flex items-center justify-between p-2 bg-muted rounded-md"
                    >
                      <div className="flex items-center gap-2">
                        <XCircle className="h-4 w-4 text-destructive" />
                        <span className="text-sm">{item.description}</span>
                      </div>
                      <Badge variant="secondary">{item.count}</Badge>
                    </div>
                  ))}
                </div>
              </ScrollArea>

              <div className="text-sm text-muted-foreground text-center">
                Total: <span className="font-semibold">{totalCascadeItems}</span> elemente vor fi șterse
              </div>

              <div className="flex items-start gap-2 p-3 bg-destructive/5 rounded-md">
                <Checkbox
                  id="cascade-ack"
                  checked={cascadeAcknowledged}
                  onCheckedChange={(checked) => setCascadeAcknowledged(checked === true)}
                />
                <Label htmlFor="cascade-ack" className="text-sm cursor-pointer leading-relaxed">
                  Înțeleg că toate elementele asociate vor fi șterse permanent și
                  accept consecințele acestei acțiuni.
                </Label>
              </div>
            </div>
          )}

          {/* Confirmation Input */}
          {requireConfirmation && (
            <div className="space-y-2">
              <Label htmlFor="confirm-delete">
                Pentru confirmare, scrie{' '}
                <code className="px-1 py-0.5 bg-muted rounded text-sm font-mono">
                  {expectedConfirmation}
                </code>
              </Label>
              <Input
                id="confirm-delete"
                value={confirmInput}
                onChange={(e) => setConfirmInput(e.target.value)}
                placeholder={expectedConfirmation}
                className={
                  confirmInput.length > 0
                    ? confirmInput === expectedConfirmation
                      ? 'border-green-500 focus-visible:ring-green-500'
                      : 'border-destructive focus-visible:ring-destructive'
                    : ''
                }
              />
              <div className="flex items-center gap-1 text-xs">
                {confirmInput.length > 0 && (
                  confirmInput === expectedConfirmation ? (
                    <>
                      <CheckCircle2 className="h-3 w-3 text-green-500" />
                      <span className="text-green-500">Confirmare corectă</span>
                    </>
                  ) : (
                    <>
                      <XCircle className="h-3 w-3 text-destructive" />
                      <span className="text-destructive">Textul nu corespunde</span>
                    </>
                  )
                )}
              </div>
            </div>
          )}
        </div>

        <AlertDialogFooter>
          <AlertDialogCancel disabled={isDeleting}>Anulează</AlertDialogCancel>
          <AlertDialogAction
            onClick={handleDelete}
            disabled={!canDelete || isDeleting}
            className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
          >
            {isDeleting ? (
              <>
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                Se șterge...
              </>
            ) : (
              <>
                <Trash2 className="h-4 w-4 mr-2" />
                Șterge Definitiv
              </>
            )}
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
```

**Utilizare:**

```typescript
// În componenta părinte
const [deleteDialog, setDeleteDialog] = useState<{
  open: boolean;
  contact: Contact | null;
}>({ open: false, contact: null });

// Deschidere dialog
setDeleteDialog({ open: true, contact: selectedContact });

// Render
<DeleteConfirmDialog
  open={deleteDialog.open}
  onOpenChange={(open) => setDeleteDialog({ ...deleteDialog, open })}
  resourceType="contact"
  resourceName={deleteDialog.contact?.name || ''}
  resourceId={deleteDialog.contact?.id || ''}
  cascadeItems={[
    { type: 'negotiations', count: 5, description: 'Negocieri asociate' },
    { type: 'documents', count: 12, description: 'Documente (oferte, facturi)' },
    { type: 'messages', count: 47, description: 'Mesaje și comunicări' },
  ]}
  requireConfirmation={true}
  warningMessage="Acest contact are negocieri active în derulare!"
  onConfirm={async () => {
    await deleteContact(deleteDialog.contact!.id);
  }}
  onSuccess={() => {
    refetchContacts();
    setDeleteDialog({ open: false, contact: null });
  }}
/>
```

### 12.2 BulkActionDialog

Dialog pentru acțiuni în masă pe selecții multiple.

```typescript
// src/components/dialogs/BulkActionDialog.tsx

'use client';

import { useState, useMemo } from 'react';
import { toast } from 'sonner';
import {
  CheckCircle2,
  XCircle,
  Loader2,
  AlertTriangle,
  Trash2,
  Archive,
  Tag,
  Send,
  Download,
  RefreshCw,
  Play,
  Pause,
  ArrowRight,
} from 'lucide-react';

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Checkbox } from '@/components/ui/checkbox';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Separator } from '@/components/ui/separator';
import { Textarea } from '@/components/ui/textarea';

// Types
type BulkActionType =
  | 'delete'
  | 'archive'
  | 'unarchive'
  | 'assign_tag'
  | 'remove_tag'
  | 'export'
  | 'send_campaign'
  | 'change_status'
  | 'refresh_data'
  | 'start_negotiation'
  | 'pause_negotiation'
  | 'transfer_owner';

interface BulkActionConfig {
  type: BulkActionType;
  label: string;
  description: string;
  icon: React.ComponentType<{ className?: string }>;
  variant: 'default' | 'destructive' | 'secondary';
  requiresConfirmation: boolean;
  requiresInput?: 'tag' | 'status' | 'owner' | 'message';
}

interface SelectedItem {
  id: string;
  name: string;
  status?: string;
  canProcess?: boolean;
  errorReason?: string;
}

interface ProcessingResult {
  id: string;
  name: string;
  success: boolean;
  error?: string;
}

interface BulkActionDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  actionType: BulkActionType;
  selectedItems: SelectedItem[];
  resourceType: string;
  availableTags?: { id: string; name: string; color: string }[];
  availableStatuses?: { value: string; label: string }[];
  availableOwners?: { id: string; name: string; email: string }[];
  onExecute: (items: SelectedItem[], options?: Record<string, any>) => Promise<ProcessingResult[]>;
  onComplete?: (results: ProcessingResult[]) => void;
}

// Action configurations
const actionConfigs: Record<BulkActionType, BulkActionConfig> = {
  delete: {
    type: 'delete',
    label: 'Șterge',
    description: 'Șterge permanent elementele selectate',
    icon: Trash2,
    variant: 'destructive',
    requiresConfirmation: true,
  },
  archive: {
    type: 'archive',
    label: 'Arhivează',
    description: 'Mută în arhivă pentru păstrare',
    icon: Archive,
    variant: 'secondary',
    requiresConfirmation: false,
  },
  unarchive: {
    type: 'unarchive',
    label: 'Dezarhivează',
    description: 'Restaurează din arhivă',
    icon: Archive,
    variant: 'secondary',
    requiresConfirmation: false,
  },
  assign_tag: {
    type: 'assign_tag',
    label: 'Adaugă Etichetă',
    description: 'Adaugă o etichetă la toate elementele',
    icon: Tag,
    variant: 'default',
    requiresConfirmation: false,
    requiresInput: 'tag',
  },
  remove_tag: {
    type: 'remove_tag',
    label: 'Elimină Etichetă',
    description: 'Elimină eticheta de pe elementele selectate',
    icon: Tag,
    variant: 'secondary',
    requiresConfirmation: false,
    requiresInput: 'tag',
  },
  export: {
    type: 'export',
    label: 'Exportă',
    description: 'Exportă datele în format CSV/Excel',
    icon: Download,
    variant: 'default',
    requiresConfirmation: false,
  },
  send_campaign: {
    type: 'send_campaign',
    label: 'Trimite Campanie',
    description: 'Trimite o campanie de comunicare',
    icon: Send,
    variant: 'default',
    requiresConfirmation: true,
    requiresInput: 'message',
  },
  change_status: {
    type: 'change_status',
    label: 'Schimbă Status',
    description: 'Modifică statusul pentru toate elementele',
    icon: RefreshCw,
    variant: 'default',
    requiresConfirmation: false,
    requiresInput: 'status',
  },
  refresh_data: {
    type: 'refresh_data',
    label: 'Reîmprospătează Date',
    description: 'Re-sincronizează datele din surse externe',
    icon: RefreshCw,
    variant: 'default',
    requiresConfirmation: false,
  },
  start_negotiation: {
    type: 'start_negotiation',
    label: 'Pornește Negocieri',
    description: 'Inițiază negocieri pentru contactele selectate',
    icon: Play,
    variant: 'default',
    requiresConfirmation: true,
  },
  pause_negotiation: {
    type: 'pause_negotiation',
    label: 'Pune pe Pauză',
    description: 'Suspendă temporar negocierile',
    icon: Pause,
    variant: 'secondary',
    requiresConfirmation: false,
  },
  transfer_owner: {
    type: 'transfer_owner',
    label: 'Transfer Proprietar',
    description: 'Transferă elementele la alt utilizator',
    icon: ArrowRight,
    variant: 'default',
    requiresConfirmation: true,
    requiresInput: 'owner',
  },
};

export function BulkActionDialog({
  open,
  onOpenChange,
  actionType,
  selectedItems,
  resourceType,
  availableTags = [],
  availableStatuses = [],
  availableOwners = [],
  onExecute,
  onComplete,
}: BulkActionDialogProps) {
  const [phase, setPhase] = useState<'config' | 'processing' | 'results'>('config');
  const [isProcessing, setIsProcessing] = useState(false);
  const [progress, setProgress] = useState(0);
  const [results, setResults] = useState<ProcessingResult[]>([]);
  const [confirmAcknowledged, setConfirmAcknowledged] = useState(false);

  // Input states
  const [selectedTag, setSelectedTag] = useState<string>('');
  const [selectedStatus, setSelectedStatus] = useState<string>('');
  const [selectedOwner, setSelectedOwner] = useState<string>('');
  const [messageContent, setMessageContent] = useState<string>('');

  const config = actionConfigs[actionType];
  const IconComponent = config.icon;

  // Calculate processable items
  const processableItems = useMemo(
    () => selectedItems.filter((item) => item.canProcess !== false),
    [selectedItems]
  );
  const unprocessableItems = useMemo(
    () => selectedItems.filter((item) => item.canProcess === false),
    [selectedItems]
  );

  // Validation
  const isInputValid = useMemo(() => {
    if (!config.requiresInput) return true;
    switch (config.requiresInput) {
      case 'tag':
        return !!selectedTag;
      case 'status':
        return !!selectedStatus;
      case 'owner':
        return !!selectedOwner;
      case 'message':
        return messageContent.length >= 10;
      default:
        return true;
    }
  }, [config.requiresInput, selectedTag, selectedStatus, selectedOwner, messageContent]);

  const canExecute =
    processableItems.length > 0 &&
    isInputValid &&
    (!config.requiresConfirmation || confirmAcknowledged);

  // Reset state when dialog closes
  const handleOpenChange = (newOpen: boolean) => {
    if (!newOpen) {
      setPhase('config');
      setProgress(0);
      setResults([]);
      setConfirmAcknowledged(false);
      setSelectedTag('');
      setSelectedStatus('');
      setSelectedOwner('');
      setMessageContent('');
    }
    onOpenChange(newOpen);
  };

  // Execute bulk action
  const handleExecute = async () => {
    if (!canExecute) return;

    setPhase('processing');
    setIsProcessing(true);
    setProgress(0);

    try {
      // Build options based on action type
      const options: Record<string, any> = {};
      if (config.requiresInput === 'tag') options.tagId = selectedTag;
      if (config.requiresInput === 'status') options.status = selectedStatus;
      if (config.requiresInput === 'owner') options.ownerId = selectedOwner;
      if (config.requiresInput === 'message') options.message = messageContent;

      // Simulate progress updates
      const progressInterval = setInterval(() => {
        setProgress((prev) => Math.min(prev + 10, 90));
      }, 200);

      const executionResults = await onExecute(processableItems, options);

      clearInterval(progressInterval);
      setProgress(100);
      setResults(executionResults);
      setPhase('results');

      // Summary toast
      const successCount = executionResults.filter((r) => r.success).length;
      const failCount = executionResults.filter((r) => !r.success).length;

      if (failCount === 0) {
        toast.success(`${successCount} ${resourceType} procesate cu succes`);
      } else if (successCount === 0) {
        toast.error(`Toate cele ${failCount} ${resourceType} au eșuat`);
      } else {
        toast.warning(`${successCount} succes, ${failCount} eșuate`);
      }

      onComplete?.(executionResults);
    } catch (error) {
      toast.error('Eroare la procesare');
      console.error(error);
      setPhase('config');
    } finally {
      setIsProcessing(false);
    }
  };

  // Results summary
  const successCount = results.filter((r) => r.success).length;
  const failCount = results.filter((r) => !r.success).length;

  return (
    <Dialog open={open} onOpenChange={handleOpenChange}>
      <DialogContent className="max-w-xl">
        <DialogHeader>
          <div className="flex items-center gap-3">
            <div
              className={`p-2 rounded-full ${
                config.variant === 'destructive'
                  ? 'bg-destructive/10'
                  : 'bg-primary/10'
              }`}
            >
              <IconComponent
                className={`h-5 w-5 ${
                  config.variant === 'destructive'
                    ? 'text-destructive'
                    : 'text-primary'
                }`}
              />
            </div>
            <div>
              <DialogTitle>{config.label}</DialogTitle>
              <DialogDescription>{config.description}</DialogDescription>
            </div>
          </div>
        </DialogHeader>

        {/* Configuration Phase */}
        {phase === 'config' && (
          <div className="space-y-4 py-4">
            {/* Selection Summary */}
            <div className="flex items-center justify-between p-3 bg-muted rounded-lg">
              <div className="text-sm">
                <span className="font-medium">{selectedItems.length}</span> {resourceType} selectate
              </div>
              <div className="flex gap-2">
                <Badge variant="default" className="gap-1">
                  <CheckCircle2 className="h-3 w-3" />
                  {processableItems.length} procesabile
                </Badge>
                {unprocessableItems.length > 0 && (
                  <Badge variant="secondary" className="gap-1">
                    <XCircle className="h-3 w-3" />
                    {unprocessableItems.length} exclude
                  </Badge>
                )}
              </div>
            </div>

            {/* Unprocessable Items Warning */}
            {unprocessableItems.length > 0 && (
              <Alert>
                <AlertTriangle className="h-4 w-4" />
                <AlertDescription>
                  <div className="font-medium mb-1">
                    {unprocessableItems.length} {resourceType} nu pot fi procesate:
                  </div>
                  <ScrollArea className="max-h-24">
                    <ul className="text-xs space-y-1">
                      {unprocessableItems.slice(0, 5).map((item) => (
                        <li key={item.id} className="flex items-center gap-2">
                          <XCircle className="h-3 w-3 text-muted-foreground" />
                          <span>{item.name}</span>
                          {item.errorReason && (
                            <span className="text-muted-foreground">
                              - {item.errorReason}
                            </span>
                          )}
                        </li>
                      ))}
                      {unprocessableItems.length > 5 && (
                        <li className="text-muted-foreground">
                          ...și alte {unprocessableItems.length - 5}
                        </li>
                      )}
                    </ul>
                  </ScrollArea>
                </AlertDescription>
              </Alert>
            )}

            {/* Input Fields Based on Action Type */}
            {config.requiresInput === 'tag' && (
              <div className="space-y-2">
                <Label>Selectează Eticheta</Label>
                <Select value={selectedTag} onValueChange={setSelectedTag}>
                  <SelectTrigger>
                    <SelectValue placeholder="Alege o etichetă..." />
                  </SelectTrigger>
                  <SelectContent>
                    {availableTags.map((tag) => (
                      <SelectItem key={tag.id} value={tag.id}>
                        <div className="flex items-center gap-2">
                          <div
                            className="h-3 w-3 rounded-full"
                            style={{ backgroundColor: tag.color }}
                          />
                          {tag.name}
                        </div>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            )}

            {config.requiresInput === 'status' && (
              <div className="space-y-2">
                <Label>Selectează Statusul Nou</Label>
                <Select value={selectedStatus} onValueChange={setSelectedStatus}>
                  <SelectTrigger>
                    <SelectValue placeholder="Alege un status..." />
                  </SelectTrigger>
                  <SelectContent>
                    {availableStatuses.map((status) => (
                      <SelectItem key={status.value} value={status.value}>
                        {status.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            )}

            {config.requiresInput === 'owner' && (
              <div className="space-y-2">
                <Label>Selectează Noul Proprietar</Label>
                <Select value={selectedOwner} onValueChange={setSelectedOwner}>
                  <SelectTrigger>
                    <SelectValue placeholder="Alege un utilizator..." />
                  </SelectTrigger>
                  <SelectContent>
                    {availableOwners.map((owner) => (
                      <SelectItem key={owner.id} value={owner.id}>
                        <div className="flex flex-col">
                          <span>{owner.name}</span>
                          <span className="text-xs text-muted-foreground">
                            {owner.email}
                          </span>
                        </div>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            )}

            {config.requiresInput === 'message' && (
              <div className="space-y-2">
                <Label>Conținut Mesaj</Label>
                <Textarea
                  value={messageContent}
                  onChange={(e) => setMessageContent(e.target.value)}
                  placeholder="Scrie mesajul pentru campanie..."
                  className="min-h-[100px]"
                />
                <div className="text-xs text-muted-foreground">
                  {messageContent.length}/500 caractere (minim 10)
                </div>
              </div>
            )}

            {/* Confirmation Checkbox for Destructive Actions */}
            {config.requiresConfirmation && (
              <>
                <Separator />
                <div className="flex items-start gap-2 p-3 bg-destructive/5 rounded-md">
                  <Checkbox
                    id="confirm-bulk"
                    checked={confirmAcknowledged}
                    onCheckedChange={(checked) =>
                      setConfirmAcknowledged(checked === true)
                    }
                  />
                  <Label
                    htmlFor="confirm-bulk"
                    className="text-sm cursor-pointer leading-relaxed"
                  >
                    {config.variant === 'destructive'
                      ? `Confirm că doresc să șterg permanent ${processableItems.length} ${resourceType}. Această acțiune nu poate fi anulată.`
                      : `Confirm că doresc să execut această acțiune pentru ${processableItems.length} ${resourceType}.`}
                  </Label>
                </div>
              </>
            )}
          </div>
        )}

        {/* Processing Phase */}
        {phase === 'processing' && (
          <div className="space-y-4 py-8">
            <div className="text-center">
              <Loader2 className="h-12 w-12 animate-spin text-primary mx-auto mb-4" />
              <p className="text-lg font-medium">Se procesează...</p>
              <p className="text-sm text-muted-foreground">
                {Math.round(progress)}% completat
              </p>
            </div>
            <Progress value={progress} className="w-full" />
            <p className="text-center text-sm text-muted-foreground">
              Procesare {processableItems.length} {resourceType}
            </p>
          </div>
        )}

        {/* Results Phase */}
        {phase === 'results' && (
          <div className="space-y-4 py-4">
            {/* Results Summary */}
            <div className="grid grid-cols-2 gap-4">
              <div className="p-4 bg-green-50 dark:bg-green-950 rounded-lg text-center">
                <CheckCircle2 className="h-8 w-8 text-green-600 mx-auto mb-2" />
                <p className="text-2xl font-bold text-green-600">{successCount}</p>
                <p className="text-sm text-muted-foreground">Procesate cu succes</p>
              </div>
              <div className="p-4 bg-red-50 dark:bg-red-950 rounded-lg text-center">
                <XCircle className="h-8 w-8 text-red-600 mx-auto mb-2" />
                <p className="text-2xl font-bold text-red-600">{failCount}</p>
                <p className="text-sm text-muted-foreground">Erori</p>
              </div>
            </div>

            {/* Detailed Results */}
            {failCount > 0 && (
              <div className="space-y-2">
                <Label className="text-destructive">Erori:</Label>
                <ScrollArea className="max-h-40">
                  <div className="space-y-2 pr-4">
                    {results
                      .filter((r) => !r.success)
                      .map((result) => (
                        <div
                          key={result.id}
                          className="flex items-start gap-2 p-2 bg-destructive/5 rounded text-sm"
                        >
                          <XCircle className="h-4 w-4 text-destructive mt-0.5" />
                          <div>
                            <span className="font-medium">{result.name}</span>
                            {result.error && (
                              <p className="text-xs text-muted-foreground">
                                {result.error}
                              </p>
                            )}
                          </div>
                        </div>
                      ))}
                  </div>
                </ScrollArea>
              </div>
            )}
          </div>
        )}

        <DialogFooter>
          {phase === 'config' && (
            <>
              <Button variant="outline" onClick={() => handleOpenChange(false)}>
                Anulează
              </Button>
              <Button
                onClick={handleExecute}
                disabled={!canExecute}
                variant={config.variant === 'destructive' ? 'destructive' : 'default'}
              >
                <IconComponent className="h-4 w-4 mr-2" />
                {config.label} ({processableItems.length})
              </Button>
            </>
          )}

          {phase === 'results' && (
            <Button onClick={() => handleOpenChange(false)}>Închide</Button>
          )}
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**Utilizare:**

```typescript
<BulkActionDialog
  open={bulkDialog.open}
  onOpenChange={(open) => setBulkDialog({ ...bulkDialog, open })}
  actionType="assign_tag"
  selectedItems={selectedContacts.map(c => ({
    id: c.id,
    name: c.name,
    canProcess: c.status !== 'archived',
    errorReason: c.status === 'archived' ? 'Contact arhivat' : undefined
  }))}
  resourceType="contacte"
  availableTags={tags}
  onExecute={async (items, options) => {
    return await assignTagToContacts(items.map(i => i.id), options.tagId);
  }}
  onComplete={(results) => {
    refetchContacts();
    clearSelection();
  }}
/>
```

### 12.3 DataExportDialog

Dialog pentru export date cu opțiuni de format și filtrare.

```typescript
// src/components/dialogs/DataExportDialog.tsx

'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { toast } from 'sonner';
import { format } from 'date-fns';
import { ro } from 'date-fns/locale';
import {
  Download,
  FileSpreadsheet,
  FileText,
  FileJson,
  File,
  Loader2,
  Calendar,
  Filter,
  CheckCircle2,
  HardDrive,
} from 'lucide-react';

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
} from '@/components/ui/form';
import { Button } from '@/components/ui/button';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Checkbox } from '@/components/ui/checkbox';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Calendar as CalendarComponent } from '@/components/ui/calendar';
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from '@/components/ui/accordion';

// Schema
const exportSchema = z.object({
  format: z.enum(['xlsx', 'csv', 'json', 'pdf']),
  encoding: z.enum(['utf-8', 'windows-1252', 'iso-8859-1']).default('utf-8'),
  delimiter: z.enum([',', ';', '\t']).default(','),
  
  // Date Range
  dateRange: z.object({
    enabled: z.boolean().default(false),
    from: z.date().optional(),
    to: z.date().optional(),
  }),

  // Field Selection
  fields: z.array(z.string()).min(1, 'Selectează cel puțin un câmp'),
  
  // Filters
  filters: z.object({
    status: z.array(z.string()).optional(),
    tags: z.array(z.string()).optional(),
    tier: z.array(z.string()).optional(),
  }),

  // Options
  options: z.object({
    includeHeaders: z.boolean().default(true),
    includeMetadata: z.boolean().default(false),
    flattenNested: z.boolean().default(true),
    maskSensitive: z.boolean().default(false),
  }),
});

type ExportFormData = z.infer<typeof exportSchema>;

// Export format configurations
const formatConfigs = [
  {
    value: 'xlsx',
    label: 'Excel (.xlsx)',
    description: 'Format Microsoft Excel cu formatare',
    icon: FileSpreadsheet,
    color: 'text-green-600',
  },
  {
    value: 'csv',
    label: 'CSV (.csv)',
    description: 'Text delimitat, compatibil universal',
    icon: FileText,
    color: 'text-blue-600',
  },
  {
    value: 'json',
    label: 'JSON (.json)',
    description: 'Format structurat pentru integrări',
    icon: FileJson,
    color: 'text-yellow-600',
  },
  {
    value: 'pdf',
    label: 'PDF (.pdf)',
    description: 'Document formatat pentru print',
    icon: File,
    color: 'text-red-600',
  },
];

// Available fields by resource type
const fieldsByResource: Record<string, { key: string; label: string; category: string }[]> = {
  contacts: [
    { key: 'name', label: 'Nume', category: 'Informații de bază' },
    { key: 'cui', label: 'CUI', category: 'Informații de bază' },
    { key: 'email', label: 'Email', category: 'Contact' },
    { key: 'phone', label: 'Telefon', category: 'Contact' },
    { key: 'address', label: 'Adresă', category: 'Contact' },
    { key: 'city', label: 'Oraș', category: 'Contact' },
    { key: 'county', label: 'Județ', category: 'Contact' },
    { key: 'tier', label: 'Tier', category: 'Clasificare' },
    { key: 'score', label: 'Scor', category: 'Clasificare' },
    { key: 'status', label: 'Status', category: 'Clasificare' },
    { key: 'tags', label: 'Etichete', category: 'Clasificare' },
    { key: 'createdAt', label: 'Data creare', category: 'Metadate' },
    { key: 'updatedAt', label: 'Ultima actualizare', category: 'Metadate' },
    { key: 'lastContactedAt', label: 'Ultimul contact', category: 'Activitate' },
    { key: 'negotiationsCount', label: 'Nr. negocieri', category: 'Activitate' },
    { key: 'totalRevenue', label: 'Venituri totale', category: 'Financiar' },
  ],
  negotiations: [
    { key: 'id', label: 'ID', category: 'Identificare' },
    { key: 'contactName', label: 'Contact', category: 'Identificare' },
    { key: 'stage', label: 'Etapă', category: 'Status' },
    { key: 'status', label: 'Status', category: 'Status' },
    { key: 'totalValue', label: 'Valoare totală', category: 'Financiar' },
    { key: 'currency', label: 'Monedă', category: 'Financiar' },
    { key: 'discountPercent', label: 'Discount %', category: 'Financiar' },
    { key: 'productsCount', label: 'Nr. produse', category: 'Detalii' },
    { key: 'createdAt', label: 'Data creare', category: 'Metadate' },
    { key: 'completedAt', label: 'Data finalizare', category: 'Metadate' },
    { key: 'assignedTo', label: 'Responsabil', category: 'Asignare' },
  ],
  products: [
    { key: 'sku', label: 'SKU', category: 'Identificare' },
    { key: 'name', label: 'Nume', category: 'Identificare' },
    { key: 'category', label: 'Categorie', category: 'Clasificare' },
    { key: 'price', label: 'Preț', category: 'Financiar' },
    { key: 'unit', label: 'Unitate', category: 'Detalii' },
    { key: 'stock', label: 'Stoc', category: 'Inventar' },
    { key: 'status', label: 'Status', category: 'Clasificare' },
  ],
};

interface DataExportDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  resourceType: 'contacts' | 'negotiations' | 'products';
  totalCount: number;
  selectedCount?: number;
  availableTags?: { id: string; name: string }[];
  availableStatuses?: { value: string; label: string }[];
  onExport: (config: ExportFormData) => Promise<{ downloadUrl: string; filename: string }>;
}

export function DataExportDialog({
  open,
  onOpenChange,
  resourceType,
  totalCount,
  selectedCount,
  availableTags = [],
  availableStatuses = [],
  onExport,
}: DataExportDialogProps) {
  const [phase, setPhase] = useState<'config' | 'exporting' | 'complete'>('config');
  const [progress, setProgress] = useState(0);
  const [downloadUrl, setDownloadUrl] = useState<string>('');
  const [filename, setFilename] = useState<string>('');
  const [estimatedSize, setEstimatedSize] = useState<string>('');

  const availableFields = fieldsByResource[resourceType] || [];
  const fieldCategories = [...new Set(availableFields.map((f) => f.category))];

  const form = useForm<ExportFormData>({
    resolver: zodResolver(exportSchema),
    defaultValues: {
      format: 'xlsx',
      encoding: 'utf-8',
      delimiter: ',',
      dateRange: {
        enabled: false,
      },
      fields: availableFields.slice(0, 5).map((f) => f.key), // Default first 5 fields
      filters: {},
      options: {
        includeHeaders: true,
        includeMetadata: false,
        flattenNested: true,
        maskSensitive: false,
      },
    },
  });

  const selectedFormat = form.watch('format');
  const selectedFields = form.watch('fields');
  const dateRangeEnabled = form.watch('dateRange.enabled');

  // Calculate estimated size
  const calculateSize = () => {
    const count = selectedCount || totalCount;
    const fieldsCount = selectedFields.length;
    const bytesPerField = selectedFormat === 'json' ? 50 : 20;
    const totalBytes = count * fieldsCount * bytesPerField;

    if (totalBytes < 1024) return `~${totalBytes} B`;
    if (totalBytes < 1024 * 1024) return `~${(totalBytes / 1024).toFixed(1)} KB`;
    return `~${(totalBytes / (1024 * 1024)).toFixed(1)} MB`;
  };

  // Toggle all fields in a category
  const toggleCategory = (category: string, enabled: boolean) => {
    const categoryFields = availableFields
      .filter((f) => f.category === category)
      .map((f) => f.key);

    const currentFields = form.getValues('fields');

    if (enabled) {
      const newFields = [...new Set([...currentFields, ...categoryFields])];
      form.setValue('fields', newFields, { shouldDirty: true });
    } else {
      const newFields = currentFields.filter((f) => !categoryFields.includes(f));
      form.setValue('fields', newFields, { shouldDirty: true });
    }
  };

  // Handle export
  const onSubmit = async (data: ExportFormData) => {
    setPhase('exporting');
    setProgress(0);

    try {
      // Simulate progress
      const progressInterval = setInterval(() => {
        setProgress((prev) => Math.min(prev + 15, 90));
      }, 300);

      const result = await onExport(data);

      clearInterval(progressInterval);
      setProgress(100);
      setDownloadUrl(result.downloadUrl);
      setFilename(result.filename);
      setPhase('complete');

      toast.success('Export finalizat cu succes');
    } catch (error) {
      toast.error('Eroare la export');
      console.error(error);
      setPhase('config');
    }
  };

  // Reset on close
  const handleOpenChange = (newOpen: boolean) => {
    if (!newOpen) {
      setPhase('config');
      setProgress(0);
      setDownloadUrl('');
      setFilename('');
    }
    onOpenChange(newOpen);
  };

  // Auto-download on complete
  const handleDownload = () => {
    if (downloadUrl) {
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  };

  return (
    <Dialog open={open} onOpenChange={handleOpenChange}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-hidden">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Download className="h-5 w-5" />
            Export Date
          </DialogTitle>
          <DialogDescription>
            Exportă {selectedCount ? `${selectedCount} din ${totalCount}` : totalCount}{' '}
            {resourceType}
          </DialogDescription>
        </DialogHeader>

        {/* Configuration Phase */}
        {phase === 'config' && (
          <Form {...form}>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
              <ScrollArea className="h-[500px] pr-4">
                <div className="space-y-6">
                  {/* Format Selection */}
                  <FormField
                    control={form.control}
                    name="format"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Format Export</FormLabel>
                        <FormControl>
                          <RadioGroup
                            value={field.value}
                            onValueChange={field.onChange}
                            className="grid grid-cols-2 gap-3"
                          >
                            {formatConfigs.map((format) => (
                              <Label
                                key={format.value}
                                htmlFor={format.value}
                                className={`flex items-start gap-3 p-3 border rounded-lg cursor-pointer transition-colors ${
                                  field.value === format.value
                                    ? 'border-primary bg-primary/5'
                                    : 'hover:bg-muted'
                                }`}
                              >
                                <RadioGroupItem
                                  value={format.value}
                                  id={format.value}
                                  className="mt-1"
                                />
                                <div className="flex-1">
                                  <div className="flex items-center gap-2">
                                    <format.icon className={`h-4 w-4 ${format.color}`} />
                                    <span className="font-medium">{format.label}</span>
                                  </div>
                                  <p className="text-xs text-muted-foreground mt-1">
                                    {format.description}
                                  </p>
                                </div>
                              </Label>
                            ))}
                          </RadioGroup>
                        </FormControl>
                      </FormItem>
                    )}
                  />

                  {/* CSV Options */}
                  {selectedFormat === 'csv' && (
                    <div className="grid grid-cols-2 gap-4 p-3 bg-muted rounded-lg">
                      <FormField
                        control={form.control}
                        name="encoding"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Encoding</FormLabel>
                            <Select value={field.value} onValueChange={field.onChange}>
                              <FormControl>
                                <SelectTrigger>
                                  <SelectValue />
                                </SelectTrigger>
                              </FormControl>
                              <SelectContent>
                                <SelectItem value="utf-8">UTF-8 (recomandat)</SelectItem>
                                <SelectItem value="windows-1252">Windows-1252</SelectItem>
                                <SelectItem value="iso-8859-1">ISO-8859-1</SelectItem>
                              </SelectContent>
                            </Select>
                          </FormItem>
                        )}
                      />

                      <FormField
                        control={form.control}
                        name="delimiter"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Delimitator</FormLabel>
                            <Select value={field.value} onValueChange={field.onChange}>
                              <FormControl>
                                <SelectTrigger>
                                  <SelectValue />
                                </SelectTrigger>
                              </FormControl>
                              <SelectContent>
                                <SelectItem value=",">Virgulă (,)</SelectItem>
                                <SelectItem value=";">Punct și virgulă (;)</SelectItem>
                                <SelectItem value="\t">Tab</SelectItem>
                              </SelectContent>
                            </Select>
                          </FormItem>
                        )}
                      />
                    </div>
                  )}

                  <Separator />

                  {/* Date Range */}
                  <div className="space-y-3">
                    <div className="flex items-center justify-between">
                      <FormLabel className="flex items-center gap-2">
                        <Calendar className="h-4 w-4" />
                        Interval de Date
                      </FormLabel>
                      <FormField
                        control={form.control}
                        name="dateRange.enabled"
                        render={({ field }) => (
                          <FormItem>
                            <FormControl>
                              <Checkbox
                                checked={field.value}
                                onCheckedChange={field.onChange}
                              />
                            </FormControl>
                          </FormItem>
                        )}
                      />
                    </div>

                    {dateRangeEnabled && (
                      <div className="grid grid-cols-2 gap-4">
                        <FormField
                          control={form.control}
                          name="dateRange.from"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>De la</FormLabel>
                              <Popover>
                                <PopoverTrigger asChild>
                                  <FormControl>
                                    <Button variant="outline" className="w-full justify-start">
                                      <Calendar className="h-4 w-4 mr-2" />
                                      {field.value
                                        ? format(field.value, 'dd MMM yyyy', { locale: ro })
                                        : 'Selectează...'}
                                    </Button>
                                  </FormControl>
                                </PopoverTrigger>
                                <PopoverContent className="w-auto p-0">
                                  <CalendarComponent
                                    mode="single"
                                    selected={field.value}
                                    onSelect={field.onChange}
                                    locale={ro}
                                  />
                                </PopoverContent>
                              </Popover>
                            </FormItem>
                          )}
                        />

                        <FormField
                          control={form.control}
                          name="dateRange.to"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Până la</FormLabel>
                              <Popover>
                                <PopoverTrigger asChild>
                                  <FormControl>
                                    <Button variant="outline" className="w-full justify-start">
                                      <Calendar className="h-4 w-4 mr-2" />
                                      {field.value
                                        ? format(field.value, 'dd MMM yyyy', { locale: ro })
                                        : 'Selectează...'}
                                    </Button>
                                  </FormControl>
                                </PopoverTrigger>
                                <PopoverContent className="w-auto p-0">
                                  <CalendarComponent
                                    mode="single"
                                    selected={field.value}
                                    onSelect={field.onChange}
                                    locale={ro}
                                  />
                                </PopoverContent>
                              </Popover>
                            </FormItem>
                          )}
                        />
                      </div>
                    )}
                  </div>

                  <Separator />

                  {/* Field Selection */}
                  <FormField
                    control={form.control}
                    name="fields"
                    render={({ field }) => (
                      <FormItem>
                        <div className="flex items-center justify-between mb-2">
                          <FormLabel className="flex items-center gap-2">
                            <Filter className="h-4 w-4" />
                            Câmpuri de Export
                          </FormLabel>
                          <Badge variant="secondary">
                            {field.value.length} selectate
                          </Badge>
                        </div>
                        <FormDescription>
                          Selectează câmpurile pe care dorești să le exporți
                        </FormDescription>
                        <FormControl>
                          <Accordion type="multiple" className="w-full">
                            {fieldCategories.map((category) => {
                              const categoryFields = availableFields.filter(
                                (f) => f.category === category
                              );
                              const selectedInCategory = categoryFields.filter((f) =>
                                field.value.includes(f.key)
                              ).length;

                              return (
                                <AccordionItem key={category} value={category}>
                                  <AccordionTrigger className="hover:no-underline">
                                    <div className="flex items-center justify-between w-full pr-4">
                                      <span>{category}</span>
                                      <Badge variant="outline" className="text-xs">
                                        {selectedInCategory}/{categoryFields.length}
                                      </Badge>
                                    </div>
                                  </AccordionTrigger>
                                  <AccordionContent>
                                    <div className="space-y-2 pt-2">
                                      <div className="flex gap-2 mb-2">
                                        <Button
                                          type="button"
                                          variant="ghost"
                                          size="sm"
                                          onClick={() => toggleCategory(category, true)}
                                        >
                                          Toate
                                        </Button>
                                        <Button
                                          type="button"
                                          variant="ghost"
                                          size="sm"
                                          onClick={() => toggleCategory(category, false)}
                                        >
                                          Niciunul
                                        </Button>
                                      </div>
                                      {categoryFields.map((f) => (
                                        <div
                                          key={f.key}
                                          className="flex items-center gap-2"
                                        >
                                          <Checkbox
                                            id={f.key}
                                            checked={field.value.includes(f.key)}
                                            onCheckedChange={(checked) => {
                                              if (checked) {
                                                field.onChange([...field.value, f.key]);
                                              } else {
                                                field.onChange(
                                                  field.value.filter((v) => v !== f.key)
                                                );
                                              }
                                            }}
                                          />
                                          <Label
                                            htmlFor={f.key}
                                            className="font-normal cursor-pointer"
                                          >
                                            {f.label}
                                          </Label>
                                        </div>
                                      ))}
                                    </div>
                                  </AccordionContent>
                                </AccordionItem>
                              );
                            })}
                          </Accordion>
                        </FormControl>
                      </FormItem>
                    )}
                  />

                  <Separator />

                  {/* Export Options */}
                  <div className="space-y-3">
                    <FormLabel>Opțiuni</FormLabel>
                    <div className="space-y-2">
                      <FormField
                        control={form.control}
                        name="options.includeHeaders"
                        render={({ field }) => (
                          <FormItem className="flex items-center gap-2">
                            <FormControl>
                              <Checkbox
                                checked={field.value}
                                onCheckedChange={field.onChange}
                              />
                            </FormControl>
                            <FormLabel className="font-normal cursor-pointer">
                              Include rândul cu anteturi
                            </FormLabel>
                          </FormItem>
                        )}
                      />

                      <FormField
                        control={form.control}
                        name="options.includeMetadata"
                        render={({ field }) => (
                          <FormItem className="flex items-center gap-2">
                            <FormControl>
                              <Checkbox
                                checked={field.value}
                                onCheckedChange={field.onChange}
                              />
                            </FormControl>
                            <FormLabel className="font-normal cursor-pointer">
                              Include metadate (timestamp, utilizator)
                            </FormLabel>
                          </FormItem>
                        )}
                      />

                      <FormField
                        control={form.control}
                        name="options.flattenNested"
                        render={({ field }) => (
                          <FormItem className="flex items-center gap-2">
                            <FormControl>
                              <Checkbox
                                checked={field.value}
                                onCheckedChange={field.onChange}
                              />
                            </FormControl>
                            <FormLabel className="font-normal cursor-pointer">
                              Aplatizează structurile imbricate
                            </FormLabel>
                          </FormItem>
                        )}
                      />

                      <FormField
                        control={form.control}
                        name="options.maskSensitive"
                        render={({ field }) => (
                          <FormItem className="flex items-center gap-2">
                            <FormControl>
                              <Checkbox
                                checked={field.value}
                                onCheckedChange={field.onChange}
                              />
                            </FormControl>
                            <FormLabel className="font-normal cursor-pointer">
                              Maschează date sensibile (email, telefon parțial)
                            </FormLabel>
                          </FormItem>
                        )}
                      />
                    </div>
                  </div>

                  {/* Size Estimate */}
                  <div className="flex items-center justify-between p-3 bg-muted rounded-lg">
                    <div className="flex items-center gap-2 text-sm">
                      <HardDrive className="h-4 w-4" />
                      <span>Dimensiune estimată:</span>
                    </div>
                    <Badge variant="secondary">{calculateSize()}</Badge>
                  </div>
                </div>
              </ScrollArea>

              <DialogFooter className="pt-4 border-t">
                <Button
                  type="button"
                  variant="outline"
                  onClick={() => handleOpenChange(false)}
                >
                  Anulează
                </Button>
                <Button type="submit" disabled={selectedFields.length === 0}>
                  <Download className="h-4 w-4 mr-2" />
                  Exportă
                </Button>
              </DialogFooter>
            </form>
          </Form>
        )}

        {/* Exporting Phase */}
        {phase === 'exporting' && (
          <div className="space-y-6 py-12">
            <div className="text-center">
              <Loader2 className="h-12 w-12 animate-spin text-primary mx-auto mb-4" />
              <p className="text-lg font-medium">Se generează exportul...</p>
              <p className="text-sm text-muted-foreground">
                Procesare {selectedCount || totalCount} înregistrări
              </p>
            </div>
            <Progress value={progress} className="w-full" />
            <p className="text-center text-sm text-muted-foreground">
              {Math.round(progress)}% completat
            </p>
          </div>
        )}

        {/* Complete Phase */}
        {phase === 'complete' && (
          <div className="space-y-6 py-8">
            <div className="text-center">
              <div className="w-16 h-16 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center mx-auto mb-4">
                <CheckCircle2 className="h-10 w-10 text-green-600" />
              </div>
              <p className="text-lg font-medium">Export Finalizat!</p>
              <p className="text-sm text-muted-foreground mt-1">{filename}</p>
            </div>

            <div className="flex justify-center gap-3">
              <Button onClick={handleDownload}>
                <Download className="h-4 w-4 mr-2" />
                Descarcă Fișier
              </Button>
              <Button variant="outline" onClick={() => handleOpenChange(false)}>
                Închide
              </Button>
            </div>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}
```

**Utilizare:**

```typescript
<DataExportDialog
  open={exportDialog}
  onOpenChange={setExportDialog}
  resourceType="contacts"
  totalCount={contacts.length}
  selectedCount={selectedIds.length > 0 ? selectedIds.length : undefined}
  availableTags={tags}
  availableStatuses={statusOptions}
  onExport={async (config) => {
    const response = await fetch('/api/v1/contacts/export', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        ...config,
        ids: selectedIds.length > 0 ? selectedIds : undefined,
      }),
    });
    return response.json();
  }}
/>
```

---

## 13. Multi-Step Forms (Wizards)

Formulare complexe cu mai mulți pași pentru fluxuri complete.

### 13.1 NegotiationWizard

Wizard complet pentru crearea unei negocieri noi cu selectare contact, produse, configurare și confirmare.

```typescript
// src/components/wizards/NegotiationWizard.tsx

'use client';

import { useState, useCallback, useMemo } from 'react';
import { useForm, useFieldArray } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { toast } from 'sonner';
import {
  ChevronLeft,
  ChevronRight,
  Check,
  User,
  Package,
  Settings,
  FileText,
  Loader2,
  Search,
  Plus,
  Minus,
  Trash2,
  Calculator,
  Info,
  AlertCircle,
} from 'lucide-react';

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Badge } from '@/components/ui/badge';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Checkbox } from '@/components/ui/checkbox';
import { Label } from '@/components/ui/label';
import { Progress } from '@/components/ui/progress';
import { Separator } from '@/components/ui/separator';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Alert, AlertDescription } from '@/components/ui/alert';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { Switch } from '@/components/ui/switch';
import { Slider } from '@/components/ui/slider';
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
  CommandList,
} from '@/components/ui/command';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';

// Types
interface Contact {
  id: string;
  name: string;
  cui: string;
  email?: string;
  phone?: string;
  tier: 'bronze' | 'silver' | 'gold';
  address?: string;
  city?: string;
  county?: string;
}

interface Product {
  id: string;
  sku: string;
  name: string;
  category: string;
  price: number;
  unit: string;
  stock: number;
  minOrderQty?: number;
  maxDiscount?: number;
}

interface SelectedProduct {
  productId: string;
  product: Product;
  quantity: number;
  unitPrice: number;
  discount: number;
  notes?: string;
}

// Wizard Schema
const negotiationWizardSchema = z.object({
  // Step 1: Contact
  contactId: z.string().min(1, 'Selectează un contact'),
  
  // Step 2: Products
  products: z.array(
    z.object({
      productId: z.string(),
      quantity: z.number().min(1, 'Cantitatea minimă este 1'),
      unitPrice: z.number().min(0),
      discount: z.number().min(0).max(100),
      notes: z.string().optional(),
    })
  ).min(1, 'Adaugă cel puțin un produs'),

  // Step 3: Settings
  settings: z.object({
    currency: z.enum(['RON', 'EUR', 'USD']).default('RON'),
    paymentTerms: z.number().min(0).max(180).default(30),
    validityDays: z.number().min(1).max(90).default(15),
    deliveryMethod: z.enum(['pickup', 'delivery', 'courier']).default('delivery'),
    deliveryAddress: z.string().optional(),
    notes: z.string().optional(),
    priority: z.enum(['low', 'medium', 'high']).default('medium'),
    assignedTo: z.string().optional(),
  }),

  // Step 4: AI Configuration
  aiConfig: z.object({
    enabled: z.boolean().default(true),
    autoRespond: z.boolean().default(false),
    maxAutoDiscount: z.number().min(0).max(30).default(10),
    escalateOnLowConfidence: z.boolean().default(true),
    confidenceThreshold: z.number().min(50).max(100).default(80),
  }),
});

type NegotiationWizardFormData = z.infer<typeof negotiationWizardSchema>;

// Wizard Steps
const steps = [
  { id: 1, title: 'Contact', icon: User, description: 'Selectează clientul' },
  { id: 2, title: 'Produse', icon: Package, description: 'Adaugă produsele' },
  { id: 3, title: 'Configurare', icon: Settings, description: 'Setări negociere' },
  { id: 4, title: 'Confirmare', icon: FileText, description: 'Verifică și finalizează' },
];

interface NegotiationWizardProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  contacts: Contact[];
  products: Product[];
  users?: { id: string; name: string }[];
  onComplete: (data: NegotiationWizardFormData) => Promise<{ id: string }>;
}

export function NegotiationWizard({
  open,
  onOpenChange,
  contacts,
  products,
  users = [],
  onComplete,
}: NegotiationWizardProps) {
  const [currentStep, setCurrentStep] = useState(1);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [contactSearch, setContactSearch] = useState('');
  const [productSearch, setProductSearch] = useState('');
  const [contactPopoverOpen, setContactPopoverOpen] = useState(false);

  const form = useForm<NegotiationWizardFormData>({
    resolver: zodResolver(negotiationWizardSchema),
    defaultValues: {
      contactId: '',
      products: [],
      settings: {
        currency: 'RON',
        paymentTerms: 30,
        validityDays: 15,
        deliveryMethod: 'delivery',
        priority: 'medium',
      },
      aiConfig: {
        enabled: true,
        autoRespond: false,
        maxAutoDiscount: 10,
        escalateOnLowConfidence: true,
        confidenceThreshold: 80,
      },
    },
  });

  const { fields: productFields, append: addProduct, remove: removeProduct, update: updateProduct } = 
    useFieldArray({
      control: form.control,
      name: 'products',
    });

  const selectedContactId = form.watch('contactId');
  const selectedProducts = form.watch('products');
  const settings = form.watch('settings');
  const aiConfig = form.watch('aiConfig');

  // Get selected contact details
  const selectedContact = useMemo(
    () => contacts.find((c) => c.id === selectedContactId),
    [contacts, selectedContactId]
  );

  // Filter contacts by search
  const filteredContacts = useMemo(
    () =>
      contacts.filter(
        (c) =>
          c.name.toLowerCase().includes(contactSearch.toLowerCase()) ||
          c.cui.includes(contactSearch)
      ),
    [contacts, contactSearch]
  );

  // Filter products by search
  const filteredProducts = useMemo(
    () =>
      products.filter(
        (p) =>
          p.name.toLowerCase().includes(productSearch.toLowerCase()) ||
          p.sku.toLowerCase().includes(productSearch.toLowerCase())
      ),
    [products, productSearch]
  );

  // Calculate totals
  const totals = useMemo(() => {
    let subtotal = 0;
    let totalDiscount = 0;

    selectedProducts.forEach((item) => {
      const product = products.find((p) => p.id === item.productId);
      if (product) {
        const lineTotal = item.quantity * item.unitPrice;
        const lineDiscount = lineTotal * (item.discount / 100);
        subtotal += lineTotal;
        totalDiscount += lineDiscount;
      }
    });

    const total = subtotal - totalDiscount;
    const avgDiscount = subtotal > 0 ? (totalDiscount / subtotal) * 100 : 0;

    return { subtotal, totalDiscount, total, avgDiscount };
  }, [selectedProducts, products]);

  // Step validation
  const canProceed = useCallback(
    (step: number): boolean => {
      switch (step) {
        case 1:
          return !!selectedContactId;
        case 2:
          return selectedProducts.length > 0;
        case 3:
          return true; // Settings have defaults
        case 4:
          return true; // Review step
        default:
          return false;
      }
    },
    [selectedContactId, selectedProducts]
  );

  // Navigation
  const goNext = () => {
    if (canProceed(currentStep) && currentStep < 4) {
      setCurrentStep(currentStep + 1);
    }
  };

  const goBack = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);
    }
  };

  // Add product to selection
  const handleAddProduct = (product: Product) => {
    const existing = selectedProducts.find((p) => p.productId === product.id);
    if (existing) {
      toast.info('Produsul este deja adăugat');
      return;
    }

    addProduct({
      productId: product.id,
      quantity: product.minOrderQty || 1,
      unitPrice: product.price,
      discount: 0,
    });
    setProductSearch('');
  };

  // Update product quantity
  const handleQuantityChange = (index: number, delta: number) => {
    const current = selectedProducts[index];
    const product = products.find((p) => p.id === current.productId);
    const minQty = product?.minOrderQty || 1;
    const newQty = Math.max(minQty, current.quantity + delta);

    updateProduct(index, { ...current, quantity: newQty });
  };

  // Submit handler
  const onSubmit = async (data: NegotiationWizardFormData) => {
    setIsSubmitting(true);
    try {
      const result = await onComplete(data);
      toast.success('Negociere creată cu succes', {
        description: `ID: ${result.id}`,
      });
      onOpenChange(false);
    } catch (error) {
      toast.error('Eroare la crearea negocierii');
      console.error(error);
    } finally {
      setIsSubmitting(false);
    }
  };

  // Reset on close
  const handleOpenChange = (newOpen: boolean) => {
    if (!newOpen) {
      setCurrentStep(1);
      form.reset();
      setContactSearch('');
      setProductSearch('');
    }
    onOpenChange(newOpen);
  };

  // Format currency
  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('ro-RO', {
      style: 'currency',
      currency: settings.currency,
    }).format(amount);
  };

  return (
    <Dialog open={open} onOpenChange={handleOpenChange}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-hidden">
        <DialogHeader>
          <DialogTitle>Negociere Nouă</DialogTitle>
          <DialogDescription>
            Creează o negociere nouă în {steps.length} pași simpli
          </DialogDescription>
        </DialogHeader>

        {/* Progress Steps */}
        <div className="relative">
          <div className="flex justify-between items-center">
            {steps.map((step, index) => (
              <div
                key={step.id}
                className={`flex flex-col items-center z-10 ${
                  step.id <= currentStep ? 'text-primary' : 'text-muted-foreground'
                }`}
              >
                <div
                  className={`w-10 h-10 rounded-full flex items-center justify-center ${
                    step.id < currentStep
                      ? 'bg-primary text-primary-foreground'
                      : step.id === currentStep
                      ? 'border-2 border-primary bg-background'
                      : 'border-2 border-muted bg-background'
                  }`}
                >
                  {step.id < currentStep ? (
                    <Check className="h-5 w-5" />
                  ) : (
                    <step.icon className="h-5 w-5" />
                  )}
                </div>
                <span className="text-xs mt-1 font-medium">{step.title}</span>
              </div>
            ))}
          </div>
          {/* Progress Line */}
          <div className="absolute top-5 left-0 right-0 h-0.5 bg-muted -z-0">
            <div
              className="h-full bg-primary transition-all duration-300"
              style={{ width: `${((currentStep - 1) / (steps.length - 1)) * 100}%` }}
            />
          </div>
        </div>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)}>
            <ScrollArea className="h-[500px] pr-4">
              {/* Step 1: Contact Selection */}
              {currentStep === 1 && (
                <div className="space-y-4 p-1">
                  <div>
                    <h3 className="text-lg font-semibold mb-2">Selectează Contactul</h3>
                    <p className="text-sm text-muted-foreground mb-4">
                      Alege clientul pentru care vrei să creezi negocierea
                    </p>
                  </div>

                  <FormField
                    control={form.control}
                    name="contactId"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Contact</FormLabel>
                        <Popover open={contactPopoverOpen} onOpenChange={setContactPopoverOpen}>
                          <PopoverTrigger asChild>
                            <FormControl>
                              <Button
                                variant="outline"
                                role="combobox"
                                className="w-full justify-between"
                              >
                                {selectedContact ? (
                                  <div className="flex items-center gap-2">
                                    <Avatar className="h-6 w-6">
                                      <AvatarFallback className="text-xs">
                                        {selectedContact.name.charAt(0)}
                                      </AvatarFallback>
                                    </Avatar>
                                    <span>{selectedContact.name}</span>
                                    <Badge variant="outline" className="ml-2">
                                      {selectedContact.tier}
                                    </Badge>
                                  </div>
                                ) : (
                                  <span className="text-muted-foreground">
                                    Caută și selectează un contact...
                                  </span>
                                )}
                                <Search className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                              </Button>
                            </FormControl>
                          </PopoverTrigger>
                          <PopoverContent className="w-[500px] p-0" align="start">
                            <Command>
                              <CommandInput
                                placeholder="Caută după nume sau CUI..."
                                value={contactSearch}
                                onValueChange={setContactSearch}
                              />
                              <CommandList>
                                <CommandEmpty>Niciun contact găsit</CommandEmpty>
                                <CommandGroup>
                                  <ScrollArea className="h-64">
                                    {filteredContacts.map((contact) => (
                                      <CommandItem
                                        key={contact.id}
                                        value={contact.id}
                                        onSelect={() => {
                                          field.onChange(contact.id);
                                          setContactPopoverOpen(false);
                                        }}
                                        className="cursor-pointer"
                                      >
                                        <div className="flex items-center gap-3 w-full">
                                          <Avatar className="h-8 w-8">
                                            <AvatarFallback>
                                              {contact.name.charAt(0)}
                                            </AvatarFallback>
                                          </Avatar>
                                          <div className="flex-1 min-w-0">
                                            <div className="flex items-center gap-2">
                                              <span className="font-medium truncate">
                                                {contact.name}
                                              </span>
                                              <Badge
                                                variant={
                                                  contact.tier === 'gold'
                                                    ? 'default'
                                                    : contact.tier === 'silver'
                                                    ? 'secondary'
                                                    : 'outline'
                                                }
                                                className="text-xs"
                                              >
                                                {contact.tier}
                                              </Badge>
                                            </div>
                                            <p className="text-xs text-muted-foreground">
                                              CUI: {contact.cui}
                                              {contact.email && ` • ${contact.email}`}
                                            </p>
                                          </div>
                                          {field.value === contact.id && (
                                            <Check className="h-4 w-4 text-primary" />
                                          )}
                                        </div>
                                      </CommandItem>
                                    ))}
                                  </ScrollArea>
                                </CommandGroup>
                              </CommandList>
                            </Command>
                          </PopoverContent>
                        </Popover>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  {/* Selected Contact Details */}
                  {selectedContact && (
                    <Card className="mt-4">
                      <CardHeader className="pb-2">
                        <CardTitle className="text-base">Detalii Contact</CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="grid grid-cols-2 gap-4 text-sm">
                          <div>
                            <span className="text-muted-foreground">Nume:</span>
                            <p className="font-medium">{selectedContact.name}</p>
                          </div>
                          <div>
                            <span className="text-muted-foreground">CUI:</span>
                            <p className="font-medium">{selectedContact.cui}</p>
                          </div>
                          <div>
                            <span className="text-muted-foreground">Email:</span>
                            <p className="font-medium">{selectedContact.email || '-'}</p>
                          </div>
                          <div>
                            <span className="text-muted-foreground">Telefon:</span>
                            <p className="font-medium">{selectedContact.phone || '-'}</p>
                          </div>
                          <div className="col-span-2">
                            <span className="text-muted-foreground">Adresă:</span>
                            <p className="font-medium">
                              {selectedContact.address
                                ? `${selectedContact.address}, ${selectedContact.city}, ${selectedContact.county}`
                                : '-'}
                            </p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}

              {/* Step 2: Product Selection */}
              {currentStep === 2 && (
                <div className="space-y-4 p-1">
                  <div>
                    <h3 className="text-lg font-semibold mb-2">Selectează Produsele</h3>
                    <p className="text-sm text-muted-foreground mb-4">
                      Adaugă produsele pentru negociere și configurează cantitățile
                    </p>
                  </div>

                  {/* Product Search */}
                  <div className="flex gap-2">
                    <div className="relative flex-1">
                      <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                      <Input
                        placeholder="Caută produse după nume sau SKU..."
                        value={productSearch}
                        onChange={(e) => setProductSearch(e.target.value)}
                        className="pl-10"
                      />
                    </div>
                  </div>

                  {/* Product List */}
                  {productSearch && (
                    <Card>
                      <CardContent className="p-2">
                        <ScrollArea className="h-48">
                          {filteredProducts.length === 0 ? (
                            <p className="text-center text-muted-foreground py-4">
                              Niciun produs găsit
                            </p>
                          ) : (
                            <div className="space-y-1">
                              {filteredProducts.slice(0, 10).map((product) => (
                                <div
                                  key={product.id}
                                  className="flex items-center justify-between p-2 hover:bg-muted rounded cursor-pointer"
                                  onClick={() => handleAddProduct(product)}
                                >
                                  <div>
                                    <p className="font-medium">{product.name}</p>
                                    <p className="text-xs text-muted-foreground">
                                      SKU: {product.sku} • {product.category}
                                    </p>
                                  </div>
                                  <div className="text-right">
                                    <p className="font-medium">
                                      {formatCurrency(product.price)}/{product.unit}
                                    </p>
                                    <p className="text-xs text-muted-foreground">
                                      Stoc: {product.stock}
                                    </p>
                                  </div>
                                  <Button size="sm" variant="ghost">
                                    <Plus className="h-4 w-4" />
                                  </Button>
                                </div>
                              ))}
                            </div>
                          )}
                        </ScrollArea>
                      </CardContent>
                    </Card>
                  )}

                  {/* Selected Products Table */}
                  {productFields.length > 0 ? (
                    <div className="space-y-4">
                      <Table>
                        <TableHeader>
                          <TableRow>
                            <TableHead className="w-[300px]">Produs</TableHead>
                            <TableHead>Cantitate</TableHead>
                            <TableHead>Preț/u.</TableHead>
                            <TableHead>Discount</TableHead>
                            <TableHead className="text-right">Total</TableHead>
                            <TableHead className="w-[50px]" />
                          </TableRow>
                        </TableHeader>
                        <TableBody>
                          {productFields.map((field, index) => {
                            const product = products.find(
                              (p) => p.id === selectedProducts[index]?.productId
                            );
                            if (!product) return null;

                            const item = selectedProducts[index];
                            const lineTotal = item.quantity * item.unitPrice;
                            const discountAmount = lineTotal * (item.discount / 100);
                            const finalTotal = lineTotal - discountAmount;

                            return (
                              <TableRow key={field.id}>
                                <TableCell>
                                  <div>
                                    <p className="font-medium">{product.name}</p>
                                    <p className="text-xs text-muted-foreground">
                                      SKU: {product.sku}
                                    </p>
                                  </div>
                                </TableCell>
                                <TableCell>
                                  <div className="flex items-center gap-1">
                                    <Button
                                      type="button"
                                      variant="outline"
                                      size="icon"
                                      className="h-8 w-8"
                                      onClick={() => handleQuantityChange(index, -1)}
                                      disabled={item.quantity <= (product.minOrderQty || 1)}
                                    >
                                      <Minus className="h-3 w-3" />
                                    </Button>
                                    <Input
                                      type="number"
                                      className="w-20 h-8 text-center"
                                      value={item.quantity}
                                      onChange={(e) =>
                                        updateProduct(index, {
                                          ...item,
                                          quantity: Math.max(1, parseInt(e.target.value) || 1),
                                        })
                                      }
                                    />
                                    <Button
                                      type="button"
                                      variant="outline"
                                      size="icon"
                                      className="h-8 w-8"
                                      onClick={() => handleQuantityChange(index, 1)}
                                    >
                                      <Plus className="h-3 w-3" />
                                    </Button>
                                    <span className="text-xs text-muted-foreground ml-1">
                                      {product.unit}
                                    </span>
                                  </div>
                                </TableCell>
                                <TableCell>
                                  <Input
                                    type="number"
                                    className="w-24 h-8"
                                    value={item.unitPrice}
                                    onChange={(e) =>
                                      updateProduct(index, {
                                        ...item,
                                        unitPrice: parseFloat(e.target.value) || 0,
                                      })
                                    }
                                  />
                                </TableCell>
                                <TableCell>
                                  <div className="flex items-center gap-1">
                                    <Input
                                      type="number"
                                      className="w-16 h-8"
                                      value={item.discount}
                                      min={0}
                                      max={product.maxDiscount || 30}
                                      onChange={(e) =>
                                        updateProduct(index, {
                                          ...item,
                                          discount: Math.min(
                                            product.maxDiscount || 30,
                                            parseFloat(e.target.value) || 0
                                          ),
                                        })
                                      }
                                    />
                                    <span className="text-sm">%</span>
                                  </div>
                                </TableCell>
                                <TableCell className="text-right font-medium">
                                  {formatCurrency(finalTotal)}
                                </TableCell>
                                <TableCell>
                                  <Button
                                    type="button"
                                    variant="ghost"
                                    size="icon"
                                    onClick={() => removeProduct(index)}
                                  >
                                    <Trash2 className="h-4 w-4 text-destructive" />
                                  </Button>
                                </TableCell>
                              </TableRow>
                            );
                          })}
                        </TableBody>
                      </Table>

                      {/* Totals */}
                      <Card className="bg-muted/50">
                        <CardContent className="py-4">
                          <div className="flex justify-end">
                            <div className="w-64 space-y-2">
                              <div className="flex justify-between text-sm">
                                <span>Subtotal:</span>
                                <span>{formatCurrency(totals.subtotal)}</span>
                              </div>
                              <div className="flex justify-between text-sm text-green-600">
                                <span>Discount ({totals.avgDiscount.toFixed(1)}%):</span>
                                <span>-{formatCurrency(totals.totalDiscount)}</span>
                              </div>
                              <Separator />
                              <div className="flex justify-between font-semibold text-lg">
                                <span>Total:</span>
                                <span>{formatCurrency(totals.total)}</span>
                              </div>
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    </div>
                  ) : (
                    <Alert>
                      <AlertCircle className="h-4 w-4" />
                      <AlertDescription>
                        Caută și adaugă produse pentru a continua
                      </AlertDescription>
                    </Alert>
                  )}
                </div>
              )}

              {/* Step 3: Settings - will continue in next part */}

              {/* Step 3: Settings */}
              {currentStep === 2 && (
                <div className="space-y-6">
                  <div className="grid grid-cols-2 gap-6">
                    {/* Left Column - General Settings */}
                    <div className="space-y-4">
                      <h4 className="font-medium flex items-center gap-2">
                        <Settings className="h-4 w-4" />
                        Setări Generale
                      </h4>

                      {/* Currency */}
                      <FormField
                        control={form.control}
                        name="settings.currency"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Moneda</FormLabel>
                            <Select 
                              onValueChange={field.onChange} 
                              defaultValue={field.value}
                            >
                              <FormControl>
                                <SelectTrigger>
                                  <SelectValue placeholder="Selectează moneda" />
                                </SelectTrigger>
                              </FormControl>
                              <SelectContent>
                                <SelectItem value="RON">
                                  <div className="flex items-center gap-2">
                                    <span className="font-mono">RON</span>
                                    <span className="text-muted-foreground">Lei românești</span>
                                  </div>
                                </SelectItem>
                                <SelectItem value="EUR">
                                  <div className="flex items-center gap-2">
                                    <span className="font-mono">EUR</span>
                                    <span className="text-muted-foreground">Euro</span>
                                  </div>
                                </SelectItem>
                                <SelectItem value="USD">
                                  <div className="flex items-center gap-2">
                                    <span className="font-mono">USD</span>
                                    <span className="text-muted-foreground">Dolar american</span>
                                  </div>
                                </SelectItem>
                              </SelectContent>
                            </Select>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      {/* Payment Terms */}
                      <FormField
                        control={form.control}
                        name="settings.paymentTermsDays"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Termen de plată (zile)</FormLabel>
                            <Select 
                              onValueChange={(v) => field.onChange(parseInt(v))} 
                              defaultValue={field.value?.toString()}
                            >
                              <FormControl>
                                <SelectTrigger>
                                  <SelectValue placeholder="Selectează termenul" />
                                </SelectTrigger>
                              </FormControl>
                              <SelectContent>
                                <SelectItem value="0">Plată imediată</SelectItem>
                                <SelectItem value="7">7 zile</SelectItem>
                                <SelectItem value="14">14 zile</SelectItem>
                                <SelectItem value="30">30 zile (standard)</SelectItem>
                                <SelectItem value="45">45 zile</SelectItem>
                                <SelectItem value="60">60 zile</SelectItem>
                                <SelectItem value="90">90 zile</SelectItem>
                              </SelectContent>
                            </Select>
                            <FormDescription>
                              Termenul de plată pentru factură
                            </FormDescription>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      {/* Delivery Terms */}
                      <FormField
                        control={form.control}
                        name="settings.deliveryTerms"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Condiții de livrare</FormLabel>
                            <Select 
                              onValueChange={field.onChange} 
                              defaultValue={field.value}
                            >
                              <FormControl>
                                <SelectTrigger>
                                  <SelectValue placeholder="Selectează condițiile" />
                                </SelectTrigger>
                              </FormControl>
                              <SelectContent>
                                <SelectItem value="EXW">
                                  <div className="flex flex-col">
                                    <span className="font-medium">EXW - Ex Works</span>
                                    <span className="text-xs text-muted-foreground">
                                      Franco fabrică
                                    </span>
                                  </div>
                                </SelectItem>
                                <SelectItem value="FCA">
                                  <div className="flex flex-col">
                                    <span className="font-medium">FCA - Free Carrier</span>
                                    <span className="text-xs text-muted-foreground">
                                      Franco transportator
                                    </span>
                                  </div>
                                </SelectItem>
                                <SelectItem value="CPT">
                                  <div className="flex flex-col">
                                    <span className="font-medium">CPT - Carriage Paid To</span>
                                    <span className="text-xs text-muted-foreground">
                                      Transport plătit până la
                                    </span>
                                  </div>
                                </SelectItem>
                                <SelectItem value="DAP">
                                  <div className="flex flex-col">
                                    <span className="font-medium">DAP - Delivered At Place</span>
                                    <span className="text-xs text-muted-foreground">
                                      Livrat la destinație
                                    </span>
                                  </div>
                                </SelectItem>
                                <SelectItem value="DDP">
                                  <div className="flex flex-col">
                                    <span className="font-medium">DDP - Delivered Duty Paid</span>
                                    <span className="text-xs text-muted-foreground">
                                      Livrat cu taxe plătite
                                    </span>
                                  </div>
                                </SelectItem>
                              </SelectContent>
                            </Select>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      {/* Delivery Address Override */}
                      <FormField
                        control={form.control}
                        name="settings.deliveryAddressOverride"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Adresă de livrare alternativă</FormLabel>
                            <FormControl>
                              <Textarea
                                placeholder="Lasă gol pentru adresa implicită a contactului"
                                className="resize-none"
                                rows={2}
                                {...field}
                              />
                            </FormControl>
                            <FormDescription>
                              Opțional - specifică doar dacă diferă de adresa contactului
                            </FormDescription>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      {/* Validity Days */}
                      <FormField
                        control={form.control}
                        name="settings.validityDays"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Valabilitate ofertă (zile)</FormLabel>
                            <FormControl>
                              <div className="flex items-center gap-4">
                                <Slider
                                  min={1}
                                  max={90}
                                  step={1}
                                  value={[field.value || 30]}
                                  onValueChange={([v]) => field.onChange(v)}
                                  className="flex-1"
                                />
                                <span className="w-12 text-center font-medium">
                                  {field.value || 30}
                                </span>
                              </div>
                            </FormControl>
                            <FormDescription>
                              Câte zile rămâne valabilă oferta
                            </FormDescription>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    </div>

                    {/* Right Column - Priority & Assignment */}
                    <div className="space-y-4">
                      <h4 className="font-medium flex items-center gap-2">
                        <User className="h-4 w-4" />
                        Prioritate & Alocare
                      </h4>

                      {/* Priority */}
                      <FormField
                        control={form.control}
                        name="settings.priority"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Prioritate</FormLabel>
                            <Select 
                              onValueChange={field.onChange} 
                              defaultValue={field.value}
                            >
                              <FormControl>
                                <SelectTrigger>
                                  <SelectValue placeholder="Selectează prioritatea" />
                                </SelectTrigger>
                              </FormControl>
                              <SelectContent>
                                <SelectItem value="low">
                                  <div className="flex items-center gap-2">
                                    <div className="h-2 w-2 rounded-full bg-gray-400" />
                                    <span>Scăzută</span>
                                  </div>
                                </SelectItem>
                                <SelectItem value="normal">
                                  <div className="flex items-center gap-2">
                                    <div className="h-2 w-2 rounded-full bg-blue-500" />
                                    <span>Normală</span>
                                  </div>
                                </SelectItem>
                                <SelectItem value="high">
                                  <div className="flex items-center gap-2">
                                    <div className="h-2 w-2 rounded-full bg-orange-500" />
                                    <span>Ridicată</span>
                                  </div>
                                </SelectItem>
                                <SelectItem value="urgent">
                                  <div className="flex items-center gap-2">
                                    <div className="h-2 w-2 rounded-full bg-red-500" />
                                    <span>Urgentă</span>
                                  </div>
                                </SelectItem>
                              </SelectContent>
                            </Select>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      {/* Assigned User */}
                      <FormField
                        control={form.control}
                        name="settings.assignedUserId"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Responsabil</FormLabel>
                            <Popover 
                              open={userPopoverOpen} 
                              onOpenChange={setUserPopoverOpen}
                            >
                              <PopoverTrigger asChild>
                                <FormControl>
                                  <Button
                                    variant="outline"
                                    role="combobox"
                                    className="w-full justify-between"
                                  >
                                    {field.value ? (
                                      <div className="flex items-center gap-2">
                                        <Avatar className="h-6 w-6">
                                          <AvatarImage 
                                            src={users.find(u => u.id === field.value)?.avatar} 
                                          />
                                          <AvatarFallback className="text-xs">
                                            {users.find(u => u.id === field.value)?.name
                                              .split(' ')
                                              .map(n => n[0])
                                              .join('')}
                                          </AvatarFallback>
                                        </Avatar>
                                        <span>
                                          {users.find(u => u.id === field.value)?.name}
                                        </span>
                                      </div>
                                    ) : (
                                      <span className="text-muted-foreground">
                                        Selectează responsabil
                                      </span>
                                    )}
                                    <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                                  </Button>
                                </FormControl>
                              </PopoverTrigger>
                              <PopoverContent className="w-[400px] p-0" align="start">
                                <Command>
                                  <CommandInput placeholder="Caută utilizator..." />
                                  <CommandList>
                                    <CommandEmpty>
                                      Niciun utilizator găsit
                                    </CommandEmpty>
                                    <CommandGroup>
                                      {users.map((user) => (
                                        <CommandItem
                                          key={user.id}
                                          value={user.name}
                                          onSelect={() => {
                                            field.onChange(user.id);
                                            setUserPopoverOpen(false);
                                          }}
                                        >
                                          <Avatar className="h-8 w-8 mr-2">
                                            <AvatarImage src={user.avatar} />
                                            <AvatarFallback>
                                              {user.name.split(' ').map(n => n[0]).join('')}
                                            </AvatarFallback>
                                          </Avatar>
                                          <div className="flex-1">
                                            <p className="font-medium">{user.name}</p>
                                            <p className="text-xs text-muted-foreground">
                                              {user.email} • {user.role}
                                            </p>
                                          </div>
                                          <Check
                                            className={cn(
                                              "h-4 w-4",
                                              field.value === user.id 
                                                ? "opacity-100" 
                                                : "opacity-0"
                                            )}
                                          />
                                        </CommandItem>
                                      ))}
                                    </CommandGroup>
                                  </CommandList>
                                </Command>
                              </PopoverContent>
                            </Popover>
                            <FormDescription>
                              Persoana responsabilă pentru această negociere
                            </FormDescription>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      {/* Tags */}
                      <FormField
                        control={form.control}
                        name="settings.tags"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Etichete</FormLabel>
                            <div className="flex flex-wrap gap-2">
                              {availableTags.map((tag) => {
                                const isSelected = field.value?.includes(tag.id);
                                return (
                                  <Badge
                                    key={tag.id}
                                    variant={isSelected ? "default" : "outline"}
                                    className="cursor-pointer"
                                    style={{
                                      backgroundColor: isSelected ? tag.color : undefined,
                                      borderColor: tag.color,
                                    }}
                                    onClick={() => {
                                      const current = field.value || [];
                                      if (isSelected) {
                                        field.onChange(current.filter(t => t !== tag.id));
                                      } else {
                                        field.onChange([...current, tag.id]);
                                      }
                                    }}
                                  >
                                    {tag.label}
                                  </Badge>
                                );
                              })}
                            </div>
                            <FormDescription>
                              Click pentru a selecta/deselecta etichete
                            </FormDescription>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      {/* Internal Notes */}
                      <FormField
                        control={form.control}
                        name="settings.internalNotes"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Note interne</FormLabel>
                            <FormControl>
                              <Textarea
                                placeholder="Note vizibile doar pentru echipa ta..."
                                className="resize-none"
                                rows={3}
                                {...field}
                              />
                            </FormControl>
                            <FormDescription>
                              Aceste note nu vor fi vizibile pentru client
                            </FormDescription>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    </div>
                  </div>

                  <Separator />

                  {/* AI Configuration */}
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <h4 className="font-medium flex items-center gap-2">
                        <Bot className="h-4 w-4" />
                        Configurare Agent AI
                      </h4>
                      <FormField
                        control={form.control}
                        name="aiConfig.enabled"
                        render={({ field }) => (
                          <FormItem className="flex items-center gap-2">
                            <FormLabel className="text-sm text-muted-foreground">
                              Agent AI activ
                            </FormLabel>
                            <FormControl>
                              <Switch
                                checked={field.value}
                                onCheckedChange={field.onChange}
                              />
                            </FormControl>
                          </FormItem>
                        )}
                      />
                    </div>

                    {form.watch('aiConfig.enabled') && (
                      <div className="grid grid-cols-2 gap-6 pt-2">
                        {/* Auto Approve Threshold */}
                        <FormField
                          control={form.control}
                          name="aiConfig.autoApproveThreshold"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Prag auto-aprobare</FormLabel>
                              <FormControl>
                                <div className="flex items-center gap-4">
                                  <Slider
                                    min={50}
                                    max={100}
                                    step={5}
                                    value={[field.value || 85]}
                                    onValueChange={([v]) => field.onChange(v)}
                                    className="flex-1"
                                  />
                                  <span className="w-12 text-center font-medium">
                                    {field.value || 85}%
                                  </span>
                                </div>
                              </FormControl>
                              <FormDescription>
                                Răspunsuri cu scor ≥ acest prag sunt trimise automat
                              </FormDescription>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        {/* Max Discount Authority */}
                        <FormField
                          control={form.control}
                          name="aiConfig.maxDiscountAuthority"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Autoritate maximă discount</FormLabel>
                              <FormControl>
                                <div className="flex items-center gap-4">
                                  <Slider
                                    min={0}
                                    max={50}
                                    step={5}
                                    value={[field.value || 15]}
                                    onValueChange={([v]) => field.onChange(v)}
                                    className="flex-1"
                                  />
                                  <span className="w-12 text-center font-medium">
                                    {field.value || 15}%
                                  </span>
                                </div>
                              </FormControl>
                              <FormDescription>
                                Discounturi peste acest prag necesită aprobare HITL
                              </FormDescription>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        {/* Guardrails Profile */}
                        <FormField
                          control={form.control}
                          name="aiConfig.guardrailsProfile"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Profil de siguranță</FormLabel>
                              <Select 
                                onValueChange={field.onChange} 
                                defaultValue={field.value}
                              >
                                <FormControl>
                                  <SelectTrigger>
                                    <SelectValue placeholder="Selectează profilul" />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  <SelectItem value="strict">
                                    <div className="flex items-center gap-2">
                                      <Shield className="h-4 w-4 text-red-500" />
                                      <div>
                                        <span className="font-medium">Strict</span>
                                        <p className="text-xs text-muted-foreground">
                                          Verificări maxime, toate răspunsurile revizuite
                                        </p>
                                      </div>
                                    </div>
                                  </SelectItem>
                                  <SelectItem value="balanced">
                                    <div className="flex items-center gap-2">
                                      <Shield className="h-4 w-4 text-yellow-500" />
                                      <div>
                                        <span className="font-medium">Echilibrat</span>
                                        <p className="text-xs text-muted-foreground">
                                          Verificări standard, balanță viteză/siguranță
                                        </p>
                                      </div>
                                    </div>
                                  </SelectItem>
                                  <SelectItem value="permissive">
                                    <div className="flex items-center gap-2">
                                      <Shield className="h-4 w-4 text-green-500" />
                                      <div>
                                        <span className="font-medium">Permisiv</span>
                                        <p className="text-xs text-muted-foreground">
                                          Verificări minime, viteză maximă
                                        </p>
                                      </div>
                                    </div>
                                  </SelectItem>
                                </SelectContent>
                              </Select>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        {/* Tone */}
                        <FormField
                          control={form.control}
                          name="aiConfig.tone"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Ton comunicare</FormLabel>
                              <Select 
                                onValueChange={field.onChange} 
                                defaultValue={field.value}
                              >
                                <FormControl>
                                  <SelectTrigger>
                                    <SelectValue placeholder="Selectează tonul" />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  <SelectItem value="formal">Formal</SelectItem>
                                  <SelectItem value="professional">Profesional</SelectItem>
                                  <SelectItem value="friendly">Prietenos</SelectItem>
                                  <SelectItem value="casual">Casual</SelectItem>
                                </SelectContent>
                              </Select>
                              <FormDescription>
                                Stilul de comunicare pentru răspunsuri AI
                              </FormDescription>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        {/* Allowed Actions */}
                        <FormField
                          control={form.control}
                          name="aiConfig.allowedActions"
                          render={({ field }) => (
                            <FormItem className="col-span-2">
                              <FormLabel>Acțiuni permise AI</FormLabel>
                              <div className="grid grid-cols-3 gap-4 pt-2">
                                {[
                                  { id: 'send_quote', label: 'Trimite ofertă', icon: FileText },
                                  { id: 'apply_discount', label: 'Aplică discount', icon: Percent },
                                  { id: 'schedule_followup', label: 'Programează follow-up', icon: Calendar },
                                  { id: 'answer_questions', label: 'Răspunde întrebări', icon: MessageSquare },
                                  { id: 'negotiate_terms', label: 'Negociază termeni', icon: Handshake },
                                  { id: 'generate_documents', label: 'Generează documente', icon: FileOutput },
                                ].map(({ id, label, icon: Icon }) => {
                                  const isChecked = field.value?.includes(id);
                                  return (
                                    <label
                                      key={id}
                                      className={cn(
                                        "flex items-center gap-3 p-3 border rounded-lg cursor-pointer",
                                        "hover:bg-muted/50 transition-colors",
                                        isChecked && "border-primary bg-primary/5"
                                      )}
                                    >
                                      <Checkbox
                                        checked={isChecked}
                                        onCheckedChange={(checked) => {
                                          const current = field.value || [];
                                          if (checked) {
                                            field.onChange([...current, id]);
                                          } else {
                                            field.onChange(current.filter(a => a !== id));
                                          }
                                        }}
                                      />
                                      <Icon className="h-4 w-4 text-muted-foreground" />
                                      <span className="text-sm">{label}</span>
                                    </label>
                                  );
                                })}
                              </div>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Step 4: Confirmation */}
              {currentStep === 3 && (
                <div className="space-y-6">
                  <Alert className="border-blue-200 bg-blue-50">
                    <AlertCircle className="h-4 w-4 text-blue-600" />
                    <AlertTitle className="text-blue-900">
                      Verifică detaliile negocierii
                    </AlertTitle>
                    <AlertDescription className="text-blue-800">
                      Revizuiește informațiile de mai jos înainte de a crea negocierea.
                    </AlertDescription>
                  </Alert>

                  <div className="grid grid-cols-2 gap-6">
                    {/* Contact Summary */}
                    <Card>
                      <CardHeader className="pb-2">
                        <CardTitle className="text-sm font-medium flex items-center gap-2">
                          <User className="h-4 w-4" />
                          Contact
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        {selectedContact && (
                          <div className="space-y-2">
                            <div className="flex items-center gap-3">
                              <Avatar className="h-10 w-10">
                                <AvatarImage src={selectedContact.avatar} />
                                <AvatarFallback>
                                  {selectedContact.name.split(' ').map(n => n[0]).join('')}
                                </AvatarFallback>
                              </Avatar>
                              <div>
                                <p className="font-medium">{selectedContact.name}</p>
                                <Badge variant="outline" className="text-xs">
                                  {selectedContact.tier.toUpperCase()}
                                </Badge>
                              </div>
                            </div>
                            <Separator className="my-2" />
                            <div className="text-sm space-y-1">
                              <div className="flex justify-between">
                                <span className="text-muted-foreground">CUI:</span>
                                <span className="font-mono">{selectedContact.cui}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-muted-foreground">Email:</span>
                                <span>{selectedContact.email}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-muted-foreground">Telefon:</span>
                                <span>{selectedContact.phone}</span>
                              </div>
                            </div>
                          </div>
                        )}
                      </CardContent>
                    </Card>

                    {/* Settings Summary */}
                    <Card>
                      <CardHeader className="pb-2">
                        <CardTitle className="text-sm font-medium flex items-center gap-2">
                          <Settings className="h-4 w-4" />
                          Setări
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="text-sm space-y-2">
                          <div className="flex justify-between">
                            <span className="text-muted-foreground">Moneda:</span>
                            <span className="font-medium">
                              {form.watch('settings.currency') || 'RON'}
                            </span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-muted-foreground">Termen plată:</span>
                            <span>
                              {form.watch('settings.paymentTermsDays') || 30} zile
                            </span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-muted-foreground">Livrare:</span>
                            <span>{form.watch('settings.deliveryTerms') || 'DAP'}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-muted-foreground">Valabilitate:</span>
                            <span>{form.watch('settings.validityDays') || 30} zile</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-muted-foreground">Prioritate:</span>
                            <Badge variant="outline">
                              {form.watch('settings.priority') || 'normal'}
                            </Badge>
                          </div>
                          <Separator className="my-2" />
                          <div className="flex justify-between items-center">
                            <span className="text-muted-foreground">Agent AI:</span>
                            {form.watch('aiConfig.enabled') ? (
                              <Badge variant="default" className="bg-green-600">
                                <Bot className="h-3 w-3 mr-1" />
                                Activ
                              </Badge>
                            ) : (
                              <Badge variant="secondary">
                                Inactiv
                              </Badge>
                            )}
                          </div>
                          {form.watch('aiConfig.enabled') && (
                            <div className="flex justify-between text-xs">
                              <span className="text-muted-foreground">Profil:</span>
                              <span>{form.watch('aiConfig.guardrailsProfile') || 'balanced'}</span>
                            </div>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  </div>

                  {/* Products Summary */}
                  <Card>
                    <CardHeader className="pb-2">
                      <CardTitle className="text-sm font-medium flex items-center gap-2">
                        <Package className="h-4 w-4" />
                        Produse ({selectedProducts.length})
                      </CardTitle>
                    </CardHeader>
                    <CardContent>
                      <Table>
                        <TableHeader>
                          <TableRow>
                            <TableHead>Produs</TableHead>
                            <TableHead className="text-right">Cantitate</TableHead>
                            <TableHead className="text-right">Preț unitar</TableHead>
                            <TableHead className="text-right">Discount</TableHead>
                            <TableHead className="text-right">Total</TableHead>
                          </TableRow>
                        </TableHeader>
                        <TableBody>
                          {selectedProducts.map((item, index) => {
                            const product = products.find(p => p.id === item.productId);
                            const lineTotal = item.quantity * item.unitPrice;
                            const discountAmount = lineTotal * (item.discount / 100);
                            const finalTotal = lineTotal - discountAmount;
                            
                            return (
                              <TableRow key={index}>
                                <TableCell>
                                  <div>
                                    <p className="font-medium">{product?.name}</p>
                                    <p className="text-xs text-muted-foreground">
                                      SKU: {product?.sku}
                                    </p>
                                  </div>
                                </TableCell>
                                <TableCell className="text-right">
                                  {item.quantity} {product?.unit}
                                </TableCell>
                                <TableCell className="text-right">
                                  {formatCurrency(item.unitPrice)}
                                </TableCell>
                                <TableCell className="text-right">
                                  {item.discount > 0 && (
                                    <span className="text-green-600">
                                      -{item.discount}%
                                    </span>
                                  )}
                                </TableCell>
                                <TableCell className="text-right font-medium">
                                  {formatCurrency(finalTotal)}
                                </TableCell>
                              </TableRow>
                            );
                          })}
                        </TableBody>
                        <TableFooter>
                          <TableRow>
                            <TableCell colSpan={4} className="text-right">
                              Subtotal:
                            </TableCell>
                            <TableCell className="text-right">
                              {formatCurrency(totals.subtotal)}
                            </TableCell>
                          </TableRow>
                          {totals.totalDiscount > 0 && (
                            <TableRow>
                              <TableCell colSpan={4} className="text-right text-green-600">
                                Discount total ({totals.avgDiscount.toFixed(1)}%):
                              </TableCell>
                              <TableCell className="text-right text-green-600">
                                -{formatCurrency(totals.totalDiscount)}
                              </TableCell>
                            </TableRow>
                          )}
                          <TableRow>
                            <TableCell colSpan={4} className="text-right font-semibold">
                              Total:
                            </TableCell>
                            <TableCell className="text-right font-semibold text-lg">
                              {formatCurrency(totals.total)}
                            </TableCell>
                          </TableRow>
                        </TableFooter>
                      </Table>
                    </CardContent>
                  </Card>

                  {/* Warnings if any */}
                  {(form.watch('settings.priority') === 'urgent' || 
                    totals.avgDiscount > 20) && (
                    <Alert variant="warning">
                      <AlertTriangle className="h-4 w-4" />
                      <AlertTitle>Atenție</AlertTitle>
                      <AlertDescription>
                        <ul className="list-disc list-inside space-y-1">
                          {form.watch('settings.priority') === 'urgent' && (
                            <li>Negocierea este marcată ca urgentă</li>
                          )}
                          {totals.avgDiscount > 20 && (
                            <li>
                              Discountul mediu ({totals.avgDiscount.toFixed(1)}%) 
                              este peste pragul standard și poate necesita aprobare
                            </li>
                          )}
                        </ul>
                      </AlertDescription>
                    </Alert>
                  )}

                  {/* Confirmation Checkbox */}
                  <div className="flex items-start gap-3 p-4 bg-muted/50 rounded-lg">
                    <Checkbox
                      id="confirm-creation"
                      checked={confirmChecked}
                      onCheckedChange={(checked) => setConfirmChecked(!!checked)}
                    />
                    <div className="space-y-1">
                      <label
                        htmlFor="confirm-creation"
                        className="text-sm font-medium cursor-pointer"
                      >
                        Confirm că am verificat toate detaliile
                      </label>
                      <p className="text-xs text-muted-foreground">
                        După creare, negocierea va fi trimisă automat către contact 
                        dacă AI Agent este activ
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </form>
          </Form>
        </ScrollArea>

        <DialogFooter className="flex items-center justify-between">
          <Button
            type="button"
            variant="outline"
            onClick={() => setCurrentStep(prev => prev - 1)}
            disabled={currentStep === 0 || isSubmitting}
          >
            <ChevronLeft className="h-4 w-4 mr-1" />
            Înapoi
          </Button>

          <div className="flex items-center gap-2">
            <Button
              type="button"
              variant="ghost"
              onClick={onClose}
              disabled={isSubmitting}
            >
              Anulează
            </Button>

            {currentStep < STEPS.length - 1 ? (
              <Button
                type="button"
                onClick={() => setCurrentStep(prev => prev + 1)}
                disabled={!canProceed()}
              >
                Continuă
                <ChevronRight className="h-4 w-4 ml-1" />
              </Button>
            ) : (
              <Button
                type="button"
                onClick={form.handleSubmit(handleSubmit)}
                disabled={!canProceed() || !confirmChecked || isSubmitting}
              >
                {isSubmitting ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Se creează...
                  </>
                ) : (
                  <>
                    <Check className="h-4 w-4 mr-1" />
                    Creează negocierea
                  </>
                )}
              </Button>
            )}
          </div>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

// Usage Example
function NegotiationWizardExample() {
  const [open, setOpen] = useState(false);
  
  return (
    <>
      <Button onClick={() => setOpen(true)}>
        <Plus className="h-4 w-4 mr-2" />
        Negociere nouă
      </Button>
      
      <NegotiationWizard
        open={open}
        onClose={() => setOpen(false)}
        contacts={sampleContacts}
        products={sampleProducts}
        users={sampleUsers}
        availableTags={sampleTags}
        onComplete={async (data) => {
          const response = await fetch('/api/v1/negotiations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          return response.json();
        }}
      />
    </>
  );
}
```

**Date de test pentru NegotiationWizard:**

```typescript
// Sample data pentru NegotiationWizard
const sampleContacts = [
  {
    id: 'contact-1',
    name: 'Agro Farm SRL',
    cui: 'RO12345678',
    email: 'contact@agrofarm.ro',
    phone: '+40721123456',
    address: 'Str. Câmpiei 15, Brăila',
    tier: 'gold',
  },
  {
    id: 'contact-2',
    name: 'Bio Seeds SA',
    cui: 'RO87654321',
    email: 'office@bioseeds.ro',
    phone: '+40722987654',
    address: 'Bd. Agriculturii 42, Constanța',
    tier: 'silver',
  },
];

const sampleProducts = [
  {
    id: 'prod-1',
    name: 'Semințe Grâu Premium',
    sku: 'GRU-PREM-001',
    category: 'Semințe',
    price: 2.5,
    unit: 'kg',
    stock: 50000,
    minOrderQty: 100,
    maxDiscount: 25,
  },
  {
    id: 'prod-2',
    name: 'Fertilizant NPK 15-15-15',
    sku: 'FERT-NPK-15',
    category: 'Fertilizanți',
    price: 3.2,
    unit: 'kg',
    stock: 30000,
    minOrderQty: 500,
    maxDiscount: 20,
  },
];

const sampleUsers = [
  {
    id: 'user-1',
    name: 'Maria Popescu',
    email: 'maria@cerniq.app',
    role: 'Sales Manager',
    avatar: '/avatars/maria.jpg',
  },
  {
    id: 'user-2',
    name: 'Ion Ionescu',
    email: 'ion@cerniq.app',
    role: 'Sales Representative',
  },
];

const sampleTags = [
  { id: 'tag-1', label: 'VIP', color: '#FFD700' },
  { id: 'tag-2', label: 'Agricol', color: '#228B22' },
  { id: 'tag-3', label: 'Urgent', color: '#FF4500' },
  { id: 'tag-4', label: 'Contract mare', color: '#4169E1' },
];
```

---

### 13.2 ProductImportWizard

Wizard pentru importul în masă de produse din fișiere CSV/Excel.

```typescript
// components/forms/wizards/ProductImportWizard.tsx
import { useState, useCallback, useMemo } from 'react';
import { useDropzone } from 'react-dropzone';
import * as XLSX from 'xlsx';
import Papa from 'papaparse';
import { useForm, useFieldArray } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Progress } from '@/components/ui/progress';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Separator } from '@/components/ui/separator';
import { Checkbox } from '@/components/ui/checkbox';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import {
  Tooltip,
  TooltipContent,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import {
  Upload,
  FileSpreadsheet,
  FileText,
  Check,
  X,
  AlertCircle,
  AlertTriangle,
  ChevronLeft,
  ChevronRight,
  Loader2,
  MapPin,
  Settings,
  Eye,
  Download,
  ArrowRight,
  ArrowLeft,
  RefreshCw,
  XCircle,
  CheckCircle,
  HelpCircle,
  Trash2,
  Edit2,
} from 'lucide-react';
import { cn } from '@/lib/utils';

// Wizard Steps
const IMPORT_STEPS = [
  { id: 0, name: 'Încărcare fișier', icon: Upload },
  { id: 1, name: 'Mapare coloane', icon: MapPin },
  { id: 2, name: 'Validare date', icon: Settings },
  { id: 3, name: 'Import', icon: Check },
];

// Target Fields for Mapping
const TARGET_FIELDS = [
  { key: 'sku', label: 'SKU / Cod produs', required: true, type: 'string' },
  { key: 'name', label: 'Denumire produs', required: true, type: 'string' },
  { key: 'description', label: 'Descriere', required: false, type: 'string' },
  { key: 'category', label: 'Categorie', required: true, type: 'string' },
  { key: 'subcategory', label: 'Subcategorie', required: false, type: 'string' },
  { key: 'brand', label: 'Brand / Producător', required: false, type: 'string' },
  { key: 'unit', label: 'Unitate de măsură', required: true, type: 'string' },
  { key: 'price', label: 'Preț de bază', required: true, type: 'number' },
  { key: 'currency', label: 'Moneda', required: false, type: 'string' },
  { key: 'vat_rate', label: 'Cotă TVA (%)', required: false, type: 'number' },
  { key: 'cost_price', label: 'Preț cost', required: false, type: 'number' },
  { key: 'min_order_qty', label: 'Cantitate minimă comandă', required: false, type: 'number' },
  { key: 'max_discount', label: 'Discount maxim (%)', required: false, type: 'number' },
  { key: 'stock_quantity', label: 'Stoc', required: false, type: 'number' },
  { key: 'weight', label: 'Greutate (kg)', required: false, type: 'number' },
  { key: 'barcode', label: 'Cod de bare', required: false, type: 'string' },
  { key: 'tags', label: 'Etichete', required: false, type: 'array' },
  { key: 'is_active', label: 'Activ', required: false, type: 'boolean' },
];

// Validation Schema for import settings
const importSettingsSchema = z.object({
  updateExisting: z.boolean(),
  skipInvalid: z.boolean(),
  defaultCategory: z.string().optional(),
  defaultUnit: z.string().optional(),
  defaultVatRate: z.number().optional(),
  defaultCurrency: z.string().optional(),
});

type ImportSettings = z.infer<typeof importSettingsSchema>;

// Types
interface FileData {
  name: string;
  type: 'csv' | 'xlsx';
  size: number;
  headers: string[];
  rows: Record<string, any>[];
  totalRows: number;
}

interface ColumnMapping {
  sourceColumn: string;
  targetField: string;
  transform?: 'none' | 'uppercase' | 'lowercase' | 'trim' | 'number' | 'boolean';
}

interface ValidationResult {
  row: number;
  data: Record<string, any>;
  errors: { field: string; message: string }[];
  warnings: { field: string; message: string }[];
  isValid: boolean;
}

interface ImportResult {
  created: number;
  updated: number;
  skipped: number;
  errors: { row: number; sku: string; error: string }[];
}

interface ProductImportWizardProps {
  open: boolean;
  onClose: () => void;
  existingCategories: string[];
  existingUnits: string[];
  onImport: (
    products: Record<string, any>[],
    settings: ImportSettings
  ) => Promise<ImportResult>;
}

export function ProductImportWizard({
  open,
  onClose,
  existingCategories,
  existingUnits,
  onImport,
}: ProductImportWizardProps) {
  // State
  const [currentStep, setCurrentStep] = useState(0);
  const [fileData, setFileData] = useState<FileData | null>(null);
  const [columnMappings, setColumnMappings] = useState<ColumnMapping[]>([]);
  const [validationResults, setValidationResults] = useState<ValidationResult[]>([]);
  const [importResult, setImportResult] = useState<ImportResult | null>(null);
  const [isProcessing, setIsProcessing] = useState(false);
  const [progress, setProgress] = useState(0);

  // Form for import settings
  const form = useForm<ImportSettings>({
    resolver: zodResolver(importSettingsSchema),
    defaultValues: {
      updateExisting: true,
      skipInvalid: true,
      defaultCategory: '',
      defaultUnit: 'buc',
      defaultVatRate: 19,
      defaultCurrency: 'RON',
    },
  });

  // Reset state when dialog closes
  const handleClose = useCallback(() => {
    setCurrentStep(0);
    setFileData(null);
    setColumnMappings([]);
    setValidationResults([]);
    setImportResult(null);
    setIsProcessing(false);
    setProgress(0);
    form.reset();
    onClose();
  }, [form, onClose]);

  // File drop handler
  const onDrop = useCallback(async (acceptedFiles: File[]) => {
    const file = acceptedFiles[0];
    if (!file) return;

    setIsProcessing(true);
    setProgress(10);

    try {
      const fileType = file.name.endsWith('.csv') ? 'csv' : 'xlsx';
      let headers: string[] = [];
      let rows: Record<string, any>[] = [];

      if (fileType === 'csv') {
        // Parse CSV
        const text = await file.text();
        const result = Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          transformHeader: (h) => h.trim(),
        });
        headers = result.meta.fields || [];
        rows = result.data as Record<string, any>[];
      } else {
        // Parse XLSX
        const buffer = await file.arrayBuffer();
        const workbook = XLSX.read(buffer, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        if (jsonData.length > 0) {
          headers = (jsonData[0] as any[]).map(h => String(h).trim());
          rows = jsonData.slice(1).map(row => {
            const obj: Record<string, any> = {};
            headers.forEach((header, index) => {
              obj[header] = (row as any[])[index];
            });
            return obj;
          });
        }
      }

      setProgress(50);

      // Auto-map columns
      const autoMappings = autoMapColumns(headers);

      setFileData({
        name: file.name,
        type: fileType,
        size: file.size,
        headers,
        rows: rows.slice(0, 1000), // Limit preview to 1000 rows
        totalRows: rows.length,
      });

      setColumnMappings(autoMappings);
      setProgress(100);

      // Move to next step
      setTimeout(() => {
        setCurrentStep(1);
        setIsProcessing(false);
      }, 500);
    } catch (error) {
      console.error('Error parsing file:', error);
      setIsProcessing(false);
    }
  }, []);

  // Auto-map columns based on similarity
  const autoMapColumns = (headers: string[]): ColumnMapping[] => {
    const mappings: ColumnMapping[] = [];
    
    headers.forEach(header => {
      const normalizedHeader = header.toLowerCase().trim();
      
      // Find matching target field
      const match = TARGET_FIELDS.find(field => {
        const normalizedField = field.label.toLowerCase();
        const normalizedKey = field.key.toLowerCase().replace(/_/g, ' ');
        
        return (
          normalizedHeader === normalizedKey ||
          normalizedHeader.includes(normalizedKey) ||
          normalizedHeader === normalizedField ||
          normalizedHeader.includes(normalizedField) ||
          // Common aliases
          (field.key === 'sku' && (
            normalizedHeader.includes('cod') ||
            normalizedHeader.includes('sku') ||
            normalizedHeader === 'cod produs'
          )) ||
          (field.key === 'name' && (
            normalizedHeader.includes('denumire') ||
            normalizedHeader.includes('nume') ||
            normalizedHeader === 'produs'
          )) ||
          (field.key === 'price' && (
            normalizedHeader.includes('pret') ||
            normalizedHeader.includes('preț')
          )) ||
          (field.key === 'category' && (
            normalizedHeader.includes('categorie')
          )) ||
          (field.key === 'stock_quantity' && (
            normalizedHeader.includes('stoc') ||
            normalizedHeader.includes('cantitate')
          ))
        );
      });

      mappings.push({
        sourceColumn: header,
        targetField: match?.key || '',
        transform: match?.type === 'number' ? 'number' : 'none',
      });
    });

    return mappings;
  };

  // Dropzone config
  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    onDrop,
    accept: {
      'text/csv': ['.csv'],
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'],
      'application/vnd.ms-excel': ['.xls'],
    },
    maxFiles: 1,
    disabled: isProcessing,
  });

  // Update column mapping
  const updateMapping = (sourceColumn: string, targetField: string) => {
    setColumnMappings(prev =>
      prev.map(m =>
        m.sourceColumn === sourceColumn
          ? { ...m, targetField }
          : m
      )
    );
  };

  // Validate data
  const validateData = useCallback(async () => {
    if (!fileData) return;

    setIsProcessing(true);
    setProgress(0);

    const results: ValidationResult[] = [];
    const settings = form.getValues();

    for (let i = 0; i < fileData.rows.length; i++) {
      const row = fileData.rows[i];
      const errors: { field: string; message: string }[] = [];
      const warnings: { field: string; message: string }[] = [];
      const mappedData: Record<string, any> = {};

      // Map data according to mappings
      columnMappings.forEach(mapping => {
        if (!mapping.targetField) return;
        
        let value = row[mapping.sourceColumn];
        
        // Apply transform
        if (value !== undefined && value !== null) {
          switch (mapping.transform) {
            case 'uppercase':
              value = String(value).toUpperCase();
              break;
            case 'lowercase':
              value = String(value).toLowerCase();
              break;
            case 'trim':
              value = String(value).trim();
              break;
            case 'number':
              value = parseFloat(value) || 0;
              break;
            case 'boolean':
              value = value === 'true' || value === '1' || value === 'da';
              break;
          }
        }

        mappedData[mapping.targetField] = value;
      });

      // Apply defaults
      if (!mappedData.category && settings.defaultCategory) {
        mappedData.category = settings.defaultCategory;
      }
      if (!mappedData.unit && settings.defaultUnit) {
        mappedData.unit = settings.defaultUnit;
      }
      if (!mappedData.vat_rate && settings.defaultVatRate) {
        mappedData.vat_rate = settings.defaultVatRate;
      }
      if (!mappedData.currency && settings.defaultCurrency) {
        mappedData.currency = settings.defaultCurrency;
      }

      // Validate required fields
      TARGET_FIELDS.forEach(field => {
        if (field.required && !mappedData[field.key]) {
          errors.push({
            field: field.key,
            message: `${field.label} este obligatoriu`,
          });
        }
      });

      // Validate data types
      if (mappedData.price !== undefined && isNaN(Number(mappedData.price))) {
        errors.push({ field: 'price', message: 'Prețul trebuie să fie un număr' });
      }
      if (mappedData.price !== undefined && Number(mappedData.price) < 0) {
        errors.push({ field: 'price', message: 'Prețul nu poate fi negativ' });
      }
      if (mappedData.max_discount !== undefined && (Number(mappedData.max_discount) < 0 || Number(mappedData.max_discount) > 100)) {
        errors.push({ field: 'max_discount', message: 'Discountul trebuie să fie între 0 și 100' });
      }
      if (mappedData.vat_rate !== undefined && ![0, 5, 9, 19].includes(Number(mappedData.vat_rate))) {
        warnings.push({ field: 'vat_rate', message: 'Cota TVA nestandard' });
      }

      // Check for duplicate SKU in file
      const duplicateInFile = fileData.rows.findIndex(
        (r, idx) => idx < i && r[columnMappings.find(m => m.targetField === 'sku')?.sourceColumn || ''] === mappedData.sku
      );
      if (duplicateInFile >= 0) {
        warnings.push({ field: 'sku', message: `SKU duplicat la rândul ${duplicateInFile + 2}` });
      }

      results.push({
        row: i + 2, // +2 for header and 1-based index
        data: mappedData,
        errors,
        warnings,
        isValid: errors.length === 0,
      });

      // Update progress
      if (i % 100 === 0) {
        setProgress(Math.round((i / fileData.rows.length) * 100));
        await new Promise(resolve => setTimeout(resolve, 0));
      }
    }

    setValidationResults(results);
    setProgress(100);
    setIsProcessing(false);
    setCurrentStep(2);
  }, [fileData, columnMappings, form]);

  // Perform import
  const performImport = useCallback(async () => {
    const validProducts = validationResults
      .filter(r => r.isValid)
      .map(r => r.data);

    if (validProducts.length === 0) {
      return;
    }

    setIsProcessing(true);
    setProgress(0);
    setCurrentStep(3);

    try {
      // Simulate progress during import
      const progressInterval = setInterval(() => {
        setProgress(prev => Math.min(prev + 5, 90));
      }, 200);

      const result = await onImport(validProducts, form.getValues());

      clearInterval(progressInterval);
      setProgress(100);
      setImportResult(result);
    } catch (error) {
      console.error('Import error:', error);
      setImportResult({
        created: 0,
        updated: 0,
        skipped: validProducts.length,
        errors: [{ row: 0, sku: '', error: 'Eroare la import' }],
      });
    } finally {
      setIsProcessing(false);
    }
  }, [validationResults, form, onImport]);

  // Calculate statistics
  const stats = useMemo(() => {
    const valid = validationResults.filter(r => r.isValid).length;
    const invalid = validationResults.filter(r => !r.isValid).length;
    const warnings = validationResults.filter(r => r.warnings.length > 0).length;
    
    return { valid, invalid, warnings, total: validationResults.length };
  }, [validationResults]);

  // Check if can proceed
  const canProceed = () => {
    switch (currentStep) {
      case 0:
        return fileData !== null;
      case 1:
        const requiredMapped = TARGET_FIELDS
          .filter(f => f.required)
          .every(f => columnMappings.some(m => m.targetField === f.key));
        return requiredMapped;
      case 2:
        return stats.valid > 0;
      default:
        return false;
    }
  };

  // Format file size
  const formatFileSize = (bytes: number) => {
    if (bytes < 1024) return `${bytes} B`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
  };

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="max-w-4xl max-h-[90vh]">
        <DialogHeader>
          <DialogTitle>Import produse</DialogTitle>
          <DialogDescription>
            Importă produse din fișiere CSV sau Excel
          </DialogDescription>
        </DialogHeader>

        {/* Stepper */}
        <div className="flex items-center justify-between px-4 py-2 bg-muted/30 rounded-lg">
          {IMPORT_STEPS.map((step, index) => {
            const Icon = step.icon;
            const isActive = currentStep === index;
            const isCompleted = currentStep > index;

            return (
              <div key={step.id} className="flex items-center">
                <div
                  className={cn(
                    "flex items-center gap-2 px-3 py-2 rounded-lg transition-colors",
                    isActive && "bg-primary text-primary-foreground",
                    isCompleted && "text-green-600",
                    !isActive && !isCompleted && "text-muted-foreground"
                  )}
                >
                  <div
                    className={cn(
                      "w-8 h-8 rounded-full flex items-center justify-center",
                      isActive && "bg-primary-foreground/20",
                      isCompleted && "bg-green-100",
                      !isActive && !isCompleted && "bg-muted"
                    )}
                  >
                    {isCompleted ? (
                      <Check className="h-4 w-4" />
                    ) : (
                      <Icon className="h-4 w-4" />
                    )}
                  </div>
                  <span className="text-sm font-medium hidden md:block">
                    {step.name}
                  </span>
                </div>
                {index < IMPORT_STEPS.length - 1 && (
                  <div
                    className={cn(
                      "w-12 h-0.5 mx-2",
                      isCompleted ? "bg-green-500" : "bg-border"
                    )}
                  />
                )}
              </div>
            );
          })}
        </div>

        <ScrollArea className="max-h-[500px] pr-4">
          <Form {...form}>
            <form className="space-y-6">

              {/* Step 0: File Upload */}
              {currentStep === 0 && (
                <div className="space-y-4">
                  <div
                    {...getRootProps()}
                    className={cn(
                      "border-2 border-dashed rounded-lg p-12 text-center cursor-pointer transition-colors",
                      isDragActive && "border-primary bg-primary/5",
                      !isDragActive && "border-muted-foreground/25 hover:border-primary/50"
                    )}
                  >
                    <input {...getInputProps()} />
                    
                    {isProcessing ? (
                      <div className="space-y-4">
                        <Loader2 className="h-12 w-12 mx-auto animate-spin text-primary" />
                        <div className="space-y-2">
                          <p className="text-sm">Se procesează fișierul...</p>
                          <Progress value={progress} className="w-64 mx-auto" />
                        </div>
                      </div>
                    ) : fileData ? (
                      <div className="space-y-4">
                        <div className="flex items-center justify-center gap-2">
                          {fileData.type === 'csv' ? (
                            <FileText className="h-12 w-12 text-green-600" />
                          ) : (
                            <FileSpreadsheet className="h-12 w-12 text-green-600" />
                          )}
                        </div>
                        <div>
                          <p className="font-medium">{fileData.name}</p>
                          <p className="text-sm text-muted-foreground">
                            {formatFileSize(fileData.size)} • {fileData.totalRows} rânduri • 
                            {fileData.headers.length} coloane
                          </p>
                        </div>
                        <Button
                          type="button"
                          variant="outline"
                          size="sm"
                          onClick={(e) => {
                            e.stopPropagation();
                            setFileData(null);
                            setColumnMappings([]);
                          }}
                        >
                          <RefreshCw className="h-4 w-4 mr-1" />
                          Schimbă fișierul
                        </Button>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        <Upload className="h-12 w-12 mx-auto text-muted-foreground" />
                        <div>
                          <p className="font-medium">
                            {isDragActive 
                              ? 'Eliberează pentru a încărca' 
                              : 'Trage fișierul aici sau click pentru a selecta'
                            }
                          </p>
                          <p className="text-sm text-muted-foreground">
                            Formate acceptate: CSV, XLSX, XLS
                          </p>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Download Template */}
                  <Alert>
                    <HelpCircle className="h-4 w-4" />
                    <AlertTitle>Template</AlertTitle>
                    <AlertDescription className="flex items-center justify-between">
                      <span>
                        Descarcă template-ul Excel cu coloanele recomandate
                      </span>
                      <Button variant="outline" size="sm" className="ml-2">
                        <Download className="h-4 w-4 mr-1" />
                        Descarcă template
                      </Button>
                    </AlertDescription>
                  </Alert>

                  {/* Preview if file loaded */}
                  {fileData && (
                    <Card>
                      <CardHeader className="pb-2">
                        <CardTitle className="text-sm flex items-center gap-2">
                          <Eye className="h-4 w-4" />
                          Previzualizare (primele 5 rânduri)
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                {fileData.headers.slice(0, 8).map((header, i) => (
                                  <TableHead key={i} className="whitespace-nowrap">
                                    {header}
                                  </TableHead>
                                ))}
                                {fileData.headers.length > 8 && (
                                  <TableHead>...</TableHead>
                                )}
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {fileData.rows.slice(0, 5).map((row, rowIndex) => (
                                <TableRow key={rowIndex}>
                                  {fileData.headers.slice(0, 8).map((header, i) => (
                                    <TableCell key={i} className="max-w-[150px] truncate">
                                      {row[header] || '-'}
                                    </TableCell>
                                  ))}
                                  {fileData.headers.length > 8 && (
                                    <TableCell>...</TableCell>
                                  )}
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}

              {/* Step 1: Column Mapping */}
              {currentStep === 1 && fileData && (
                <div className="space-y-4">
                  <Alert>
                    <MapPin className="h-4 w-4" />
                    <AlertTitle>Maparea coloanelor</AlertTitle>
                    <AlertDescription>
                      Asociază coloanele din fișier cu câmpurile din sistem. 
                      Câmpurile marcate cu * sunt obligatorii.
                    </AlertDescription>
                  </Alert>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {columnMappings.map((mapping, index) => {
                      const targetField = TARGET_FIELDS.find(
                        f => f.key === mapping.targetField
                      );
                      
                      return (
                        <Card key={mapping.sourceColumn} className="p-3">
                          <div className="flex items-center gap-3">
                            {/* Source Column */}
                            <div className="flex-1">
                              <p className="text-sm font-medium truncate" title={mapping.sourceColumn}>
                                {mapping.sourceColumn}
                              </p>
                              <p className="text-xs text-muted-foreground">
                                Ex: {fileData.rows[0]?.[mapping.sourceColumn] || '-'}
                              </p>
                            </div>

                            <ArrowRight className="h-4 w-4 text-muted-foreground flex-shrink-0" />

                            {/* Target Field Selector */}
                            <div className="flex-1">
                              <Select
                                value={mapping.targetField}
                                onValueChange={(value) => updateMapping(mapping.sourceColumn, value)}
                              >
                                <SelectTrigger className={cn(
                                  "h-9",
                                  mapping.targetField && "border-green-500"
                                )}>
                                  <SelectValue placeholder="Selectează câmp" />
                                </SelectTrigger>
                                <SelectContent>
                                  <SelectItem value="">
                                    <span className="text-muted-foreground">Nu mapa</span>
                                  </SelectItem>
                                  {TARGET_FIELDS.map(field => {
                                    const isUsed = columnMappings.some(
                                      m => m.targetField === field.key && m.sourceColumn !== mapping.sourceColumn
                                    );
                                    return (
                                      <SelectItem 
                                        key={field.key} 
                                        value={field.key}
                                        disabled={isUsed}
                                      >
                                        <div className="flex items-center gap-2">
                                          <span>
                                            {field.label}
                                            {field.required && (
                                              <span className="text-red-500 ml-0.5">*</span>
                                            )}
                                          </span>
                                          {isUsed && (
                                            <Badge variant="secondary" className="text-xs">
                                              în uz
                                            </Badge>
                                          )}
                                        </div>
                                      </SelectItem>
                                    );
                                  })}
                                </SelectContent>
                              </Select>
                            </div>

                            {/* Status indicator */}
                            <div className="w-6">
                              {mapping.targetField ? (
                                <CheckCircle className="h-5 w-5 text-green-500" />
                              ) : (
                                <div className="h-5 w-5 rounded-full border-2 border-muted" />
                              )}
                            </div>
                          </div>
                        </Card>
                      );
                    })}
                  </div>

                  {/* Mapping Summary */}
                  <Card className="bg-muted/50">
                    <CardContent className="py-3">
                      <div className="flex items-center justify-between text-sm">
                        <div className="flex items-center gap-4">
                          <span>
                            <strong>{columnMappings.filter(m => m.targetField).length}</strong> 
                            {' / '}{columnMappings.length} coloane mapate
                          </span>
                          <Separator orientation="vertical" className="h-4" />
                          <span className="text-muted-foreground">
                            Obligatorii: {TARGET_FIELDS.filter(f => f.required).map(f => {
                              const isMapped = columnMappings.some(m => m.targetField === f.key);
                              return (
                                <Badge 
                                  key={f.key}
                                  variant={isMapped ? "default" : "destructive"}
                                  className="text-xs ml-1"
                                >
                                  {f.label}
                                </Badge>
                              );
                            })}
                          </span>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Import Settings */}
                  <Card>
                    <CardHeader className="pb-2">
                      <CardTitle className="text-sm flex items-center gap-2">
                        <Settings className="h-4 w-4" />
                        Setări import
                      </CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <div className="grid grid-cols-2 gap-4">
                        <FormField
                          control={form.control}
                          name="updateExisting"
                          render={({ field }) => (
                            <FormItem className="flex items-center gap-2">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-0">
                                <FormLabel className="font-normal">
                                  Actualizează produsele existente
                                </FormLabel>
                                <FormDescription className="text-xs">
                                  Produsele cu același SKU vor fi actualizate
                                </FormDescription>
                              </div>
                            </FormItem>
                          )}
                        />

                        <FormField
                          control={form.control}
                          name="skipInvalid"
                          render={({ field }) => (
                            <FormItem className="flex items-center gap-2">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-0">
                                <FormLabel className="font-normal">
                                  Sari peste rândurile invalide
                                </FormLabel>
                                <FormDescription className="text-xs">
                                  Importul continuă chiar dacă unele rânduri au erori
                                </FormDescription>
                              </div>
                            </FormItem>
                          )}
                        />
                      </div>

                      <Separator />

                      <div className="grid grid-cols-2 gap-4">
                        <FormField
                          control={form.control}
                          name="defaultCategory"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Categorie implicită</FormLabel>
                              <Select onValueChange={field.onChange} defaultValue={field.value}>
                                <FormControl>
                                  <SelectTrigger>
                                    <SelectValue placeholder="Selectează" />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  <SelectItem value="">Niciuna</SelectItem>
                                  {existingCategories.map(cat => (
                                    <SelectItem key={cat} value={cat}>{cat}</SelectItem>
                                  ))}
                                </SelectContent>
                              </Select>
                              <FormDescription>
                                Pentru rândurile fără categorie
                              </FormDescription>
                            </FormItem>
                          )}
                        />

                        <FormField
                          control={form.control}
                          name="defaultUnit"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Unitate implicită</FormLabel>
                              <Select onValueChange={field.onChange} defaultValue={field.value}>
                                <FormControl>
                                  <SelectTrigger>
                                    <SelectValue placeholder="Selectează" />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  {existingUnits.map(unit => (
                                    <SelectItem key={unit} value={unit}>{unit}</SelectItem>
                                  ))}
                                </SelectContent>
                              </Select>
                              <FormDescription>
                                Pentru rândurile fără unitate
                              </FormDescription>
                            </FormItem>
                          )}
                        />

                        <FormField
                          control={form.control}
                          name="defaultVatRate"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Cotă TVA implicită</FormLabel>
                              <Select 
                                onValueChange={(v) => field.onChange(parseInt(v))} 
                                defaultValue={field.value?.toString()}
                              >
                                <FormControl>
                                  <SelectTrigger>
                                    <SelectValue placeholder="Selectează" />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  <SelectItem value="19">19%</SelectItem>
                                  <SelectItem value="9">9%</SelectItem>
                                  <SelectItem value="5">5%</SelectItem>
                                  <SelectItem value="0">0%</SelectItem>
                                </SelectContent>
                              </Select>
                            </FormItem>
                          )}
                        />

                        <FormField
                          control={form.control}
                          name="defaultCurrency"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Moneda implicită</FormLabel>
                              <Select onValueChange={field.onChange} defaultValue={field.value}>
                                <FormControl>
                                  <SelectTrigger>
                                    <SelectValue placeholder="Selectează" />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  <SelectItem value="RON">RON</SelectItem>
                                  <SelectItem value="EUR">EUR</SelectItem>
                                  <SelectItem value="USD">USD</SelectItem>
                                </SelectContent>
                              </Select>
                            </FormItem>
                          )}
                        />
                      </div>
                    </CardContent>
                  </Card>
                </div>
              )}

              {/* Step 2: Validation */}
              {currentStep === 2 && (
                <div className="space-y-4">
                  {isProcessing ? (
                    <div className="py-12 text-center space-y-4">
                      <Loader2 className="h-12 w-12 mx-auto animate-spin text-primary" />
                      <div className="space-y-2">
                        <p className="font-medium">Se validează datele...</p>
                        <Progress value={progress} className="w-64 mx-auto" />
                        <p className="text-sm text-muted-foreground">
                          {Math.round(progress)}% complet
                        </p>
                      </div>
                    </div>
                  ) : (
                    <>
                      {/* Validation Summary */}
                      <div className="grid grid-cols-4 gap-4">
                        <Card className="bg-muted/50">
                          <CardContent className="pt-4 text-center">
                            <p className="text-3xl font-bold">{stats.total}</p>
                            <p className="text-sm text-muted-foreground">Total rânduri</p>
                          </CardContent>
                        </Card>
                        <Card className="bg-green-50 border-green-200">
                          <CardContent className="pt-4 text-center">
                            <p className="text-3xl font-bold text-green-600">{stats.valid}</p>
                            <p className="text-sm text-green-600">Valide</p>
                          </CardContent>
                        </Card>
                        <Card className="bg-red-50 border-red-200">
                          <CardContent className="pt-4 text-center">
                            <p className="text-3xl font-bold text-red-600">{stats.invalid}</p>
                            <p className="text-sm text-red-600">Cu erori</p>
                          </CardContent>
                        </Card>
                        <Card className="bg-yellow-50 border-yellow-200">
                          <CardContent className="pt-4 text-center">
                            <p className="text-3xl font-bold text-yellow-600">{stats.warnings}</p>
                            <p className="text-sm text-yellow-600">Cu avertismente</p>
                          </CardContent>
                        </Card>
                      </div>

                      {/* Validation Details */}
                      {stats.invalid > 0 && (
                        <Alert variant="destructive">
                          <AlertCircle className="h-4 w-4" />
                          <AlertTitle>Erori de validare</AlertTitle>
                          <AlertDescription>
                            {stats.invalid} rânduri au erori și nu vor fi importate. 
                            Corectează fișierul sau activează "Sari peste rândurile invalide".
                          </AlertDescription>
                        </Alert>
                      )}

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm flex items-center justify-between">
                            <span className="flex items-center gap-2">
                              <Eye className="h-4 w-4" />
                              Detalii validare
                            </span>
                            <div className="flex items-center gap-2">
                              <Badge variant="outline" className="text-xs">
                                Afișare: toate
                              </Badge>
                            </div>
                          </CardTitle>
                        </CardHeader>
                        <CardContent>
                          <ScrollArea className="h-[300px]">
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  <TableHead className="w-16">Rând</TableHead>
                                  <TableHead>SKU</TableHead>
                                  <TableHead>Denumire</TableHead>
                                  <TableHead>Status</TableHead>
                                  <TableHead>Probleme</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {validationResults
                                  .filter(r => !r.isValid || r.warnings.length > 0)
                                  .slice(0, 50)
                                  .map((result) => (
                                    <TableRow key={result.row}>
                                      <TableCell className="font-mono text-sm">
                                        {result.row}
                                      </TableCell>
                                      <TableCell className="font-mono text-sm">
                                        {result.data.sku || '-'}
                                      </TableCell>
                                      <TableCell className="max-w-[200px] truncate">
                                        {result.data.name || '-'}
                                      </TableCell>
                                      <TableCell>
                                        {result.isValid ? (
                                          result.warnings.length > 0 ? (
                                            <Badge variant="outline" className="text-yellow-600 border-yellow-400">
                                              <AlertTriangle className="h-3 w-3 mr-1" />
                                              Avertisment
                                            </Badge>
                                          ) : (
                                            <Badge variant="outline" className="text-green-600 border-green-400">
                                              <CheckCircle className="h-3 w-3 mr-1" />
                                              Valid
                                            </Badge>
                                          )
                                        ) : (
                                          <Badge variant="destructive">
                                            <XCircle className="h-3 w-3 mr-1" />
                                            Eroare
                                          </Badge>
                                        )}
                                      </TableCell>
                                      <TableCell>
                                        <div className="space-y-1">
                                          {result.errors.map((err, i) => (
                                            <p key={i} className="text-xs text-red-600">
                                              {err.field}: {err.message}
                                            </p>
                                          ))}
                                          {result.warnings.map((warn, i) => (
                                            <p key={i} className="text-xs text-yellow-600">
                                              {warn.field}: {warn.message}
                                            </p>
                                          ))}
                                        </div>
                                      </TableCell>
                                    </TableRow>
                                  ))}
                                {validationResults.filter(r => !r.isValid || r.warnings.length > 0).length === 0 && (
                                  <TableRow>
                                    <TableCell colSpan={5} className="text-center text-muted-foreground py-8">
                                      <CheckCircle className="h-8 w-8 mx-auto mb-2 text-green-500" />
                                      Toate rândurile sunt valide!
                                    </TableCell>
                                  </TableRow>
                                )}
                              </TableBody>
                            </Table>
                          </ScrollArea>
                        </CardContent>
                      </Card>

                      {/* Ready to Import */}
                      {stats.valid > 0 && (
                        <Alert className="border-green-200 bg-green-50">
                          <CheckCircle className="h-4 w-4 text-green-600" />
                          <AlertTitle className="text-green-800">
                            Gata pentru import
                          </AlertTitle>
                          <AlertDescription className="text-green-700">
                            {stats.valid} produse vor fi importate. 
                            {stats.invalid > 0 && form.watch('skipInvalid') && (
                              <span> {stats.invalid} rânduri vor fi sărite din cauza erorilor.</span>
                            )}
                          </AlertDescription>
                        </Alert>
                      )}
                    </>
                  )}
                </div>
              )}

              {/* Step 3: Import */}
              {currentStep === 3 && (
                <div className="space-y-6">
                  {isProcessing ? (
                    <div className="py-16 text-center space-y-6">
                      <div className="relative w-24 h-24 mx-auto">
                        <Loader2 className="h-24 w-24 animate-spin text-primary" />
                        <div className="absolute inset-0 flex items-center justify-center">
                          <span className="text-lg font-bold">{Math.round(progress)}%</span>
                        </div>
                      </div>
                      <div className="space-y-2">
                        <p className="font-medium text-lg">Se importă produsele...</p>
                        <Progress value={progress} className="w-96 mx-auto" />
                        <p className="text-sm text-muted-foreground">
                          Vă rugăm să nu închideți această fereastră
                        </p>
                      </div>
                    </div>
                  ) : importResult ? (
                    <div className="space-y-6">
                      {/* Success Summary */}
                      <div className="text-center py-8">
                        {importResult.errors.length === 0 ? (
                          <CheckCircle className="h-16 w-16 mx-auto text-green-500 mb-4" />
                        ) : (
                          <AlertTriangle className="h-16 w-16 mx-auto text-yellow-500 mb-4" />
                        )}
                        <h3 className="text-xl font-semibold">
                          {importResult.errors.length === 0 
                            ? 'Import finalizat cu succes!' 
                            : 'Import finalizat cu avertismente'
                          }
                        </h3>
                      </div>

                      {/* Results Grid */}
                      <div className="grid grid-cols-4 gap-4">
                        <Card className="text-center">
                          <CardContent className="pt-4">
                            <p className="text-3xl font-bold text-green-600">
                              {importResult.created}
                            </p>
                            <p className="text-sm text-muted-foreground">Produse create</p>
                          </CardContent>
                        </Card>
                        <Card className="text-center">
                          <CardContent className="pt-4">
                            <p className="text-3xl font-bold text-blue-600">
                              {importResult.updated}
                            </p>
                            <p className="text-sm text-muted-foreground">Produse actualizate</p>
                          </CardContent>
                        </Card>
                        <Card className="text-center">
                          <CardContent className="pt-4">
                            <p className="text-3xl font-bold text-gray-500">
                              {importResult.skipped}
                            </p>
                            <p className="text-sm text-muted-foreground">Rânduri sărite</p>
                          </CardContent>
                        </Card>
                        <Card className="text-center">
                          <CardContent className="pt-4">
                            <p className="text-3xl font-bold text-red-600">
                              {importResult.errors.length}
                            </p>
                            <p className="text-sm text-muted-foreground">Erori</p>
                          </CardContent>
                        </Card>
                      </div>

                      {/* Error Details */}
                      {importResult.errors.length > 0 && (
                        <Card>
                          <CardHeader className="pb-2">
                            <CardTitle className="text-sm flex items-center gap-2 text-red-600">
                              <XCircle className="h-4 w-4" />
                              Erori la import
                            </CardTitle>
                          </CardHeader>
                          <CardContent>
                            <ScrollArea className="h-[200px]">
                              <Table>
                                <TableHeader>
                                  <TableRow>
                                    <TableHead className="w-16">Rând</TableHead>
                                    <TableHead>SKU</TableHead>
                                    <TableHead>Eroare</TableHead>
                                  </TableRow>
                                </TableHeader>
                                <TableBody>
                                  {importResult.errors.map((error, index) => (
                                    <TableRow key={index}>
                                      <TableCell className="font-mono">{error.row}</TableCell>
                                      <TableCell className="font-mono">{error.sku || '-'}</TableCell>
                                      <TableCell className="text-red-600">{error.error}</TableCell>
                                    </TableRow>
                                  ))}
                                </TableBody>
                              </Table>
                            </ScrollArea>
                          </CardContent>
                        </Card>
                      )}

                      {/* Action Buttons */}
                      <div className="flex justify-center gap-4">
                        <Button variant="outline" onClick={handleClose}>
                          Închide
                        </Button>
                        <Button onClick={() => {
                          setCurrentStep(0);
                          setFileData(null);
                          setColumnMappings([]);
                          setValidationResults([]);
                          setImportResult(null);
                        }}>
                          <Upload className="h-4 w-4 mr-2" />
                          Import nou
                        </Button>
                      </div>
                    </div>
                  ) : null}
                </div>
              )}
            </form>
          </Form>
        </ScrollArea>

        {/* Footer with Navigation */}
        {currentStep < 3 || (currentStep === 3 && isProcessing) ? (
          <DialogFooter className="flex items-center justify-between">
            <Button
              type="button"
              variant="outline"
              onClick={() => setCurrentStep(prev => prev - 1)}
              disabled={currentStep === 0 || isProcessing}
            >
              <ChevronLeft className="h-4 w-4 mr-1" />
              Înapoi
            </Button>

            <div className="flex items-center gap-2">
              <Button
                type="button"
                variant="ghost"
                onClick={handleClose}
                disabled={isProcessing}
              >
                Anulează
              </Button>

              {currentStep === 0 && (
                <Button
                  type="button"
                  onClick={() => setCurrentStep(1)}
                  disabled={!canProceed()}
                >
                  Continuă
                  <ChevronRight className="h-4 w-4 ml-1" />
                </Button>
              )}

              {currentStep === 1 && (
                <Button
                  type="button"
                  onClick={validateData}
                  disabled={!canProceed() || isProcessing}
                >
                  {isProcessing ? (
                    <>
                      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                      Se validează...
                    </>
                  ) : (
                    <>
                      Validează
                      <ChevronRight className="h-4 w-4 ml-1" />
                    </>
                  )}
                </Button>
              )}

              {currentStep === 2 && (
                <Button
                  type="button"
                  onClick={performImport}
                  disabled={!canProceed() || isProcessing}
                >
                  {isProcessing ? (
                    <>
                      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                      Se importă...
                    </>
                  ) : (
                    <>
                      <Check className="h-4 w-4 mr-1" />
                      Importă {stats.valid} produse
                    </>
                  )}
                </Button>
              )}
            </div>
          </DialogFooter>
        ) : null}
      </DialogContent>
    </Dialog>
  );
}

// Usage Example
function ProductImportWizardExample() {
  const [open, setOpen] = useState(false);

  return (
    <>
      <Button onClick={() => setOpen(true)}>
        <Upload className="h-4 w-4 mr-2" />
        Import produse
      </Button>

      <ProductImportWizard
        open={open}
        onClose={() => setOpen(false)}
        existingCategories={['Semințe', 'Fertilizanți', 'Pesticide', 'Echipamente', 'Piese']}
        existingUnits={['buc', 'kg', 'l', 't', 'mp', 'ml']}
        onImport={async (products, settings) => {
          const response = await fetch('/api/v1/products/import', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ products, settings }),
          });
          return response.json();
        }}
      />
    </>
  );
}
```

### 13.3 OnboardingWizard

Wizard pentru configurarea inițială a unui nou tenant în sistem.

```typescript
// components/wizards/OnboardingWizard.tsx
import React, { useState, useEffect, useCallback } from 'react';
import { useForm, useFieldArray } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Checkbox } from '@/components/ui/checkbox';
import { Badge } from '@/components/ui/badge';
import { Switch } from '@/components/ui/switch';
import { Progress } from '@/components/ui/progress';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Separator } from '@/components/ui/separator';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import {
  Tooltip,
  TooltipContent,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { cn } from '@/lib/utils';
import {
  Building2,
  Users,
  Settings,
  Plug,
  CheckCircle2,
  ChevronRight,
  ChevronLeft,
  Loader2,
  AlertCircle,
  Info,
  Upload,
  Trash2,
  Plus,
  Mail,
  Phone,
  MapPin,
  Globe,
  CreditCard,
  FileText,
  Warehouse,
  Zap,
  Shield,
  Key,
  Eye,
  EyeOff,
  ExternalLink,
  Copy,
  Check,
  RefreshCw,
  User,
  Crown,
  UserPlus,
  Send,
  Clock,
  X,
  HelpCircle,
  Sparkles,
} from 'lucide-react';

// =============================================================================
// SCHEMA DEFINITIONS
// =============================================================================

// Step 1: Company Profile Schema
const companyProfileSchema = z.object({
  // Basic Info
  companyName: z.string().min(2, 'Numele firmei este obligatoriu').max(200),
  cui: z.string()
    .regex(/^(RO)?[0-9]{2,10}$/, 'CUI invalid (ex: RO12345678 sau 12345678)'),
  registrationNumber: z.string()
    .regex(/^J[0-9]{1,2}\/[0-9]{1,6}\/[0-9]{4}$/, 'Nr. înregistrare invalid (ex: J40/1234/2020)')
    .optional()
    .or(z.literal('')),
  
  // Contact Info
  email: z.string().email('Email invalid'),
  phone: z.string()
    .regex(/^\+?[0-9]{10,15}$/, 'Telefon invalid')
    .optional()
    .or(z.literal('')),
  website: z.string().url('URL invalid').optional().or(z.literal('')),
  
  // Address
  address: z.object({
    street: z.string().min(1, 'Adresa este obligatorie'),
    city: z.string().min(1, 'Orașul este obligatoriu'),
    county: z.string().min(1, 'Județul este obligatoriu'),
    postalCode: z.string()
      .regex(/^[0-9]{6}$/, 'Cod poștal invalid (6 cifre)'),
    country: z.string().default('România'),
  }),
  
  // Business Details
  industry: z.enum([
    'agriculture',
    'food_processing',
    'distribution',
    'retail',
    'services',
    'manufacturing',
    'other',
  ]),
  companySize: z.enum(['micro', 'small', 'medium', 'large']),
  
  // Branding
  logo: z.string().optional(),
  primaryColor: z.string().regex(/^#[0-9A-Fa-f]{6}$/).default('#2563eb'),
  
  // Bank Account
  bankAccounts: z.array(z.object({
    id: z.string(),
    bankName: z.string().min(1, 'Numele băncii este obligatoriu'),
    iban: z.string()
      .regex(/^RO[0-9]{2}[A-Z]{4}[A-Z0-9]{16}$/, 'IBAN invalid'),
    currency: z.enum(['RON', 'EUR', 'USD']),
    isDefault: z.boolean(),
  })).min(1, 'Cel puțin un cont bancar este necesar'),
});

// Step 2: Team Members Schema
const teamMemberSchema = z.object({
  id: z.string(),
  firstName: z.string().min(1, 'Prenumele este obligatoriu'),
  lastName: z.string().min(1, 'Numele este obligatoriu'),
  email: z.string().email('Email invalid'),
  role: z.enum(['admin', 'sales_manager', 'sales_rep', 'viewer']),
  sendInvite: z.boolean().default(true),
});

const teamSchema = z.object({
  members: z.array(teamMemberSchema),
  defaultRole: z.enum(['admin', 'sales_manager', 'sales_rep', 'viewer']).default('sales_rep'),
});

// Step 3: Settings Schema
const settingsSchema = z.object({
  // Regional Settings
  timezone: z.string().default('Europe/Bucharest'),
  dateFormat: z.enum(['DD/MM/YYYY', 'MM/DD/YYYY', 'YYYY-MM-DD']).default('DD/MM/YYYY'),
  currency: z.enum(['RON', 'EUR', 'USD']).default('RON'),
  language: z.enum(['ro', 'en']).default('ro'),
  
  // Negotiation Defaults
  defaultPaymentTerms: z.number().min(0).max(180).default(30),
  defaultValidityDays: z.number().min(1).max(90).default(14),
  defaultDiscountApprovalThreshold: z.number().min(0).max(50).default(15),
  autoArchiveCompletedDays: z.number().min(0).max(365).default(30),
  
  // AI Settings
  aiEnabled: z.boolean().default(true),
  aiModel: z.enum(['claude-3-5-haiku', 'claude-sonnet-4', 'claude-opus-4']).default('claude-sonnet-4'),
  aiAutoApproveThreshold: z.number().min(50).max(100).default(85),
  aiGuardrailsProfile: z.enum(['strict', 'balanced', 'permissive']).default('balanced'),
  
  // Notification Defaults
  emailNotifications: z.boolean().default(true),
  pushNotifications: z.boolean().default(true),
  dailyDigest: z.boolean().default(true),
  
  // Security
  requireTwoFactor: z.boolean().default(false),
  sessionTimeoutMinutes: z.number().min(15).max(480).default(60),
  ipWhitelist: z.string().optional(),
});

// Step 4: Integrations Schema
const integrationSchema = z.object({
  // ANAF Integration
  anaf: z.object({
    enabled: z.boolean().default(true),
    autoSync: z.boolean().default(true),
    syncFrequency: z.enum(['daily', 'weekly', 'manual']).default('daily'),
  }),
  
  // e-Factura
  efactura: z.object({
    enabled: z.boolean().default(false),
    certificatePath: z.string().optional(),
    certificatePassword: z.string().optional(),
    testMode: z.boolean().default(true),
  }),
  
  // Oblio
  oblio: z.object({
    enabled: z.boolean().default(false),
    apiKey: z.string().optional(),
    companyName: z.string().optional(),
    autoInvoice: z.boolean().default(false),
  }),
  
  // Email (SMTP)
  email: z.object({
    enabled: z.boolean().default(true),
    provider: z.enum(['smtp', 'sendgrid', 'mailgun', 'ses']).default('smtp'),
    smtpHost: z.string().optional(),
    smtpPort: z.number().optional(),
    smtpUser: z.string().optional(),
    smtpPassword: z.string().optional(),
    fromAddress: z.string().email().optional(),
    fromName: z.string().optional(),
  }),
  
  // WhatsApp (optional)
  whatsapp: z.object({
    enabled: z.boolean().default(false),
    phoneNumberId: z.string().optional(),
    accessToken: z.string().optional(),
    businessId: z.string().optional(),
  }),
  
  // Hunter.io
  hunter: z.object({
    enabled: z.boolean().default(false),
    apiKey: z.string().optional(),
    monthlyQuota: z.number().default(100),
  }),
  
  // Termene.ro
  termene: z.object({
    enabled: z.boolean().default(false),
    apiKey: z.string().optional(),
  }),
});

// Combined Onboarding Schema
const onboardingSchema = z.object({
  companyProfile: companyProfileSchema,
  team: teamSchema,
  settings: settingsSchema,
  integrations: integrationSchema,
  acceptTerms: z.boolean().refine(val => val === true, 'Trebuie să acceptați termenii'),
  acceptPrivacy: z.boolean().refine(val => val === true, 'Trebuie să acceptați politica de confidențialitate'),
});

type OnboardingFormValues = z.infer<typeof onboardingSchema>;

// =============================================================================
// CONSTANTS
// =============================================================================

const WIZARD_STEPS = [
  {
    id: 'company',
    title: 'Companie',
    description: 'Informații despre firma ta',
    icon: Building2,
  },
  {
    id: 'team',
    title: 'Echipă',
    description: 'Invită membrii echipei',
    icon: Users,
  },
  {
    id: 'settings',
    title: 'Setări',
    description: 'Configurează preferințele',
    icon: Settings,
  },
  {
    id: 'integrations',
    title: 'Integrări',
    description: 'Conectează serviciile',
    icon: Plug,
  },
  {
    id: 'finish',
    title: 'Finalizare',
    description: 'Revizuiește și confirmă',
    icon: CheckCircle2,
  },
];

const INDUSTRIES = [
  { value: 'agriculture', label: 'Agricultură' },
  { value: 'food_processing', label: 'Procesare alimente' },
  { value: 'distribution', label: 'Distribuție' },
  { value: 'retail', label: 'Retail' },
  { value: 'services', label: 'Servicii' },
  { value: 'manufacturing', label: 'Producție' },
  { value: 'other', label: 'Altele' },
];

const COMPANY_SIZES = [
  { value: 'micro', label: 'Micro (1-9 angajați)' },
  { value: 'small', label: 'Mică (10-49 angajați)' },
  { value: 'medium', label: 'Medie (50-249 angajați)' },
  { value: 'large', label: 'Mare (250+ angajați)' },
];

const ROMANIAN_COUNTIES = [
  'Alba', 'Arad', 'Argeș', 'Bacău', 'Bihor', 'Bistrița-Năsăud', 'Botoșani',
  'Brăila', 'Brașov', 'București', 'Buzău', 'Călărași', 'Caraș-Severin',
  'Cluj', 'Constanța', 'Covasna', 'Dâmbovița', 'Dolj', 'Galați', 'Giurgiu',
  'Gorj', 'Harghita', 'Hunedoara', 'Ialomița', 'Iași', 'Ilfov', 'Maramureș',
  'Mehedinți', 'Mureș', 'Neamț', 'Olt', 'Prahova', 'Sălaj', 'Satu Mare',
  'Sibiu', 'Suceava', 'Teleorman', 'Timiș', 'Tulcea', 'Vâlcea', 'Vaslui', 'Vrancea',
];

const USER_ROLES = [
  { 
    value: 'admin', 
    label: 'Administrator', 
    description: 'Acces complet la toate funcționalitățile',
    icon: Crown,
    color: 'text-amber-500',
  },
  { 
    value: 'sales_manager', 
    label: 'Manager Vânzări', 
    description: 'Gestionare echipă și rapoarte',
    icon: Users,
    color: 'text-blue-500',
  },
  { 
    value: 'sales_rep', 
    label: 'Agent Vânzări', 
    description: 'Gestionare proprii clienți și negocieri',
    icon: User,
    color: 'text-green-500',
  },
  { 
    value: 'viewer', 
    label: 'Vizualizator', 
    description: 'Doar citire, fără modificări',
    icon: Eye,
    color: 'text-gray-500',
  },
];

// =============================================================================
// PROPS INTERFACE
// =============================================================================

interface OnboardingWizardProps {
  open: boolean;
  onComplete: (data: OnboardingFormValues) => Promise<{
    tenantId: string;
    invitesSent: number;
    errors?: string[];
  }>;
  initialData?: Partial<OnboardingFormValues>;
  cuiLookup?: (cui: string) => Promise<{
    companyName: string;
    address: string;
    city: string;
    county: string;
  } | null>;
}

// =============================================================================
// MAIN COMPONENT
// =============================================================================

export function OnboardingWizard({
  open,
  onComplete,
  initialData,
  cuiLookup,
}: OnboardingWizardProps) {
  // -------------------------------------------------------------------------
  // State
  // -------------------------------------------------------------------------
  const [currentStep, setCurrentStep] = useState(0);
  const [isProcessing, setIsProcessing] = useState(false);
  const [isLookingUpCui, setIsLookingUpCui] = useState(false);
  const [completionResult, setCompletionResult] = useState<{
    tenantId: string;
    invitesSent: number;
    errors?: string[];
  } | null>(null);
  const [showPassword, setShowPassword] = useState<Record<string, boolean>>({});
  const [copiedField, setCopiedField] = useState<string | null>(null);

  // -------------------------------------------------------------------------
  // Form
  // -------------------------------------------------------------------------
  const form = useForm<OnboardingFormValues>({
    resolver: zodResolver(onboardingSchema),
    defaultValues: initialData || {
      companyProfile: {
        companyName: '',
        cui: '',
        registrationNumber: '',
        email: '',
        phone: '',
        website: '',
        address: {
          street: '',
          city: '',
          county: '',
          postalCode: '',
          country: 'România',
        },
        industry: 'agriculture',
        companySize: 'small',
        logo: '',
        primaryColor: '#2563eb',
        bankAccounts: [
          {
            id: crypto.randomUUID(),
            bankName: '',
            iban: '',
            currency: 'RON',
            isDefault: true,
          },
        ],
      },
      team: {
        members: [],
        defaultRole: 'sales_rep',
      },
      settings: {
        timezone: 'Europe/Bucharest',
        dateFormat: 'DD/MM/YYYY',
        currency: 'RON',
        language: 'ro',
        defaultPaymentTerms: 30,
        defaultValidityDays: 14,
        defaultDiscountApprovalThreshold: 15,
        autoArchiveCompletedDays: 30,
        aiEnabled: true,
        aiModel: 'claude-sonnet-4',
        aiAutoApproveThreshold: 85,
        aiGuardrailsProfile: 'balanced',
        emailNotifications: true,
        pushNotifications: true,
        dailyDigest: true,
        requireTwoFactor: false,
        sessionTimeoutMinutes: 60,
        ipWhitelist: '',
      },
      integrations: {
        anaf: { enabled: true, autoSync: true, syncFrequency: 'daily' },
        efactura: { enabled: false, testMode: true },
        oblio: { enabled: false, autoInvoice: false },
        email: { enabled: true, provider: 'smtp' },
        whatsapp: { enabled: false },
        hunter: { enabled: false, monthlyQuota: 100 },
        termene: { enabled: false },
      },
      acceptTerms: false,
      acceptPrivacy: false,
    },
    mode: 'onChange',
  });

  const {
    fields: bankAccountFields,
    append: appendBankAccount,
    remove: removeBankAccount,
  } = useFieldArray({
    control: form.control,
    name: 'companyProfile.bankAccounts',
  });

  const {
    fields: teamMemberFields,
    append: appendTeamMember,
    remove: removeTeamMember,
  } = useFieldArray({
    control: form.control,
    name: 'team.members',
  });

  // -------------------------------------------------------------------------
  // Handlers
  // -------------------------------------------------------------------------
  const handleCuiLookup = async () => {
    if (!cuiLookup) return;
    
    const cui = form.getValues('companyProfile.cui');
    if (!cui) return;

    setIsLookingUpCui(true);
    try {
      const result = await cuiLookup(cui);
      if (result) {
        form.setValue('companyProfile.companyName', result.companyName);
        form.setValue('companyProfile.address.street', result.address);
        form.setValue('companyProfile.address.city', result.city);
        form.setValue('companyProfile.address.county', result.county);
      }
    } finally {
      setIsLookingUpCui(false);
    }
  };

  const handleAddBankAccount = () => {
    appendBankAccount({
      id: crypto.randomUUID(),
      bankName: '',
      iban: '',
      currency: 'RON',
      isDefault: bankAccountFields.length === 0,
    });
  };

  const handleSetDefaultBankAccount = (index: number) => {
    bankAccountFields.forEach((_, i) => {
      form.setValue(`companyProfile.bankAccounts.${i}.isDefault`, i === index);
    });
  };

  const handleAddTeamMember = () => {
    appendTeamMember({
      id: crypto.randomUUID(),
      firstName: '',
      lastName: '',
      email: '',
      role: form.getValues('team.defaultRole'),
      sendInvite: true,
    });
  };

  const handleCopyToClipboard = async (text: string, field: string) => {
    await navigator.clipboard.writeText(text);
    setCopiedField(field);
    setTimeout(() => setCopiedField(null), 2000);
  };

  const togglePasswordVisibility = (field: string) => {
    setShowPassword(prev => ({ ...prev, [field]: !prev[field] }));
  };

  // -------------------------------------------------------------------------
  // Step Validation
  // -------------------------------------------------------------------------
  const validateCurrentStep = useCallback(async (): Promise<boolean> => {
    switch (currentStep) {
      case 0: // Company Profile
        const companyResult = await form.trigger([
          'companyProfile.companyName',
          'companyProfile.cui',
          'companyProfile.email',
          'companyProfile.address.street',
          'companyProfile.address.city',
          'companyProfile.address.county',
          'companyProfile.address.postalCode',
          'companyProfile.industry',
          'companyProfile.companySize',
          'companyProfile.bankAccounts',
        ]);
        return companyResult;
        
      case 1: // Team
        // Team members are optional
        if (teamMemberFields.length > 0) {
          return await form.trigger('team.members');
        }
        return true;
        
      case 2: // Settings
        return await form.trigger('settings');
        
      case 3: // Integrations
        return await form.trigger('integrations');
        
      case 4: // Finish
        return await form.trigger(['acceptTerms', 'acceptPrivacy']);
        
      default:
        return true;
    }
  }, [currentStep, form, teamMemberFields.length]);

  const handleNext = async () => {
    const isValid = await validateCurrentStep();
    if (isValid && currentStep < WIZARD_STEPS.length - 1) {
      setCurrentStep(prev => prev + 1);
    }
  };

  const handlePrevious = () => {
    if (currentStep > 0) {
      setCurrentStep(prev => prev - 1);
    }
  };

  const handleComplete = async () => {
    const isValid = await form.trigger();
    if (!isValid) return;

    setIsProcessing(true);
    try {
      const data = form.getValues();
      const result = await onComplete(data);
      setCompletionResult(result);
    } catch (error) {
      console.error('Onboarding error:', error);
    } finally {
      setIsProcessing(false);
    }
  };

  // -------------------------------------------------------------------------
  // Calculate Progress
  // -------------------------------------------------------------------------
  const progress = ((currentStep + 1) / WIZARD_STEPS.length) * 100;

  // -------------------------------------------------------------------------
  // Render Step Content
  // -------------------------------------------------------------------------
  const renderStepContent = () => {
    switch (currentStep) {
      case 0:
        return renderCompanyStep();
      case 1:
        return renderTeamStep();
      case 2:
        return renderSettingsStep();
      case 3:
        return renderIntegrationsStep();
      case 4:
        return renderFinishStep();
      default:
        return null;
    }
  };

  // -------------------------------------------------------------------------
  // Step 1: Company Profile
  // -------------------------------------------------------------------------
  const renderCompanyStep = () => (
    <div className="space-y-6">
      {/* Basic Company Info */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base flex items-center gap-2">
            <Building2 className="h-4 w-4" />
            Informații firmă
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {/* CUI with Lookup */}
          <div className="flex gap-2">
            <FormField
              control={form.control}
              name="companyProfile.cui"
              render={({ field }) => (
                <FormItem className="flex-1">
                  <FormLabel>CUI *</FormLabel>
                  <FormControl>
                    <Input
                      placeholder="RO12345678"
                      {...field}
                      className="font-mono"
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            {cuiLookup && (
              <Button
                type="button"
                variant="outline"
                className="mt-8"
                onClick={handleCuiLookup}
                disabled={isLookingUpCui}
              >
                {isLookingUpCui ? (
                  <Loader2 className="h-4 w-4 animate-spin" />
                ) : (
                  <RefreshCw className="h-4 w-4" />
                )}
              </Button>
            )}
          </div>

          <div className="grid grid-cols-2 gap-4">
            <FormField
              control={form.control}
              name="companyProfile.companyName"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Denumire firmă *</FormLabel>
                  <FormControl>
                    <Input placeholder="SC Exemplu SRL" {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="companyProfile.registrationNumber"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Nr. înregistrare</FormLabel>
                  <FormControl>
                    <Input placeholder="J40/1234/2020" {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <FormField
              control={form.control}
              name="companyProfile.industry"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Domeniu de activitate *</FormLabel>
                  <Select onValueChange={field.onChange} value={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Selectează domeniul" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {INDUSTRIES.map((industry) => (
                        <SelectItem key={industry.value} value={industry.value}>
                          {industry.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="companyProfile.companySize"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Dimensiune firmă *</FormLabel>
                  <Select onValueChange={field.onChange} value={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Selectează dimensiunea" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {COMPANY_SIZES.map((size) => (
                        <SelectItem key={size.value} value={size.value}>
                          {size.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />
          </div>
        </CardContent>
      </Card>

      {/* Contact Info */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base flex items-center gap-2">
            <Mail className="h-4 w-4" />
            Contact
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <FormField
              control={form.control}
              name="companyProfile.email"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Email *</FormLabel>
                  <FormControl>
                    <Input 
                      type="email" 
                      placeholder="contact@firma.ro" 
                      {...field} 
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="companyProfile.phone"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Telefon</FormLabel>
                  <FormControl>
                    <Input 
                      type="tel" 
                      placeholder="+40721234567" 
                      {...field} 
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
          </div>

          <FormField
            control={form.control}
            name="companyProfile.website"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Website</FormLabel>
                <FormControl>
                  <Input 
                    type="url" 
                    placeholder="https://www.firma.ro" 
                    {...field} 
                  />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
        </CardContent>
      </Card>

      {/* Address */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base flex items-center gap-2">
            <MapPin className="h-4 w-4" />
            Adresă sediu social
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <FormField
            control={form.control}
            name="companyProfile.address.street"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Stradă, număr *</FormLabel>
                <FormControl>
                  <Input placeholder="Str. Principală nr. 1" {...field} />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />

          <div className="grid grid-cols-3 gap-4">
            <FormField
              control={form.control}
              name="companyProfile.address.city"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Localitate *</FormLabel>
                  <FormControl>
                    <Input placeholder="București" {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="companyProfile.address.county"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Județ *</FormLabel>
                  <Select onValueChange={field.onChange} value={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Selectează" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {ROMANIAN_COUNTIES.map((county) => (
                        <SelectItem key={county} value={county}>
                          {county}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="companyProfile.address.postalCode"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Cod poștal *</FormLabel>
                  <FormControl>
                    <Input 
                      placeholder="012345" 
                      maxLength={6}
                      {...field} 
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
          </div>
        </CardContent>
      </Card>

      {/* Bank Accounts */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base flex items-center gap-2">
            <CreditCard className="h-4 w-4" />
            Conturi bancare
          </CardTitle>
          <CardDescription>
            Adaugă cel puțin un cont bancar pentru facturare
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          {bankAccountFields.map((field, index) => (
            <div 
              key={field.id} 
              className="p-4 border rounded-lg space-y-4"
            >
              <div className="flex items-center justify-between">
                <span className="text-sm font-medium">
                  Cont #{index + 1}
                </span>
                <div className="flex items-center gap-2">
                  <FormField
                    control={form.control}
                    name={`companyProfile.bankAccounts.${index}.isDefault`}
                    render={({ field: checkField }) => (
                      <FormItem className="flex items-center gap-2">
                        <FormControl>
                          <Checkbox
                            checked={checkField.value}
                            onCheckedChange={() => handleSetDefaultBankAccount(index)}
                          />
                        </FormControl>
                        <FormLabel className="!mt-0 text-sm">Principal</FormLabel>
                      </FormItem>
                    )}
                  />
                  {bankAccountFields.length > 1 && (
                    <Button
                      type="button"
                      variant="ghost"
                      size="sm"
                      onClick={() => removeBankAccount(index)}
                    >
                      <Trash2 className="h-4 w-4 text-red-500" />
                    </Button>
                  )}
                </div>
              </div>

              <div className="grid grid-cols-3 gap-4">
                <FormField
                  control={form.control}
                  name={`companyProfile.bankAccounts.${index}.bankName`}
                  render={({ field: inputField }) => (
                    <FormItem>
                      <FormLabel>Banca *</FormLabel>
                      <FormControl>
                        <Input placeholder="Banca Transilvania" {...inputField} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name={`companyProfile.bankAccounts.${index}.iban`}
                  render={({ field: inputField }) => (
                    <FormItem>
                      <FormLabel>IBAN *</FormLabel>
                      <FormControl>
                        <Input 
                          placeholder="RO49AAAA1B31007593840000" 
                          className="font-mono uppercase"
                          {...inputField}
                          onChange={(e) => inputField.onChange(e.target.value.toUpperCase())}
                        />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name={`companyProfile.bankAccounts.${index}.currency`}
                  render={({ field: selectField }) => (
                    <FormItem>
                      <FormLabel>Monedă *</FormLabel>
                      <Select onValueChange={selectField.onChange} value={selectField.value}>
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          <SelectItem value="RON">RON</SelectItem>
                          <SelectItem value="EUR">EUR</SelectItem>
                          <SelectItem value="USD">USD</SelectItem>
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </div>
            </div>
          ))}

          <Button
            type="button"
            variant="outline"
            onClick={handleAddBankAccount}
            className="w-full"
          >
            <Plus className="h-4 w-4 mr-2" />
            Adaugă cont bancar
          </Button>
        </CardContent>
      </Card>
    </div>
  );

  // -------------------------------------------------------------------------
  // Step 2: Team
  // -------------------------------------------------------------------------
  const renderTeamStep = () => (
    <div className="space-y-6">
      <Alert>
        <Info className="h-4 w-4" />
        <AlertDescription>
          Invită membrii echipei tale. Aceștia vor primi un email de invitație 
          pentru a-și crea contul. Poți sări peste acest pas și invita membri mai târziu.
        </AlertDescription>
      </Alert>

      {/* Default Role */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base">Rol implicit pentru membri noi</CardTitle>
        </CardHeader>
        <CardContent>
          <FormField
            control={form.control}
            name="team.defaultRole"
            render={({ field }) => (
              <FormItem>
                <Select onValueChange={field.onChange} value={field.value}>
                  <FormControl>
                    <SelectTrigger className="w-full">
                      <SelectValue />
                    </SelectTrigger>
                  </FormControl>
                  <SelectContent>
                    {USER_ROLES.map((role) => {
                      const IconComponent = role.icon;
                      return (
                        <SelectItem key={role.value} value={role.value}>
                          <div className="flex items-center gap-2">
                            <IconComponent className={cn("h-4 w-4", role.color)} />
                            <span>{role.label}</span>
                          </div>
                        </SelectItem>
                      );
                    })}
                  </SelectContent>
                </Select>
              </FormItem>
            )}
          />
        </CardContent>
      </Card>

      {/* Team Members */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle className="text-base flex items-center gap-2">
                <Users className="h-4 w-4" />
                Membri echipă
              </CardTitle>
              <CardDescription>
                {teamMemberFields.length === 0 
                  ? 'Nu ai adăugat încă membri' 
                  : `${teamMemberFields.length} membru${teamMemberFields.length !== 1 ? 'i' : ''} adăugat${teamMemberFields.length !== 1 ? 'i' : ''}`}
              </CardDescription>
            </div>
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={handleAddTeamMember}
            >
              <UserPlus className="h-4 w-4 mr-2" />
              Adaugă membru
            </Button>
          </div>
        </CardHeader>
        <CardContent>
          {teamMemberFields.length === 0 ? (
            <div className="text-center py-8 text-muted-foreground">
              <Users className="h-12 w-12 mx-auto mb-4 opacity-50" />
              <p>Nu ai adăugat încă membri în echipă</p>
              <p className="text-sm">
                Poți să sari peste acest pas și să îi adaugi mai târziu
              </p>
            </div>
          ) : (
            <div className="space-y-4">
              {teamMemberFields.map((field, index) => (
                <div 
                  key={field.id}
                  className="p-4 border rounded-lg space-y-4"
                >
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium flex items-center gap-2">
                      <Avatar className="h-6 w-6">
                        <AvatarFallback className="text-xs">
                          {form.watch(`team.members.${index}.firstName`)?.[0] || '?'}
                          {form.watch(`team.members.${index}.lastName`)?.[0] || '?'}
                        </AvatarFallback>
                      </Avatar>
                      Membru #{index + 1}
                    </span>
                    <Button
                      type="button"
                      variant="ghost"
                      size="sm"
                      onClick={() => removeTeamMember(index)}
                    >
                      <Trash2 className="h-4 w-4 text-red-500" />
                    </Button>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name={`team.members.${index}.firstName`}
                      render={({ field: inputField }) => (
                        <FormItem>
                          <FormLabel>Prenume *</FormLabel>
                          <FormControl>
                            <Input placeholder="Ion" {...inputField} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name={`team.members.${index}.lastName`}
                      render={({ field: inputField }) => (
                        <FormItem>
                          <FormLabel>Nume *</FormLabel>
                          <FormControl>
                            <Input placeholder="Popescu" {...inputField} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name={`team.members.${index}.email`}
                      render={({ field: inputField }) => (
                        <FormItem>
                          <FormLabel>Email *</FormLabel>
                          <FormControl>
                            <Input 
                              type="email" 
                              placeholder="ion.popescu@firma.ro" 
                              {...inputField} 
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name={`team.members.${index}.role`}
                      render={({ field: selectField }) => (
                        <FormItem>
                          <FormLabel>Rol *</FormLabel>
                          <Select 
                            onValueChange={selectField.onChange} 
                            value={selectField.value}
                          >
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              {USER_ROLES.map((role) => {
                                const IconComponent = role.icon;
                                return (
                                  <SelectItem key={role.value} value={role.value}>
                                    <div className="flex items-center gap-2">
                                      <IconComponent className={cn("h-4 w-4", role.color)} />
                                      <span>{role.label}</span>
                                    </div>
                                  </SelectItem>
                                );
                              })}
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <FormField
                    control={form.control}
                    name={`team.members.${index}.sendInvite`}
                    render={({ field: checkField }) => (
                      <FormItem className="flex items-center gap-2 space-y-0">
                        <FormControl>
                          <Checkbox
                            checked={checkField.value}
                            onCheckedChange={checkField.onChange}
                          />
                        </FormControl>
                        <FormLabel className="text-sm font-normal">
                          <Send className="h-3 w-3 inline mr-1" />
                          Trimite invitație pe email
                        </FormLabel>
                      </FormItem>
                    )}
                  />
                </div>
              ))}

              <Button
                type="button"
                variant="outline"
                onClick={handleAddTeamMember}
                className="w-full"
              >
                <Plus className="h-4 w-4 mr-2" />
                Adaugă alt membru
              </Button>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Role Permissions Info */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base flex items-center gap-2">
            <Shield className="h-4 w-4" />
            Permisiuni roluri
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {USER_ROLES.map((role) => {
              const IconComponent = role.icon;
              return (
                <div 
                  key={role.value}
                  className="flex items-start gap-3 p-2 rounded-lg hover:bg-muted/50"
                >
                  <IconComponent className={cn("h-5 w-5 mt-0.5", role.color)} />
                  <div>
                    <p className="font-medium text-sm">{role.label}</p>
                    <p className="text-xs text-muted-foreground">
                      {role.description}
                    </p>
                  </div>
                </div>
              );
            })}
          </div>
        </CardContent>
      </Card>
    </div>
  );

  // -------------------------------------------------------------------------
  // Step 3: Settings
  // -------------------------------------------------------------------------
  const renderSettingsStep = () => (
    <div className="space-y-6">
      {/* Regional Settings */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base flex items-center gap-2">
            <Globe className="h-4 w-4" />
            Setări regionale
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <FormField
              control={form.control}
              name="settings.language"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Limbă</FormLabel>
                  <Select onValueChange={field.onChange} value={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="ro">Română</SelectItem>
                      <SelectItem value="en">English</SelectItem>
                    </SelectContent>
                  </Select>
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="settings.timezone"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Fus orar</FormLabel>
                  <Select onValueChange={field.onChange} value={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="Europe/Bucharest">București (GMT+2/3)</SelectItem>
                      <SelectItem value="Europe/London">Londra (GMT+0/1)</SelectItem>
                      <SelectItem value="Europe/Paris">Paris (GMT+1/2)</SelectItem>
                      <SelectItem value="America/New_York">New York (GMT-5/-4)</SelectItem>
                      <SelectItem value="UTC">UTC</SelectItem>
                    </SelectContent>
                  </Select>
                </FormItem>
              )}
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <FormField
              control={form.control}
              name="settings.currency"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Monedă implicită</FormLabel>
                  <Select onValueChange={field.onChange} value={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="RON">RON (Lei)</SelectItem>
                      <SelectItem value="EUR">EUR (Euro)</SelectItem>
                      <SelectItem value="USD">USD (Dolari)</SelectItem>
                    </SelectContent>
                  </Select>
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="settings.dateFormat"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Format dată</FormLabel>
                  <Select onValueChange={field.onChange} value={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="DD/MM/YYYY">DD/MM/YYYY</SelectItem>
                      <SelectItem value="MM/DD/YYYY">MM/DD/YYYY</SelectItem>
                      <SelectItem value="YYYY-MM-DD">YYYY-MM-DD</SelectItem>
                    </SelectContent>
                  </Select>
                </FormItem>
              )}
            />
          </div>
        </CardContent>
      </Card>

      {/* Negotiation Defaults */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base flex items-center gap-2">
            <FileText className="h-4 w-4" />
            Setări negocieri
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <FormField
              control={form.control}
              name="settings.defaultPaymentTerms"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Termen plată implicit (zile)</FormLabel>
                  <FormControl>
                    <Input 
                      type="number" 
                      min={0}
                      max={180}
                      {...field}
                      onChange={(e) => field.onChange(parseInt(e.target.value))}
                    />
                  </FormControl>
                  <FormDescription>0-180 zile</FormDescription>
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="settings.defaultValidityDays"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Valabilitate ofertă (zile)</FormLabel>
                  <FormControl>
                    <Input 
                      type="number" 
                      min={1}
                      max={90}
                      {...field}
                      onChange={(e) => field.onChange(parseInt(e.target.value))}
                    />
                  </FormControl>
                  <FormDescription>1-90 zile</FormDescription>
                </FormItem>
              )}
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <FormField
              control={form.control}
              name="settings.defaultDiscountApprovalThreshold"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Prag aprobare discount (%)</FormLabel>
                  <FormControl>
                    <Input 
                      type="number" 
                      min={0}
                      max={50}
                      {...field}
                      onChange={(e) => field.onChange(parseInt(e.target.value))}
                    />
                  </FormControl>
                  <FormDescription>
                    Peste acest procent este necesară aprobarea
                  </FormDescription>
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="settings.autoArchiveCompletedDays"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Auto-arhivare după (zile)</FormLabel>
                  <FormControl>
                    <Input 
                      type="number" 
                      min={0}
                      max={365}
                      {...field}
                      onChange={(e) => field.onChange(parseInt(e.target.value))}
                    />
                  </FormControl>
                  <FormDescription>0 = dezactivat</FormDescription>
                </FormItem>
              )}
            />
          </div>
        </CardContent>
      </Card>

      {/* AI Settings */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base flex items-center gap-2">
            <Sparkles className="h-4 w-4" />
            Setări AI
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <FormField
            control={form.control}
            name="settings.aiEnabled"
            render={({ field }) => (
              <FormItem className="flex items-center justify-between rounded-lg border p-3">
                <div className="space-y-0.5">
                  <FormLabel>Activează AI Agent</FormLabel>
                  <FormDescription>
                    Permite agentului AI să proceseze și să răspundă automat
                  </FormDescription>
                </div>
                <FormControl>
                  <Switch
                    checked={field.value}
                    onCheckedChange={field.onChange}
                  />
                </FormControl>
              </FormItem>
            )}
          />

          {form.watch('settings.aiEnabled') && (
            <>
              <div className="grid grid-cols-2 gap-4">
                <FormField
                  control={form.control}
                  name="settings.aiModel"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Model AI</FormLabel>
                      <Select onValueChange={field.onChange} value={field.value}>
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          <SelectItem value="claude-3-5-haiku">
                            Claude 3.5 Haiku (rapid, economic)
                          </SelectItem>
                          <SelectItem value="claude-sonnet-4">
                            Claude Sonnet 4 (echilibrat)
                          </SelectItem>
                          <SelectItem value="claude-opus-4">
                            Claude Opus 4 (avansat)
                          </SelectItem>
                        </SelectContent>
                      </Select>
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="settings.aiAutoApproveThreshold"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Prag auto-aprobare (%)</FormLabel>
                      <FormControl>
                        <Input 
                          type="number" 
                          min={50}
                          max={100}
                          {...field}
                          onChange={(e) => field.onChange(parseInt(e.target.value))}
                        />
                      </FormControl>
                      <FormDescription>
                        Răspunsuri cu încredere peste acest prag sunt auto-aprobate
                      </FormDescription>
                    </FormItem>
                  )}
                />
              </div>

              <FormField
                control={form.control}
                name="settings.aiGuardrailsProfile"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Profil guardrails</FormLabel>
                    <Select onValueChange={field.onChange} value={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        <SelectItem value="strict">
                          Strict - Verificare maximă, rate HITL ridicată
                        </SelectItem>
                        <SelectItem value="balanced">
                          Echilibrat - Balanță între automatizare și control
                        </SelectItem>
                        <SelectItem value="permissive">
                          Permisiv - Automatizare maximă, intervenție minimă
                        </SelectItem>
                      </SelectContent>
                    </Select>
                  </FormItem>
                )}
              />
            </>
          )}
        </CardContent>
      </Card>

      {/* Notifications */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base flex items-center gap-2">
            <Mail className="h-4 w-4" />
            Notificări
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          <FormField
            control={form.control}
            name="settings.emailNotifications"
            render={({ field }) => (
              <FormItem className="flex items-center justify-between">
                <FormLabel className="font-normal">Notificări email</FormLabel>
                <FormControl>
                  <Switch
                    checked={field.value}
                    onCheckedChange={field.onChange}
                  />
                </FormControl>
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="settings.pushNotifications"
            render={({ field }) => (
              <FormItem className="flex items-center justify-between">
                <FormLabel className="font-normal">Notificări push</FormLabel>
                <FormControl>
                  <Switch
                    checked={field.value}
                    onCheckedChange={field.onChange}
                  />
                </FormControl>
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="settings.dailyDigest"
            render={({ field }) => (
              <FormItem className="flex items-center justify-between">
                <FormLabel className="font-normal">Rezumat zilnic</FormLabel>
                <FormControl>
                  <Switch
                    checked={field.value}
                    onCheckedChange={field.onChange}
                  />
                </FormControl>
              </FormItem>
            )}
          />
        </CardContent>
      </Card>

      {/* Security */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base flex items-center gap-2">
            <Shield className="h-4 w-4" />
            Securitate
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <FormField
            control={form.control}
            name="settings.requireTwoFactor"
            render={({ field }) => (
              <FormItem className="flex items-center justify-between">
                <div className="space-y-0.5">
                  <FormLabel className="font-normal">Autentificare 2FA obligatorie</FormLabel>
                  <FormDescription>
                    Toți utilizatorii vor trebui să configureze 2FA
                  </FormDescription>
                </div>
                <FormControl>
                  <Switch
                    checked={field.value}
                    onCheckedChange={field.onChange}
                  />
                </FormControl>
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="settings.sessionTimeoutMinutes"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Timeout sesiune (minute)</FormLabel>
                <FormControl>
                  <Input 
                    type="number" 
                    min={15}
                    max={480}
                    {...field}
                    onChange={(e) => field.onChange(parseInt(e.target.value))}
                  />
                </FormControl>
                <FormDescription>15-480 minute</FormDescription>
              </FormItem>
            )}
          />
        </CardContent>
      </Card>
    </div>
  );

  // -------------------------------------------------------------------------
  // Step 4: Integrations
  // -------------------------------------------------------------------------
  const renderIntegrationsStep = () => (
    <div className="space-y-6">
      <Alert>
        <Info className="h-4 w-4" />
        <AlertDescription>
          Configurează integrările cu servicii externe. Toate integrările pot fi 
          modificate ulterior din setări. Integrările marcate ca opționale nu sunt 
          necesare pentru funcționarea de bază.
        </AlertDescription>
      </Alert>

      {/* ANAF Integration */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle className="text-base flex items-center gap-2">
              <Building2 className="h-4 w-4" />
              ANAF - Date fiscale
              <Badge variant="secondary">Recomandat</Badge>
            </CardTitle>
            <FormField
              control={form.control}
              name="integrations.anaf.enabled"
              render={({ field }) => (
                <FormControl>
                  <Switch
                    checked={field.value}
                    onCheckedChange={field.onChange}
                  />
                </FormControl>
              )}
            />
          </div>
          <CardDescription>
            Verificare automată date fiscale companii din România
          </CardDescription>
        </CardHeader>
        {form.watch('integrations.anaf.enabled') && (
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="integrations.anaf.autoSync"
              render={({ field }) => (
                <FormItem className="flex items-center justify-between">
                  <FormLabel className="font-normal">Sincronizare automată</FormLabel>
                  <FormControl>
                    <Switch
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                </FormItem>
              )}
            />

            {form.watch('integrations.anaf.autoSync') && (
              <FormField
                control={form.control}
                name="integrations.anaf.syncFrequency"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Frecvență sincronizare</FormLabel>
                    <Select onValueChange={field.onChange} value={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        <SelectItem value="daily">Zilnic</SelectItem>
                        <SelectItem value="weekly">Săptămânal</SelectItem>
                        <SelectItem value="manual">Manual</SelectItem>
                      </SelectContent>
                    </Select>
                  </FormItem>
                )}
              />
            )}
          </CardContent>
        )}
      </Card>

      {/* e-Factura Integration */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle className="text-base flex items-center gap-2">
              <FileText className="h-4 w-4" />
              e-Factura SPV
              <Badge variant="outline">Opțional</Badge>
            </CardTitle>
            <FormField
              control={form.control}
              name="integrations.efactura.enabled"
              render={({ field }) => (
                <FormControl>
                  <Switch
                    checked={field.value}
                    onCheckedChange={field.onChange}
                  />
                </FormControl>
              )}
            />
          </div>
          <CardDescription>
            Transmitere facturi electronice prin sistemul ANAF SPV
          </CardDescription>
        </CardHeader>
        {form.watch('integrations.efactura.enabled') && (
          <CardContent className="space-y-4">
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertDescription>
                Configurarea e-Factura necesită un certificat digital valid. 
                Poți configura acest serviciu ulterior din setări.
              </AlertDescription>
            </Alert>

            <FormField
              control={form.control}
              name="integrations.efactura.testMode"
              render={({ field }) => (
                <FormItem className="flex items-center justify-between">
                  <div className="space-y-0.5">
                    <FormLabel className="font-normal">Mod test</FormLabel>
                    <FormDescription>
                      Trimite către mediul de test ANAF
                    </FormDescription>
                  </div>
                  <FormControl>
                    <Switch
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                </FormItem>
              )}
            />
          </CardContent>
        )}
      </Card>

      {/* Oblio Integration */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle className="text-base flex items-center gap-2">
              <FileText className="h-4 w-4" />
              Oblio.eu
              <Badge variant="outline">Opțional</Badge>
            </CardTitle>
            <FormField
              control={form.control}
              name="integrations.oblio.enabled"
              render={({ field }) => (
                <FormControl>
                  <Switch
                    checked={field.value}
                    onCheckedChange={field.onChange}
                  />
                </FormControl>
              )}
            />
          </div>
          <CardDescription>
            Generare facturi prin Oblio.eu cu suport e-Factura
          </CardDescription>
        </CardHeader>
        {form.watch('integrations.oblio.enabled') && (
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="integrations.oblio.apiKey"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>API Key</FormLabel>
                  <div className="flex gap-2">
                    <FormControl>
                      <Input 
                        type={showPassword['oblio'] ? 'text' : 'password'}
                        placeholder="Oblio API Key"
                        {...field}
                      />
                    </FormControl>
                    <Button
                      type="button"
                      variant="ghost"
                      size="icon"
                      onClick={() => togglePasswordVisibility('oblio')}
                    >
                      {showPassword['oblio'] ? (
                        <EyeOff className="h-4 w-4" />
                      ) : (
                        <Eye className="h-4 w-4" />
                      )}
                    </Button>
                  </div>
                  <FormDescription>
                    <a 
                      href="https://www.oblio.eu/api" 
                      target="_blank" 
                      rel="noopener noreferrer"
                      className="text-primary hover:underline inline-flex items-center gap-1"
                    >
                      Obține API Key <ExternalLink className="h-3 w-3" />
                    </a>
                  </FormDescription>
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="integrations.oblio.companyName"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Nume companie în Oblio</FormLabel>
                  <FormControl>
                    <Input placeholder="Numele exact din Oblio" {...field} />
                  </FormControl>
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="integrations.oblio.autoInvoice"
              render={({ field }) => (
                <FormItem className="flex items-center justify-between">
                  <FormLabel className="font-normal">
                    Generare automată facturi la finalizarea negocierii
                  </FormLabel>
                  <FormControl>
                    <Switch
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                </FormItem>
              )}
            />
          </CardContent>
        )}
      </Card>

      {/* Email Integration */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle className="text-base flex items-center gap-2">
              <Mail className="h-4 w-4" />
              Email (SMTP)
              <Badge variant="secondary">Recomandat</Badge>
            </CardTitle>
            <FormField
              control={form.control}
              name="integrations.email.enabled"
              render={({ field }) => (
                <FormControl>
                  <Switch
                    checked={field.value}
                    onCheckedChange={field.onChange}
                  />
                </FormControl>
              )}
            />
          </div>
          <CardDescription>
            Configurare email pentru notificări și comunicare cu clienții
          </CardDescription>
        </CardHeader>
        {form.watch('integrations.email.enabled') && (
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="integrations.email.provider"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Provider</FormLabel>
                  <Select onValueChange={field.onChange} value={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="smtp">SMTP Custom</SelectItem>
                      <SelectItem value="sendgrid">SendGrid</SelectItem>
                      <SelectItem value="mailgun">Mailgun</SelectItem>
                      <SelectItem value="ses">Amazon SES</SelectItem>
                    </SelectContent>
                  </Select>
                </FormItem>
              )}
            />

            {form.watch('integrations.email.provider') === 'smtp' && (
              <>
                <div className="grid grid-cols-2 gap-4">
                  <FormField
                    control={form.control}
                    name="integrations.email.smtpHost"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>SMTP Host</FormLabel>
                        <FormControl>
                          <Input placeholder="smtp.gmail.com" {...field} />
                        </FormControl>
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="integrations.email.smtpPort"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Port</FormLabel>
                        <FormControl>
                          <Input 
                            type="number" 
                            placeholder="587" 
                            {...field}
                            onChange={(e) => field.onChange(parseInt(e.target.value))}
                          />
                        </FormControl>
                      </FormItem>
                    )}
                  />
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <FormField
                    control={form.control}
                    name="integrations.email.smtpUser"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Username</FormLabel>
                        <FormControl>
                          <Input placeholder="user@gmail.com" {...field} />
                        </FormControl>
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="integrations.email.smtpPassword"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Password</FormLabel>
                        <div className="flex gap-2">
                          <FormControl>
                            <Input 
                              type={showPassword['smtp'] ? 'text' : 'password'}
                              {...field}
                            />
                          </FormControl>
                          <Button
                            type="button"
                            variant="ghost"
                            size="icon"
                            onClick={() => togglePasswordVisibility('smtp')}
                          >
                            {showPassword['smtp'] ? (
                              <EyeOff className="h-4 w-4" />
                            ) : (
                              <Eye className="h-4 w-4" />
                            )}
                          </Button>
                        </div>
                      </FormItem>
                    )}
                  />
                </div>
              </>
            )}

            <Separator />

            <div className="grid grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="integrations.email.fromAddress"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Adresă expeditor</FormLabel>
                    <FormControl>
                      <Input 
                        type="email" 
                        placeholder="noreply@firma.ro" 
                        {...field} 
                      />
                    </FormControl>
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="integrations.email.fromName"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Nume expeditor</FormLabel>
                    <FormControl>
                      <Input placeholder="Firma SRL" {...field} />
                    </FormControl>
                  </FormItem>
                )}
              />
            </div>
          </CardContent>
        )}
      </Card>

      {/* Hunter.io Integration */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle className="text-base flex items-center gap-2">
              <Mail className="h-4 w-4" />
              Hunter.io
              <Badge variant="outline">Opțional</Badge>
            </CardTitle>
            <FormField
              control={form.control}
              name="integrations.hunter.enabled"
              render={({ field }) => (
                <FormControl>
                  <Switch
                    checked={field.value}
                    onCheckedChange={field.onChange}
                  />
                </FormControl>
              )}
            />
          </div>
          <CardDescription>
            Validare și îmbogățire adrese email
          </CardDescription>
        </CardHeader>
        {form.watch('integrations.hunter.enabled') && (
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="integrations.hunter.apiKey"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>API Key</FormLabel>
                  <div className="flex gap-2">
                    <FormControl>
                      <Input 
                        type={showPassword['hunter'] ? 'text' : 'password'}
                        placeholder="Hunter.io API Key"
                        {...field}
                      />
                    </FormControl>
                    <Button
                      type="button"
                      variant="ghost"
                      size="icon"
                      onClick={() => togglePasswordVisibility('hunter')}
                    >
                      {showPassword['hunter'] ? (
                        <EyeOff className="h-4 w-4" />
                      ) : (
                        <Eye className="h-4 w-4" />
                      )}
                    </Button>
                  </div>
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="integrations.hunter.monthlyQuota"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Cotă lunară</FormLabel>
                  <FormControl>
                    <Input 
                      type="number" 
                      min={0}
                      {...field}
                      onChange={(e) => field.onChange(parseInt(e.target.value))}
                    />
                  </FormControl>
                  <FormDescription>Verificări email pe lună</FormDescription>
                </FormItem>
              )}
            />
          </CardContent>
        )}
      </Card>

      {/* Termene.ro Integration */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle className="text-base flex items-center gap-2">
              <Building2 className="h-4 w-4" />
              Termene.ro
              <Badge variant="outline">Opțional</Badge>
            </CardTitle>
            <FormField
              control={form.control}
              name="integrations.termene.enabled"
              render={({ field }) => (
                <FormControl>
                  <Switch
                    checked={field.value}
                    onCheckedChange={field.onChange}
                  />
                </FormControl>
              )}
            />
          </div>
          <CardDescription>
            Date extinse despre companii românești
          </CardDescription>
        </CardHeader>
        {form.watch('integrations.termene.enabled') && (
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="integrations.termene.apiKey"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>API Key</FormLabel>
                  <div className="flex gap-2">
                    <FormControl>
                      <Input 
                        type={showPassword['termene'] ? 'text' : 'password'}
                        placeholder="Termene.ro API Key"
                        {...field}
                      />
                    </FormControl>
                    <Button
                      type="button"
                      variant="ghost"
                      size="icon"
                      onClick={() => togglePasswordVisibility('termene')}
                    >
                      {showPassword['termene'] ? (
                        <EyeOff className="h-4 w-4" />
                      ) : (
                        <Eye className="h-4 w-4" />
                      )}
                    </Button>
                  </div>
                </FormItem>
              )}
            />
          </CardContent>
        )}
      </Card>
    </div>
  );

  // -------------------------------------------------------------------------
  // Step 5: Finish/Review
  // -------------------------------------------------------------------------
  const renderFinishStep = () => {
    const values = form.getValues();
    
    if (completionResult) {
      // Show completion screen
      return (
        <div className="text-center py-8 space-y-6">
          <div className="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center">
            <CheckCircle2 className="h-8 w-8 text-green-600" />
          </div>
          
          <div className="space-y-2">
            <h3 className="text-xl font-semibold">Contul a fost creat cu succes!</h3>
            <p className="text-muted-foreground">
              Bine ai venit în Cerniq. Contul tău este gata de utilizare.
            </p>
          </div>

          {/* Summary Cards */}
          <div className="grid grid-cols-2 gap-4 max-w-md mx-auto">
            <Card className="text-center">
              <CardContent className="pt-4">
                <p className="text-3xl font-bold text-primary">
                  {completionResult.tenantId.slice(0, 8)}...
                </p>
                <p className="text-sm text-muted-foreground">ID Cont</p>
              </CardContent>
            </Card>
            <Card className="text-center">
              <CardContent className="pt-4">
                <p className="text-3xl font-bold text-blue-600">
                  {completionResult.invitesSent}
                </p>
                <p className="text-sm text-muted-foreground">Invitații trimise</p>
              </CardContent>
            </Card>
          </div>

          {/* Errors if any */}
          {completionResult.errors && completionResult.errors.length > 0 && (
            <Alert variant="destructive" className="max-w-md mx-auto">
              <AlertCircle className="h-4 w-4" />
              <AlertDescription>
                <div className="space-y-1">
                  {completionResult.errors.map((error, index) => (
                    <p key={index}>{error}</p>
                  ))}
                </div>
              </AlertDescription>
            </Alert>
          )}

          {/* Next Steps */}
          <Card className="max-w-md mx-auto text-left">
            <CardHeader>
              <CardTitle className="text-base">Pași următori</CardTitle>
            </CardHeader>
            <CardContent>
              <ul className="space-y-2">
                <li className="flex items-center gap-2 text-sm">
                  <CheckCircle2 className="h-4 w-4 text-green-500" />
                  Explorează dashboard-ul
                </li>
                <li className="flex items-center gap-2 text-sm">
                  <CheckCircle2 className="h-4 w-4 text-green-500" />
                  Adaugă primul tău contact
                </li>
                <li className="flex items-center gap-2 text-sm">
                  <CheckCircle2 className="h-4 w-4 text-green-500" />
                  Importă catalogul de produse
                </li>
                <li className="flex items-center gap-2 text-sm">
                  <CheckCircle2 className="h-4 w-4 text-green-500" />
                  Pornește prima negociere AI
                </li>
              </ul>
            </CardContent>
          </Card>
        </div>
      );
    }

    // Show review screen
    return (
      <div className="space-y-6">
        <Alert>
          <Info className="h-4 w-4" />
          <AlertDescription>
            Verifică informațiile și confirmă pentru a finaliza configurarea contului.
          </AlertDescription>
        </Alert>

        {/* Company Summary */}
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <CardTitle className="text-base flex items-center gap-2">
                <Building2 className="h-4 w-4" />
                Companie
              </CardTitle>
              <Button
                type="button"
                variant="ghost"
                size="sm"
                onClick={() => setCurrentStep(0)}
              >
                Modifică
              </Button>
            </div>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div>
                <p className="text-muted-foreground">Denumire</p>
                <p className="font-medium">{values.companyProfile.companyName}</p>
              </div>
              <div>
                <p className="text-muted-foreground">CUI</p>
                <p className="font-medium font-mono">{values.companyProfile.cui}</p>
              </div>
              <div>
                <p className="text-muted-foreground">Email</p>
                <p className="font-medium">{values.companyProfile.email}</p>
              </div>
              <div>
                <p className="text-muted-foreground">Domeniu</p>
                <p className="font-medium">
                  {INDUSTRIES.find(i => i.value === values.companyProfile.industry)?.label}
                </p>
              </div>
              <div className="col-span-2">
                <p className="text-muted-foreground">Adresă</p>
                <p className="font-medium">
                  {values.companyProfile.address.street}, {values.companyProfile.address.city}, 
                  {values.companyProfile.address.county}, {values.companyProfile.address.postalCode}
                </p>
              </div>
              <div className="col-span-2">
                <p className="text-muted-foreground">Conturi bancare</p>
                <p className="font-medium">
                  {values.companyProfile.bankAccounts.length} cont{values.companyProfile.bankAccounts.length !== 1 ? 'uri' : ''}
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Team Summary */}
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <CardTitle className="text-base flex items-center gap-2">
                <Users className="h-4 w-4" />
                Echipă
              </CardTitle>
              <Button
                type="button"
                variant="ghost"
                size="sm"
                onClick={() => setCurrentStep(1)}
              >
                Modifică
              </Button>
            </div>
          </CardHeader>
          <CardContent>
            {values.team.members.length === 0 ? (
              <p className="text-sm text-muted-foreground">
                Nu ai adăugat membri în echipă. Poți invita membri ulterior.
              </p>
            ) : (
              <div className="space-y-2">
                {values.team.members.map((member, index) => (
                  <div 
                    key={index}
                    className="flex items-center justify-between p-2 rounded-lg bg-muted/50"
                  >
                    <div className="flex items-center gap-3">
                      <Avatar className="h-8 w-8">
                        <AvatarFallback className="text-xs">
                          {member.firstName[0]}{member.lastName[0]}
                        </AvatarFallback>
                      </Avatar>
                      <div>
                        <p className="text-sm font-medium">
                          {member.firstName} {member.lastName}
                        </p>
                        <p className="text-xs text-muted-foreground">{member.email}</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <Badge variant="outline">
                        {USER_ROLES.find(r => r.value === member.role)?.label}
                      </Badge>
                      {member.sendInvite && (
                        <Tooltip>
                          <TooltipTrigger>
                            <Send className="h-3 w-3 text-muted-foreground" />
                          </TooltipTrigger>
                          <TooltipContent>Invitație email</TooltipContent>
                        </Tooltip>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>

        {/* Settings Summary */}
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <CardTitle className="text-base flex items-center gap-2">
                <Settings className="h-4 w-4" />
                Setări
              </CardTitle>
              <Button
                type="button"
                variant="ghost"
                size="sm"
                onClick={() => setCurrentStep(2)}
              >
                Modifică
              </Button>
            </div>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-3 gap-4 text-sm">
              <div>
                <p className="text-muted-foreground">Monedă</p>
                <p className="font-medium">{values.settings.currency}</p>
              </div>
              <div>
                <p className="text-muted-foreground">Termen plată</p>
                <p className="font-medium">{values.settings.defaultPaymentTerms} zile</p>
              </div>
              <div>
                <p className="text-muted-foreground">AI Agent</p>
                <p className="font-medium">
                  {values.settings.aiEnabled ? 'Activ' : 'Inactiv'}
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Integrations Summary */}
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <CardTitle className="text-base flex items-center gap-2">
                <Plug className="h-4 w-4" />
                Integrări
              </CardTitle>
              <Button
                type="button"
                variant="ghost"
                size="sm"
                onClick={() => setCurrentStep(3)}
              >
                Modifică
              </Button>
            </div>
          </CardHeader>
          <CardContent>
            <div className="flex flex-wrap gap-2">
              {values.integrations.anaf.enabled && (
                <Badge variant="secondary">ANAF</Badge>
              )}
              {values.integrations.efactura.enabled && (
                <Badge variant="secondary">e-Factura</Badge>
              )}
              {values.integrations.oblio.enabled && (
                <Badge variant="secondary">Oblio</Badge>
              )}
              {values.integrations.email.enabled && (
                <Badge variant="secondary">Email</Badge>
              )}
              {values.integrations.hunter.enabled && (
                <Badge variant="secondary">Hunter.io</Badge>
              )}
              {values.integrations.termene.enabled && (
                <Badge variant="secondary">Termene.ro</Badge>
              )}
              {!Object.values(values.integrations).some(i => 
                typeof i === 'object' && 'enabled' in i && i.enabled
              ) && (
                <span className="text-sm text-muted-foreground">
                  Nicio integrare activată
                </span>
              )}
            </div>
          </CardContent>
        </Card>

        {/* Terms & Privacy */}
        <Card>
          <CardContent className="pt-6 space-y-4">
            <FormField
              control={form.control}
              name="acceptTerms"
              render={({ field }) => (
                <FormItem className="flex items-start gap-3 space-y-0">
                  <FormControl>
                    <Checkbox
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                  <div className="space-y-1 leading-none">
                    <FormLabel className="font-normal">
                      Accept{' '}
                      <a 
                        href="/terms" 
                        target="_blank"
                        className="text-primary hover:underline"
                      >
                        Termenii și Condițiile
                      </a>
                      {' '}de utilizare *
                    </FormLabel>
                    <FormMessage />
                  </div>
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="acceptPrivacy"
              render={({ field }) => (
                <FormItem className="flex items-start gap-3 space-y-0">
                  <FormControl>
                    <Checkbox
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                  <div className="space-y-1 leading-none">
                    <FormLabel className="font-normal">
                      Accept{' '}
                      <a 
                        href="/privacy" 
                        target="_blank"
                        className="text-primary hover:underline"
                      >
                        Politica de Confidențialitate
                      </a>
                      {' '}și prelucrarea datelor personale conform GDPR *
                    </FormLabel>
                    <FormMessage />
                  </div>
                </FormItem>
              )}
            />
          </CardContent>
        </Card>
      </div>
    );
  };

  // -------------------------------------------------------------------------
  // Main Render
  // -------------------------------------------------------------------------
  return (
    <Dialog open={open}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        {/* Header with Progress */}
        <DialogHeader className="pb-2">
          <DialogTitle className="text-xl">Configurare cont Cerniq</DialogTitle>
          <DialogDescription>
            {completionResult 
              ? 'Contul a fost configurat cu succes!'
              : `Pas ${currentStep + 1} din ${WIZARD_STEPS.length} - ${WIZARD_STEPS[currentStep].description}`
            }
          </DialogDescription>
          
          {/* Progress Bar */}
          {!completionResult && (
            <Progress value={progress} className="h-2 mt-4" />
          )}
        </DialogHeader>

        {/* Step Indicators */}
        {!completionResult && (
          <div className="flex justify-between px-4 py-2 border-b">
            {WIZARD_STEPS.map((step, index) => {
              const IconComponent = step.icon;
              const isCompleted = index < currentStep;
              const isCurrent = index === currentStep;
              
              return (
                <div 
                  key={step.id}
                  className={cn(
                    "flex items-center gap-2 text-sm",
                    isCompleted && "text-green-600",
                    isCurrent && "text-primary font-medium",
                    !isCompleted && !isCurrent && "text-muted-foreground"
                  )}
                >
                  <div className={cn(
                    "w-8 h-8 rounded-full flex items-center justify-center border-2",
                    isCompleted && "border-green-600 bg-green-50",
                    isCurrent && "border-primary bg-primary/10",
                    !isCompleted && !isCurrent && "border-muted"
                  )}>
                    {isCompleted ? (
                      <Check className="h-4 w-4" />
                    ) : (
                      <IconComponent className="h-4 w-4" />
                    )}
                  </div>
                  <span className="hidden md:inline">{step.title}</span>
                </div>
              );
            })}
          </div>
        )}

        {/* Content */}
        <Form {...form}>
          <form className="flex-1 overflow-hidden">
            <ScrollArea className="h-[calc(90vh-280px)] px-1">
              <div className="pr-4">
                {renderStepContent()}
              </div>
            </ScrollArea>
          </form>
        </Form>

        {/* Footer with Navigation */}
        {!completionResult && (
          <DialogFooter className="flex items-center justify-between border-t pt-4">
            <Button
              type="button"
              variant="outline"
              onClick={handlePrevious}
              disabled={currentStep === 0 || isProcessing}
            >
              <ChevronLeft className="h-4 w-4 mr-1" />
              Înapoi
            </Button>

            <div className="flex items-center gap-2">
              {/* Step indicator */}
              <span className="text-sm text-muted-foreground mr-4">
                {currentStep + 1} / {WIZARD_STEPS.length}
              </span>

              {currentStep < WIZARD_STEPS.length - 1 ? (
                <Button
                  type="button"
                  onClick={handleNext}
                  disabled={isProcessing}
                >
                  Continuă
                  <ChevronRight className="h-4 w-4 ml-1" />
                </Button>
              ) : (
                <Button
                  type="button"
                  onClick={handleComplete}
                  disabled={isProcessing || !form.watch('acceptTerms') || !form.watch('acceptPrivacy')}
                >
                  {isProcessing ? (
                    <>
                      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                      Se creează contul...
                    </>
                  ) : (
                    <>
                      <CheckCircle2 className="h-4 w-4 mr-2" />
                      Finalizează configurarea
                    </>
                  )}
                </Button>
              )}
            </div>
          </DialogFooter>
        )}

        {/* Completion Footer */}
        {completionResult && (
          <DialogFooter className="border-t pt-4">
            <Button
              type="button"
              onClick={() => window.location.href = '/dashboard'}
              className="w-full"
            >
              <Zap className="h-4 w-4 mr-2" />
              Începe să folosești Cerniq
            </Button>
          </DialogFooter>
        )}
      </DialogContent>
    </Dialog>
  );
}

// =============================================================================
// USAGE EXAMPLE
// =============================================================================

function OnboardingWizardExample() {
  const [showOnboarding, setShowOnboarding] = useState(true);

  const handleCuiLookup = async (cui: string) => {
    // Simulate API call to ANAF/ONRC
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // Return mock data
    if (cui === 'RO12345678' || cui === '12345678') {
      return {
        companyName: 'SC AGRICOM SRL',
        address: 'Str. Fermei nr. 15',
        city: 'București',
        county: 'București',
      };
    }
    return null;
  };

  const handleComplete = async (data: OnboardingFormValues) => {
    // Simulate API call
    console.log('Onboarding data:', data);
    await new Promise(resolve => setTimeout(resolve, 2000));

    // POST /api/v1/tenants/onboard
    const response = await fetch('/api/v1/tenants/onboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });

    if (!response.ok) {
      throw new Error('Failed to create tenant');
    }

    const result = await response.json();
    return {
      tenantId: result.id,
      invitesSent: data.team.members.filter(m => m.sendInvite).length,
      errors: result.warnings || [],
    };
  };

  return (
    <OnboardingWizard
      open={showOnboarding}
      onComplete={handleComplete}
      cuiLookup={handleCuiLookup}
    />
  );
}
```

#### API Endpoints pentru OnboardingWizard

```typescript
// POST /api/v1/tenants/onboard - Creare tenant nou cu onboarding complet
// Request Body: OnboardingFormValues
// Response: { id: string, invitesSent: number, warnings?: string[] }

// POST /api/v1/tenants/lookup-cui - Căutare date companie după CUI
// Request Body: { cui: string }
// Response: { companyName, address, city, county } | null
```

---

## 14. Form Testing

Această secțiune documentează strategiile și implementările pentru testarea formularelor și dialogurilor.

### 14.1 Testing Strategy Overview

```typescript
// testing/forms/strategy.ts

/**
 * Form Testing Strategy pentru Etapa 3 - AI Sales Agent
 * 
 * Strategia de testare acoperă:
 * 1. Unit Tests - Validare Zod schemas
 * 2. Component Tests - Rendering și interacțiuni
 * 3. Integration Tests - Form submission flows
 * 4. E2E Tests - Complete user journeys
 * 5. Accessibility Tests - A11y compliance
 */

export const TESTING_STRATEGY = {
  // Unit Testing - Vitest
  unit: {
    coverage: {
      schemas: 100, // All Zod schemas must be 100% covered
      utilities: 90,
      helpers: 90,
    },
    tools: ['vitest', '@testing-library/react'],
  },
  
  // Component Testing - Vitest + Testing Library
  component: {
    coverage: {
      forms: 85,
      dialogs: 85,
      wizards: 80,
    },
    tools: ['vitest', '@testing-library/react', '@testing-library/user-event'],
  },
  
  // Integration Testing - Vitest + MSW
  integration: {
    coverage: {
      formSubmission: 80,
      apiInteraction: 80,
      stateManagement: 75,
    },
    tools: ['vitest', 'msw', '@testing-library/react'],
  },
  
  // E2E Testing - Playwright
  e2e: {
    coverage: {
      criticalPaths: 90,
      happyPaths: 85,
      errorPaths: 70,
    },
    tools: ['playwright'],
  },
  
  // Accessibility Testing
  accessibility: {
    tools: ['@testing-library/jest-dom', 'axe-core', '@axe-core/playwright'],
    standards: ['WCAG 2.1 AA'],
  },
};
```

### 14.2 Schema Validation Tests

```typescript
// testing/forms/schemas.test.ts
import { describe, it, expect } from 'vitest';
import { z } from 'zod';
import {
  negotiationSchema,
  productSchema,
  discountSchema,
  documentSchema,
  aiConfigSchema,
  guardrailSchema,
  hitlApprovalSchema,
  integrationSchema,
  userSettingsSchema,
  tenantSettingsSchema,
} from '@/lib/schemas';

// =============================================================================
// NEGOTIATION SCHEMA TESTS
// =============================================================================

describe('NegotiationSchema', () => {
  describe('valid inputs', () => {
    it('should accept valid negotiation data', () => {
      const validData = {
        contactId: 'uuid-123',
        title: 'Negociere test',
        products: [
          {
            productId: 'prod-1',
            quantity: 10,
            unitPrice: 100,
            discount: 5,
          },
        ],
        settings: {
          currency: 'RON',
          paymentTerms: 30,
          validityDays: 14,
          deliveryTerms: 'DDP',
          priority: 'medium',
        },
      };

      const result = negotiationSchema.safeParse(validData);
      expect(result.success).toBe(true);
    });

    it('should accept minimal required fields', () => {
      const minimalData = {
        contactId: 'uuid-123',
        products: [
          {
            productId: 'prod-1',
            quantity: 1,
            unitPrice: 1,
          },
        ],
      };

      const result = negotiationSchema.safeParse(minimalData);
      expect(result.success).toBe(true);
    });

    it('should accept maximum discount at 100%', () => {
      const data = {
        contactId: 'uuid-123',
        products: [
          {
            productId: 'prod-1',
            quantity: 1,
            unitPrice: 100,
            discount: 100,
          },
        ],
      };

      const result = negotiationSchema.safeParse(data);
      expect(result.success).toBe(true);
    });
  });

  describe('invalid inputs', () => {
    it('should reject missing contactId', () => {
      const invalidData = {
        products: [
          {
            productId: 'prod-1',
            quantity: 1,
            unitPrice: 100,
          },
        ],
      };

      const result = negotiationSchema.safeParse(invalidData);
      expect(result.success).toBe(false);
      if (!result.success) {
        expect(result.error.issues[0].path).toContain('contactId');
      }
    });

    it('should reject empty products array', () => {
      const invalidData = {
        contactId: 'uuid-123',
        products: [],
      };

      const result = negotiationSchema.safeParse(invalidData);
      expect(result.success).toBe(false);
    });

    it('should reject negative quantity', () => {
      const invalidData = {
        contactId: 'uuid-123',
        products: [
          {
            productId: 'prod-1',
            quantity: -1,
            unitPrice: 100,
          },
        ],
      };

      const result = negotiationSchema.safeParse(invalidData);
      expect(result.success).toBe(false);
    });

    it('should reject discount over 100%', () => {
      const invalidData = {
        contactId: 'uuid-123',
        products: [
          {
            productId: 'prod-1',
            quantity: 1,
            unitPrice: 100,
            discount: 101,
          },
        ],
      };

      const result = negotiationSchema.safeParse(invalidData);
      expect(result.success).toBe(false);
    });

    it('should reject invalid currency', () => {
      const invalidData = {
        contactId: 'uuid-123',
        products: [{ productId: 'prod-1', quantity: 1, unitPrice: 100 }],
        settings: {
          currency: 'BTC', // Invalid
          paymentTerms: 30,
        },
      };

      const result = negotiationSchema.safeParse(invalidData);
      expect(result.success).toBe(false);
    });
  });
});

// =============================================================================
// PRODUCT SCHEMA TESTS
// =============================================================================

describe('ProductSchema', () => {
  describe('valid inputs', () => {
    it('should accept complete product data', () => {
      const validProduct = {
        sku: 'PROD-001',
        name: 'Semințe porumb',
        category: 'Semințe',
        description: 'Descriere produs',
        basePrice: 150.50,
        currency: 'RON',
        unit: 'kg',
        vatRate: 9,
        minOrderQty: 100,
        stockQuantity: 5000,
        isActive: true,
      };

      const result = productSchema.safeParse(validProduct);
      expect(result.success).toBe(true);
    });

    it('should accept product with optional fields missing', () => {
      const minimalProduct = {
        sku: 'PROD-001',
        name: 'Test Product',
        basePrice: 100,
        unit: 'buc',
      };

      const result = productSchema.safeParse(minimalProduct);
      expect(result.success).toBe(true);
    });
  });

  describe('invalid inputs', () => {
    it('should reject empty SKU', () => {
      const invalidProduct = {
        sku: '',
        name: 'Test',
        basePrice: 100,
        unit: 'buc',
      };

      const result = productSchema.safeParse(invalidProduct);
      expect(result.success).toBe(false);
    });

    it('should reject negative price', () => {
      const invalidProduct = {
        sku: 'PROD-001',
        name: 'Test',
        basePrice: -100,
        unit: 'buc',
      };

      const result = productSchema.safeParse(invalidProduct);
      expect(result.success).toBe(false);
    });

    it('should reject invalid VAT rate', () => {
      const invalidProduct = {
        sku: 'PROD-001',
        name: 'Test',
        basePrice: 100,
        unit: 'buc',
        vatRate: 25, // Not in [0, 5, 9, 19]
      };

      const result = productSchema.safeParse(invalidProduct);
      expect(result.success).toBe(false);
    });
  });
});

// =============================================================================
// ROMANIAN SPECIFIC VALIDATION TESTS
// =============================================================================

describe('Romanian Validation', () => {
  const cuiSchema = z.string().regex(/^(RO)?[0-9]{2,10}$/);
  const ibanSchema = z.string().regex(/^RO[0-9]{2}[A-Z]{4}[A-Z0-9]{16}$/);
  const regComSchema = z.string().regex(/^J[0-9]{1,2}\/[0-9]{1,6}\/[0-9]{4}$/);
  const postalCodeSchema = z.string().regex(/^[0-9]{6}$/);
  const phoneSchema = z.string().regex(/^\+?[0-9]{10,15}$/);

  describe('CUI validation', () => {
    it.each([
      ['12345678', true],
      ['RO12345678', true],
      ['RO1234567890', true],
      ['12', true], // Minimum 2 digits
      ['RO', false], // No digits
      ['1', false], // Too short
      ['12345678901', false], // Too long
      ['ROABC123', false], // Letters in number
      ['RO 12345678', false], // Space
    ])('CUI "%s" should be valid: %s', (cui, expected) => {
      const result = cuiSchema.safeParse(cui);
      expect(result.success).toBe(expected);
    });
  });

  describe('IBAN validation', () => {
    it.each([
      ['RO49AAAA1B31007593840000', true],
      ['RO00BTRL0000000000000000', true],
      ['RO12BRDE410SV00000000001', true],
      ['DE89370400440532013000', false], // German IBAN
      ['RO49AAAA', false], // Too short
      ['ro49AAAA1B31007593840000', false], // Lowercase RO
      ['RO49aaaa1B31007593840000', false], // Lowercase bank code
    ])('IBAN "%s" should be valid: %s', (iban, expected) => {
      const result = ibanSchema.safeParse(iban);
      expect(result.success).toBe(expected);
    });
  });

  describe('Reg Com validation', () => {
    it.each([
      ['J40/1234/2020', true],
      ['J1/1/2000', true],
      ['J99/999999/2025', true],
      ['J40-1234-2020', false], // Wrong separator
      ['40/1234/2020', false], // Missing J
      ['J400/1234/2020', false], // County too long
    ])('Reg Com "%s" should be valid: %s', (regCom, expected) => {
      const result = regComSchema.safeParse(regCom);
      expect(result.success).toBe(expected);
    });
  });

  describe('Postal Code validation', () => {
    it.each([
      ['012345', true],
      ['123456', true],
      ['000000', true],
      ['12345', false], // 5 digits
      ['1234567', false], // 7 digits
      ['12345A', false], // Letter
    ])('Postal code "%s" should be valid: %s', (code, expected) => {
      const result = postalCodeSchema.safeParse(code);
      expect(result.success).toBe(expected);
    });
  });

  describe('Phone validation', () => {
    it.each([
      ['+40721234567', true],
      ['0721234567', true],
      ['+40123456789012345', true], // 15 digits
      ['40721234567', true],
      ['+4072123', false], // Too short
      ['+407212345678901234', false], // Too long
      ['+40-721-234-567', false], // Dashes
    ])('Phone "%s" should be valid: %s', (phone, expected) => {
      const result = phoneSchema.safeParse(phone);
      expect(result.success).toBe(expected);
    });
  });
});

// =============================================================================
// AI CONFIG SCHEMA TESTS
// =============================================================================

describe('AIConfigSchema', () => {
  describe('valid inputs', () => {
    it('should accept valid AI configuration', () => {
      const validConfig = {
        enabled: true,
        model: 'claude-sonnet-4',
        temperature: 0.7,
        maxTokens: 4096,
        systemPrompt: 'You are a helpful assistant',
        guardrailsProfile: 'balanced',
        autoApproveThreshold: 85,
        allowedTopics: ['pricing', 'products', 'delivery'],
        blockedTopics: ['competitors', 'internal'],
      };

      const result = aiConfigSchema.safeParse(validConfig);
      expect(result.success).toBe(true);
    });
  });

  describe('invalid inputs', () => {
    it('should reject temperature below 0', () => {
      const invalidConfig = {
        enabled: true,
        model: 'claude-sonnet-4',
        temperature: -0.1,
      };

      const result = aiConfigSchema.safeParse(invalidConfig);
      expect(result.success).toBe(false);
    });

    it('should reject temperature above 1', () => {
      const invalidConfig = {
        enabled: true,
        model: 'claude-sonnet-4',
        temperature: 1.5,
      };

      const result = aiConfigSchema.safeParse(invalidConfig);
      expect(result.success).toBe(false);
    });

    it('should reject invalid model name', () => {
      const invalidConfig = {
        enabled: true,
        model: 'gpt-4', // Not in allowed list
        temperature: 0.7,
      };

      const result = aiConfigSchema.safeParse(invalidConfig);
      expect(result.success).toBe(false);
    });

    it('should reject autoApproveThreshold below 50', () => {
      const invalidConfig = {
        enabled: true,
        model: 'claude-sonnet-4',
        autoApproveThreshold: 30,
      };

      const result = aiConfigSchema.safeParse(invalidConfig);
      expect(result.success).toBe(false);
    });
  });
});

// =============================================================================
// GUARDRAIL SCHEMA TESTS
// =============================================================================

describe('GuardrailSchema', () => {
  describe('valid inputs', () => {
    it('should accept valid guardrail rule', () => {
      const validRule = {
        name: 'Max Discount Rule',
        type: 'discount_limit',
        condition: {
          field: 'discount_percentage',
          operator: 'greater_than',
          value: 15,
        },
        action: 'require_approval',
        severity: 'warning',
        isActive: true,
      };

      const result = guardrailSchema.safeParse(validRule);
      expect(result.success).toBe(true);
    });

    it('should accept rule with multiple conditions', () => {
      const validRule = {
        name: 'High Value Rule',
        type: 'value_limit',
        conditions: [
          { field: 'total_value', operator: 'greater_than', value: 50000 },
          { field: 'discount_percentage', operator: 'greater_than', value: 10 },
        ],
        conditionLogic: 'AND',
        action: 'block',
        severity: 'critical',
        isActive: true,
      };

      const result = guardrailSchema.safeParse(validRule);
      expect(result.success).toBe(true);
    });
  });

  describe('invalid inputs', () => {
    it('should reject empty rule name', () => {
      const invalidRule = {
        name: '',
        type: 'discount_limit',
        condition: { field: 'discount', operator: 'gt', value: 10 },
        action: 'warn',
      };

      const result = guardrailSchema.safeParse(invalidRule);
      expect(result.success).toBe(false);
    });

    it('should reject invalid operator', () => {
      const invalidRule = {
        name: 'Test Rule',
        type: 'value_limit',
        condition: {
          field: 'value',
          operator: 'LIKE', // Invalid
          value: 100,
        },
        action: 'warn',
      };

      const result = guardrailSchema.safeParse(invalidRule);
      expect(result.success).toBe(false);
    });
  });
});
```

### 14.3 Component Rendering Tests

```typescript
// testing/forms/components.test.tsx
import { describe, it, expect, vi } from 'vitest';
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { NegotiationCreateForm } from '@/components/forms/NegotiationCreateForm';
import { ProductForm } from '@/components/forms/ProductForm';
import { DiscountApprovalDialog } from '@/components/dialogs/DiscountApprovalDialog';
import { DeleteConfirmDialog } from '@/components/dialogs/DeleteConfirmDialog';

// =============================================================================
// FORM RENDERING TESTS
// =============================================================================

describe('NegotiationCreateForm', () => {
  const mockContacts = [
    { id: 'c1', name: 'Contact 1', cui: 'RO12345678', tier: 'gold' },
    { id: 'c2', name: 'Contact 2', cui: 'RO87654321', tier: 'silver' },
  ];

  const mockProducts = [
    { id: 'p1', name: 'Product 1', sku: 'SKU-001', price: 100, stock: 500 },
    { id: 'p2', name: 'Product 2', sku: 'SKU-002', price: 200, stock: 300 },
  ];

  it('should render all form sections', () => {
    render(
      <NegotiationCreateForm
        contacts={mockContacts}
        products={mockProducts}
        onSubmit={vi.fn()}
      />
    );

    expect(screen.getByText(/selectează contact/i)).toBeInTheDocument();
    expect(screen.getByText(/produse/i)).toBeInTheDocument();
    expect(screen.getByText(/setări/i)).toBeInTheDocument();
  });

  it('should enable submit only when form is valid', async () => {
    const user = userEvent.setup();
    render(
      <NegotiationCreateForm
        contacts={mockContacts}
        products={mockProducts}
        onSubmit={vi.fn()}
      />
    );

    const submitButton = screen.getByRole('button', { name: /creează/i });
    expect(submitButton).toBeDisabled();

    // Select contact
    await user.click(screen.getByRole('combobox', { name: /contact/i }));
    await user.click(screen.getByText('Contact 1'));

    // Add product
    await user.click(screen.getByText('Product 1'));

    // Submit should now be enabled
    await waitFor(() => {
      expect(submitButton).not.toBeDisabled();
    });
  });

  it('should show validation errors for invalid input', async () => {
    const user = userEvent.setup();
    render(
      <NegotiationCreateForm
        contacts={mockContacts}
        products={mockProducts}
        onSubmit={vi.fn()}
      />
    );

    // Try to submit without data
    const submitButton = screen.getByRole('button', { name: /creează/i });
    await user.click(submitButton);

    await waitFor(() => {
      expect(screen.getByText(/contactul este obligatoriu/i)).toBeInTheDocument();
    });
  });

  it('should call onSubmit with form data when valid', async () => {
    const user = userEvent.setup();
    const mockSubmit = vi.fn().mockResolvedValue({ id: 'neg-1' });

    render(
      <NegotiationCreateForm
        contacts={mockContacts}
        products={mockProducts}
        onSubmit={mockSubmit}
      />
    );

    // Fill form
    await user.click(screen.getByRole('combobox', { name: /contact/i }));
    await user.click(screen.getByText('Contact 1'));
    await user.click(screen.getByText('Product 1'));

    // Submit
    const submitButton = screen.getByRole('button', { name: /creează/i });
    await user.click(submitButton);

    await waitFor(() => {
      expect(mockSubmit).toHaveBeenCalledWith(
        expect.objectContaining({
          contactId: 'c1',
          products: expect.arrayContaining([
            expect.objectContaining({ productId: 'p1' }),
          ]),
        })
      );
    });
  });
});

// =============================================================================
// PRODUCT FORM TESTS
// =============================================================================

describe('ProductForm', () => {
  it('should render all required fields', () => {
    render(<ProductForm onSubmit={vi.fn()} />);

    expect(screen.getByLabelText(/sku/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/nume produs/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/preț/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/unitate/i)).toBeInTheDocument();
  });

  it('should populate form when editing existing product', () => {
    const existingProduct = {
      id: 'p1',
      sku: 'PROD-001',
      name: 'Existing Product',
      basePrice: 150,
      unit: 'kg',
      category: 'Seeds',
    };

    render(<ProductForm product={existingProduct} onSubmit={vi.fn()} />);

    expect(screen.getByDisplayValue('PROD-001')).toBeInTheDocument();
    expect(screen.getByDisplayValue('Existing Product')).toBeInTheDocument();
    expect(screen.getByDisplayValue('150')).toBeInTheDocument();
  });

  it('should validate SKU format', async () => {
    const user = userEvent.setup();
    render(<ProductForm onSubmit={vi.fn()} />);

    const skuInput = screen.getByLabelText(/sku/i);
    await user.type(skuInput, 'invalid sku!');
    await user.tab();

    await waitFor(() => {
      expect(screen.getByText(/sku invalid/i)).toBeInTheDocument();
    });
  });

  it('should validate price is positive', async () => {
    const user = userEvent.setup();
    render(<ProductForm onSubmit={vi.fn()} />);

    const priceInput = screen.getByLabelText(/preț/i);
    await user.clear(priceInput);
    await user.type(priceInput, '-100');
    await user.tab();

    await waitFor(() => {
      expect(screen.getByText(/prețul trebuie să fie pozitiv/i)).toBeInTheDocument();
    });
  });
});

// =============================================================================
// DIALOG TESTS
// =============================================================================

describe('DiscountApprovalDialog', () => {
  const mockApprovalRequest = {
    id: 'apr-1',
    negotiationId: 'neg-1',
    negotiationTitle: 'Test Negotiation',
    requestedDiscount: 25,
    originalPrice: 10000,
    discountedPrice: 7500,
    reason: 'Client fidel',
    requestedBy: 'Agent Test',
    requestedAt: new Date().toISOString(),
  };

  it('should render approval request details', () => {
    render(
      <DiscountApprovalDialog
        open={true}
        request={mockApprovalRequest}
        onApprove={vi.fn()}
        onReject={vi.fn()}
        onClose={vi.fn()}
      />
    );

    expect(screen.getByText('Test Negotiation')).toBeInTheDocument();
    expect(screen.getByText(/25%/)).toBeInTheDocument();
    expect(screen.getByText('Client fidel')).toBeInTheDocument();
  });

  it('should call onApprove when approved', async () => {
    const user = userEvent.setup();
    const mockApprove = vi.fn().mockResolvedValue({});

    render(
      <DiscountApprovalDialog
        open={true}
        request={mockApprovalRequest}
        onApprove={mockApprove}
        onReject={vi.fn()}
        onClose={vi.fn()}
      />
    );

    await user.click(screen.getByRole('button', { name: /aprobă/i }));

    await waitFor(() => {
      expect(mockApprove).toHaveBeenCalledWith(mockApprovalRequest.id, undefined);
    });
  });

  it('should require reason when rejecting', async () => {
    const user = userEvent.setup();
    const mockReject = vi.fn().mockResolvedValue({});

    render(
      <DiscountApprovalDialog
        open={true}
        request={mockApprovalRequest}
        onApprove={vi.fn()}
        onReject={mockReject}
        onClose={vi.fn()}
      />
    );

    // Try to reject without reason
    await user.click(screen.getByRole('button', { name: /respinge/i }));

    // Should show reason input
    const reasonInput = await screen.findByPlaceholderText(/motiv respingere/i);
    await user.type(reasonInput, 'Discount prea mare');
    await user.click(screen.getByRole('button', { name: /confirmă respingere/i }));

    await waitFor(() => {
      expect(mockReject).toHaveBeenCalledWith(
        mockApprovalRequest.id,
        'Discount prea mare'
      );
    });
  });
});

describe('DeleteConfirmDialog', () => {
  it('should render with resource details', () => {
    render(
      <DeleteConfirmDialog
        open={true}
        resourceType="contact"
        resourceName="Test Contact"
        onConfirm={vi.fn()}
        onClose={vi.fn()}
      />
    );

    expect(screen.getByText(/șterge contact/i)).toBeInTheDocument();
    expect(screen.getByText('Test Contact')).toBeInTheDocument();
  });

  it('should show cascade warning when provided', () => {
    render(
      <DeleteConfirmDialog
        open={true}
        resourceType="contact"
        resourceName="Test Contact"
        cascadeItems={[
          { type: 'negotiation', count: 5 },
          { type: 'document', count: 12 },
        ]}
        onConfirm={vi.fn()}
        onClose={vi.fn()}
      />
    );

    expect(screen.getByText(/5 negocieri/i)).toBeInTheDocument();
    expect(screen.getByText(/12 documente/i)).toBeInTheDocument();
  });

  it('should require confirmation text when specified', async () => {
    const user = userEvent.setup();
    const mockConfirm = vi.fn();

    render(
      <DeleteConfirmDialog
        open={true}
        resourceType="contact"
        resourceName="Test Contact"
        requireConfirmation={true}
        onConfirm={mockConfirm}
        onClose={vi.fn()}
      />
    );

    const deleteButton = screen.getByRole('button', { name: /șterge/i });
    expect(deleteButton).toBeDisabled();

    const confirmInput = screen.getByPlaceholderText(/tastează/i);
    await user.type(confirmInput, 'Test Contact');

    await waitFor(() => {
      expect(deleteButton).not.toBeDisabled();
    });

    await user.click(deleteButton);
    expect(mockConfirm).toHaveBeenCalled();
  });
});
```

### 14.4 Integration Tests with API Mocking

```typescript
// testing/forms/integration.test.tsx
import { describe, it, expect, beforeAll, afterAll, afterEach, vi } from 'vitest';
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { http, HttpResponse } from 'msw';
import { setupServer } from 'msw/node';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { NegotiationWizard } from '@/components/wizards/NegotiationWizard';
import { ProductImportWizard } from '@/components/wizards/ProductImportWizard';
import { OnboardingWizard } from '@/components/wizards/OnboardingWizard';

// =============================================================================
// MSW SETUP
// =============================================================================

const server = setupServer(
  // Contacts endpoint
  http.get('/api/v1/contacts', () => {
    return HttpResponse.json({
      data: [
        { id: 'c1', name: 'Agricom SRL', cui: 'RO12345678', tier: 'gold' },
        { id: 'c2', name: 'Fermier SRL', cui: 'RO87654321', tier: 'silver' },
      ],
      pagination: { total: 2, page: 1, limit: 20 },
    });
  }),

  // Products endpoint
  http.get('/api/v1/products', () => {
    return HttpResponse.json({
      data: [
        { id: 'p1', name: 'Semințe porumb', sku: 'SEM-001', price: 100, stock: 5000 },
        { id: 'p2', name: 'Fertilizant NPK', sku: 'FER-001', price: 250, stock: 2000 },
      ],
      pagination: { total: 2, page: 1, limit: 20 },
    });
  }),

  // Negotiation creation endpoint
  http.post('/api/v1/negotiations', async ({ request }) => {
    const body = await request.json();
    return HttpResponse.json({
      id: 'neg-new-1',
      ...body,
      status: 'draft',
      createdAt: new Date().toISOString(),
    });
  }),

  // Product import endpoint
  http.post('/api/v1/products/import', async ({ request }) => {
    const body = await request.json();
    const products = body.products || [];
    return HttpResponse.json({
      created: Math.floor(products.length * 0.7),
      updated: Math.floor(products.length * 0.2),
      skipped: Math.floor(products.length * 0.05),
      errors: [
        { row: 5, sku: 'INVALID', error: 'SKU duplicat' },
      ],
    });
  }),

  // CUI lookup endpoint
  http.post('/api/v1/tenants/lookup-cui', async ({ request }) => {
    const body = await request.json();
    if (body.cui === 'RO12345678' || body.cui === '12345678') {
      return HttpResponse.json({
        companyName: 'SC AGRICOM SRL',
        address: 'Str. Fermei nr. 15',
        city: 'București',
        county: 'București',
      });
    }
    return HttpResponse.json(null);
  }),

  // Onboarding endpoint
  http.post('/api/v1/tenants/onboard', async ({ request }) => {
    const body = await request.json();
    return HttpResponse.json({
      id: 'tenant-new-1',
      invitesSent: body.team?.members?.filter((m: any) => m.sendInvite).length || 0,
    });
  }),

  // Approval endpoints
  http.post('/api/v1/hitl/approvals/:id/approve', () => {
    return HttpResponse.json({ success: true });
  }),

  http.post('/api/v1/hitl/approvals/:id/reject', () => {
    return HttpResponse.json({ success: true });
  })
);

beforeAll(() => server.listen());
afterEach(() => server.resetHandlers());
afterAll(() => server.close());

// Query client wrapper
function createWrapper() {
  const queryClient = new QueryClient({
    defaultOptions: {
      queries: { retry: false },
      mutations: { retry: false },
    },
  });

  return ({ children }: { children: React.ReactNode }) => (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  );
}

// =============================================================================
// INTEGRATION TESTS
// =============================================================================

describe('NegotiationWizard Integration', () => {
  it('should complete full negotiation creation flow', async () => {
    const user = userEvent.setup();
    const mockOnComplete = vi.fn();

    render(
      <NegotiationWizard
        open={true}
        onClose={vi.fn()}
        onComplete={mockOnComplete}
      />,
      { wrapper: createWrapper() }
    );

    // Step 1: Select contact
    await waitFor(() => {
      expect(screen.getByText(/selectează contact/i)).toBeInTheDocument();
    });

    await user.click(screen.getByRole('combobox'));
    await user.click(await screen.findByText('Agricom SRL'));
    await user.click(screen.getByRole('button', { name: /continuă/i }));

    // Step 2: Select products
    await waitFor(() => {
      expect(screen.getByText(/produse/i)).toBeInTheDocument();
    });

    await user.click(await screen.findByText('Semințe porumb'));
    await user.click(screen.getByRole('button', { name: /continuă/i }));

    // Step 3: Configure settings
    await waitFor(() => {
      expect(screen.getByText(/setări/i)).toBeInTheDocument();
    });

    await user.click(screen.getByRole('button', { name: /continuă/i }));

    // Step 4: Confirm and create
    await waitFor(() => {
      expect(screen.getByText(/confirmă/i)).toBeInTheDocument();
    });

    await user.click(screen.getByRole('button', { name: /creează negociere/i }));

    await waitFor(() => {
      expect(mockOnComplete).toHaveBeenCalledWith(
        expect.objectContaining({
          id: 'neg-new-1',
        })
      );
    });
  });

  it('should handle API errors gracefully', async () => {
    server.use(
      http.post('/api/v1/negotiations', () => {
        return HttpResponse.json(
          { error: 'Internal Server Error' },
          { status: 500 }
        );
      })
    );

    const user = userEvent.setup();
    const mockOnComplete = vi.fn();

    render(
      <NegotiationWizard
        open={true}
        onClose={vi.fn()}
        onComplete={mockOnComplete}
      />,
      { wrapper: createWrapper() }
    );

    // Navigate through wizard
    await user.click(screen.getByRole('combobox'));
    await user.click(await screen.findByText('Agricom SRL'));
    await user.click(screen.getByRole('button', { name: /continuă/i }));

    await user.click(await screen.findByText('Semințe porumb'));
    await user.click(screen.getByRole('button', { name: /continuă/i }));
    await user.click(screen.getByRole('button', { name: /continuă/i }));
    await user.click(screen.getByRole('button', { name: /creează negociere/i }));

    // Should show error
    await waitFor(() => {
      expect(screen.getByText(/eroare/i)).toBeInTheDocument();
    });

    expect(mockOnComplete).not.toHaveBeenCalled();
  });
});

describe('ProductImportWizard Integration', () => {
  it('should complete import flow with valid CSV', async () => {
    const user = userEvent.setup();
    const mockOnImport = vi.fn().mockResolvedValue({
      created: 7,
      updated: 2,
      skipped: 0,
      errors: [],
    });

    render(
      <ProductImportWizard
        open={true}
        onClose={vi.fn()}
        onImport={mockOnImport}
        existingCategories={['Semințe', 'Fertilizanți']}
        existingUnits={['kg', 'l', 'buc']}
      />
    );

    // Step 1: Upload file
    const csvContent = `sku,name,price,unit,category
PROD-001,Produs 1,100,kg,Semințe
PROD-002,Produs 2,200,l,Fertilizanți`;

    const file = new File([csvContent], 'products.csv', { type: 'text/csv' });
    const input = screen.getByLabelText(/încarcă fișier/i);
    await user.upload(input, file);

    await user.click(screen.getByRole('button', { name: /continuă/i }));

    // Step 2: Map columns
    await waitFor(() => {
      expect(screen.getByText(/mapare coloane/i)).toBeInTheDocument();
    });

    await user.click(screen.getByRole('button', { name: /validează/i }));

    // Step 3: Review validation
    await waitFor(() => {
      expect(screen.getByText(/validare/i)).toBeInTheDocument();
    });

    await user.click(screen.getByRole('button', { name: /importă/i }));

    // Should show results
    await waitFor(() => {
      expect(mockOnImport).toHaveBeenCalled();
    });
  });
});

describe('OnboardingWizard Integration', () => {
  it('should complete onboarding flow', async () => {
    const user = userEvent.setup();
    const mockOnComplete = vi.fn().mockResolvedValue({
      tenantId: 'tenant-new-1',
      invitesSent: 2,
    });

    render(
      <OnboardingWizard
        open={true}
        onComplete={mockOnComplete}
        cuiLookup={async (cui) => {
          if (cui === 'RO12345678') {
            return {
              companyName: 'SC AGRICOM SRL',
              address: 'Str. Fermei nr. 15',
              city: 'București',
              county: 'București',
            };
          }
          return null;
        }}
      />
    );

    // Step 1: Company info
    await user.type(screen.getByLabelText(/cui/i), 'RO12345678');
    await user.click(screen.getByRole('button', { name: /refresh/i }));

    await waitFor(() => {
      expect(screen.getByDisplayValue('SC AGRICOM SRL')).toBeInTheDocument();
    });

    await user.type(screen.getByLabelText(/email/i), 'contact@agricom.ro');
    await user.type(screen.getByLabelText(/cod poștal/i), '012345');

    // Fill bank account
    await user.type(screen.getByLabelText(/banca/i), 'BT');
    await user.type(screen.getByLabelText(/iban/i), 'RO49BTRL0000000000000000');

    await user.click(screen.getByRole('button', { name: /continuă/i }));

    // Step 2: Team (skip)
    await user.click(screen.getByRole('button', { name: /continuă/i }));

    // Step 3: Settings (use defaults)
    await user.click(screen.getByRole('button', { name: /continuă/i }));

    // Step 4: Integrations (use defaults)
    await user.click(screen.getByRole('button', { name: /continuă/i }));

    // Step 5: Confirm
    await user.click(screen.getByRole('checkbox', { name: /termeni/i }));
    await user.click(screen.getByRole('checkbox', { name: /confidențialitate/i }));
    await user.click(screen.getByRole('button', { name: /finalizează/i }));

    await waitFor(() => {
      expect(mockOnComplete).toHaveBeenCalled();
    });
  });
});
```

### 14.5 E2E Tests with Playwright

```typescript
// testing/e2e/forms.spec.ts
import { test, expect } from '@playwright/test';

// =============================================================================
// E2E TEST SUITE
// =============================================================================

test.describe('Negotiation Forms E2E', () => {
  test.beforeEach(async ({ page }) => {
    // Login
    await page.goto('/login');
    await page.fill('[name="email"]', 'test@cerniq.app');
    await page.fill('[name="password"]', 'TestPass123!');
    await page.click('button[type="submit"]');
    await page.waitForURL('/dashboard');
  });

  test('should create negotiation via wizard', async ({ page }) => {
    await page.goto('/negotiations');
    await page.click('button:has-text("Negociere nouă")');

    // Wait for wizard dialog
    await expect(page.getByRole('dialog')).toBeVisible();

    // Step 1: Select contact
    await page.click('[role="combobox"]');
    await page.click('text=Agricom SRL');
    await page.click('button:has-text("Continuă")');

    // Step 2: Add products
    await page.click('text=Semințe porumb');
    await page.fill('input[name="quantity"]', '100');
    await page.click('button:has-text("Continuă")');

    // Step 3: Settings
    await page.selectOption('select[name="paymentTerms"]', '30');
    await page.click('button:has-text("Continuă")');

    // Step 4: Confirm
    await page.click('button:has-text("Creează negociere")');

    // Wait for redirect
    await expect(page).toHaveURL(/\/negotiations\/[a-z0-9-]+/);

    // Verify negotiation was created
    await expect(page.locator('h1')).toContainText('Agricom SRL');
  });

  test('should show validation errors for invalid data', async ({ page }) => {
    await page.goto('/negotiations/new');

    // Try to submit without required fields
    await page.click('button:has-text("Salvează")');

    // Should show validation errors
    await expect(page.locator('.text-red-500')).toContainText('obligatoriu');
  });

  test('should handle discount approval workflow', async ({ page }) => {
    // Navigate to negotiation with pending discount
    await page.goto('/negotiations/neg-with-discount');

    // Request discount
    await page.click('button:has-text("Solicită discount")');
    await page.fill('input[name="discount"]', '25');
    await page.fill('textarea[name="reason"]', 'Client fidel');
    await page.click('button:has-text("Trimite cererea")');

    // Verify approval dialog
    await expect(page.getByRole('dialog')).toBeVisible();
    await expect(page.locator('text=Cerere în așteptare')).toBeVisible();
  });
});

test.describe('Product Management E2E', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/login');
    await page.fill('[name="email"]', 'admin@cerniq.app');
    await page.fill('[name="password"]', 'AdminPass123!');
    await page.click('button[type="submit"]');
    await page.waitForURL('/dashboard');
  });

  test('should import products from CSV', async ({ page }) => {
    await page.goto('/products');
    await page.click('button:has-text("Import")');

    // Upload file
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles('testing/fixtures/products.csv');

    // Wait for file processing
    await expect(page.locator('text=Fișier încărcat')).toBeVisible();

    // Map columns
    await page.click('button:has-text("Continuă")');
    await expect(page.locator('text=Mapare coloane')).toBeVisible();

    // Validate
    await page.click('button:has-text("Validează")');
    await expect(page.locator('text=produse valide')).toBeVisible();

    // Import
    await page.click('button:has-text("Importă")');

    // Wait for completion
    await expect(page.locator('text=Import finalizat')).toBeVisible({ timeout: 30000 });
  });

  test('should edit product inline', async ({ page }) => {
    await page.goto('/products');

    // Click on product row
    await page.click('tr:has-text("Semințe porumb")');

    // Edit price
    await page.dblclick('td:has-text("100")');
    await page.fill('input[name="price"]', '150');
    await page.press('input[name="price"]', 'Enter');

    // Verify toast
    await expect(page.locator('.toast')).toContainText('Produs actualizat');

    // Verify new value
    await expect(page.locator('tr:has-text("Semințe porumb")')).toContainText('150');
  });

  test('should handle bulk delete', async ({ page }) => {
    await page.goto('/products');

    // Select multiple products
    await page.click('tr:has-text("Produs 1") input[type="checkbox"]');
    await page.click('tr:has-text("Produs 2") input[type="checkbox"]');

    // Click bulk action
    await page.click('button:has-text("Acțiuni")');
    await page.click('text=Șterge selectate');

    // Confirm deletion
    await page.fill('input[placeholder*="confirmă"]', 'STERGE');
    await page.click('button:has-text("Confirmă ștergerea")');

    // Verify deletion
    await expect(page.locator('tr:has-text("Produs 1")')).not.toBeVisible();
    await expect(page.locator('tr:has-text("Produs 2")')).not.toBeVisible();
  });
});

test.describe('HITL Approval E2E', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/login');
    await page.fill('[name="email"]', 'manager@cerniq.app');
    await page.fill('[name="password"]', 'ManagerPass123!');
    await page.click('button[type="submit"]');
    await page.waitForURL('/dashboard');
  });

  test('should approve discount request', async ({ page }) => {
    await page.goto('/hitl/approvals');

    // Find pending approval
    await page.click('tr:has-text("Cerere discount 25%")');

    // Review and approve
    await expect(page.getByRole('dialog')).toBeVisible();
    await page.fill('textarea[name="notes"]', 'Aprobat conform politicii');
    await page.click('button:has-text("Aprobă")');

    // Verify approval
    await expect(page.locator('.toast')).toContainText('aprobat');
  });

  test('should reject with reason', async ({ page }) => {
    await page.goto('/hitl/approvals');

    await page.click('tr:has-text("Cerere discount 40%")');

    // Reject
    await page.click('button:has-text("Respinge")');
    await page.fill('textarea[name="rejectionReason"]', 'Discount prea mare');
    await page.click('button:has-text("Confirmă respingerea")');

    // Verify rejection
    await expect(page.locator('.toast')).toContainText('respins');
  });

  test('should handle AI response review', async ({ page }) => {
    await page.goto('/hitl/ai-responses');

    // Find pending response
    await page.click('tr:has-text("Răspuns AI - Întrebare prețuri")');

    // Review dialog
    await expect(page.getByRole('dialog')).toBeVisible();
    await expect(page.locator('text=Răspuns generat:')).toBeVisible();

    // Edit response
    await page.click('button:has-text("Editează")');
    const textarea = page.locator('textarea[name="editedResponse"]');
    await textarea.fill('Răspuns editat de manager');
    await page.click('button:has-text("Salvează și trimite")');

    // Verify
    await expect(page.locator('.toast')).toContainText('trimis');
  });
});
```

### 14.6 Accessibility Tests

```typescript
// testing/accessibility/forms.test.tsx
import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';
import { axe, toHaveNoViolations } from 'jest-axe';
import { NegotiationCreateForm } from '@/components/forms/NegotiationCreateForm';
import { ProductForm } from '@/components/forms/ProductForm';
import { DeleteConfirmDialog } from '@/components/dialogs/DeleteConfirmDialog';
import { NegotiationWizard } from '@/components/wizards/NegotiationWizard';

expect.extend(toHaveNoViolations);

// =============================================================================
// ACCESSIBILITY TESTS
// =============================================================================

describe('Form Accessibility', () => {
  it('NegotiationCreateForm should have no accessibility violations', async () => {
    const { container } = render(
      <NegotiationCreateForm
        contacts={[]}
        products={[]}
        onSubmit={() => Promise.resolve()}
      />
    );

    const results = await axe(container);
    expect(results).toHaveNoViolations();
  });

  it('ProductForm should have no accessibility violations', async () => {
    const { container } = render(
      <ProductForm onSubmit={() => Promise.resolve()} />
    );

    const results = await axe(container);
    expect(results).toHaveNoViolations();
  });

  it('DeleteConfirmDialog should have no accessibility violations', async () => {
    const { container } = render(
      <DeleteConfirmDialog
        open={true}
        resourceType="contact"
        resourceName="Test Contact"
        onConfirm={() => Promise.resolve()}
        onClose={() => {}}
      />
    );

    const results = await axe(container);
    expect(results).toHaveNoViolations();
  });
});

describe('Form Label Associations', () => {
  it('all form fields should have associated labels', () => {
    render(
      <NegotiationCreateForm
        contacts={[]}
        products={[]}
        onSubmit={() => Promise.resolve()}
      />
    );

    // Get all inputs
    const inputs = screen.getAllByRole('textbox');
    const selects = screen.getAllByRole('combobox');
    const checkboxes = screen.queryAllByRole('checkbox');

    // Each input should have an accessible name
    inputs.forEach((input) => {
      expect(input).toHaveAccessibleName();
    });

    selects.forEach((select) => {
      expect(select).toHaveAccessibleName();
    });

    checkboxes.forEach((checkbox) => {
      expect(checkbox).toHaveAccessibleName();
    });
  });

  it('error messages should be associated with inputs', async () => {
    render(
      <ProductForm onSubmit={() => Promise.resolve()} />
    );

    // Trigger validation
    const submitButton = screen.getByRole('button', { name: /salvează/i });
    await userEvent.click(submitButton);

    // Error messages should be connected via aria-describedby
    const skuInput = screen.getByLabelText(/sku/i);
    expect(skuInput).toHaveAttribute('aria-invalid', 'true');
    expect(skuInput).toHaveAccessibleDescription();
  });
});

describe('Keyboard Navigation', () => {
  it('should support tab navigation through form fields', async () => {
    render(
      <ProductForm onSubmit={() => Promise.resolve()} />
    );

    const skuInput = screen.getByLabelText(/sku/i);
    const nameInput = screen.getByLabelText(/nume produs/i);
    const priceInput = screen.getByLabelText(/preț/i);
    const submitButton = screen.getByRole('button', { name: /salvează/i });

    // Tab through fields
    skuInput.focus();
    expect(skuInput).toHaveFocus();

    await userEvent.tab();
    expect(nameInput).toHaveFocus();

    await userEvent.tab();
    expect(priceInput).toHaveFocus();
  });

  it('dialog should trap focus', async () => {
    render(
      <DeleteConfirmDialog
        open={true}
        resourceType="contact"
        resourceName="Test"
        onConfirm={() => Promise.resolve()}
        onClose={() => {}}
      />
    );

    const dialog = screen.getByRole('dialog');
    const focusableElements = dialog.querySelectorAll(
      'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
    );

    // First element should be focused
    expect(focusableElements[0]).toHaveFocus();

    // Tab should cycle within dialog
    for (let i = 0; i < focusableElements.length + 1; i++) {
      await userEvent.tab();
    }

    // Should be back at first element
    expect(focusableElements[0]).toHaveFocus();
  });

  it('should support Escape key to close dialog', async () => {
    const mockClose = vi.fn();

    render(
      <DeleteConfirmDialog
        open={true}
        resourceType="contact"
        resourceName="Test"
        onConfirm={() => Promise.resolve()}
        onClose={mockClose}
      />
    );

    await userEvent.keyboard('{Escape}');
    expect(mockClose).toHaveBeenCalled();
  });
});

describe('Screen Reader Support', () => {
  it('wizard should announce step changes', async () => {
    render(
      <NegotiationWizard
        open={true}
        onClose={() => {}}
        onComplete={() => Promise.resolve({})}
      />
    );

    // Check for live region
    const liveRegion = document.querySelector('[aria-live="polite"]');
    expect(liveRegion).toBeInTheDocument();

    // Step indicator should be announced
    expect(screen.getByText(/pas 1/i)).toBeInTheDocument();
  });

  it('form errors should be announced', async () => {
    render(
      <ProductForm onSubmit={() => Promise.resolve()} />
    );

    // Submit empty form
    await userEvent.click(screen.getByRole('button', { name: /salvează/i }));

    // Errors should be in an alert role or live region
    const errorAlerts = screen.queryAllByRole('alert');
    expect(errorAlerts.length).toBeGreaterThan(0);
  });

  it('loading states should be announced', async () => {
    const mockSubmit = vi.fn(() => new Promise(resolve => setTimeout(resolve, 1000)));

    render(
      <ProductForm
        product={{ sku: 'TEST', name: 'Test', basePrice: 100, unit: 'kg' }}
        onSubmit={mockSubmit}
      />
    );

    await userEvent.click(screen.getByRole('button', { name: /salvează/i }));

    // Loading state should have aria-busy
    const button = screen.getByRole('button', { name: /se salvează/i });
    expect(button).toHaveAttribute('aria-busy', 'true');
  });
});

describe('Color Contrast', () => {
  it('error messages should have sufficient contrast', async () => {
    const { container } = render(
      <ProductForm onSubmit={() => Promise.resolve()} />
    );

    // Trigger validation
    await userEvent.click(screen.getByRole('button', { name: /salvează/i }));

    // Run axe with color contrast rules
    const results = await axe(container, {
      rules: {
        'color-contrast': { enabled: true },
      },
    });

    expect(results).toHaveNoViolations();
  });
});
```
