# ============================================================================
# Cerniq.app - Docker Compose Base Configuration
# ============================================================================
# Version: 1.0.1
# Last Updated: 2026-02-03
# References: ADR-0015, ADR-0022, ADR-0027
# ============================================================================
# IMPORTANT: Networks are created externally via `docker network create`
# to ensure proper isolation and persistence across compose restarts.
# See: docs/infrastructure/network-topology.md
# ============================================================================

name: cerniq

# ============================================================================
# Networks (External)
# ============================================================================
# Networks are pre-created on servers (staging/production) with:
#   docker network create --subnet X.X.X.X/24 [--internal] <name>
#
# Subnets (avoiding conflicts with GeniusERP/Neanelu on staging):
# - cerniq_public:  172.27.0.0/24 (external access via Traefik)
# - cerniq_backend: 172.28.0.0/24 (internal: API + Workers)
# - cerniq_data:    172.29.0.0/24 (internal: PostgreSQL + Redis)
# ============================================================================

networks:
  cerniq_public:
    external: true
  cerniq_backend:
    external: true
  cerniq_data:
    external: true

# ============================================================================
# Volumes
# ============================================================================
# Persistent storage for databases and application data
# ============================================================================

volumes:
  # PostgreSQL data persistence
  postgres_data:
    driver: local

  # Redis data persistence (RDB snapshots)
  redis_data:
    driver: local

  # Traefik certificates (Let's Encrypt)
  traefik_certs:
    driver: local

  # SigNoz/ClickHouse data
  signoz_data:
    driver: local

# ============================================================================
# X-Common Configurations (YAML Anchors)
# ============================================================================
# Reusable configuration blocks for services
# ============================================================================

x-common-labels: &common-labels
  com.cerniq.app: "cerniq"
  com.cerniq.environment: "${CERNIQ_ENV:-development}"
  com.cerniq.version: "${CERNIQ_VERSION:-0.0.0}"

x-logging: &default-logging
  driver: json-file
  options:
    max-size: "50m"
    max-file: "5"

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s

# Resource limits from ADR-0027 (128GB RAM, 20 cores server)
x-resource-api: &resource-api
  limits:
    memory: 8G
    cpus: '4'
  reservations:
    memory: 4G
    cpus: '2'

x-resource-worker: &resource-worker
  limits:
    memory: 4G
    cpus: '2'
  reservations:
    memory: 2G
    cpus: '1'

x-resource-postgres: &resource-postgres
  limits:
    memory: 48G
    cpus: '8'
  reservations:
    memory: 32G
    cpus: '4'

x-resource-redis: &resource-redis
  limits:
    memory: 12G
    cpus: '2'
  reservations:
    memory: 8G
    cpus: '1'

x-resource-signoz: &resource-signoz
  limits:
    memory: 16G
    cpus: '2'
  reservations:
    memory: 8G
    cpus: '1'

x-resource-traefik: &resource-traefik
  limits:
    memory: 512M
    cpus: '0.5'
  reservations:
    memory: 256M
    cpus: '0.25'

# ============================================================================
# Services
# ============================================================================
# Services will be defined in subsequent PRs:
# - E0-S2-PR02: PostgreSQL + Redis
# - E0-S3-PR01: Redis/BullMQ
# - E0-S3-PR02: Traefik
# - etc.
# ============================================================================

services: {}
