# =============================================================================
# Cerniq.app - Production Docker Compose Override
# =============================================================================
# Version: 2.0.0 (Full path corrections for server deployment)
# Purpose: Override relative paths for /opt/cerniq server structure
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# 
# Server directory structure:
#   /opt/cerniq/
#   ├── docker-compose.yml
#   ├── docker-compose.prod.yml
#   ├── config/
#   │   ├── postgres/
#   │   ├── traefik/
#   │   └── openbao/
#   ├── scripts/
#   └── secrets/
# =============================================================================

name: cerniq

services:
  # ==========================================================================
  # PostgreSQL - Path overrides for production
  # ==========================================================================
  postgres:
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_wal_archive:/var/lib/postgresql/wal_archive
      - ./config/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./config/postgres/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
      - ./secrets/postgres_password.txt:/run/secrets/postgres_password:ro
    networks:
      cerniq_data:
        ipv4_address: 172.29.30.10
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # ==========================================================================
  # PgBouncer - Path overrides for production
  # ==========================================================================
  pgbouncer:
    networks:
      cerniq_data:
        ipv4_address: 172.29.30.11
      cerniq_backend:
        ipv4_address: 172.29.20.11
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # ==========================================================================
  # Traefik - Path overrides for production
  # ==========================================================================
  traefik:
    volumes:
      - ./config/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./config/traefik/dynamic:/etc/traefik/dynamic:ro
      - ./secrets/traefik_dashboard.htpasswd:/etc/traefik/auth/dashboard.htpasswd:ro
      - traefik_certs:/etc/traefik/certs
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      cerniq_public:
        ipv4_address: 172.29.10.10
      cerniq_backend:
        ipv4_address: 172.29.20.10
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ==========================================================================
  # Redis - Production logging
  # ==========================================================================
  redis:
    networks:
      cerniq_data:
        ipv4_address: 172.29.30.20
      cerniq_backend:
        ipv4_address: 172.29.20.20
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # ==========================================================================
  # OpenBao Server - Path overrides for production
  # ==========================================================================
  openbao:
    volumes:
      - openbao_data:/openbao/data
      - ./config/openbao:/openbao/config:ro
    networks:
      cerniq_backend:
        ipv4_address: 172.29.20.50
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ==========================================================================
  # OpenBao Agent API - Path overrides for production
  # ==========================================================================
  openbao-agent-api:
    volumes:
      - ./config/openbao/agent-api.hcl:/openbao/config/agent-api.hcl:ro
      - ./config/openbao/templates:/openbao/templates:ro
      - api_secrets:/secrets
      - ./secrets/api_role_id:/openbao/config/role_id:ro
      - ./secrets/api_secret_id:/openbao/config/secret_id:ro
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

  # ==========================================================================
  # OpenBao Agent Workers - Path overrides for production
  # ==========================================================================
  openbao-agent-workers:
    volumes:
      - ./config/openbao/agent-workers.hcl:/openbao/config/agent-workers.hcl:ro
      - ./config/openbao/templates:/openbao/templates:ro
      - workers_secrets:/secrets
      - ./secrets/workers_role_id:/openbao/config/role_id:ro
      - ./secrets/workers_secret_id:/openbao/config/secret_id:ro
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

# =============================================================================
# Secrets - Production paths (./secrets/ from /opt/cerniq/)
# =============================================================================
secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt
  redis_password:
    file: ./secrets/redis_password.txt
  traefik_dashboard_htpasswd:
    file: ./secrets/traefik_dashboard.htpasswd

# =============================================================================
# Networks - External (pre-created on server)
# =============================================================================
networks:
  cerniq_public:
    external: true
  cerniq_backend:
    external: true
  cerniq_data:
    external: true
