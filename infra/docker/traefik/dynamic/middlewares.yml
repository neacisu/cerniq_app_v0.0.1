# ============================================================================
# Cerniq.app - Traefik Dynamic Middleware Configuration
# ============================================================================
# Version: 1.0.0
# Last Updated: 2026-02-04
# References: ADR-0014, F0.4.1.T002, F0.4.2.T001
# ============================================================================
# This file is hot-reloaded by Traefik file provider.
# Changes take effect immediately without container restart.
# ============================================================================

http:
  # ==========================================================================
  # Middlewares
  # ==========================================================================
  middlewares:
    # ========================================================================
    # Security Headers (F0.4.1.T002)
    # ========================================================================
    # NOTE: HSTS is handled by external proxy (nginx/neanelu_traefik)
    # since TLS termination happens there. We add other security headers.
    # ========================================================================
    security-headers:
      headers:
        # Frame protection
        frameDeny: true
        # XSS Protection
        browserXssFilter: true
        # Content Type sniffing protection
        contentTypeNosniff: true
        # Referrer Policy
        referrerPolicy: "strict-origin-when-cross-origin"
        # Permissions Policy (Feature Policy successor)
        permissionsPolicy: "camera=(), microphone=(), geolocation=(), payment=()"
        # Custom headers
        customResponseHeaders:
          X-Powered-By: ""  # Remove tech stack disclosure
          Server: ""        # Remove server header

    # ========================================================================
    # Rate Limiting (ADR-0014: 100 req/s average, 200 burst)
    # ========================================================================
    rate-limit:
      rateLimit:
        average: 100
        burst: 200
        period: 1s
        sourceCriterion:
          ipStrategy:
            depth: 1
            excludedIPs:
              - "127.0.0.1/32"
              - "10.0.0.0/8"
              - "172.16.0.0/12"

    # ========================================================================
    # Rate Limiting - Strict (for sensitive endpoints)
    # ========================================================================
    rate-limit-strict:
      rateLimit:
        average: 10
        burst: 20
        period: 1s
        sourceCriterion:
          ipStrategy:
            depth: 1

    # ========================================================================
    # Compression (F0.4.1.T002)
    # ========================================================================
    compress:
      compress:
        excludedContentTypes:
          - "text/event-stream"
        minResponseBodyBytes: 1024

    # ========================================================================
    # Dashboard Authentication (F0.4.2.T001)
    # ========================================================================
    # Uses BasicAuth with bcrypt hashed password
    # htpasswd file: /etc/traefik/auth/dashboard.htpasswd
    # ========================================================================
    dashboard-auth:
      basicAuth:
        usersFile: /etc/traefik/auth/dashboard.htpasswd
        removeHeader: true
        realm: "Cerniq Traefik Dashboard"

    # ========================================================================
    # IP Whitelist for Dashboard (Option B - Office IPs only)
    # ========================================================================
    # IMPORTANT: Update with actual office/admin IPs
    # For initial setup, includes localhost and private ranges
    # ========================================================================
    ip-whitelist:
      ipAllowList:
        sourceRange:
          - "127.0.0.1/32"       # Localhost
          - "10.0.0.0/8"         # Private network
          - "172.16.0.0/12"      # Docker networks
          - "192.168.0.0/16"     # Private network
          # TODO: Add office IP(s) here
          # - "YOUR_OFFICE_IP/32"
        ipStrategy:
          depth: 1

    # ========================================================================
    # Retry middleware for transient failures
    # ========================================================================
    retry:
      retry:
        attempts: 3
        initialInterval: 100ms

    # ========================================================================
    # Circuit Breaker for backend protection
    # ========================================================================
    circuit-breaker:
      circuitBreaker:
        expression: "NetworkErrorRatio() > 0.30 || ResponseCodeRatio(500, 600, 0, 600) > 0.25"
        checkPeriod: 10s
        fallbackDuration: 30s
        recoveryDuration: 60s

    # ========================================================================
    # Default middleware chain for API endpoints
    # ========================================================================
    api-chain:
      chain:
        middlewares:
          - security-headers
          - rate-limit
          - compress

    # ========================================================================
    # Strict middleware chain for auth endpoints
    # ========================================================================
    auth-chain:
      chain:
        middlewares:
          - security-headers
          - rate-limit-strict
          - compress

    # ========================================================================
    # Dashboard middleware chain (IP whitelist + BasicAuth)
    # ========================================================================
    dashboard-chain:
      chain:
        middlewares:
          - ip-whitelist
          - dashboard-auth

  # ==========================================================================
  # Routers
  # ==========================================================================
  routers:
    # ========================================================================
    # Dashboard Router (accessible on metrics entrypoint)
    # ========================================================================
    dashboard:
      rule: "PathPrefix(`/api`) || PathPrefix(`/dashboard`)"
      entryPoints:
        - metrics
      service: api@internal
      middlewares:
        - dashboard-chain

    # ========================================================================
    # Ping Router (health check - no auth required)
    # ========================================================================
    ping:
      rule: "Path(`/ping`)"
      entryPoints:
        - metrics
      service: ping@internal

    # ========================================================================
    # Metrics Router (Prometheus scraping - no auth for internal network)
    # ========================================================================
    prometheus:
      rule: "Path(`/metrics`)"
      entryPoints:
        - metrics
      service: prometheus@internal
      middlewares:
        - ip-whitelist
