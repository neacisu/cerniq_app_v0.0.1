{{/*
=============================================================================
OpenBao Agent Template: Workers Service Environment
=============================================================================
Reference: ADR-0033 OpenBao Secrets Management
Destination: /secrets/workers.env
Version: 1.0
=============================================================================
*/}}
# =============================================================================
# Auto-generated by OpenBao Agent - DO NOT EDIT MANUALLY
# Generated: {{ timestamp }}
# Template: workers-env.tpl
# =============================================================================

{{- with secret "secret/cerniq/workers/config" }}
# =============================================================================
# Worker Configuration
# =============================================================================
WORKER_CONCURRENCY={{ .Data.worker_concurrency }}
MAX_RETRIES={{ .Data.max_retries }}
{{- end }}

{{- $env := env "CERNIQ_ENV" -}}
{{- with secret "secret/cerniq/api/config" }}
# =============================================================================
# Database Configuration
# =============================================================================
{{- $db := "cerniq" -}}
{{- if eq $env "staging" -}}{{- $db = "cerniq_staging" -}}{{- end -}}
{{- with secret "cerniq-db/creds/workers-dynamic" }}
DATABASE_URL=postgresql://{{ .Data.username }}:{{ .Data.password }}@pgbouncer:64033/{{ $db }}
POSTGRES_USER={{ .Data.username }}
POSTGRES_PASSWORD={{ .Data.password }}
{{- end }}

# =============================================================================
# Redis Configuration
# =============================================================================
REDIS_URL=redis://{{ .Data.redis_username }}:{{ .Data.redis_password }}@{{ .Data.redis_host }}:{{ .Data.redis_port }}/0
REDIS_PASSWORD={{ .Data.redis_password }}
REDIS_PREFIX={{ .Data.redis_prefix }}
BULLMQ_PREFIX={{ .Data.bullmq_prefix }}
{{- end }}

{{- with secret "secret/cerniq/shared/external" }}
# =============================================================================
# External API Keys (for enrichment workers)
# =============================================================================
{{- $d := .Data -}}
ANAF_CLIENT_ID={{- $v := index $d "anaf_client_id" -}}{{ if $v }}{{ $v }}{{ end }}
ANAF_CLIENT_SECRET={{- $v := index $d "anaf_client_secret" -}}{{ if $v }}{{ $v }}{{ end }}
RESEND_API_KEY={{- $v := index $d "resend_api_key" -}}{{ if $v }}{{ $v }}{{ end }}
HUNTER_API_KEY={{- $v := index $d "hunter_api_key" -}}{{ if $v }}{{ $v }}{{ end }}
TERMENE_API_KEY={{- $v := index $d "termene_api_key" -}}{{ if $v }}{{ $v }}{{ end }}
{{- end }}

# =============================================================================
# OpenBao Metadata
# =============================================================================
OPENBAO_SECRETS_LOADED=true
OPENBAO_SECRETS_TIMESTAMP={{ timestamp }}
